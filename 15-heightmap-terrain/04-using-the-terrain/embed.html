




	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.117.0">
    <meta name="generator" content="Relearn 5.18.0">
    <meta name="description" content="K-State CIS 580 Textbook">
    <meta name="author" content="Nathan H. Bean">
    <title>Using the Terrain :: K-State CIS 580 Textbook</title>
    <link href="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/04-using-the-terrain/index.html" rel="canonical" type="text/html" title="Using the Terrain :: K-State CIS 580 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/04-using-the-terrain/index.xml" rel="alternate" type="application/rss+xml" title="Using the Terrain :: K-State CIS 580 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/04-using-the-terrain/index.print.html" rel="alternate" type="text/html" title="Using the Terrain :: K-State CIS 580 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/04-using-the-terrain/tele.html" rel="alternate" type="text/html" title="Using the Terrain :: K-State CIS 580 Textbook">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/fontawesome-all.min.css?1691771330" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/fontawesome-all.min.css?1691771330" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/nucleus.css?1691771330" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/auto-complete.css?1691771330" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/auto-complete.css?1691771330" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/perfect-scrollbar.min.css?1691771330" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/fonts.css?1691771330" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/fonts.css?1691771330" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/theme.css?1691771330" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/theme-auto.css?1691771330" rel="stylesheet" id="variant-style">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/variant.css?1691771330" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/print.css?1691771330" rel="stylesheet" media="print">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/ie.css?1691771330" rel="stylesheet">
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/url.js?1691771330"></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/variant.js?1691771330"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="https://ksu-cs-textbooks.github.io/cis580/index.search.js";
      var root_url="https://ksu-cs-textbooks.github.io/cis580/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      window.T_No_results_found = 'No results found for \u0022{0}\u0022';
      window.T_N_results_found = '{1} results found for \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/ksu-cs-textbooks.github.io\/cis580/';
      window.variants && variants.init( [ 'auto', 'light-theme', 'dark-theme' ] );
    </script>
    
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/custom.css?1691771330" rel="stylesheet">

  </head>
  <body class="mobile-support embed disableInlineCopyToClipboard" data-url="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/04-using-the-terrain/embed.html">
    <div id="body" class="default-animation">
      
      
      
      <main id="body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
    
    
    
<p>Let&rsquo;s see our terrain in action.  First we&rsquo;ll need to make some changes in our <code>Game1</code> class.  We&rsquo;ll add a <code>Terrain</code> field:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The terrain </span>
</span></span><span style="display:flex;"><span>    Terrain terrain;</span></span></code></pre></div><p>In our <code>Game1.LoadContent()</code>, we&rsquo;ll load the heightmap and construct our terrain:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Build the terrain</span>
</span></span><span style="display:flex;"><span>    Texture2D heightmap = Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;heightmap&#34;</span>);
</span></span><span style="display:flex;"><span>    terrain = <span style="color:#66d9ef">new</span> Terrain(<span style="color:#66d9ef">this</span>, heightmap, <span style="color:#ae81ff">10f</span>, Matrix.Identity);</span></span></code></pre></div><p>And in our <code>Game1.Draw()</code> we&rsquo;ll render it with the existing camera:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the terrain</span>
</span></span><span style="display:flex;"><span>    terrain.Draw(camera);</span></span></code></pre></div><p>Now if you run the game, you should see your terrain, and even be able to move around it using the camera controls (WASD + Mouse).</p>
<p>
<a href="#image-b3c326ad4d239bb541369d275757b862" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-4.1.png" alt="The rendered terrain" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b3c326ad4d239bb541369d275757b862">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-4.1.png" alt="The rendered terrain" class="lightbox-image" loading="lazy">
</a></p>
<p>You&rsquo;ll probably notice that your camera does not change position as you move over the terrain - in fact, in some parts of the map you can actually end up looking up from underneath!</p>
<p>Clearly we need to do a bit more work.  We need a way to tell the camera what its Y-value should be, based on what part of the terrain it is over.</p>
<h2 id="the-iheightmap-interface">The IHeightMap Interface</h2>
<p>Rather than linking our camera <em>directly</em> to our terrain implementation, let&rsquo;s define an interface that could be used for any surface the player might be walking on.  For lack of a better name, I&rsquo;m calling this interface <code>IHeightMap</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// An interface providing methods for determining the </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// height at a point in a height map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IHeightMap</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Gets the height of the map at the specified position</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;x&#34;&gt;The x coordinate in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;z&#34;&gt;The z coordinate in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;The height at the specified position&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> GetHeightAt(<span style="color:#66d9ef">float</span> x, <span style="color:#66d9ef">float</span> z);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>The interface defines a single method, <code>GetHeightAt()</code>.  Note that we take the X and Z coordinate - these are <em>world coordinates</em> in the game.  The return value is the Y world coordinate corresponding to the elevation of the terrain at <code>x</code> and <code>z</code>.</p>
<h2 id="refactoring-fpscamera">Refactoring FPSCamera</h2>
<p>We can then use this interface within our <code>FPSCamera</code> class to change its height based on its X and Z.  We&rsquo;ll start by adding a property of type <code>ICamera</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets the heightmap this camera is interacting with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IHeightMap HeightMap { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }</span></span></code></pre></div><p>We also might want to add a property to say how far above any heightmap we want the camera to be.  Let&rsquo;s call this <code>HeightOffset</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets how high above the heightmap the camera should be</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> HeightOffset { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">5</span>;</span></span></code></pre></div><p>And we&rsquo;ll modify our <code>FPSCamera.Update()</code> to use the <code>HeightMap</code> and <code>HeightOffset</code> to determine the camera&rsquo;s Y position:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Adjust camera height to heightmap </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(HeightMap != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        position.Y = HeightMap.GetHeightAt(position.X, position.Z) + HeightOffset;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Notice that we wrap this in a <code>null</code> check.  If there is no heightmap, we want to keep our default behavior.</p>
<h2 id="refactoring-game1">Refactoring Game1</h2>
<p>Since the <code>HeightMap</code> is a property of the <code>FPSCamera</code>, we&rsquo;ll need to set it to our terrain in the <code>Game1.LoadContent()</code> method after both the camera and terrain have been created:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    camera.HeightMap = Terrain;</span></span></code></pre></div><h2 id="refactoring-terrain">Refactoring Terrain</h2>
<p>Now we need to implement the <code>IHeightMap</code> interface in our <code>Terrain</code> class.  Add it to the class definition:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Terrain</span> : IHeightMap {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And add the method it calls for:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets the height of the terrain at</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// the supplied world coordinates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;x&#34;&gt;The x world coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;z&#34;&gt;The z world coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> GetHeightAt(<span style="color:#66d9ef">float</span> x, <span style="color:#66d9ef">float</span> z)
</span></span><span style="display:flex;"><span>    {}</span></span></code></pre></div><p>Now, let&rsquo;s talk through the process of finding the height.  As our comments suggest, we&rsquo;re using <em>world</em> coordinates, not <em>model</em> coordinates.  As long as the world matrix remains the identity matrix, these are the same.  But as soon as that changes, the world coordinates no longer line up.  So the first thing we need to do is transform them from world coordinates to model coordinates.</p>
<p>Since multiplying a vector in model coordinates by the world matrix transforms them into world coordinates, the inverse should be true.  Specifically, multiplying world coordinates by the <em>inverse of the world matrix</em> should transform them into model coordinates.</p>
<p>The <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Matrix_Invert_1" target="_blank">Matrix.Invert()</a>
 method can create this inverse matrix:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Matrix inverseWorld = Matrix.Invert(effect.World);</span></span></code></pre></div><p>We&rsquo;ll also need the world coordinates as a <code>Vector3</code> to transform:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Vector3 worldCoordinates = <span style="color:#66d9ef">new</span> Vector3(x, <span style="color:#ae81ff">0</span>, z);</span></span></code></pre></div><p>Here we don&rsquo;t care about the y value, so we&rsquo;ll set it to 0.</p>
<p>Then we can apply the transformation with <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Vector3_Transform_7" target="_blank">Vector3.Transform()</a>
:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Vector3 modelCoordinates = Vector3.Transform(worldCoordinates, inverseWorld);</span></span></code></pre></div><p>At this point, <code>modelCoordinates.X</code> and <code>modelCoordinates.Z</code> correspond to the x and -y indices of our <code>heights</code> array, respectively.  The y coordinate needs to be inverted, because our terrain was defined along the negative z-axis (as the positive z-axis is towards the screen).  Let&rsquo;s save them in float variables so we don&rsquo;t have to remember to invert the z as our y coordinate:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> tx = modelCoordinates.X;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> ty = -modelCoordinates.Z;</span></span></code></pre></div><p>These <em>should</em> correspond to the x and y indices in the <code>heights</code> array, but it is also possible that they are out-of-bounds.  It&rsquo;s a good idea to check:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (tx &lt; <span style="color:#ae81ff">0</span> || ty &lt; <span style="color:#ae81ff">0</span> || tx &gt;= width || ty &gt;= height) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>If we&rsquo;re out-of-bounds, we&rsquo;ll just return a height of 0.  Otherwise, we&rsquo;ll return the value in our <code>heights</code> array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty];</span></span></code></pre></div><p>Now try running the game and exploring your terrain.  The camera should now move vertically according to the elevation!</p>

            <footer class="footline">

            </footer>
          </article>
        </div>
      </main>
    </div>
    
    
    
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/clipboard.min.js?1691771331" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/perfect-scrollbar.min.js?1691771331" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/theme.js?1691771331" defer></script>
  </body>
</html>
