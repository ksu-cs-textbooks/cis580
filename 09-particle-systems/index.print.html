




  
	
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.128.0">
    <meta name="generator" content="Relearn 6.0.0">
    <meta name="description" content="One, Two, three, … BOOM!">
    <meta name="author" content="Nathan Bean">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Particle Systems :: K-State CIS 580 Textbook">
    <meta name="twitter:description" content="One, Two, three, … BOOM!">
    <meta property="og:url" content="https://textbooks.cs.ksu.edu/cis580/09-particle-systems/">
    <meta property="og:site_name" content="K-State CIS 580 Textbook">
    <meta property="og:title" content="Particle Systems :: K-State CIS 580 Textbook">
    <meta property="og:description" content="One, Two, three, … BOOM!">
    <meta property="og:locale" content="en-us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Particle Systems :: K-State CIS 580 Textbook">
    <meta itemprop="description" content="One, Two, three, … BOOM!">
    <meta itemprop="datePublished" content="2020-03-20T10:53:05-05:00">
    <meta itemprop="dateModified" content="2023-08-11T11:18:05-05:00">
    <meta itemprop="wordCount" content="5">
    <title>Particle Systems :: K-State CIS 580 Textbook</title>
    <link href="https://textbooks.cs.ksu.edu/cis580/09-particle-systems/" rel="canonical" type="text/html" title="Particle Systems :: K-State CIS 580 Textbook">
    <link href="/cis580/09-particle-systems/index.xml" rel="alternate" type="application/rss+xml" title="Particle Systems :: K-State CIS 580 Textbook">
    <link href="/cis580/09-particle-systems/tele.html" rel="alternate" type="text/html" title="Particle Systems :: K-State CIS 580 Textbook">
    <link href="/cis580/09-particle-systems/embed.html" rel="alternate" type="text/html" title="Particle Systems :: K-State CIS 580 Textbook">
    <link href="/cis580/css/fontawesome-all.min.css?1723670679" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/fontawesome-all.min.css?1723670679" rel="stylesheet"></noscript>
    <link href="/cis580/css/nucleus.css?1723670679" rel="stylesheet">
    <link href="/cis580/css/auto-complete.css?1723670679" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/auto-complete.css?1723670679" rel="stylesheet"></noscript>
    <link href="/cis580/css/perfect-scrollbar.min.css?1723670679" rel="stylesheet">
    <link href="/cis580/css/fonts.css?1723670679" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/fonts.css?1723670679" rel="stylesheet"></noscript>
    <link href="/cis580/css/theme.css?1723670679" rel="stylesheet">
    <link href="/cis580/css/theme-auto.css?1723670679" rel="stylesheet" id="R-variant-style">
    <link href="/cis580/css/chroma-auto.css?1723670679" rel="stylesheet" id="R-variant-chroma-style">
    <link href="/cis580/css/variant.css?1723670679" rel="stylesheet">
    <link href="/cis580/css/print.css?1723670679" rel="stylesheet" media="print">
    <link href="/cis580/css/format-print.css?1723670679" rel="stylesheet">
    <script src="/cis580/js/variant.js?1723670679"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='https:\/\/textbooks.cs.ksu.edu\/cis580';
      window.index_js_url="/cis580/index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'auto', 'light-theme', 'dark-theme' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
    
    <link href="/cis580/css/custom.css?1723670679" rel="stylesheet">
  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="/cis580/09-particle-systems/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Particle Systems</span><meta itemprop="position" content="1"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/cis580/08-spritebatch-transforms/07-summary/" title="Summary (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/cis580/09-particle-systems/01-introduction/" title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="particle-systems">Particle Systems</h1>

<p>One, Two, three, &hellip; BOOM!</p>
<img src="https://media.giphy.com/media/2dnGHOAQt1tIziib5X/giphy.gif" />
            <footer class="footline">
              
              
              
              
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Particle Systems</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="introduction">Introduction</h1>

<p>Continuing our exploration of the SpriteBatch and Sprites, let&rsquo;s turn our attention to <em>particle systems</em>.  Particle systems leverage thousands of very small sprites to create the illusion of fire, smoke, explosions, precipitation, waterfalls, and many other interesting effects.  They are a staple in modern game engines both to create ambience (i.e. fires and smoke) and to enhance gameplay (glowing sparkles around objects that can be interacted with).  In this section, we&rsquo;ll discuss the basics of how particle systems work, and iteratively build a particle system in MonoGame that can be used in your own games.</p>
<p>This approach is based on one that appeared in the original XNA samples, but has been modified for ease of use.  You can see the original source updated for MonoGame on GithHub at <a href="https://github.com/CartBlanche/MonoGame-Samples/tree/master/ParticleSample" rel="external" target="_blank">https://github.com/CartBlanche/MonoGame-Samples/tree/master/ParticleSample</a></p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="the-particle">The Particle</h1>

<p>At the heart of a particle system is a collection of particles - tiny sprites that move independently of one another, but when rendered together, create the interesting effects we are after.  To draw each individual particle, we need to know where on the screen it should appear, as well as the texture we should be rendering, and any color effects we might want to apply.  Moreover, each frame our particles will be moving, so we&rsquo;ll also want to be able to track information to make that process easier, like velocity, acceleration, and how long a particle has been &ldquo;alive&rdquo;.</p>
<p>With thousands of particles in a system, it behooves us to think on efficiency as we write this representation.  The <a href="https://gameprogrammingpatterns.com/flyweight.html" rel="external" target="_blank">flyweight pattern</a> is a great fit here - each particle in the system can be implemented as a flyweight.  This means that we only store the information that is <em>specific to that particle</em>.  Any information shared by <em>all</em> particles will instead be stored in the <code>ParticleSystem</code> class, which we&rsquo;ll define separately.</p>
<p>We&rsquo;ll start with a fairly generic properties that are used by most particle systems:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A class representing a single particle in a particle system </span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Particle</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current position of the particle. Default (0,0).</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current velocity of the particle. Default (0,0).</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current acceleration of the particle. Default (0,0).</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Acceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current rotation of the particle. Default 0.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">Rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current angular velocity of the particle. Default 0.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">AngularVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current angular acceleration of the particle. Default 0.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">AngularAcceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current scale of the particle.  Default 1.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">Scale</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current lifetime of the particle (how long it will &#34;live&#34;).  Default 1s.</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">Lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// How long this particle has been alive </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">float</span> <span class="n">TimeSinceStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// The current color of the particle. Default White</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Color</span> <span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// If this particle is still alive, and should be rendered</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">bool</span> <span class="n">Active</span> <span class="p">=&gt;</span> <span class="n">TimeSinceStart</span> <span class="p">&lt;</span> <span class="n">Lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Here we&rsquo;ve created fields to hold all information unique to the particle, both for updating and drawing it.  Feel free to add or remove fields specific to your needs; this sampling represents only some of the most commonly used options.  Note that we don&rsquo;t define a texture here - all the particles in a particle system typically share a single texture (per the flyweight pattern), and that texture is maintained by the particle system itself.</p>
<p>We should also write an initialize function to initialize the values of a newly minted particle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Sets the particle up for first use, restoring defaults</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="k">where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularAcceleration</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>We can also provide some overloads of this method to allow us to specify additional parameters (avoiding setting them twice - once to the default value and once to the expected value).  An easy way to keep these under control is to provide <em>default</em> values.  Unfortunately, we can only do this for values that can be determined at compile time (i.e. primitives), so the vectors cannot have a default value.  Thus, we would need at least three overloads:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Sets the particle up for first use </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">position</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">velocity</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lifetime</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">scale</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularVelocity</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularAcceleration</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="n">lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="n">scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">=</span> <span class="n">rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">=</span> <span class="n">angularVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularAcceleration</span> <span class="p">=</span> <span class="n">angularAcceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Sets the particle up for first use </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">position</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">acceleration</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lifetime</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">scale</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularVelocity</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularAcceleration</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">=</span> <span class="n">acceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="n">lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="n">scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">=</span> <span class="n">rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">=</span> <span class="n">angularVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularAcceleration</span> <span class="p">=</span> <span class="n">angularAcceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Sets the particle up for first use </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">position</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">acceleration</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lifetime</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">scale</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularVelocity</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angularAcceleration</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">=</span> <span class="n">acceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="n">lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="n">scale</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">=</span> <span class="n">rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">=</span> <span class="n">angularVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">AngularAcceleration</span> <span class="p">=</span> <span class="n">angularAcceleration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>You might wonder why we don&rsquo;t use a constructor for this initialization.  The answer is because we&rsquo;ll want to reuse the same <code>Particle</code> instance multiple times - we&rsquo;ll see this soon, in the particle system.  We&rsquo;ll turn our attention to that next.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="the-particle-system-class">The Particle System Class</h1>

<p>The next part of the particle system is the class representing the particle system itself.  Like any other sprite-based strategy, this will involve both an <code>Update()</code> and <code>Draw()</code> method that must be invoked every time through the game loop.  But ideally we&rsquo;d like our particle systems to be an almost hands-off system - once it&rsquo;s created, we can just let it do its thing without intervention.  This is where the idea of game components from our <a href="/cis580/09-particle-systems/03-particle-system-class/">architecture discussion</a> can come into play - our particle system can inherit from the  <code>DrawableGameComponent</code> class, which means it can be added to to our <code>Game.Components</code> list and the <code>Game</code> will handle invoking those methods for us every frame:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A class representing a generic particle system</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ParticleSystem</span> <span class="p">:</span> <span class="n">DrawableGameComponent</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Add fields, properties, and methods</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Now we want to add generic functionality for a particle system, and in doing so, we want to make sure the system is as efficient as possible - remember, we may be updating and rendering <em>thousands</em> of sprites for each active particle system.  We&rsquo;ll keep this in mind throughout the design process.  Let&rsquo;s start by defining some fields that determine the behavior of the particle system.  As we do this, we&rsquo;ll stretch our use of the C# programming language in ways you may have not done so previously.</p>
<h3 id="constants">Constants</h3>
<p>We&rsquo;ll start by defining a couple of constants, <code>AlphaBlendDrawOrder</code> and <code>AdditiveBlendDrawOrder</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The draw order for particles using Alpha Blending</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;remarks&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Particles drawn using additive blending should be drawn on top of </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// particles that use regular alpha blending</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/remarks&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">const</span> <span class="kt">int</span> <span class="n">AlphaBlendDrawOrder</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The draw order for particles using Additive Blending</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;remarks&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Particles drawn using additive blending should be drawn on top of </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// particles that use regular alpha blending</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/remarks&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">const</span> <span class="kt">int</span> <span class="n">AdditiveBlendDrawOrder</span> <span class="p">=</span> <span class="m">200</span><span class="p">;</span></span></span></code></pre></div><p>Remember that the <code>DrawOrder</code> property of a <code>DrawableGameComponent</code> determines the order in which they are drawn.  These constants represent values we can reference when setting that draw order, based on what kind of alpha blending we are using.</p>
<h3 id="static-fields">Static Fields</h3>
<p>To use our particle systems, we&rsquo;ll need both a <code>ContentManager</code> and <code>SpriteBatch</code> instance.  We could create one for each particle system, but that creates a lot of unnecessary objects.  Alternatively, we could share the ones created in our <code>Game</code> class, which would be the most efficient approach.  However, that does mean those need to be made public, and we need to pass the derived class into this one.  As a comfortable middle ground, we&rsquo;ll create protected static fields for these, so that all particle systems share a single set:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// A SpriteBatch to share amongst the various particle systems</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">static</span> <span class="n">SpriteBatch</span> <span class="n">spriteBatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// A ContentManager to share amongst the various particle systems</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">static</span> <span class="n">ContentManager</span> <span class="n">contentManager</span><span class="p">;</span></span></span></code></pre></div><h3 id="private-fields">Private Fields</h3>
<p>This class needs to hold our collection of particles, and in keeping with the <a href="https://gameprogrammingpatterns.com/data-locality.html" rel="external" target="_blank">data locality pattern</a>, we&rsquo;d like these to be stored sequentially.  An array is therefore a great fit.  Add it as a private field to the class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The collection of particles </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Particle</span><span class="p">[]</span> <span class="n">particles</span><span class="p">;</span></span></span></code></pre></div><p>We&rsquo;ll also use a <code>Queue</code> (from <code>System.Collections.Generic</code>) to hold references to unused particles.  This way we can avoid re-creating particles and creating a glut in memory that will result in the garbage collector running often.  We could store a reference directly to the particle location, or an index indicating its position in the array.  We&rsquo;ll opt for the former here, as it provides some benefits in usage:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// A Queue containing indices of unused particles in the Particles array</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Queue</span><span class="p">&lt;</span><span class="n">Particle</span><span class="p">&gt;</span> <span class="n">freeParticles</span><span class="p">;</span></span></span></code></pre></div><p>As we said in the discussion of the <code>Particle</code> class, in using the <a href="https://gameprogrammingpatterns.com/flyweight.html" rel="external" target="_blank">Flyweight Pattern</a> the actual texture will be held by our <code>ParticleSystem</code>, so let&rsquo;s add a private variable to hold that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The texture this particle system uses </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Texture2D</span> <span class="n">texture</span><span class="p">;</span></span></span></code></pre></div><p>We&rsquo;ll also keep track of an origin vector for when we draw the textures:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The origin when we&#39;re drawing textures </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector2</span> <span class="n">origin</span><span class="p">;</span></span></span></code></pre></div><h3 id="public-fields">Public Fields</h3>
<p>It can also be useful to know how many particles are currently available (free) in the system.  We can expose this value with a public property:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The available particles in the system </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">FreeParticleCount</span> <span class="p">=&gt;</span> <span class="n">freeParticles</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span></span></span></code></pre></div><h3 id="protected-fields">Protected Fields</h3>
<p>A slightly unique approach we&rsquo;ll adopt here is defining a number of <code>protected</code> fields that essentially define the behavior of the particle system.  These represent the information that is shared amongst all particles in the system.  We make them protected so that derived particle systems can adjust them to suit the needs of the effect we are trying to create.  For example the <code>blendState</code> determines how a texture is drawn, and the <code>textureFilename</code> helps define which texture to use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;The BlendState to use with this particle system&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">BlendState</span> <span class="n">blendState</span> <span class="p">=</span> <span class="n">BlendState</span><span class="p">.</span><span class="n">AlphaBlend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;The filename of the texture to use for the particles&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">string</span> <span class="n">textureFilename</span><span class="p">;</span></span></span></code></pre></div><p>We&rsquo;ll also use a min/max pair to determine the number of particles to activate in the system each time we add particles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;The minimum number of particles to add when AddParticles() is called&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">minNumParticles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;The maximum number of particles to add when AddParticles() is called&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">int</span> <span class="n">maxNumParticles</span><span class="p">;</span></span></span></code></pre></div><p>Like the <code>Particle</code> class&rsquo; fields, these too could be tweaked to meet the needs of your game.</p>
<h3 id="constructor">Constructor</h3>
<p>As the <code>DrawableGameComponent</code> has a constructor requiring a <code>Game</code> instance, we must provide our own constructor that passes that along by invoking <code>base()</code> (which runs the constructor of the base object).  We&rsquo;ll also want to initialize our <code>particles</code> array and <code>freeParticles</code> queue, which means we need to know the maximum number of particles we&rsquo;ll allow in this particle system.  Therefore, we&rsquo;ll add that as a second parameter.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Constructs a new instance of a particle system</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ParticleSystem</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxParticles</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">game</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Create our particles</span>
</span></span><span class="line"><span class="cl">        <span class="n">particles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Particle</span><span class="p">[</span><span class="n">maxParticles</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">particles</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Particle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add all free particles to the queue</span>
</span></span><span class="line"><span class="cl">        <span class="n">freeParticles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">Particle</span><span class="p">&gt;(</span><span class="n">particles</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Run the InitializeConstants hook</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitializeConstants</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Since none of the particles are in use, we&rsquo;ll also initialize our Queue with <em>all</em> the newly created particles.  This has the helpful side effect of allocating enough memory to hold a reference to each particle in our array, ensuring we never need to re-allocate.</p>
<p>Finally, we invoke <code>InitializeConstants()</code>, a protected method that is intended to be used as a <em>hook</em> - a method that can be overridden to inject your own functionality into the class.  Let&rsquo;s look at this, and the other hook methods next</p>
<h3 id="virtual-hook-methods">Virtual Hook Methods</h3>
<p>Now that we have the structure of the class put together, let&rsquo;s start thinking about the functionality.  We&rsquo;ll write a couple of <code>virtual</code> hook methods to define the default behavior we expect from our particles - most notably setting those protected constant values, <em>initializing</em> new active particles to the particle system, and then <em>updating</em> those particles each frame.  We&rsquo;ll make these methods virtual so we can override them in derived classes, but also provide a base implementation when one makes sense.  Let&rsquo;s start with <code>InitializeConstants()</code> we invoked above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Used to do the initial configuration of the particle engine.  The </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// protected constants `textureFilename`, `minNumParticles`, and `maxNumParticles`</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// should be set in the override.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">InitializeConstants</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span></span></span></code></pre></div><p>If the <code>textureFilename</code> is not set here, we&rsquo;ll encounter a runtime error, so this <em>must</em> be overridden in the derived classes. As a possible way to emphasize this, we could instead declare this method, and the <code>ParticleSystem</code> class as <code>abstract</code>.</p>
<p>In contrast, the <code>InitializeParticle()</code> hook method will provide some logic that could potentially be used, but will also probably be overridden in most cases:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// InitializeParticle randomizes some properties for a particle, then</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// calls initialize on it. It can be overridden by subclasses if they </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// want to modify the way particles are created.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p&#34;&gt;the particle to initialize&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;the position on the screen that the particle should be</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">p</span><span class="p">,</span> <span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Initialize the particle with default values</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Similarly, we will supply a default implementation for <em>updating</em> a particle.  Our default approach is based on Newtonian physics:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Updates the individual particles.  Can be overridden in derived classes</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;particle&#34;&gt;The particle to update&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;dt&#34;&gt;The elapsed time&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="n">UpdateParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">particle</span><span class="p">,</span> <span class="kt">float</span> <span class="n">dt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Update particle&#39;s linear motion values</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">+=</span> <span class="n">particle</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">*</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">Position</span> <span class="p">+=</span> <span class="n">particle</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">*</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Update the particle&#39;s angular motion values</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">+=</span> <span class="n">particle</span><span class="p">.</span><span class="n">AngularAcceleration</span> <span class="p">*</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">+=</span> <span class="n">particle</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">*</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Update the time the particle has been alive </span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">+=</span> <span class="n">dt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>This implementation works for a wide variety of particle systems, but it can be overridden by a derived particle system if something different is needed.</p>
<h3 id="drawablegamecomponent-overrides">DrawableGameComponent Overrides</h3>
<p>Now we can tackle the methods from <code>DrawableGameComponent</code>, which we&rsquo;ll need to replace with our own custom overrides.  First, we&rsquo;ll load the texture in our <code>LoadContent</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Override the base class LoadContent to load the texture. once it&#39;s</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// loaded, calculate the origin.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;throws&gt;A InvalidOperationException if the texture filename is not provided&lt;/throws&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">LoadContent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// create the shared static ContentManager and SpriteBatch,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if this hasn&#39;t already been done by another particle engine</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">contentManager</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">contentManager</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContentManager</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">Services</span><span class="p">,</span> <span class="s">&#34;Content&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">spriteBatch</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="n">spriteBatch</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SpriteBatch</span><span class="p">(</span><span class="n">Game</span><span class="p">.</span><span class="n">GraphicsDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// make sure sub classes properly set textureFilename.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">textureFilename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="s">&#34;textureFilename wasn&#39;t set properly, so the &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;particle system doesn&#39;t know what texture to load. Make &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;sure your particle system&#39;s InitializeConstants function &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;properly sets textureFilename.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// load the texture....</span>
</span></span><span class="line"><span class="cl">        <span class="n">texture</span> <span class="p">=</span> <span class="n">contentManager</span><span class="p">.</span><span class="n">Load</span><span class="p">&lt;</span><span class="n">Texture2D</span><span class="p">&gt;(</span><span class="n">textureFilename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ... and calculate the center. this&#39;ll be used in the draw call, we</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// always want to rotate and scale around this point.</span>
</span></span><span class="line"><span class="cl">        <span class="n">origin</span><span class="p">.</span><span class="n">X</span> <span class="p">=</span> <span class="n">texture</span><span class="p">.</span><span class="n">Width</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">origin</span><span class="p">.</span><span class="n">Y</span> <span class="p">=</span> <span class="n">texture</span><span class="p">.</span><span class="n">Height</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">LoadContent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>In addition to loading the texture, we make sure that our shared <code>ContentManager</code> and <code>SpriteBatch</code> are created, and calculate the <code>Origin</code> for the texture.</p>
<p>Our <code>Update()</code> method iterates over the particles and updates each one, invoking our <code>UpdateParticle()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Overriden from DrawableGameComponent, Update will update all of the active</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// particles.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// calculate dt, the change in the since the last frame. the particle</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// updates will use this value.</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">dt</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">gameTime</span><span class="p">.</span><span class="n">ElapsedGameTime</span><span class="p">.</span><span class="n">TotalSeconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// go through all of the particles...</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="n">Particle</span> <span class="n">p</span> <span class="k">in</span> <span class="n">particles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ... and if they&#39;re active, update them.</span>
</span></span><span class="line"><span class="cl">                <span class="n">UpdateParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// if that update finishes them, put them onto the free particles</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// queue.</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(!</span><span class="n">p</span><span class="p">.</span><span class="n">Active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">freeParticles</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Notice that we only update the <em>active</em> particles.  And if a particle is no longer active after we update it, we add it to the <code>freeParticles</code> queue to be reused.</p>
<p>Similarly, our <code>Draw()</code> method draws only the active particles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Overriden from DrawableGameComponent, Draw will use the static </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// SpriteBatch to render all of the active particles.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Draw</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// tell sprite batch to begin, using the BlendState specified in</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// initializeConstants</span>
</span></span><span class="line"><span class="cl">        <span class="n">spriteBatch</span><span class="p">.</span><span class="n">Begin</span><span class="p">(</span><span class="n">blendState</span><span class="p">:</span> <span class="n">blendState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="n">Particle</span> <span class="n">p</span> <span class="k">in</span> <span class="n">particles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// skip inactive particles</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">p</span><span class="p">.</span><span class="n">Active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">spriteBatch</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Position</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Color</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="p">.</span><span class="n">Rotation</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">SpriteEffects</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">spriteBatch</span><span class="p">.</span><span class="n">End</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Note that we provide a <code>SpriteBlendState</code> to the <code>SpriteBatch.Begin()</code> call, as different blend states can replicate different effects.  We&rsquo;ll see this in play soon.</p>
<h3 id="methods-for-adding-particles-to-the-system">Methods for Adding Particles to the System</h3>
<p>Finally, we need some methods to add active particles into our system (otherwise, nothing will ever be drawn)!  We&rsquo;ll create two generic protected methods for doing this, which can be utilized by the derived particle system classes.  We&rsquo;ll start with one that adds particles at a specific position (defined by a <code>Vector2</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// AddParticles&#39;s job is to add an effect somewhere on the screen. If there </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// aren&#39;t enough particles in the freeParticles queue, it will use as many as </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// it can. This means that if there not enough particles available, calling</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// AddParticles will have no effect.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;where the particle effect should be created&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">void</span> <span class="n">AddParticles</span><span class="p">(</span><span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// the number of particles we want for this effect is a random number</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// somewhere between the two constants specified by the subclasses.</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">numParticles</span> <span class="p">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">RandomHelper</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="n">minNumParticles</span><span class="p">,</span> <span class="n">maxNumParticles</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// create that many particles, if you can.</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numParticles</span> <span class="p">&amp;&amp;</span> <span class="n">freeParticles</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// grab a particle from the freeParticles queue, and Initialize it.</span>
</span></span><span class="line"><span class="cl">            <span class="n">Particle</span> <span class="n">p</span> <span class="p">=</span> <span class="n">freeParticles</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>This approach is especially useful for effects like explosions, which start with a bunch of particles, but don&rsquo;t create more.</p>
<p>We may instead want to supply a region of screen space (say, a rectangle) to fill with particles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// AddParticles&#39;s job is to add an effect somewhere on the screen. If there </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// aren&#39;t enough particles in the freeParticles queue, it will use as many as </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// it can. This means that if there not enough particles available, calling</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// AddParticles will have no effect.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;where the particle effect should be created&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">void</span> <span class="n">AddParticles</span><span class="p">(</span><span class="n">Rectangle</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// the number of particles we want for this effect is a random number</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// somewhere between the two constants specified by the subclasses.</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">numParticles</span> <span class="p">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">RandomHelper</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="n">minNumParticles</span><span class="p">,</span> <span class="n">maxNumParticles</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// create that many particles, if you can.</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numParticles</span> <span class="p">&amp;&amp;</span> <span class="n">freeParticles</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// grab a particle from the freeParticles queue, and Initialize it.</span>
</span></span><span class="line"><span class="cl">            <span class="n">Particle</span> <span class="n">p</span> <span class="p">=</span> <span class="n">freeParticles</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">RandomPosition</span><span class="p">(</span><span class="k">where</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>This works well for something like rain and snow - we can add it just off-screen (say above the top of the screen) and let it flow over the screen based on its direction and speed.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="example-particle-systems">Example Particle Systems</h1>

<p>To create a particle system, we&rsquo;ll derive a class from the <code>ParticleSystem</code> class and override its <code>InitializeConstants()</code>, and possibly its <code>InitializeParticle()</code> and <code>UpdateParticle()</code> methods.  Let&rsquo;s look at some examples:</p>
<h3 id="rain-particle-system">Rain Particle System</h3>
<p>This is a simplistic implementation of rain that is spawned in a predefined rectangle and falls to the bottom of the screen.  The texture we&rsquo;ll use is <a href="/cis580/images/drop.png">this drop</a></p>
<p>We start by defining a class extending the <code>ParticleSystem</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A class embodying a particle system emulating rain</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">RainParticleSystem</span> <span class="p">:</span> <span class="n">ParticleSystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Add Implementation</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Inside this class, we&rsquo;ll define a private <code>Rectangle</code> field to represent where the rain begins:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The source of the rain</span>
</span></span><span class="line"><span class="cl">    <span class="n">Rectangle</span> <span class="n">_source</span><span class="p">;</span></span></span></code></pre></div><p>And a boolean property to start and stop the rain:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Determines if it is currently raining or not</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">bool</span> <span class="n">IsRaining</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span></span></span></code></pre></div><p>We&rsquo;ll add a constructor that must also invoke the <code>ParticleSystem</code> constructor.  We&rsquo;ll supply the <code>Rectangle</code> to use for the source, and hard-code a maximum amount of particles (this may need to be tweaked for larger/smaller rain effects - if there aren&rsquo;t enough particles there will be gaps in the rain):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Constructs the rain particle system</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;The game this particle system belongs to&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;source&#34;&gt;A rectangle defining where the raindrops start&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RainParticleSystem</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">,</span> <span class="n">Rectangle</span> <span class="n">source</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="m">5000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_source</span> <span class="p">=</span> <span class="n">source</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>We override the <code>InitializeConstants()</code> to set the number of particles that should be spawned with an <code>AddParticles()</code> method call, and the name of the texture to use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Initialize the particle system constants</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeConstants</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;ll use a raindrop texture</span>
</span></span><span class="line"><span class="cl">        <span class="n">textureFilename</span> <span class="p">=</span> <span class="s">&#34;opaque-drop&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;ll spawn a large number of particles each frame </span>
</span></span><span class="line"><span class="cl">        <span class="n">minNumParticles</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxNumParticles</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Then we override the <code>InitializeParticle()</code> method of the base <code>ParticleSystem</code> to provide custom behavior for our rain particles.  Basically, they just fall straight down.  However, you could expand on this to add wind, etc.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Initializes individual particles</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;Where the particle appears&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">p</span><span class="p">,</span> <span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">InitializeParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// rain particles fall downward at the same speed</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">UnitY</span> <span class="p">*</span> <span class="m">260</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// rain particles have already hit terminal velocity,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// and do not spin, so we don&#39;t need to set the other</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// physics values (they default to 0)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// we&#39;ll use blue for the rain </span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// rain particles are small</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// rain particles need to reach the bottom of the screen</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// it takes about 3 seconds at current velocity/screen size</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Finally, we&rsquo;ll override the <code>Update()</code> method from <code>DrawableGameComponent</code> to add spawning new droplets every frame within our source rectangle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Override the default DrawableGameComponent.Update method to add </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// new particles every frame.  </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing the game time&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Spawn new rain particles every frame</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">IsRaining</span><span class="p">)</span> <span class="n">AddParticles</span><span class="p">(</span><span class="n">_source</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h3 id="explosion-particle-system">Explosion Particle System</h3>
<p>Another particle effect we see often in games is explosions.  Let&rsquo;s create an effect that will let us create explosions at specific points on-screen as our game is running.  We&rsquo;ll use <a href="/cis580/images/explosion.png">this explosion texture</a>.</p>
<p>We again start by defining a new class derived from <code>ParticleSystem</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A GameComponent providing a particle system to render explosions in a game</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ExplosionParticleSystem</span> <span class="p">:</span> <span class="n">ParticleSystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Add implementation</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Our constructor will invoke the base <code>ParticleSystem</code> constructor, but we&rsquo;ll also ask for the maximum number of anticipated explosions the system needs to handle.  As each explosion needs 20-25 particles, we&rsquo;ll multiply that value by 25 to determine how many particles the system needs to have:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Constructs a new explosion particle system</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;The game to render explosions in&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;maxExplosions&#34;&gt;The anticipated maximum number of explosions on-screen at one time&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ExplosionParticleSystem</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxExplosions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">maxExplosions</span> <span class="p">*</span> <span class="m">25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>The explosion will use an explosion texture, 20-25 particles per explosion, and <em>additive blending</em>.  This blend mode means if two particles overlap, their colors are added together.  As more particle combine, the combined color gets closer to white, meaning the center of the explosion will be bright white, but as the particles spread out they will get redder (as the texture is red and yellow).  We&rsquo;ll set these up by overriding the <code>ParticleSystem.InitializeConstants()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Set up the constants that will give this particle system its behavior and</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// properties.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeConstants</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">textureFilename</span> <span class="p">=</span> <span class="s">&#34;explosion&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;ll use a handful of particles for each explosion</span>
</span></span><span class="line"><span class="cl">        <span class="n">minNumParticles</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxNumParticles</span> <span class="p">=</span> <span class="m">25</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Additive blending is very good at creating fiery effects.</span>
</span></span><span class="line"><span class="cl">        <span class="n">blendState</span> <span class="p">=</span> <span class="n">BlendState</span><span class="p">.</span><span class="n">Additive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DrawOrder</span> <span class="p">=</span> <span class="n">AdditiveBlendDrawOrder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>We&rsquo;ll also override <code>ParticleSystem.InitializeParticle()</code> to provide the default starting state for all particles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Initializes the particle &lt;paramref name=&#34;p&#34;/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;Where the particle begins its life&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">p</span><span class="p">,</span> <span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">InitializeParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Explosion particles move outward from the point of origin in all directions,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// at varying speeds</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">RandomDirection</span><span class="p">()</span> <span class="p">*</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">NextFloat</span><span class="p">(</span><span class="m">40</span><span class="p">,</span> <span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Explosions should be relatively short lived</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">NextFloat</span><span class="p">(</span><span class="m">0.5f</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Explosion particles spin at different speeds</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">AngularVelocity</span> <span class="p">=</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">NextFloat</span><span class="p">(-</span><span class="n">MathHelper</span><span class="p">.</span><span class="n">PiOver4</span><span class="p">,</span> <span class="n">MathHelper</span><span class="p">.</span><span class="n">PiOver4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Explosions move outwards, then slow down and stop because of air resistance.</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Let&#39;s set acceleration so that when the particle is at max lifetime, the velocity</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// will be zero.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;ll use the equation vt = v0 + (a0 * t). (If you&#39;re not familiar with</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// this, it&#39;s one of the basic kinematics equations for constant</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// acceleration, and basically says:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// velocity at time t = initial velocity + acceleration * t)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;ll solve the equation for a0, using t = p.Lifetime and vt = 0.</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Acceleration</span> <span class="p">=</span> <span class="p">-</span><span class="n">p</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">/</span> <span class="n">p</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>And we&rsquo;ll also override the <code>ParticleSystem.Update()</code> method, so we can use custom logic to change the color and scale of the particle over its lifetime:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// We override the UpdateParticle() method to scale and colorize </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// explosion particles over time</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;particle&#34;&gt;the particle to update&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;dt&#34;&gt;the time elapsed between frames&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">UpdateParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">particle</span><span class="p">,</span> <span class="kt">float</span> <span class="n">dt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">UpdateParticle</span><span class="p">(</span><span class="n">particle</span><span class="p">,</span> <span class="n">dt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// normalized lifetime is a value from 0 to 1 and represents how far</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// a particle is through its life. 0 means it just started, .5 is half</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// way through, and 1.0 means it&#39;s just about to be finished.</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// this value will be used to calculate alpha and scale, to avoid </span>
</span></span><span class="line"><span class="cl">        <span class="c1">// having particles suddenly appear or disappear.</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">normalizedLifetime</span> <span class="p">=</span> <span class="n">particle</span><span class="p">.</span><span class="n">TimeSinceStart</span> <span class="p">/</span> <span class="n">particle</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// we want particles to fade in and fade out, so we&#39;ll calculate alpha</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// to be (normalizedLifetime) * (1-normalizedLifetime). this way, when</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// normalizedLifetime is 0 or 1, alpha is 0. the maximum value is at</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// normalizedLifetime = .5, and is</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// (normalizedLifetime) * (1-normalizedLifetime)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// (.5)                 * (1-.5)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// .25</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// since we want the maximum alpha to be 1, not .25, we&#39;ll scale the </span>
</span></span><span class="line"><span class="cl">        <span class="c1">// entire equation by 4.</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">alpha</span> <span class="p">=</span> <span class="m">4</span> <span class="p">*</span> <span class="n">normalizedLifetime</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">normalizedLifetime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">Color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span> <span class="p">*</span> <span class="n">alpha</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// make particles grow as they age. they&#39;ll start at 75% of their size,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// and increase to 100% once they&#39;re finished.</span>
</span></span><span class="line"><span class="cl">        <span class="n">particle</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="n">particle</span><span class="p">.</span><span class="n">Scale</span> <span class="p">*</span> <span class="p">(.</span><span class="m">75f</span> <span class="p">+</span> <span class="p">.</span><span class="m">25f</span> <span class="p">*</span> <span class="n">normalizedLifetime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>And finally, we need to allow the game to place explosion effects, so we&rsquo;ll add a public method to do so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Places an explosion at location &lt;paramref name=&#34;where&#34;/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;The location of the explosion&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">PlaceExplosion</span><span class="p">(</span><span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">AddParticles</span><span class="p">(</span><span class="k">where</span><span class="p">);</span></span></span></code></pre></div><h3 id="pixieparticlesystem">PixieParticleSystem</h3>
<p>Another common use for particle systems is to have them <em>emitted</em> from an object in the game - i.e. the player, an enemy, or something the player can interact with.  Let&rsquo;s explore this idea by making a particle system that emits colored sparks that fall to the ground, like pixie dust.  For this particle system, we&rsquo;ll use <a href="/cis580/images/particle.png">this particle texture with a circular gradient</a>.</p>
<p>Let&rsquo;s start by defining an interface that can serve as our emitter representation.  With an emitter, the particle starts in the same place as the emitter, so need to know its location in the game world, so a <code>Vector2</code> we&rsquo;ll name <code>Position</code>.  Also, if the emitter is moving, we need to know the velocity it is moving at, as the particle will also start with that as its initial velocity, so we&rsquo;ll add a second <code>Vector2</code> named <code>Velocity</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// An interface for the emitter of a particle system</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">interface</span> <span class="nc">IParticleEmitter</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The position of the emitter in the world</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Position</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The velocity of the emitter in the world</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Velocity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Then we start the particle system the same way as before, by defining a class that inherits from <code>ParticleSystem</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A particle system that drops &#34;pixie dust&#34; from an emitter</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">PixieParticleSystem</span> <span class="p">:</span> <span class="n">ParticleSystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: Add implementation</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>We&rsquo;ll want a list of emitters of our <code>IParticleEmitter</code> class so we know where to spawn those particles (this way we can have multiple pixies!):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The emitter for this particle system</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IParticleEmitter</span><span class="p">&gt;</span> <span class="n">Emitters</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IParticleEmitter</span><span class="p">&gt;();</span></span></span></code></pre></div><p>And we&rsquo;ll construct our particle system with an expected number of pixies to support (with each using around 200 particles):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Constructs a new PixieParticleSystem to support up to &lt;paramref name=&#34;maxPixies&#34;/&gt; pixies</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;The game this system belongs to&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;maxPixies&#34;&gt;The maximum number of pixies to support&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">PixieParticleSystem</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxPixies</span><span class="p">):</span> <span class="k">base</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="m">200</span> <span class="p">*</span> <span class="n">maxPixies</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span></span></span></code></pre></div><p>We override <code>ParticleSystem.InitializeConstants()</code> to set up the particle system values:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Set up the constants that will give this particle system its behavior and</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// properties.</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeConstants</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">textureFilename</span> <span class="p">=</span> <span class="s">&#34;particle&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">minNumParticles</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxNumParticles</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">blendState</span> <span class="p">=</span> <span class="n">BlendState</span><span class="p">.</span><span class="n">Additive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DrawOrder</span> <span class="p">=</span> <span class="n">AdditiveBlendDrawOrder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>And <code>ParticleSystem.InitializeParticle()</code> to initialize individual particles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Initialize the particles</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;where&#34;&gt;Where the particle initially appears&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">InitializeParticle</span><span class="p">(</span><span class="n">Particle</span> <span class="n">p</span><span class="p">,</span> <span class="n">Vector2</span> <span class="k">where</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">InitializeParticle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The particle&#39;s initial velocity is the same as the emitter&#39;s</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Velocity</span> <span class="p">=</span> <span class="n">_emitter</span><span class="p">.</span><span class="n">Velocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The particle is affected by gravity</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Acceleration</span><span class="p">.</span><span class="n">Y</span> <span class="p">=</span> <span class="m">400</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Randomize the particle size</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">NextFloat</span><span class="p">(</span><span class="m">0.1f</span><span class="p">,</span> <span class="m">0.5f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Randomize the lifetime of the particles</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Lifetime</span> <span class="p">=</span> <span class="n">RandomHelper</span><span class="p">.</span><span class="n">NextFloat</span><span class="p">(</span><span class="m">0.1f</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// The particle also is affected by air resistance;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// lets&#39; scale its X acceleration so it stops moving horizontally by the time it dies</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">Acceleration</span><span class="p">.</span><span class="n">X</span> <span class="p">=</span> <span class="p">-</span><span class="n">p</span><span class="p">.</span><span class="n">Velocity</span><span class="p">.</span><span class="n">X</span> <span class="p">/</span> <span class="n">p</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Since we&rsquo;ll just use the build-in physics, we don&rsquo;t need to override <code>ParticleSystem.UpdateParticle()</code>.  But we will need to add new particles every frame, so we&rsquo;ll override <code>GameComponent.Update()</code> to do so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Override Update() to add some particles each frame</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing game time&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">base</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Add particles at the emitter position</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddParticles</span><span class="p">(</span><span class="n">_emitter</span><span class="p">.</span><span class="n">Position</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>This particle system can now be attached to any object implementing the <code>IParticleEmitter</code> interface, and the particles will be spawned wherever that emitter is in the game world!</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="using-particle-systems">Using Particle Systems</h1>

<p>Now that we&rsquo;ve defined some example particle systems, let&rsquo;s see how we can put them into use.</p>
<h3 id="adding-rain">Adding Rain</h3>
<p>Let&rsquo;s start with our <code>RainParticleSystem</code>, and add rain that runs down the screen.  Since we don&rsquo;t need to start/stop the rain for this simple example, all we need to do is construct the particle system and add it to the <code>Game.Components</code> list in the <code>Game.Initialize()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">RainParticleSystem</span> <span class="n">rain</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RainParticleSystem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">Rectangle</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="p">-</span><span class="m">10</span><span class="p">,</span> <span class="m">500</span><span class="p">,</span> <span class="m">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Components</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rain</span><span class="p">);</span></span></span></code></pre></div>
  
  
<div class="box notices cstyle hint">
  <div class="box-label"></div>
  <div class="box-content">

<p>Because the <code>ExplosionParticleSystem</code> inherits from <code>DrawableGameComponent</code>, we can add it to the <code>Game.Components</code> list.  This means the game will automatically call its <code>LoadContent()</code>, <code>Update()</code> and <code>Draw()</code> methods for us.  We could instead not add it to the components list, and manually invoke these ourselves.</p>
</div>
</div>
<h3 id="adding-explosions">Adding Explosions</h3>
<p>Let&rsquo;s say we want an explosion to appear on-screen wherever we click our mouse.  We&rsquo;ll use the <code>ExplosionParticleSystem</code> from the previous section to accomplish this.</p>
<p>First, because we will need to access this system in multiple methods of <code>Game</code> we&rsquo;ll need to create a field to represent it in our <code>Game</code> class.  We&rsquo;ll also want to keep track of the previous mouse state:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">ExplosionParticleSystem</span> <span class="n">explosions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MouseState</span> <span class="n">oldMouseState</span><span class="p">;</span></span></span></code></pre></div><p>And initialize it in our <code>Game.Initialize()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">explosions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExplosionParticleSystem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="m">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Components</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">explosions</span><span class="p">);</span></span></span></code></pre></div><p>We set the particle system to use up to 20 explosions on-screen at a time (as it takes about a second for an explosion to finish, this is probably more than enough, unless we have a very explosive game).</p>
<p>Next, we add some logic to our <code>Update()</code> method to update the mouse state, and determine if we need to place an explosion:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">MouseState</span> <span class="n">newMouseState</span> <span class="p">=</span> <span class="n">Mouse</span><span class="p">.</span><span class="n">GetState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector2</span> <span class="n">mousePosition</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">mouseState</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">mouseState</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">newMouseState</span><span class="p">.</span><span class="n">Left</span> <span class="p">==</span> <span class="n">ButtonState</span><span class="p">.</span><span class="n">Down</span> <span class="p">&amp;&amp;</span> <span class="n">oldMouseState</span><span class="p">.</span><span class="n">Left</span> <span class="p">==</span> <span class="n">ButtonState</span><span class="p">.</span><span class="n">Up</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">explosions</span><span class="p">.</span><span class="n">PlaceExplosion</span><span class="p">(</span><span class="n">mousePosition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Now, whenever we click our mouse, we&rsquo;ll see an explosion spawn!</p>
<h3 id="adding-a-pixie">Adding a Pixie</h3>
<p>Rather than declare a class to represent the mouse and go through that effort, let&rsquo;s just implement the <code>IParticleEmitter</code> interface directly on our <code>Game</code>.  Thus, we need to implement <code>Position</code> and <code>Velocity</code> properties:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Position</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector2</span> <span class="n">Velocity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></span></span></code></pre></div><p>We&rsquo;ll set these in the <code>Game.Update()</code> method, based on our mouse state:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">Velocity</span> <span class="p">=</span> <span class="n">mousePosition</span> <span class="p">-</span> <span class="n">Position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Position</span> <span class="p">=</span> <span class="n">mousePosition</span><span class="p">;</span></span></span></code></pre></div><p>And we&rsquo;ll need to add the particle system in the <code>Game.Initialize()</code> method, and set its emitter to the <code>Game</code> instance:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">PixieParticleSystem</span> <span class="n">pixie</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PixieParticleSystem</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Components</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pixie</span><span class="p">);</span></span></span></code></pre></div><p>Now the mouse should start dripping a trail of sparks!</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="refactoring-as-a-game-component">Refactoring as a Game Component</h1>

<p>In this chapter we examined the idea of particle systems, which draw a large number of sprites to create visual effects within the game.  We also went over the design of such a system we can use with MonoGame, leveraging the <code>DrawableGameComponent</code> base class and design approaches like hook methods, to make a relatively hands-off but flexible approach to create new custom particle systems.  We also created three example particle systems to emulate rain, explosions, and a trail of sparks.  You can use these as a starting point for creating your own custom particle systems to meet the needs of your games.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

          </section>
        </div>
      </main>
    
<div class="git-footer">
  <p class="theme-version-footer">6.0.0</p>
  <p>Last modified by: 
              <i class='fas fa-user'></i> Russell Feldhausen
              <i class='fas fa-calendar'></i> <a href="https://github.com/ksu-cs-textbooks/cis580/commit/43f194969a638fa4572819da4b31060ad574a9ce">Aug 11, 2023</a>
  </p>
  </div>
  
    
    </div>
    <script src="/cis580/js/clipboard.min.js?1723670679" defer></script>
    <script src="/cis580/js/perfect-scrollbar.min.js?1723670679" defer></script>
    <script src="/cis580/js/theme.js?1723670679" defer></script>
  </body>
</html>
