




	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.117.0">
    <meta name="generator" content="Relearn 5.18.0">
    <meta name="description" content="K-State CIS 580 Textbook">
    <meta name="author" content="Nathan H. Bean">
    <title>CIS 580: Foundations of Game Programming :: K-State CIS 580 Textbook</title>
    <link href="https://ksu-cs-textbooks.github.io/cis580/index.html" rel="canonical" type="text/html" title="CIS 580: Foundations of Game Programming :: K-State CIS 580 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis580/index.xml" rel="alternate" type="application/rss+xml" title="CIS 580: Foundations of Game Programming :: K-State CIS 580 Textbook">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/fontawesome-all.min.css?1691771331" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/fontawesome-all.min.css?1691771331" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/nucleus.css?1691771331" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/auto-complete.css?1691771331" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/auto-complete.css?1691771331" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/perfect-scrollbar.min.css?1691771331" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/fonts.css?1691771331" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis580/css/fonts.css?1691771331" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/theme.css?1691771331" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/theme-auto.css?1691771331" rel="stylesheet" id="variant-style">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/variant.css?1691771331" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/print.css?1691771331" rel="stylesheet" media="print">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/format-print.css?1691771331" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/ie.css?1691771331" rel="stylesheet">
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/url.js?1691771331"></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/variant.js?1691771331"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="https://ksu-cs-textbooks.github.io/cis580/index.search.js";
      var root_url="https://ksu-cs-textbooks.github.io/cis580/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      window.T_No_results_found = 'No results found for \u0022{0}\u0022';
      window.T_N_results_found = '{1} results found for \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/ksu-cs-textbooks.github.io\/cis580/';
      window.variants && variants.init( [ 'auto', 'light-theme', 'dark-theme' ] );
    </script>
    
    <link href="https://ksu-cs-textbooks.github.io/cis580/css/custom.css?1691771331" rel="stylesheet">

  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="https://ksu-cs-textbooks.github.io/cis580/index.html">
    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable">
        <div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" class="topbar-link" title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">CIS 580: Foundations of Game Programming</span><meta itemprop="position" content="1"></li>
            </ol>
          </div>
        </div>
      </nav>
      <main id="body-inner" class="highlightable home" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="home">
            <header class="headline">
            </header>
<h1 id="cis-580-foundations-of-game-programming">CIS 580: Foundations of Game Programming</h1>

<p>CIS 580 Textbook</p>
<p>Nathan Bean</p>
<p>Kansas State University</p>
<p>Â© 2021</p>
<p>This is an open textbook written for the <b>Kansas State University CIS 580 - Foundations of Game Programming</b> course.</p>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of CIS 580: Foundations of Game Programming</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="course-information">Course Information</h1>

<p>Press Start to Begin</p>

  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Foundations of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Course Information</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="course-introduction">Course Introduction</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<h2 id="course-goals">Course Goals</h2>
<p>This course is intended to introduce the fundamentals of creating computer game systems. Computer games are uniquely challenging in the field of software development, as they are considerably complex systems composed of many interconnected subsystems that draw upon the breadth of the field - and must operate within real-time constraints. For this semester, my goals for you as a student are:</p>
<ol>
<li>To develop a broad understanding of the algorithms and data structures often utilized within
games.</li>
<li>To recognize that there are many valid software designs, and to learn to evaluate them in terms of their appropriateness and trade-offs.</li>
<li>To expand your games portfolio with fun, engaging, and technically sophisticated games of your own devising.</li>
<li>To practice the software development and communication skills needed to participate meaningfully within our industry.</li>
<li>To develop a feel for the aesthetics of game design.</li>
</ol>
<p>All of our activities this semester will be informed by these goals.</p>
<h2 id="course-resources">Course Resources</h2>
<ul>
<li><a href="https://ksu-cs-textbooks.github.io/cis580/00-forward/09-syllabus/">Syllabus</a>
</li>
<li><a href="https://ksu-cs-textbooks.github.io/cis580/">Course Textbook</a>
</li>
<li><a href="https://gameprogrammingpatterns.com/" target="_blank">Game Programming Patterns Textbook</a>
</li>
<li><a href="https://docs.monogame.net/" target="_blank">MonoGame Documentation</a>
</li>
</ul>
<h2 id="welcome-message">Welcome Message</h2>
<p>Hello students, and welcome to CIS 580 - Foundations of Game Programming.  My name is Nathan Bean, and I will be your instructor for this course.</p>
<p>
<a href="#image-001ce27f1034e480f82daf015a1f29af" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/nathan-and-cait.jpg" alt="Playing Sequence" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-001ce27f1034e480f82daf015a1f29af">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/nathan-and-cait.jpg" alt="Playing Sequence" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="course-structure">Course Structure</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>A good portion of this course is devoted to learning about algorithms, data structures, and design patterns commonly used in constructing computer games.  To introduce and learn about each of these topics we have adopted the following pedagogical strategies:</p>
<ol>
<li>To introduce the topic, you will read a textbook chapter or watch a recorded lecture on the theory behind the algorithm, data structure, or design pattern.</li>
<li>You will then be asked toa video tutorial to implement the approach in a sample/demo project.  When you finish, you will submit the project you have created.</li>
<li>You will then be challenged to use the approach in one (or more) original game assignments.  This requires some thought of what kind of game makes sense for the approach, and it needs to be adapted to work with that game.</li>
</ol>
<p>In addition to learning about the programming techniques used in games, you are also challenged to build <em>good</em> games.  This requires you to consider games from the standpoint of <em>an aesthetic experience</em>, much like any form of art or literature. Accordingly, we are borrowing some techniques from the study of creative subjects:</p>
<ol>
<li>Some of your readings will be focused on the aesthetics of game design.  Why do we play games?  What makes a good game?</li>
<li>For each original game you produce, a portion of the grade will be derived from the aesthetic experience it provides, i.e. is it fun?  Does it invoke emotional responses from the player?</li>
<li>You will also engage in activities focused on critiquing games - evaluating them in terms of an aesthetic experience.  What works in the game design?  What helps you engage as a player?  What doesn&rsquo;t work in the game design?  What interferes with your ability to enjoy the game?</li>
<li>You will also submit some of your original games to be &ldquo;workshopped&rdquo; by the class - critiqued by your peers as a strategy to help you evaluate your own work.</li>
</ol>
<h2 id="class-meetings">Class Meetings</h2>
<p>This class is presented in a &ldquo;flipped&rdquo; format.  This means that you will need to do readings and work through tutorials <em>before</em> the class period.  Instead of lectures, class meetings are reserved for discussion, brainstorming, development, and workshops. In light of the pandemic, attendance is not mandatory, but be aware that class time is your opportunity to ask questions, get help, and garner feedback on your game designs.</p>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>If you are sick, having symptoms, or have been asked to quarantine, <strong>do not come to class</strong>.  If you will miss a class session due to COVID, you may be able to arrange a Zoom session by contacting the instructor prior to class.</p>
</div>
</div>
<h2 id="course-modules">Course Modules</h2>
<p>The course activities have been organized into modules in Canvas which help group related materials and activities.  You should work your way through each module from start to finish.</p>
<h3 id="course-readings">Course Readings</h3>
<p>Most modules will contain assigned readings and/or videos for you to study as a first step towards understanding the topic.  These are drawn from a variety of sources, and are all available on Canvas.</p>
<p>We will make heavy use of Robert Nystrom&rsquo;s <em>Game Programming Patterns</em>, an exploration of common design patterns used in video games.  It can be bought in print, but he also has a free web version: <a href="https://gameprogrammingpatterns.com/contents.html" target="_blank">https://gameprogrammingpatterns.com/contents.html</a>
.</p>
<h3 id="course-tutorials">Course Tutorials</h3>
<p>Most modules will also contain a tutorial exploring implementing the covered topic with the MonoGame/XNA technologies we will be using in this course.  These are organized into the course textbook (which you are reading now).  It is available in its entirety at <a href="https://ksu-cs-textbooks.github.io/cis580/">https://ksu-cs-textbooks.github.io/cis580/</a>
.</p>
<h3 id="original-game-assignments">Original Game Assignments</h3>
<p>Every few topics you will be challenged to create an original game that draws upon the techniques you have learned about. For each game, there will be a limited number of algorithms, data structures, or approaches you are required to implement.  Each original game is worth 100 points.</p>
<p>These are graded using <em>criterion grading</em>, an approach where your assignment is evaluated according to a set criteria.  If it meets the criteria, you get full points.  If it doesn&rsquo;t, you get 0 points.  The criteria for your games are twofold.  First, you must implement the required techniques within your game.  If you do, you earn 70 points.  If you don&rsquo;t, you earn 0. For games that meet the criteria, they are further evaluated <em>as a game</em>.  If you have created a playable game that is at least somewhat fun and aesthetically pleasing, you can earn an additional 30 points.</p>
<p>I have adopted this grading system as I have found it allows for more creative freedom for students in creating their games than a detailed rubric does (which, by its very nature forces you to make a particular kind of game).  However, I do recognize that some students struggle with the lack of a clear end goal.  If this is the case for you, I suggest you speak with myself, the TAs, or the class to brainstorm ideas of what kind of game you can build to achieve the criteria.</p>
<h4 id="serial-submissions">Serial Submissions</h4>
<p>In this course, it is acceptable to submit the same game project for multiple assignments. Each time you submit your game, you will need to incorporate the new set of requirements.  This allows you to make more complex games by evolving a concept through multiple iterations.</p>
<h4 id="working-in-teams">Working in Teams</h4>
<p>You may work with other students as a team to develop no more than three of your original game submissions.  These cannot be one of the first four original game assignments.  If you choose to work as a team, you must send me an email listing each member of the team, ideally before you start working on the game.  Students working on teams will also be required to submit a peer review evaluating the contributions of each member of the team.  This will be used to modify the game score assigned to each student.  <strong>Be aware that I will not tolerate students letting their teammates do all the work - any student who does will receive a 0 for the assignment.</strong></p>
<h2 id="workshopping">Workshopping</h2>
<p>Workshopping is an approach common to the creative arts that we are adapting to game design.  Each student will have the opportunity to workshop their games during the semester.  In addition, for your first two workshops you may and earn up to 100 extra credit points (50 points for each).</p>
<p>Workshops will be held on Wednesdays, and we can have up to four workshops per day.  Workshops are available on a first-come basis.  To reserve your slot, You must sign up by posting to the <strong>Workshops discussion board</strong> in Canvas.</p>
<p>The class should play the week&rsquo;s workshop games <em>before</em> the class meeting on Wednesday. In that class meeting we will discuss the game for ~10 minutes while the creator of the game remains a silent observer and takes notes.  After this time has elapsed, the team can ask questions of the game creator, and visa versa.  During these workshops, please use good <a href="https://ksu-cs-textbooks.github.io/cis580/00-forward/03-workshop-etiquette/">workshop etiquette</a>
.</p>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>In order to earn points for a workshop, you must:</p>
<ol>
<li>Post your game to be workshopped <em>before</em> the Monday of the week the workshop will be held.</li>
<li>This post should include a description of your game, and a link to a release in your <strong>public</strong> GitHub repository for the game.</li>
<li>The release <strong>must contain a the game binaries as additional downloads</strong>, i.e. zip your release build folder and upload it to the GitHub release page.</li>
</ol>
<p>If one or more of these conditions are not met, you will earn NO POINTS for your workshop.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="workshop-etiquette">Workshop Etiquette</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>For many of you, workshopping represents a new kind of activity you have never engaged in. We want our workshops to be a positive learning experience, where the creator feels safe sharing their work.  Here are some guidelines to follow:</p>
<ul>
<li>
<p>Comments that are less than courteous and insightful have no place in a workshop.</p>
</li>
<li>
<p>Don&rsquo;t offer empty flattery, i.e. &ldquo;I loved this game.&rdquo;  Describe <em>why</em> you loved it, and offer specific examples of its strengths.</p>
</li>
<li>
<p>Likewise, share where the game <em>isn&rsquo;t</em> working for you. Be as tactful as possible.</p>
</li>
<li>
<p>All comments should be constructive, helping the creator to strengthen their game.</p>
</li>
<li>
<p>You must address the game you were given, not the game <em>you</em> would have created if it had been your idea.  <em>Even if you think your idea is better.</em></p>
</li>
<li>
<p>Don&rsquo;t try to redesign the game for the creator.  That is for the creator to do - just point out areas of concern.</p>
</li>
<li>
<p>Always start by describing the positive aspects of the game before you address any perceived weaknesses.</p>
</li>
<li>
<p>Always use &ldquo;I&rdquo; statements.</p>
</li>
<li>
<p>Avoid loaded judgment works like &ldquo;tacky&rdquo; or &ldquo;cliche&rdquo;</p>
</li>
<li>
<p>Never start with a disarming phrase like &ldquo;I don&rsquo;t want to be mean, but&rdquo; or &ldquo;Not to be a jerk, but&rdquo;.  These automatically put the creator on the defensive, and undermine the positive benefit of your criticism.</p>
</li>
<li>
<p>Keep the focus on the workshop.  Don&rsquo;t get diverted into what game(s) this one is similar to.</p>
</li>
<li>
<p>Like all art, games my choose to tackle subjects that may make you uncomfortable. Don&rsquo;t attack a work for this - rather, examine why you had that reaction to the game.</p>
</li>
</ul>
<p>Remember too, that <em>you</em> will be the creator for an upcoming workshop.  Treat the creator as you hope they will treat you!</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>When attending a workshop remotely, good manners dictate you should have your webcam enabled and be clearly visible and not have a distracting background.  You should strive to be as much in-person as is possible remotely!</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="where-to-find-help">Where to Find Help</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>As you work on the materials in this course, you may run into questions or problems and need assistance.</p>
<h2 id="class-sessions">Class Sessions</h2>
<p>A portion of each class session is set aside for questions that have come up as you&rsquo;ve worked through the course materials.  Please take advantage of this time; not only will you benefit from the answer, but so will your classmates!</p>
<h2 id="discord">Discord</h2>
<p>For questions that crop up outside of class times, your first line of communication for this course is the course channel on the departmental Discord server. If you have not yet signed into the course discord channel, or are not yet a Discord user, please visit <a href="https://discordbot.cs.ksu.edu" target="_blank">https://discordbot.cs.ksu.edu</a>
.  This assistant will link your K-State and Discord accounts and set your username for the server in accordance with K-State policy.</p>
<p>Discord can be used through its web app at <a href="https://discord.com/webapp" target="_blank">https://discord.com/webapp</a>
 or you can <a href="https://discord.com/download" target="_blank">download a native app</a>
 for Windows, Linux, Mac, iOS, or Android devices.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>In addition to class channels, the Discord server hosts channels for student clubs, announcements, and general discussion.  It is a good place to socialize while we are unable to meet face-to-face.</p>
</div>
</div>
<h4 id="course-channel">Course Channel</h4>
<p>Discord uses <em>channels</em> - the equivalent of chat rooms - to provide a place for related conversations.  The channel for this course is <strong>#CIS-580</strong>.  It is the best place to go to get help with anything related to this course, from the tutorials and projects to issues with Visual Studio and Canvas. Before you post on Discord, use the search feature in the channel or scroll back in the chat history to make sure the question has not already been posted before. It will save everyone quite a bit of time.</p>
<p>Additionally, all course announcements will be made in the course channel (as well as through the Canvas announcements), so make a habit of checking the channel regularly.</p>
<h4 id="direct-messaging">Direct Messaging</h4>
<p>Discord also supports direct messaging - you can use this when you have a procedural or grading question.  Type the name or eid of the person you&rsquo;d like to message into the search bar, and then select them from the results to start a direct message.  Once you&rsquo;ve started a direct message with a user, their name will also show up in your side menu.</p>
<p>However, for general questions, asking them in the course channel will give you the best chance of a fast answer, from the course instructors, TAs, or your fellow students.  And if you help a fellow student, you might get bonus points!</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>The <strong>helping hand</strong> extra credit assignment provides bonus points for students who are caught helping other students in the class Discord channel.</p>
</div>
</div>
<h3 id="other-features">Other Features</h3>
<p>Discord includes lots of useful features:</p>
<ul>
<li>Use the <code>@</code> symbol with a username in a message to create a mention, which notifies that user immediately, i.e. <strong>@Nathan Bean (he/him)</strong> will alert me that you&rsquo;ve made a post that mentions me.</li>
<li>Use <code>Shift</code>+<code>Enter</code> for new lines in a multi-line message</li>
<li>Use the backtick mark (, i.e. <code>`var c = 4;`</code>) to enclose code snippets to format them as programming code, and triple backtick marks to enclose multiline code comments (<code>```[multiline code]```</code>).</li>
<li>You can also set your status to indicate your current availability.</li>
</ul>
<h2 id="email">Email</h2>
<p>Discord is the preferred communication medium for the course because 1) you will generally get a faster response than email, and 2) writing code in email is <em>a terrible experience</em>, both to write and to read.  Discord&rsquo;s support of markdown syntax makes including code comments much easier on both of us.</p>
<p>However, if you have issues with Discord, feel free to email one of the instructors directly if you are unable to post directly on Discord itself for some reason.</p>
<h2 id="game-development-club">Game Development Club</h2>
<p>Another great resource available to you is the Kansas State University Game Development Club.  You can learn more at the club website <a href="https://gdc.cs.ksu.edu/" target="_blank">https://gdc.cs.ksu.edu/</a>
. They also have a channel on the departmental Discord Server, <strong>#game-dev-club</strong>.</p>
<h2 id="other-avenues-for-help">Other Avenues for Help</h2>
<p>There are a few resources available to you that you should be aware of. First, if you have any issues working with K-State Canvas, K-State IT resources, or any other technology related to the delivery of the course, your first source of help is the K-State IT Helpdesk. They can easily be reached via email at <a href="mailto:helpdesk@ksu.edu">helpdesk@ksu.edu</a>
. Beyond them, there are many online resources for using Canvas, all of which are linked in the resources section below the video. As a last resort, you may also want to post in Discord, but in most cases we may simply redirect you to the K-State helpdesk for assistance.</p>
<p>If you have issues with the technical content of the course, specifically related to completing the tutorials and projects, there are several resources available to you. First and foremost, make sure you consult the vast amount of material available in the course modules, including the links to resources. Usually, most answers you need can be found there.</p>
<p>If you are still stuck or unsure of where to go, the next best thing is to post your question on Discord, or review existing discussions for a possible answer. You can find the link to the left of this video. As discussed earlier, the instructors, TAs, and fellow students can all help answer your question quickly.</p>
<p>Of course, as another step you can always exercise your information-gathering skills and use online search tools such as Google to answer your question. While you are not allowed to search online for direct solutions to assignments or projects, you are more than welcome to use Google to access programming resources such as <a href="https://docs.monogame.net/" target="_blank">The MonoGame Documentation</a>
, the <a href="https://developer.microsoft.com/en-us/" target="_blank">Microsoft Developer Network</a>
, <a href="https://docs.microsoft.com/en-us/dotnet/csharp/tour-of-csharp/" target="_blank">C# language documentation</a>
, and other tutorials. I can definitely assure you that programmers working in industry are often using Google and other online resources to solve problems, so there is no reason why you shouldnât start building that skill now.</p>
<p>Next, we have grading and administrative issues. This could include problems or mistakes in the grade you received on a project, missing course resources, or any concerns you have regarding the course and the conduct of myself and your peers. Youâll be interacting with us on a variety of online platforms and sometimes things happen that are inappropriate or offensive. There are lots of resources at K-State to help you with those situations. First and foremost, please DM me on Discord as soon as possible and let me know about your concern, if it is appropriate for me to be involved. If not, or if youâd rather talk with someone other than me about your issue, I encourage you to contact either your academic advisor, the CS department staff, College of Engineering Student Services, or the K-State Office of Student Life. Finally, if you have any concerns that you feel should be reported to K-State, you can do so at <a href="https://www.k-state.edu/report/" target="_blank">https://www.k-state.edu/report/</a>
. That site also has links to a large number of resources at K-State that you can use when you need help.</p>
<p>Finally, if you find any errors or omissions in the course content, or have suggestions for additional resources to include in the course, DM the instructors on Discord. There are some extra credit points available for helping to improve the course, so be on the lookout for anything that you feel could be changed or improved.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>The <strong>Bug Bounty</strong> extra credit assignment gives points for finding errors in the course materials.  Remember, your instructors are human, and do make mistakes!  But we don&rsquo;t want those occasional mistakes to trip you and your peers up in your learning efforts, so bringing them to our attention is appreciated.</p>
</div>
</div>
<p>So, in summary, Discord should always be your first stop when you have a question or run into a problem. For issues with Canvas or Visual Studio, you are also welcome to refer directly to the resources for those platforms. For questions specifically related to the projects, use Discord for sure. For grading questions and errors in the course content or any other issues, please DM the instructors on Discord for assistance.</p>
<p>Our goal in this program is to make sure that you have the resources available to you to be successful. Please donât be afraid to take advantage of them and ask questions whenever you want.</p>
<h3 id="resources">Resources</h3>
<ul>
<li><a href="https://discordbot.cs.ksu.edu" target="_blank">CS Discordbot</a>
</li>
<li><a href="https://www.k-state.edu/its/helpdesk/" target="_blank">K-State IT Help Desk</a>
 - Email: <a href="mailto:helpdesk@ksu.edu">helpdesk@ksu.edu</a>
</li>
<li><a href="http://public.online.k-state.edu/help/" target="_blank">K-State Online Canvas Help</a>
</li>
<li><a href="https://community.canvaslms.com/community/answers/guides" target="_blank">Instructure Canvas Guides</a>
</li>
<li><a href="http://www.lib.k-state.edu/" target="_blank">K-State Libraries</a>
</li>
<li><a href="https://support.cs.ksu.edu/" target="_blank">K-State CS Support</a>
</li>
<li><a href="https://www.cs.ksu.edu/undergraduate/advising/" target="_blank">K-State CS Advising</a>
</li>
<li><a href="https://www.engg.ksu.edu/studentservices/" target="_blank">K-State Engineering Student Services</a>
</li>
<li><a href="https://www.k-state.edu/studentlife/" target="_blank">K-State Office of Student Life</a>
</li>
<li><a href="https://www.k-state.edu/report/" target="_blank">K-State Report It</a>
</li>
<li><a href="https://visualstudio.microsoft.com/support/" target="_blank">Visual Studio Support</a>
</li>
</ul>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="what-you-will-learn">What you Will Learn</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>This section is intended to give a rough schedule of course topics.  Unfortunately, it is not in a very finished form at the moment.</p>
<ul>
<li>
<p>The Game Loop</p>
<ul>
<li>The Game Class</li>
<li>The GameTime Struct</li>
<li>Initializing, Updating, and Drawing in MonoGame</li>
</ul>
</li>
<li>
<p>Input polling, and how to use it</p>
<ul>
<li>Keyboard</li>
<li>Mouse</li>
<li>GamePad</li>
<li>Joystick</li>
</ul>
</li>
<li>
<p>Rendering 2D Sprites using 3D hardware</p>
<ul>
<li>Textured Quads</li>
<li>Animated Sprites</li>
<li>SpriteBatch</li>
</ul>
</li>
<li>
<p>Playing Audio</p>
<ul>
<li>SFX Class</li>
<li>Song Class</li>
</ul>
</li>
<li>
<p>Collision Detection</p>
</li>
<li>
<p>The Content Pipeline</p>
</li>
<li>
<p>Component-Based Game Design</p>
</li>
<li>
<p>Game Service Architecture</p>
</li>
<li>
<p>Game State Management</p>
</li>
<li>
<p>Parallax Scrolling</p>
</li>
<li>
<p>Tile Maps</p>
</li>
<li>
<p>3D Rendering Basics</p>
<ul>
<li>Lighting</li>
<li>Cameras</li>
<li>Models</li>
</ul>
</li>
<li>
<p>Height Maps</p>
</li>
<li>
<p>Animated Models</p>
</li>
</ul>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="course-textbooks">Course Textbooks</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>The primary textbook for the class is Robert Nystrom&rsquo;s <em>Game Programming Patterns</em>, an exploration of common design patterns used in video games.  It can be bought in print, but he also has a free web version at <a href="https://gameprogrammingpatterns.com/contents.html" target="_blank">https://gameprogrammingpatterns.com/contents.html</a>
.</p>
<p>The resources presented in the modules are also organized into an online textbook that can be accessed here: <a href="https://ksu-cs-textbooks.github.io/cis580/">https://ksu-cs-textbooks.github.io/cis580/</a>
.  You may find this a useful reference if you prefer a traditional textbook layout.  Additionally, since the textbook exists outside of Canvas&rsquo; access control, you can continue to utilize it after the course ends.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="course-software">Course Software</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<h2 id="monogame-and-visual-studio">MonoGame and Visual Studio</h2>
<p>For this course, we will be using a number of software packages including:</p>
<ul>
<li>Microsoft Visual Studio 2019</li>
<li>The MonoGame Framework</li>
</ul>
<p>These have been installed in the classroom lab, as well as all  Computer Science labs.  It is strongly suggested that you install the same versions on your own development machines if you plan on working from home.  Alternatively, you can <em>remote desktop</em> into a lab computer and use the installed software there.</p>
<h3 id="remote-desktop-access">Remote Desktop Access</h3>
<p>To use a remote desktop, you must first install a remote desktop client on your computer. Microsoft supplies a client for most platforms, which you can find links to and information about <a href="https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients?redirectedfrom=MSDN" target="_blank">here</a>
.</p>
<p>The remote desktop server is behind a network firewall, so when accessing it from off-campus, you must be using the K-State Virtual Private Network (VPN).  It has its own client that also must be installed.  You can learn about K-State&rsquo;s VPN and download the client on <a href="https://www.k-state.edu/its/security/secure-data/vpn/" target="_blank">K-State&rsquo;s VPN Page</a>
</p>
<p>For remote desktop servers, you can use those maintained by <a href="https://support.cs.ksu.edu/CISDocs/wiki/Remote_Access" target="_blank">The Department of Computer Science</a>
.</p>
<h3 id="installing-on-your-machine">Installing on Your Machine</h3>
<p>If you would prefer to install the software on your own development machine, you can obtain no-cost copies of Microsoft Visual Studio Professional Edition through Microsoft&rsquo;s <a href="https://azureforeducation.microsoft.com/devtools" target="_blank">Azure Portal</a>
 and signing in with your K-State eid and password.</p>
<p>After signing in, click the &ldquo;Software&rdquo; option in the left menu, and browse the available software for what you need.</p>
<p>The Visual Studio Community Edition is also available as a free download <a href="https://visualstudio.microsoft.com/downloads/" target="_blank">here</a>
. While not as full-featured as the Professional edition you can download through Azure Portal, it will be sufficient for the needs of this class.</p>
<p>MonoGame can then be installed as a plugin to Visual Studio 2019, following the <a href="https://docs.monogame.net/articles/getting_started/0_getting_started.html" target="_blank">Getting Started Guide</a>
.  While it is possible to develop on Linux or macOS, all course materials will be presented for Windows, and it is recommended you use that development environment.</p>
<h2 id="discord">Discord</h2>
<p>Discord can be used through its web app at <a href="https://discord.com/webapp" target="_blank">https://discord.com/webapp</a>
 or you can <a href="https://discord.com/download" target="_blank">download a native app</a>
 for Windows, Linux, Mac, iOS, or Android devices.</p>
<h2 id="other-useful-software">Other Useful Software</h2>
<p>While not strictly required for the course, these additional software packages may come in very handy:</p>
<ul>
<li><a href="https://www.bfxr.net/" target="_blank">BFXR</a>
 A free online sound effect generator perfect for creating 8-bit sound effects.</li>
<li><a href="https://www.piskelapp.com/" target="_blank">Piskel</a>
 A free online pixel art program specifically for drawing animated sprites.</li>
<li><a href="https://graphicsgale.com/us/" target="_blank">Graphics Gale</a>
 A downloadable freeware animation editor.</li>
<li><a href="https://inkscape.org/" target="_blank">Inkscape</a>
 an open-source vector graphics editor you can install (and is installed in the labs).</li>
<li><a href="https://www.mapeditor.org/" target="_blank">Tiled Map Editor</a>
 an open-source tool for creating tile maps you can install (and is installed in the labs).</li>
</ul>
<p>A broader list of useful tools can be found <a href="https://github.com/kobitoko/Game-Jam-Tools-Resources" target="_blank">here</a>
</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="assets">Assets</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<p>Assets are all the resources - art, sound, music - that go into a game.  While you can create entirely original assets for your games, this is not required.  However, if you choose to use assets created by other people, you <em>must follow copyright law</em>.  Specifically, you must have the right to use the asset in your project.</p>
<p>This right can be expressed in several ways:</p>
<ul>
<li>
<p>If the asset is in the public domain.  This is less common with art, but old music scores (i.e. classical music, folk music) are typically in the open domain.  Be aware that just because the score (the written form) is in the public domain, a recording of a performance may not be.</p>
</li>
<li>
<p>Assets released under <a href="https://creativecommons.org/" target="_blank">Creative Commons</a>
 licenses.  These licenses can have different restrictions (i.e. only used for non-profit, the creator must be credited).  These must be followed for the use to be legal.</p>
</li>
<li>
<p>Assets you have written permission from the creator to use.</p>
</li>
</ul>
<h2 id="crediting-asset-creators">Crediting Asset Creators</h2>
<p>If you use an asset that you did not create, it is a good practice to credit the creator.  This holds true even when you aren&rsquo;t required to.  A common strategy for games is to have a credits screen that lists all the contributors to the game and what their contributions were.  You may also include a text file in your repository with the assets and creator identities.</p>
<h2 id="academic-honesty-and-games">Academic Honesty and Games</h2>
<p>Because your games are also an academic work, you also need to follow the guidelines for avoiding plagiarism.  Essentially, this is claiming credit for work you did not do.  Assets can definitely fall into this category.  The guidelines here are similar to copyright - you should credit every asset creator you use.</p>
<p>In addition you should provide in your repository a list of all assets you did not create clearly labeling:</p>
<ol>
<li>The asset file name</li>
<li>The creator (if known)</li>
<li>The terms of use (i.e. public domain, license name, or other reference)</li>
</ol>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="syllabus">Syllabus</h1>


  
    
    
  
  
<div class="box notices cstyle noiframe">
  <div class="box-label"><i class="fa-fw fas fa-times-circle"></i> Web Only</div>
  <div class="box-content">

<p>This textbook was authored for the <strong>CIS 580 - Fundamentals of Game Programming</strong> course at Kansas State University.  This front matter is specific to that course.  If you are not enrolled in the course, please disregard this section.</p>
</div>
</div>
<h2 id="cis-580---fundamentals-of-game-programming">CIS 580 - Fundamentals of Game Programming</h2>
<h3 id="instructor-contact-information">Instructor Contact Information</h3>
<ul>
<li><strong>Instructor:</strong> Nathan Bean (nhbean AT ksu DOT edu)</li>
<li><strong>Office:</strong> DUE 2216</li>
<li><strong>Phone:</strong> (785)483-9264 (Call/Text)</li>
<li><strong>Website:</strong> <a href="https://nathanhbean.com" target="_blank">https://nathanhbean.com</a>
</li>
<li><strong>Office Hours:</strong> MW 10:30-11:30 or by appointment</li>
</ul>
<h3 id="preferred-methods-of-communication">Preferred Methods of Communication:</h3>
<ul>
<li><strong>Chat:</strong>Â Quick questions via Discord are the preferred means of communication.Â  Â Questions whose answers may benefit the class I would encourage you to post in the<code> #cis400</code> channel, as this keeps a public history your classmates can review.Â  More personal questions should be direct messaged to <code>@Nathan Bean</code>.</li>
<li><strong>Email:</strong>Â For questions outside of this course, email toÂ nhbean@ksu.eduÂ is preferred.</li>
<li><strong>Phone/Text:</strong> 785-483-9264 <em>Emergencies only!</em> I will do my best to respond as quickly as I can.</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>CIS 501</li>
<li>MATH 221</li>
<li>A physics course</li>
</ul>
<p><em>Students may enroll in CIS courses only if they have earned a grade of C or better for each prerequisite to these courses.</em></p>
<h3 id="course-overview">Course Overview</h3>
<p>Fundamental principles of programming games. Foundational game algorithms and data structures. Two-dimensional graphics and game world simulation. Development for multiple platforms. Utilization of game programming libraries. Design of multiple games incorporating topics covered.</p>
<h3 id="course-description">Course Description</h3>
<p>This course is intended to introduce the fundamentals of creating computer game systems. Computer
games are uniquely challenging in the field of software development, as they are considerably complex
systems composed of many interconnected subsystems that draw upon the breadth of the field - and
must operate within real-time constraints. For this semester, my goals for you as a student are:</p>
<ol>
<li>To develop a broad understanding of the algorithms and data structures often utilized within
games.</li>
<li>To recognize that there are many valid software designs, and to learn to evaluate them in terms
of their appropriateness and trade-offs.</li>
<li>To expand your games portfolio with fun, engaging, and technically sophisticated games of your
own devising.</li>
<li>To practice the software development and communication skills needed to participate
meaningfully within our industry.
All of our activities this semester will be informed by these goals.</li>
</ol>
<h3 id="major-course-topics">Major Course Topics</h3>
<ul>
<li>Game Loops</li>
<li>Input</li>
<li>Sprite Rendering and Animation</li>
<li>Collision Detection and Restitution</li>
<li>Physics Simulation</li>
<li>Parallax Scrolling</li>
<li>Tile Engines</li>
<li>Game State Management</li>
<li>Content Management</li>
<li>3D Rendering Fundamentals</li>
<li>Rendering and Animating Models</li>
</ul>
<h3 id="course-structure">Course Structure</h3>
<p>A common axiom in learner-centered teaching is <strong><em>â(s)he who does the work does the learning.â</em></strong> What this really means is that students primarily learn through grappling with the concepts and skills of a course while attempting to apply them. Simply seeing a demonstration or hearing a lecture by itself doesnât do much in terms of learning. This is not to say that they donât serve an important role - as they set the stage for the learning to come, helping you to recognize the core ideas to focus on as you work. The work itself consists of applying ideas,
practicing skills, and putting the concepts into your own words.</p>
<p>This course is built around learner-centered teaching and its recognition of the role and
importance of these different aspects of learning. Most modules will consist of readings interspersed with a variety of hands-on activities built around the concepts and skills we are seeking to master. In addition, we will be applying these ideas in iteratively building a series of original video games over the semester. Part of our class time will be reserved for working on and discussing these games, giving you the chance to ask questions and receive feedback from your instructors, UTAs, and classmates.</p>
<h3 id="the-work">The Work</h3>
<p>There is no shortcut to becoming a great game programmer. Only by <strong><em>doing the work</em></strong> will you develop the skills and knowledge to make your a successful game developer. This course is built around that principle, and gives you ample opportunity to do the work, with as much support as we can offer.</p>
<h4 id="readings">Readings</h4>
<p>Each module will include assigned readings focusing on both game programming theory and concrete approaches using MonoGame.  You will need to read these to establish the theoretical and practical foundations for tackling the tutorials and original game projects.</p>
<h4 id="tutorials">Tutorials</h4>
<p>Each module will include tutorial assignments that will take you step-by-step through using a particular concept or technique.  The point is not simply to complete the tutorial, but to <em>practice</em> the technique and coding involved.  You will be expected to implement these techniques on your own in your game projects - so this practice helps prepare you for those assignments.</p>
<h4 id="original-game-programming-assignments">Original Game Programming Assignments</h4>
<p>Throughout the semester you will be building original games incorporating the techniques you have been learning; every two weeks a new game build will be due. These games can be completely new games, or build on games you turned in as a prior project, incorporating the new assigned techniques.</p>
<p>These original game projects are graded using <em>criterion grading</em>, and approach that <em>only</em> assigns points for completing the full requirements.  However, the requirements will be brief and straightforward, i.e.:</p>
<blockquote>
<p>Create a game that detects collisions between sprites and responds by altering the simulation in a significant way (i.e. changing sprite direction, removing sprites from the game, increasing or decreasing health, etc).</p>
</blockquote>
<p>Games that meet the assigned criteria will be awarded 70 points.</p>
<p>In addition, games that fulfill <em>aesthetic goals</em> of being engaging and/or eliciting emotions from the player (other than frustration) will be awarded an additional 30 points.  This is largely focused on <em>what separates a game from a technical demo</em>.  Your game doesn&rsquo;t have to be world-shattering to earn these points, just playable and somewhat fun.</p>
<p>You have the option of collaborating with other students in the class to create larger, group games for any original game project after the first four. As part of participating in a group development effort, you must complete a peer review for each of your teammates, due along with the game.  The results of the peer review will be shared with your teammates to help develop teamwork skills.  Additionally, your individual grade for the game assignment may be modified based on the peer review feedback.</p>
<h4 id="workshops">Workshops</h4>
<p>Over the course of the semester, you will have the opportunity to have your games be workshopped by your peers. This is a valuable opportunity to gain critical feedback on your work, and you can earn up to 100 extra credit points (the equivalent of one game assignment) for each game you workshop.</p>
<p>Each week you should download and play the games that will be workshopped that week and be ready to discuss the game in class.</p>
<h4 id="exams">Exams</h4>
<p>There will be no exams given in this course.</p>
<h3 id="grading">Grading</h3>
<p>In theory, each student begins the course with an A. As you submit work, you can either maintain your A (for good work) or chip away at it (for less adequate or incomplete work). In practice, each student starts with 0 points in the gradebook and works upward toward a final point total out of the possible number of points. In this course, it is perfectly possible to get an A simply by completing all the software milestones in a satisfactory manner and attending and participating in class each day. In such a case, the examinations will simply reflect the learning youâve been doing through that work. Each work category constitutes a portion of the final grade, as detailed below:</p>
<p>38% - Activities (The lowest score is dropped)</p>
<p>42% - Original Game Projects (7% each, 7 games total)</p>
<p>20% - Final Game</p>
<p>Extra Credit</p>
<p>14% - Workshops (7% each, 2 workshops total)</p>
<p>Letter grades will be assigned following the standard scale:
90% - 100% - A; 80% - 89.99% - B; 70% - 79.99% - C; 60% - 69.99% - D; 00% - 59.99% - F</p>
<h3 id="collaboration">Collaboration</h3>
<p>Collaboration is an important practice for both learning and software development. As such, you are encouraged to work with peers and seek out help from your instructors and UTAs. However, it is also critical to remember that <strong><em>(s)he who does the work, does the learning.</em></strong>  Relying too much on your peers will deny you the opportunity to learn yourself.</p>
<p>Game development is almost always a team activity, so you may choose to tackle the later game projects in a team.  Obviously, a high degree of collaboration is expected here.  Be aware that this does not mean you have the opportunity to let your team do all the work.  Students who have not contributed (based on their peer reviews) will receive a 0 on team game projects.</p>
<h3 id="late-work">Late Work</h3>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>Read the late work policy very carefully! If you are unsure how to interpret it, please contact the instructor via email. Not understanding the policy does not mean that it won&rsquo;t apply to you!</p>
</div>
</div>
<p>Every student should strive to turn in work on time. Late work will receive a penalty of 10% of the possible points for each day it is late. If you are getting behind in the class, you are encouraged to speak to the instructor for options to make up missed work.</p>
<h3 id="software">Software</h3>
<p>We will be using Visual Studio 2019 as our development environment. You can download a free copy of Visual Studio Community for your own machine at
<a href="https://visualstudio.microsoft.com/downloads/" target="_blank">https://visualstudio.microsoft.com/downloads/</a>
. You should also be able to get a professional
development license through your Azure Student Portal. See the CS support documentation for details: <a href="https://support.cs.ksu.edu/CISDocs/wiki/FAQ#MSDNAA" target="_blank">https://support.cs.ksu.edu/CISDocs/wiki/FAQ#MSDNAA</a>
</p>
<p>MonoGame is available through the Nuget package manager built into Visual Studio.  You can install MonoGame project templates by following the directions here: <a href="https://docs.monogame.net/articles/getting_started/1_setting_up_your_development_environment_windows.html" target="_blank">https://docs.monogame.net/articles/getting_started/1_setting_up_your_development_environment_windows.html</a>
.</p>
<p>Discord also offers some free desktop and mobile clients that you may prefer over the web client.  You may download them from: <a href="https://discord.com/download" target="_blank">https://discord.com/download</a>
.</p>
<h3 id="recommended-texts--supplies">Recommended Texts &amp; Supplies</h3>
<p>To participate in this course, students must have access to a modern web browser, broadband internet connection, and webcam and microphone. All course materials will be provided via Canvas. Modules may also contain links to external resources for additional information, such as programming language documentation.</p>
<p>This course offers an instructor-written textbook, which is broken up into a specific reading order and interleaved with activities and quizzes in the modules. It can also be directly accessed at <a href="https://ksu-cs-textbooks.github.io/cis580/">https://ksu-cs-textbooks.github.io/cis580/</a>
.</p>
<p>Additionally, we will be using Robert Nystrom&rsquo;s <em>Game Programming Patterns</em>, an exploration of common design patterns used in video games.  It can be bought in print, but he also has a free web version at <a href="https://gameprogrammingpatterns.com/contents.html" target="_blank">https://gameprogrammingpatterns.com/contents.html</a>
</p>
<p>Students who would like additional textbooks should refer to resources available on the <a href="https://go.oreilly.com/kansas-state-university" target="_blank">O&rsquo;Riley For Higher Education</a>
 digital library offered by the Kansas State University Library.  These include electronic editions of popular textbooks as well as videos and tutorials.</p>
<h3 id="subject-to-change">Subject to Change</h3>
<p>The details in this syllabus are not set in stone. Due to the flexible nature of this class, adjustments may need to be made as the semester progresses, though they will be kept to a minimum. If any changes occur, the changes will be posted on the Canvas page for this course and emailed to all students.</p>
<h3 id="k-state-8">K-State 8</h3>
<p>CIS 580 helps satisfy the Aesthetic Interpretation tag in the K-State 8 General Education program. As part of this course, you will both develop and critique computer games, which constitute a form of aesthetic expression that is both similar and dissimilar from literature and film.</p>
<h3 id="academic-honesty">Academic Honesty</h3>
<p>Kansas State University has an Honor and Integrity System based on personal integrity, which is presumed to be sufficient assurance that, in academic matters, oneâs work is performed honestly and without unauthorized assistance. Undergraduate and graduate students, by registration, acknowledge the jurisdiction of the Honor and Integrity System. The policies and procedures of the <a href="https://www.k-state.edu/honor/" target="_blank">Honor and Integrity System</a>
 apply to all full and part-time students enrolled in undergraduate and graduate courses on-campus, off-campus, and via distance learning. A component vital to the Honor and Integrity System is the inclusion of the Honor Pledge which applies to all assignments, examinations, or other course work undertaken by students. The Honor Pledge is implied, whether or not it is stated: âOn my honor, as a student, I have neither given nor received unauthorized aid on this academic work.â A grade of XF can result from a breach of academic honesty. The F indicates failure in the course; the X indicates the reason is an Honor Pledge violation.</p>
<p><strong>For this course, a violation of the Honor Pledge will result in an automatic 0 for the assignment and the violation will be reported to the Honor System. A second violation will result in an XF in the course.</strong></p>
<p>In this course, <em>unauthorized aid</em> broadly consists of <em>giving or receiving code to complete assignments</em>.  This could be code you share with a classmate, code you have asked a third party to write for you, or code you have found online or elsewhere.</p>
<p>Authorized aid - which is not a violation of the honor policy - includes using the code snippets provided in the course materials, discussing strategies and techniques with classmates, instructors, TAs, and mentors. Additionally, you may use code snippets and algorithms found in textbooks and web sources if you clearly label them with comments indicating where the code came from and how it is being used in your project.</p>
<p>Be aware that using assets (images, sounds, etc.) that you do not have permission to use constitutes both <em>unauthorized aid</em> <strong>and</strong> copyright infringement.</p>
<h3 id="copyright-notice">Copyright Notice</h3>
<p>Â©2021 The materials in this online course fall under the protection of all intellectual property, copyright and trademark laws of the U.S. The digital materials included here come with the legal permissions and releases of the copyright holders. These course materials should be used for educational purposes only; the contents should not be distributed electronically or otherwise beyond the confines of this online course. The URLs listed here do not suggest endorsement of either the site owners or the contents found at the sites. Likewise, mentioned brands (products and services) do not suggest endorsement. Students own copyright to what they create.</p>
<p>Original content in the course textbook at <a href="https://ksu-cs-textbooks.github.io/cis580/">https://ksu-cs-textbooks.github.io/cis580/</a>
 is licensed under a Creative Commons BY-SA license by Nathan Bean unless otherwise stated.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction-to-monogame">Introduction to MonoGame</h1>

<p>One Framework to Rule them All</p>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Introduction to MonoGame</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>In this class we are using the MonoGame framework to build our game projects.  MonoGame is an open-source, cross-platform framework built on C# and .NET.  I like to use it for this course because it is truly a framework, not a game engine.  Rather, it supplies tools that provides abstractions for some of the more technically challenging details of developing game software in a non-opinionated manner.</p>
<p>From the developer standpoint, there are several clear benefits:</p>
<ul>
<li>You write code in familiar C#</li>
<li>You have access to all the .NET libraries you are familiar with</li>
<li>Memory is managed (i.e. you don&rsquo;t need to write allocation/de-allocation code as you would in C/C++)</li>
<li>Access and configuration of the graphics hardware is simplified (if you&rsquo;ve ever written raw DirectX initializers, you&rsquo;ll appreciate this)</li>
</ul>
<h2 id="xna-roots">XNA Roots</h2>
<p>MonoGame is the open-source descendant of Microsoft&rsquo;s XNA.  In fact, the first builds of MonoGame were direct ports of XNA, and MonoGame still uses the <code>Microsoft.Xna</code> namespaces.  XNA was created by Microsoft to encourage indie and community game development for the Xbox 360, Windows PCs, and the Windows Phone.  From the developer perspective, it was an extremely successful program; many classic games were developed using XNA, and the XBox 360 had a thriving marketplace for independent games.  Moreover, if you owned an XBox 360, you could deploy your XNA game directly to it using only a network cable; effectively any XBox 360 could be used as a dev kit!</p>
<p>However, the Windows phone was not a market success, and as the XBox One neared development, Microsoft chose not to spend the resources necessary to adapt XNA to it, instead encouraging the indie developer community to adopt the Unity Game Engine.  Eventually, Microsoft announced the official retirement of XNA related technologies on April 1, 2014.</p>
<p>MonoGame was one of several attempts to re-implement the XNA 4 API and provide a successor to the XNA platform.  Thus it has most of the XNA functionality, plus a few additions.  Moreover, it can be targeted at a wide range of platforms, though for this class we&rsquo;ll stick with Windows.</p>
<h2 id="website-and-documentation">Website and Documentation</h2>
<p>You can find the documentation for MonoGame at <a href="https://docs.monogame.net/" target="_blank">https://docs.monogame.net/</a>
.  This includes <strong>Articles</strong> discussing MonoGame and the published <strong>API</strong>.</p>
<p>See the <strong>Getting Started</strong> section for details on installing MonoGame and starting your first project.</p>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>MonoGame&rsquo;s libraries are now loaded <em>as a Nuget package</em>, which means the first time you create a MonoGame app on your computer, it will need to download these packages.  This happens automatically, but takes a moment.  Until they finish downloading, your game will report that items in the <code>Microsoft.XNA.Framework</code> namespace cannot be found.</p>
<p>Additionally, MonoGame uses the dotnet mgcb command-line tool to build content.  As Nuget downloads its packages under your user account, and Visual Studio places projects in your user account, this means your user account will be in the path to both.  <strong>If your user folder has spaces in the name, i.e. &ldquo;C:/Users/Bob Test&rdquo;, the space will cause an error when the build process attempts to build the content</strong>.  The only fix I am aware of for this is to create another user account that does not contain spaces, and run your builds from there.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-game-class">The Game Class</h1>

<p>At the heart of an XNA project is a class that inherits from <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Game.html" target="_blank">Game</a>
.  This class handles initializing the graphics device, manages components, and most importantly, implements the game loop.</p>
<h3 id="the-monogame-game-loop">The MonoGame Game Loop</h3>
<p>As you saw in <em>Game Programming Patterns</em>:</p>
<blockquote>
<p>A <strong>game loop</strong> runs continuously during gameplay. Each turn of the loop, it <strong>processes user input</strong> without blocking, <strong>updates the game state</strong>, and <strong>renders</strong> the game. It tracks the passage of time to <strong>control the rate of gameplay</strong>.</p>
</blockquote>
<p>This is precisely what the <code>Game</code> class implements for us - a loop that 1) processes user input, 2) updates the game state, and 3) renders the game.</p>
<p>As a MonoGame developer, you create a new class that inherits from <code>Game</code> (if you use one of the MonoGame templates, this class will probably be named <code>Game1</code>).  Then, you can write code to execute during steps 2 and 3 of the loop by overriding the virtual methods: <code>Update(GameTime gameTime)</code> and <code>Draw(GameTime gameTime)</code>.  These methods are invoked by <code>Game</code> each time it executes the game loop.  In software engineering parlance, we call this kind of method a &ldquo;hook,&rdquo; as we can use it to pull new functionality into the existing class.</p>
<h3 id="time-and-the-game-loop">Time and the Game Loop</h3>
<p>Time in the MonoGame framework is typically measured using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.timespan?view=net-5.0" target="_blank">System.TimeSpan</a>
 struct.  While this struct has many general uses, for games we almost totally rely on the <code>TimeSpan.TotalSeconds</code> property, which is a double representing the full length of time the TimeSpan represents as a <code>double</code> measured in seconds.</p>
<p>You probably noticed that both methods have a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.GameTime.html" target="_blank">GameTime</a>
 object as a parameter.  This is a class used to store measurements of time in the game.  It is basically a data object with three properties:</p>
<ul>
<li><code>GameTime.ElapsedGameTime</code> is a <code>TimeSpan</code> measuring the time that elapsed between this and the previous call to <code>Update(GameTime)</code>.  In other words, it is the time between passes in the game loop.</li>
<li><code>GameTime.TotalGameTime</code> is a <code>TimeSpan</code> measuring the total time since the game was started.</li>
<li><code>IsRunningSlowly</code> is a <code>Boolean</code> indicating that the game is lagging (more on this shortly)</li>
</ul>
<p>As you saw in the <em>Game Programming Patterns</em>, the game loop can be clamped (fixed), or run as fast as possible.  MonoGame allows you to choose either strategy.  You can specify the strategy you want by changing the <code>Game.IsFixedTimeStep</code> boolean property.  When using a fixed time step, you can specify the desired time step (the time between game loop passes) by setting the <code>Game.TargetElapsedTime</code> property to a <code>TimeSpan</code> of the desired duration.</p>
<p>By default, MonoGame adopts the <strong>fixed update time step, variable rendering</strong> strategy from <em>Game Programming Patterns</em>.  If a pass through the game loop takes too long, it skips rendering (the <code>Game.Draw()</code> is not invoked), and the <code>TimeSpan</code> provided to the <code>Game.Update()</code> method has its <code>IsRunningSlowly</code> property set to <code>true</code>.  The game will continue to drop rendering frames until the <code>Game.MaximumElapsedTime</code> value is reached, at which point it will invoke <code>Game.Draw()</code>. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>Setting the <code>Game.IsFixedTimeStep</code> property to <code>false</code> instead runs the game loop as fast as possible.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>You might be wondering what timestep you should use.  It&rsquo;s a tricky question, but there are some easy parameters you can use to frame it:</p>
<p><strong>Fast enough to provide the illusion of motion</strong>  The human brain begins to translate quickly changing images to motion around 16 frames per second.  That&rsquo;s a timestep of $0.0625$</p>
<p><strong>At a multiple of 30 frames per second</strong>  At least, in the Americas and parts of Asia televisions and monitors refresh at a multiple of 30, as AC power is delivered at 60 hertz cycles (other parts of the world use 50 hertz).  Cheaper monitors run at 30 frames per second (a timestep of $0.03\overline{3333}$), while most modern monitors and televisions run at 60 frames per second (a timestep of $0.01\overline{6666}$) and high-end devices might run at 120 frames per second (a timestep of $0.008\overline{3333}$).</p>
<p><strong>Slow enough your game doesn&rsquo;t lag</strong>  This speed will vary depending on the hardware in question.  But if your game is consistently slow, you need to either increase the timestep or optimize your code.</p>
<p>By default, the <code>Game.TargetElapsedTime</code> is set to the refresh rate of your monitor - which in most cases will be the ideal rate (as drawing frames more often gives no benefit).</p>
</div>
</div>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.shawnhargreaves.com/blog/understanding-gametime.html" target="_blank">Hargreaves, Shawn (7/15/2007) Understanding Game Time</a>
&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-game-window">The Game Window</h1>

<p>While MonoGame does support 3D rendering, we&rsquo;re going to start with 2D games.  When working in 2D, MonoGame uses a coordinate system similar to the screen coordinates you&rsquo;ve seen in your earlier classes.  The origin of the coordinate system $(0, 0)$, is the upper-left corner of the game window&rsquo;s client area, and the X-axis increases to the right and the Y-axis increases downward.</p>
<p>The part of the game world that appears on-screen is determined by the active <em>viewport</em>, represented by a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Graphics.Viewport.html" target="_blank">Viewport</a>
 struct - basically a rectangle plus a minimum and maximum depth.  From the <code>game</code> class, the active viewport is normally reached with <code>GraphicsDevice.Viewport</code>.  It defines the portion of the game world drawn on-screen with four measurements:</p>
<ul>
<li><code>Viewport.X</code> the farthest left range of the viewport along the X-axis</li>
<li><code>Viewport.Y</code> the upper range of the viewport along the Y-axis</li>
<li><code>Viewport.Width</code> the farthest right range of the viewport along the X-Axis</li>
<li><code>Viewport.Height</code> the lower range of the viewport along the Y-axis</li>
</ul>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>You can set the viewport to a subsection of the screen to render into only a portion of the screen - useful for split-screen games, radar systems, missile cameras etc.  We&rsquo;ll explore this technique in a later chapter.</p>
</div>
</div>
<h2 id="aspect-ratios-and-the-titlesafe-region">Aspect Ratios and the TitleSafe Region</h2>
<p>In addition to these measurements, the <code>Viewport</code> class has a <code>AspectRatio</code> property which returns the <a href="https://en.wikipedia.org/wiki/Aspect_ratio_%28image%29" target="_blank">aspect ratio</a>
 (the width/height) of the window (or full screen).  XNA was originally developed during the transition from the old 3:1 television standard to the newer 16:9 widescreen television resolution, so aspect ratio was an important consideration.</p>
<p>Along with this is the idea of a <em>title safe</em> region - a part of the screen that you could expect to be visible on any device (where titles and credits should be displayed, hence the name).  Televisions often have a bit of <em>overscan</em>, where the edges of the displayed image are cut off.  Further, if a 3:1 aspect ratio video is displayed on a 16:9 screen, and the player doesn&rsquo;t want to have black bars on the left and right edges of the screen, one of the possible settings will scale the image to fill the space, pushing the top and bottom of the scene into the overscan regions.  Filling a 3:1 screen with a 16:9 image works similarly, except the sides are pushed into the overscan area.</p>
<p>Thus, the <code>Viewport</code> also has a <code>TitleSafeArea</code> which is a <code>Rectangle</code> defining the area that should always be shown on a television.  It is a good idea to make sure that any UI elements the player <em>needs</em> to see fall within this region.</p>
<h2 id="the-game-window">The Game Window</h2>
<p>The window itself is exposed through the <code>GameWindow</code> class.  There should ever only be one instance of the <code>GameWindow</code> class for a given game.  It is created by the <code>Game</code> and assigned to the <code>Game.Window</code> property during initialization.  It exposes properties for working with the window.  For example, you can set your game title with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Window.Title = <span style="color:#e6db74">&#34;My Cool Game Title&#34;</span>;</span></span></code></pre></div><p>This will update what Windows displays in the title bar of the window, as well as when hovering over the icon in the start bar, in the task manager, etc.</p>
<p>The <code>GameWindow</code> class handles much of the work of embedding the game within the host operating system.  For example, when the game looses focus, the <code>Window.Active</code> property is false, and the game loop stops updating (effectively pausing the game).</p>
<p>You shouldn&rsquo;t need to use most of its properties.</p>
<h2 id="setting-the-game-window-size">Setting the Game Window Size</h2>
<p>If you want to specify the size of the window for your game, you can do so by setting the <code>BackBufferWidth</code> and <code>BackBufferHeight</code> properties of the <code>Graphics</code> object.  For example to set the window to 760 x 480, you would add the following code to the <code>Game.Initialize()</code> method (assuming you used the latest MonoGame project template):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    _graphics.PreferredBackBufferWidth = <span style="color:#ae81ff">760</span>;
</span></span><span style="display:flex;"><span>    _graphics.PreferredBackBufferHeight = <span style="color:#ae81ff">480</span>;
</span></span><span style="display:flex;"><span>    _graphics.ApplyChanges();</span></span></code></pre></div><p>You can make the window any size you like - but if it is larger than your screen resolution, you won&rsquo;t be able to see all of it.  To make your game fullscreen and <em>exactly</em>  the size of your monitor, use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    _graphics.PreferredBackBufferWidth = GraphicsDevice.DisplayMode.Width;
</span></span><span style="display:flex;"><span>    _graphics.PreferredBackBufferHeight = GraphicsDevice.DisplayMode.Height;
</span></span><span style="display:flex;"><span>    _graphics.IsFullScreen = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    _graphics.ApplyChanges();</span></span></code></pre></div>
  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>Be sure that you have a means to exit full screen before you run a game in debug mode!  Otherwise, you may not be able to reach VisualStudio&rsquo;s window to stop the debugger.  The default template includes code to close the game window when <code>ESC</code> is pressed.  Also, the default <code>GameWindow</code> configuration uses <code>ALT</code>+ <code>F4</code> to close the window.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-initialization">Game Initialization</h1>

<p>Before we actually move into the game loop, we need to <em>initialize</em> the game - load all of its needed parts and set all initial values.  The MonoGame <code>Game</code> class provides two virtual <em>hook</em> methods for doing this: <code>Game.Initialize()</code> and <code>Game.LoadContent()</code>.</p>
<p>You might be wondering why we have <em>two</em> methods, or asking why the constructor is not included in this count.  These are all good questions. First, in the documentation we see that <code>Initialize()</code>:</p>
<blockquote>
<p>Initializes attached GameComponent instances and calls LoadContent().</p>
</blockquote>
<p>And, if we look at the template-generated <code>Game.Initialize()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add your initialization logic here</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">base</span>.Initialize();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We can see that the <code>Game.Initialize()</code> is only invoked <em>after</em> our own initialization logic.  Thus, it is largely a matter of controlling timing.  We only want content (i.e. sounds, textures, etc.) to be loaded once the game is fully initialized.</p>
<p>This is largely because we are using the 3D hardware, which has its own RAM (video memory).  Ideally, textures should be stored there for the fastest and most efficient rendering.  So we want to delay loading our graphics until we have finished configuring the graphics device.  Thus, we do any graphics card configuration in the <code>Initialize()</code> method, <em>before</em> invoking <code>base.Initialize()</code>.</p>
<p>And why not the constructor?  What if we want the player to be able to, upon loosing, immediately restart the game?  If our initialization logic is in <code>Initialize()</code>, we can simply re-invoke that method.  We can&rsquo;t re-construct the <code>Game</code> class though, as it is tied to the life of our application.</p>
<h3 id="a-simple-example">A Simple Example</h3>
<p>Let&rsquo;s look at a super-simple example demonstrating the game loop.  We&rsquo;ll have a ball that moves a bit each frame and bounces off the sides of the window.</p>
<h4 id="variable-declarations">Variable Declarations</h4>
<p>First, we need to know the ball&rsquo;s position and velocity.  In a two-dimensional game, we would probably use a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Vector2.html" target="_blank">Vector2</a>
 Struct to represent these.  We also need a <code>Texture2D</code> to be the image of the ball:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// The ball&#39;s information</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Vector2 _ballPosition;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Vector2 _ballVelocity;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Texture2D _ballTexture;</span></span></code></pre></div><p>Add these lines to the top of the <code>Game1</code> class definition, along with the other field declarations.</p>
<h4 id="initialize-additions">Initialize() Additions</h4>
<p>Then, in our <code>Initialize()</code> method, let&rsquo;s center the ball on the screen:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Position the ball in the center of the screen</span>
</span></span><span style="display:flex;"><span>    _ballPosition.X = GraphicsDevice.Viewport.Width / <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    _ballPosition.Y = GraphicsDevice.Viewport.Height / <span style="color:#ae81ff">2</span>;</span></span></code></pre></div><p>We&rsquo;ll also give it a random velocity:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Give the ball a random velocity</span>
</span></span><span style="display:flex;"><span>    System.Random rand = <span style="color:#66d9ef">new</span> System.Random();
</span></span><span style="display:flex;"><span>    _ballVelocity.X = (<span style="color:#66d9ef">float</span>)rand.NextDouble();
</span></span><span style="display:flex;"><span>    _ballVelocity.Y = (<span style="color:#66d9ef">float</span>)rand.NextDouble();
</span></span><span style="display:flex;"><span>    _ballVelocity.Normalize();
</span></span><span style="display:flex;"><span>    _ballVelocity *= <span style="color:#ae81ff">100</span>;</span></span></code></pre></div><p>For now we&rsquo;ll use the <code>System.Random</code> class you are used to.  For some game purposes, it is sufficient, though its randomness is not as random as we&rsquo;ll need for some kinds of games.  Also, note that because <code>Random.NextDouble()</code> returns a double, and <code>Vector2</code> uses floats, we need to implicitly cast the result.  Finally, <code>Vector2.Normalize()</code> will shorten our velocity vector to be of length $1$, which the <code>_ballVelocity *= 100;</code> line scales up to a length of $100$.  Eventually this will mean our ball will be traveling 100 pixels per second.</p>
<h4 id="adding-the-image-to-the-project">Adding the Image to the Project</h4>
<p>As we said above, <code>LoadContent()</code> is where we load our assets.  For now, we just need an image of a ball.  However, getting this image into our game takes a bit of doing.</p>
<p>First, we need to find an image to use - a .jpeg, .gif, or .png will work fine. Feel free to use this one 
<a href="#image-aba178b32998470127a6e18c984df689" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/ball.png" alt="a golden ball" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-aba178b32998470127a6e18c984df689">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/ball.png" alt="a golden ball" class="lightbox-image" loading="lazy">
</a>.</p>
<p>Look in the <em>Content</em> folder of your <strong>solution explorer</strong> in Visual Studio.  You should also notice a file, <em>Content.mgcb</em> in the same folder.  This is a listing of all content to bring into the game.  Go ahead and open it; it will look something like:</p>
<p>
<a href="#image-daed05ea2d3ab67a5843848794a8bef4" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.1.png" alt="The MGCB Editor" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-daed05ea2d3ab67a5843848794a8bef4">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.1.png" alt="The MGCB Editor" class="lightbox-image" loading="lazy">
</a></p>

  
  
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>If instead of the editor program a text file is loaded in your VisualStudio instance, try right-click the file and choose &ldquo;open with&rdquo;.  From the dialog, choose the <strong>mgcb-editor-wpf</strong>.  If it is not listed, you may need to install it.  From the command line:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; dotnet tool install --global dotnet-mgcb-editor 
</span></span><span style="display:flex;"><span>&gt; mgcb-editor --register</span></span></code></pre></div></div>
</div>
<p>Click the &ldquo;Add Existing Item&rdquo; toolbar button:</p>
<p>
<a href="#image-099e7304ac70dbf2e9e60f094c6f0f40" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.2.png" alt="Add Existing Item toolbar button" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-099e7304ac70dbf2e9e60f094c6f0f40">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.2.png" alt="Add Existing Item toolbar button" class="lightbox-image" loading="lazy">
</a></p>
<p>In the Open dialog that appears, select the ball image and click &ldquo;Open&rdquo;.  Then in the next dialog, choose &ldquo;Copy the file to the directory&rdquo;:</p>
<p>
<a href="#image-220cae233504de6a98712b49876eedef" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.3.png" alt="Add File Dialog" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-220cae233504de6a98712b49876eedef">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.3.png" alt="Add File Dialog" class="lightbox-image" loading="lazy">
</a></p>
<p>Finally, save the .mgcb file:</p>
<p>
<a href="#image-51df70b78733fc99b633229e0abfcd59" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.4.png" alt="Save the .mgcb file" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-51df70b78733fc99b633229e0abfcd59">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.4.4.png" alt="Save the .mgcb file" class="lightbox-image" loading="lazy">
</a></p>
<p>Now the image will be built into a game-specific binary format as part of the build process.  We&rsquo;ll delve deeper into how this works in the chapter on the Content Pipeline.</p>
<h4 id="loadcontent-additions">LoadContent() Additions</h4>
<p>To bring the ball texture into the game, we need to load it with a <code>ContentManager</code> class by invoking the <code>ContentManager.Load&lt;T&gt;()</code> method with the name of our content.  The <code>Game</code> class has one already created and ready in the <code>Game.Content</code> property; we&rsquo;ll use it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>_ballTexture = Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;ball&#34;</span>);</span></span></code></pre></div><p>Add this line just below the <code>#TODO: use this.Content to load your game content here</code> line in the <code>LoadContent()</code> method.</p>
<p>Note that we use the filename (sans extension) to identify the content file to load, and that we also specify the type of object it should be loaded as (in this case, <code>Texture2D</code>).</p>
<p>At this point, if we were to run the game everything would be initialized.  Now we need to handle updating and rendering the game world.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-update-method">The Update Method</h1>

<p>As we mentioned before, the virtual <code>Game.Update(GameTime gameTime)</code> method is a hook for adding your game&rsquo;s logic.  By overriding this method, and adding your own game logic code, you fulfill the update step of the game loop.</p>
<p>This is where you place the <em>simulation</em> code for your game - where the world the game is representing is updated.  Here, all your actors (the parts of the game world that move and interact) are updated.</p>
<p>Note the <code>GameTime</code> parameter - it provides us with both the total time the game has been running, <em>and</em> the time that has elapsed between this and the previous step through the game loop (the frame).  We can use this in our physics calculations.</p>
<h3 id="our-simple-example">Our Simple Example</h3>
<p>So in our example, we want the ball to move around the screen, according to its velocity.  If you remember your physics, the velocity is the change in position over time, i.e.:</p>
<p>$$
\overrightarrow{p&rsquo;} = \overrightarrow{p} + \overrightarrow{v} * t
$$</p>
<p>We can express this in C# easily:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>_ballPosition += _ballVelocity * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;</span></span></code></pre></div><p>Add this code to the <code>Update()</code> method, just below the <code>// TODO</code> statement.  Note that MonoGame provides operator overrides for performing algebraic operations on <code>Vector2</code> structs, which makes writing expressions involving vectors very much like the mathematical notation.  Also, note again that we have to cast the double <code>TotalSeconds</code> into a float as we are loosing some precision in the operation.</p>
<p>Also, note that because we multiply the velocity by the elapsed time, it does not matter <em>what</em> our timestep is - the ball will always move at the same speed.  Had we simply added the velocity to the position, a game running with a 60fps timestep would be twice as fast as one running at 30fps.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>You may encounter advocates of using a hard-coded fixed time step to avoid calculations with elapsed time.  While it is true this approach makes those calculations unnecessary (and thus, makes your code more efficient), you are trading off the ability of your game to adjust to different monitor refresh rates.  In cases where your hardware is constant (i.e. the Nintendo Entertainment System), this was an easy choice.  But with computer games, I would advocate for always calculating with the elapsed time.</p>
</div>
</div>
<h4 id="keeping-the-ball-on-screen">Keeping the Ball on-screen</h4>
<p>We need to handle when the ball moves off-screen.  We said we wanted to make it <em>bounce</em> off the edges, which is pretty straightforward.  First, we need to determine if the ball is moving off-screen.  To know when this would happen, we need to know two things:</p>
<ol>
<li>The coordinates of the ball</li>
<li>The coordinates of the edges of the screen</li>
</ol>
<p>For 1, we have <code>_ballPosition</code>.  Let&rsquo;s assume this is the upper-right corner of the ball image.  We&rsquo;ll also need to factor in the size of the ball.  The image linked above is 64 pixels, so I&rsquo;ll assume that is the size of the ball we&rsquo;re using.  Feel free to change it to match your asset.</p>
<p>For 2, we can use <code>GraphicsDevice.Viewport</code> to get a rectangle defining the screen.</p>
<p>It can be very helpful to draw a diagram of this kind of setup <em>before</em> you try to derive the necessary calculations, i.e.:</p>
<p>
<a href="#image-25c340775d72b500801dc3288eda46d1" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.5.1.png" alt="A diagram of the game" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-25c340775d72b500801dc3288eda46d1">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1.5.1.png" alt="A diagram of the game" class="lightbox-image" loading="lazy">
</a></p>
<p>To check if the ball is moving off the left of the screen, we could use an <code>if</code> statement:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(_ballPosition.X &lt; GraphicsDevice.Viewport.X) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Bounce ball</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We could then reverse the direction of the ball by multiplying its velocity in the horizontal plane by $-1$:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    _ballVelocity.X *= -<span style="color:#ae81ff">1</span>;</span></span></code></pre></div><p>Moving off-screen to the right would be almost identical, so we could actually combine the two into a single if-statement:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Moving offscreen horizontally</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_ballPosition.X &lt; GraphicsDevice.Viewport.X || _ballPosition.X &gt; GraphicsDevice.Viewport.Width - <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _ballVelocity.X *= -<span style="color:#ae81ff">1</span>;    
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Note that we need to shorten the width by 64 pixels to keep the ball on-screen.</p>
<p>The vertical bounce is almost identical:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Moving offscreen vertically</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_ballPosition.Y &lt; GraphicsDevice.Viewport.Y || _ballPosition.Y &gt; GraphicsDevice.Viewport.Height - <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _ballVelocity.Y *= -<span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>Our bounce here is not quite accurate, as the ball may have moved some pixels off-screen <em>before</em> we reverse the direction.<br>
In the worst case, it will actually so far off screen that with floating point error, it might be off-screen next frame as well (which will result in it getting stuck).  But as long as our ball is traveling less than its dimensions each frame, we should be okay.</p>
</div>
</div>
<p>Now we just need to draw our bouncy ball.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-draw-method">The Draw Method</h1>

<p>The <code>Game.Draw(Game.Update(GameTime gameTime)</code> method is a another hook, this one for adding your game&rsquo;s rendering code.  By overriding this method, and adding your own rendering code, you fulfill the draw step of the game loop.</p>
<p>MonoGame uses the graphics hardware to render the scene, along with <a href="https://gameprogrammingpatterns.com/double-buffer.html" target="_blank">double buffering</a>
.  Thus, when we render, we are drawing into a back buffer, and once that drawing is complete, we <em>flip</em> the buffers so that the one we just finished is what ends up being rendered on-screen, and we now can start drawing into the next back buffer.</p>
<p>This is why we request a certain window size by setting <code>Game.PreferredBackBufferWidth</code> and <code>Game.PreferredBackBufferHeight</code>.  It is an acknowledgement that we are working with the back buffer (all buffers end up this size).  If our window&rsquo;s client area is a different size, then the texture the back buffer contains is scaled to fit the client dimensions.  If this is not the same aspect ratio, our game will appear squished in one dimension and stretched in the other.</p>
<p>This is why resizing the window is disabled by default in MonoGame.  If you let the user resize the window, you&rsquo;ll want to also adjust your buffers to compensate.</p>
<h3 id="our-simple-example">Our Simple Example</h3>
<p>Our game is two-dimensional. Since MonoGame uses the 3D rendering hardware, this means we&rsquo;re really pretending a 3D scene is two-dimensional.  You might think of it as a bunch of cardboard cut-outs all facing the audience.  To make life easier for us, MonoGame provides the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Graphics.SpriteBatch.html" target="_blank">SpriteBatch</a>
 class to manage all of those cut-outs.</p>
<p>We&rsquo;ll dig deeper into how it works in a later chapter.  But for now, know that we can render any number of images on-screen by invoking <code>SpriteBatch.Draw()</code> between a <code>SpriteBatch.Begin()</code> and a <code>SpriteBatch.End()</code> invocation.</p>
<p>For our simple ball, this breaks down to:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    _spriteBatch.Begin();            
</span></span><span style="display:flex;"><span>    _spriteBatch.Draw(_ballTexture, _ballPosition, Color.White);
</span></span><span style="display:flex;"><span>    _spriteBatch.End();</span></span></code></pre></div><p>Effectively, we&rsquo;re saying we want to draw our texture <code>_ballTexture</code> at <code>_ballPosition</code>, and apply a white color to the image (i.e. leave it the color it already is).</p>
<p>This should be placed after the <code>// TODO</code> in the <code>Base We're going to be rendering with the </code>SpriteBatch` class.</p>
<p>That wraps up our simple exercise.  You should be able to run the game now, and see the ball bounce around the screen.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we looked at how MonoGame implements the <a href="">Game Loop</a>
 pattern within its <code>Game</code> class.  We also saw how the <code>Game</code> class interacts with the <code>GameWindow</code> class, which provides an abstraction of the operating system&rsquo;s window representation.  We saw how we can add our own custom code into the MonoGame game loop by overriding the <code>Game.Update()</code> and <code>Game.Draw()</code> methods, as well as the overriding <code>Game.Initialize()</code> and <code>Game.LoadContent()</code> to set up the game world.</p>
<p>We briefly explored ideas about performing physics calculations within that game world, as well as representing position and velocity of game actors with <code>Vector2</code> objects.  We also touched on how MonoGame renders 2D games with 3D hardware, and used a <code>SpriteBatch</code> instance to render a <code>Texture2D</code> to the screen.  Finally, we animated a bouncing ball using all of these ideas.  The one aspect of the game loop we did <em>not</em> cover though, is input, which we&rsquo;ll take a look at in the next chapter.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="player-input">Player Input</h1>

<p>Need Input!

<a href="#image-cb4d7238881241da5ee03d4e4ccb330d" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/need-input.gif" alt="Need Input" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-cb4d7238881241da5ee03d4e4ccb330d">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/need-input.gif" alt="Need Input" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Player Input</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>By this point you have probably built a lot of programs with user interfaces.  Most, or possibly all, were written in an event-driven fashion, i.e. you created a method to serve as an event handler, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> OnButtonPress(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your logic here...</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>This approach is a good fit for most productivity desktop applications.  After all, most of the time your text editor is just waiting for you to do something interesting - like move the mouse or type a letter.  During this waiting period, it doesn&rsquo;t need to do anything else - what is on-screen isn&rsquo;t changing, what it has stored internally isn&rsquo;t changing.  It basically spends most of its time waiting.</p>
<p>Most games, on the other hand, are <em>never</em> waiting.  They are real-time simulations of a world.  The Goomba will keep walking, the Bullet Bill flying, and the Piranha Plant popping in and out of pipes whether or not Mario moves.  Hence the game loop - each update and render cycle updates the state of the game world, and then renders that updated world.</p>
<p>While event-driven programming is extremely efficient in a desktop application that waits on user input most of the time, it is problematic in a real-time game.  Hence, the <em>process input</em> stage in the game loop from Game Programming Patterns:</p>
<p>
<a href="#image-5439b7c32d0273c1cf8a0ff1db57316e" class="lightbox-link">
<img src="https://gameprogrammingpatterns.com/images/game-loop-simple.png" alt="The Game Loop" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5439b7c32d0273c1cf8a0ff1db57316e">
<img src="https://gameprogrammingpatterns.com/images/game-loop-simple.png" alt="The Game Loop" class="lightbox-image" loading="lazy">
</a></p>
<p>But what exactly does that step entail?  Let&rsquo;s find out.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="input-polling">Input Polling</h1>

<p>Instead of letting the OS tell us when an input event occurs (as we do with event-driven programming), in the game loop we use <em>device polling</em> with the input devices.  This means that we <em>ask the device</em> for its current state when we start processing user input.</p>
<p>Consider a gamepad with a button, <strong>A</strong>.  We can represent such a button with a boolean value; <code>true</code> if it is pressed, and <code>false</code> if it is not.  Thus, the classic NES controller could be represented by a struct composed entirely of booleans:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">NESPad</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The D-Pad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Up;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Down;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Left;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Right;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The Buttons</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> A;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> B;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Start;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Select;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>At the start of each iteration of the game loop, we could gather the current state and assign it to a copy of this struct, say <code>PlayerOneInput</code>.  We would then use it in the <code>Update()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(PlayerOneInput.Left) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        PlayerPosition.X += Speed * gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>That works well for continuous actions like walking, but what about discrete ones like jumping?  Remember, your game is updating at 1/30th or 1/60th of a second.  No player is so fast that they only hold down a button for 1/60th of a second.  Instead, they&rsquo;ll hold it down for several frames, even when they meant to just tap it.  If our jump logic is something like:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(PlayerOneInput.A) Jump();</span></span></code></pre></div><p>We&rsquo;ll end up calling that <code>Jump()</code> method multiple frames in a row!</p>
<p>The solution is to keep <em>two</em> structs: one with the current frame&rsquo;s input, and one with the prior frames, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>NESPad currentPlayerOneInput;
</span></span><span style="display:flex;"><span>NESPad priorPlayerOneInput;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentPlayerOneInput.A &amp;&amp; !priorPlayerOneInput.A) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The A button was just pressed this frame, so Jump!</span>
</span></span><span style="display:flex;"><span>        Jump();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>That wraps up <em>using</em> the input, but how about <em>getting it</em> in the first place?  That&rsquo;s what the <em>process input</em> stage in the game loop is about.  But you&rsquo;ve probably noticed that your MonoGame <code>Game</code> class doesn&rsquo;t have a corresponding method&hellip;</p>
<p>This is because XNA was built to handle four XBox 360 gamepads (as you would see on an XBox 360), as well as keyboard and mouse input <em>out of the box</em>.  And MonoGame added support for Joysticks and expanded the number and kind of gamepads that could be used.  The process input stage is there - we just don&rsquo;t need to see it.  Instead, we can grab the already-polled input data with one of the static input classes.  We&rsquo;ll take a look at each of these next.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="keyboard-input">Keyboard Input</h1>

<p>Let&rsquo;s start with the keyboard.  MonoGame uses the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.KeyboardState.html" target="_blank"><code>KeyboardState</code></a>
 struct to represent the state of a keyboard.  It is essentially a wrapper around an array of bits - one for each key in a standard keyboard.  The indices of each key are represented by the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.Keys.html" target="_blank"><code>Keys</code></a>
 enumeration (you can find a complete listing <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.Keys.html" target="_blank">in the docs</a>
).</p>
<p>We get the current state of the keyboard with the static <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.Keyboard.html" target="_blank"><code>Keyboard</code></a>
&rsquo;s <code>GetState()</code> method, which returns the aforementioned <code>KeyboardState</code> struct.  Thus, if we wanted to have current and prior keyboard states, we&rsquo;d add fields to hold them:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> KeyboardState priorKeyboardState;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> KeyboardState currentKeyboardState;</span></span></code></pre></div><p>And within our <code>Update(GameTime gameTime)</code> method, we&rsquo;d first copy the current (but now old) state to the prior variable, and then grab the updated state for the current variable:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    priorKeyboardState = currentKeyboardState;
</span></span><span style="display:flex;"><span>    currentKeyboardState = Keyboard.GetState();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Your update logic goes here...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>The <code>KeyboardState</code> struct contains properties:</p>
<ul>
<li><code>Keys</code> - an array of 256 bits, with each bit corresponding to a particular key</li>
<li><code>CapsLock</code> - a boolean indicating if the caps lock is on</li>
<li><code>NumLock</code> - a boolean indicating if the num lock is on</li>
</ul>
<p>But more often, we&rsquo;ll use its method <code>IsKeyDown(Keys key)</code> or <code>IsKeyUp(Keys key)</code>, both of which take a <code>Keys</code> value.  For example, we can check if the escape key is pressed with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentKeyboardState.IsKeyDown(Keys.Escape))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Escape key is down</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And, if we need to determine if a key was <em>just pressed this frame</em>, we would use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentKeyboardState.IsKeyDown(Keys.I) &amp;&amp;
</span></span><span style="display:flex;"><span>         priorKeyboardState.IsKeyUp(Keys.I))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The I key was just pressed this frame</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Similarly, to see if a key was <em>just released this frame</em>, we would reverse the current and previous conditions:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentKeyboardState.IsKeyUp(Keys.I) &amp;&amp;
</span></span><span style="display:flex;"><span>        priorKeyboardSate.IsKeyDown(Keys.I))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The I key was just released this frame</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>Note that part of the reason we use a <code>struct</code> instead of a <code>Class</code> for our state is that a <code>struct</code> is a <em>value</em> type, i.e. it allocates <em>exactly</em> the space need to store its data, and when we set it equal to a different struct instance, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    priorKeyboardState = currentKeyboardState;</span></span></code></pre></div><p>What actually happens is we copy the bits from <code>currentKeyboardState</code> over the top of <code>priorKeyboardState</code>.  This is both a fast operation and it allocates no additional memory - ideal for the needs of a game.  This is also why so many of MonoGame&rsquo;s data types are structs instead of classes.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="mouse-input">Mouse Input</h1>

<p>Mouse input works much like keyboard input - we have a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.MouseState.html" target="_blank"><code>MouseState</code></a>
 struct that represents the state of the mouse, and we can get the current state from the static <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.Mouse.html" target="_blank"><code>Mouse</code></a>
 class&rsquo;s <code>GetState()</code> method.  You&rsquo;ll also want to use the same caching strategy of a current and prior state if you want to know when a button goes down or comes up, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    MouseState currentMouseState;
</span></span><span style="display:flex;"><span>    MouseState priorMouseState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        priorMouseState = currentMouseState;
</span></span><span style="display:flex;"><span>        currentMouseState = Mouse.GetState();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Add your update logic here </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>However, the <code>MouseState</code> struct has a different set of properties:</p>
<ul>
<li><code>X</code> - the horizontal position of the mouse as an integer in relation to the window.</li>
<li><code>Y</code> - the vertical position of the mouse as an integer in relation to the window.</li>
<li><code>LeftButton</code> - a <code>ButtonState</code> indicating if the left button is down</li>
<li><code>MiddleButton</code> - a <code>ButtonState</code> indicating if the middle button is down</li>
<li><code>RightButton</code> - a <code>ButtonState</code> indicating if the right button is down</li>
<li><code>ScrollWheelValue</code> - an integer representing the cumulative scroll wheel value since the start of the game</li>
<li><code>HorizontalScrollWheelValue</code> - an integer representing the cumulative scroll wheel value since the start of the game</li>
<li><code>XButton1</code> - a <code>ButtonState</code> indicating if the XButton1 button is down</li>
<li><code>XButton2</code> - a <code>ButtonState</code> indicating if the XButton2  is down</li>
</ul>
<p>Note that instead of <code>booleans</code>, buttons are represented by the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.ButtonState.html" target="_blank"><code>ButtonState</code></a>
 enumeration.  This allows the internal representation of the <code>MouseState</code> buttons to be a single bitmask, making copy operations on the <code>MouseState</code> much faster (and the struct itself to take up less space).</p>
<p>Thus, to check if the <code>LeftButton</code> is down, we&rsquo;d need to use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(currentMouseState.LeftButton == ButtonState.Pressed) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// left mouse button is pressed.</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>Note that not all mice have all of these possible inputs - the Horizontal scroll wheel and X buttons, especially, but many mice also lack the middle button and scroll wheel.  In those cases these values will be <code>ButtonState.Released</code> or <code>false</code>.</p>
</div>
</div>
<h2 id="the-mouse-cursor">The Mouse Cursor</h2>
<p>You can set what cursor the mouse should use with the <code>Mouse.SetCursor(MouseCursor cursor)</code>, and supply the cursor of your choice, i.e. <code>MouseCursor.Crosshair</code>.  A full list of cursors can be found <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.MouseCursor.html#properties" target="_blank">in the documentation</a>
.</p>
<p>You can also create a cursor from a texture with <code>MouseCursor.FromTexture2D(Texture2D texture, int originX, int originY)</code>.  The <code>Texture2D</code> is loaded with a <code>ContentManager</code>, just as we did in our <em>HelloGame</em> example.  The <code>originX</code> and <code>originY</code> describe where the mouse pointer is <em>in relation to the upper-left-hand corner of the image</em>.</p>
<p>You can also hide the mouse cursor by setting the <code>Game.IsMouseVisible</code> property to <code>false</code>.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="gamepad-input">Gamepad Input</h1>

<p>MonoGame handles gamepad input in a similar fashion to Keyboard and Mouse input.  For example, there is a static <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePad.html" target="_blank"><code>GamePad</code></a>
 class and a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadState.html" target="_blank"><code>GamePadState</code></a>
 struct.</p>
<h2 id="player-indices">Player Indices</h2>
<p>However, XNA was originally designed to work with the XBox 360, which supported up to four players connected through XBox 360 gamepads. Thus, instead of using <code>GamePad.GetState()</code> we would use <code>GamePad.GetState(PlayerIndex playerIndex)</code>, where the <code>PlayerIndex</code> enumeration value corresponded to which player&rsquo;s gamepad we wanted to poll.</p>
<p>However, MonoGame can (in theory) support more than four gamepads, so it also added a <code>GamePad.GetState(int index)</code>.  You can find out how many gamepads are supported on your system with the property <code>GamePad.MaxiumumGamePadCount</code>.</p>
<p>Thus, to get the first gamepad&rsquo;s state, we would:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    GamePadState currentGamePadState;
</span></span><span style="display:flex;"><span>    GamePadState priorGamePadState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        priorGamePadState = currentGamePadState;
</span></span><span style="display:flex;"><span>        currentGamePadState = GamePad.GetState(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Add your update logic here </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="gamepad-capabilities-and-types">GamePad Capabilities and Types</h2>
<p>Also, the XBox controller had a standardized number of buttons and triggers, but MonoGame supports a wider variety of gamepads.  You can check the capabilities of any connected pad with <code>GamePad.GetCapabilities(int index)</code>, which returns a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadCapabilities.html" target="_blank"><code>GamePadCapabilities</code></a>
 struct, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GamePadCapabilities capabilities = GamePad.GetCapabilities(<span style="color:#ae81ff">1</span>);</span></span></code></pre></div><p>The <code>GamePadType</code> property is one of the <code>GamePadType</code> enumeration values, which include options like the various Rock band/Guitar hero instruments, dance pads, arcade sticks, flight sticks, and wheels.  Note that each of these types still provide their input through standard button and axis properties.</p>
<p>The various other properties of the <code>GamePadCapabilities</code> are booleans corresponding to different types of buttons pads, and sticks.  You can see them all listed <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadCapabilities.html#properties" target="_blank">in the documentation</a>
.</p>
<h2 id="gamepadstate">GamePadState</h2>
<p>The <code>GamePadState</code> is actually implemented as a partial struct, so additional data can be added based on the platform.  The various buttons, pads, and sticks are broken out into individual sub-structs.</p>
<h4 id="buttons">Buttons</h4>
<p>For example, the <code>GamePadState.Buttons</code> property is a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadButtons.html" target="_blank"><code>GamePadButtons</code></a>
 struct representing the traditional buttons (those that are either pressed or not - A, B, X, Y, Start, Back, Big Button, Left Shoulder, Right Shoulder, Left Stick, Right Stick).  As with the mouse buttons we saw before, these are represented using the <code>ButtonState</code> enum.  Thus, to determine if the A button is pressed, we would use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentGamePadState.Buttons.A == ButtonState.Pressed)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// A button is pressed</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And to determine if the X button was _just pressed this frame:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentGamePadState.Buttons.X == ButtonState.Pressed 
</span></span><span style="display:flex;"><span>    &amp;&amp; priorGamePadState.Buttons.X == ButtonState.Released)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// X button was just pressed this frame</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h4 id="dpad">DPad</h4>
<p>The <code>GamePadState.DPad</code> property is a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadButtons.html" target="_blank"><code>GamePadDPad</code></a>
 struct, also composed of <code>ButtonValues</code> for the four directions of the DPad (Up, Down, Left, Right).  I.e. to check if the right direction pad button is pressed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentGamePadState.DPad.Right == ButtonState.Pressed)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Right Dpad button is pressed</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h4 id="triggers">Triggers</h4>
<p>The <code>GamePadState.Triggers</code> property is a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadTriggers.html" target="_blank"><code>GamePadTriggers</code></a>
 struct representing the two triggers (Left and Right).  Unlike other buttons, these measure the <em>travel</em>, or the amount of pull that has been applied to them.  Thus, they are represented by a <code>single</code> floating point number between 0 and 1.</p>
<p>To see if the left trigger is pulled back 3/4 of the way, we might use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentGameState.Triggers.Left &gt; <span style="color:#ae81ff">0.75</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Left Trigger is pulled at least 3/4 of the way back</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h4 id="thumbsticks">ThumbSticks</h4>
<p>The <code>GamePadState.Thumbsticks</code> property is a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Input.GamePadThumbSticks.html" target="_blank"><code>GamePadThumbSticks</code></a>
 struct representing the two thumbsticks (Left and Right).  These are represented by <code>Vector2</code> values with the <code>X</code> and <code>Y</code> falling between -1 and 1.</p>
<p>Thus, to get where the right thumbstick is pointing, we might use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Vector2 direction = GamePad.Thumbsticks.Right;</span></span></code></pre></div><h4 id="isbuttondownisbuttonup">IsButtonDown/IsButtonUp</h4>
<p>The <code>GamePadState</code> also implements convenience functions <code>IsButtonUp(Button button)</code> and <code>IsButtonDown(Button button)</code> that operate like the keyboards&rsquo; equivalents.</p>
<h2 id="vibration">Vibration</h2>
<p>Many gamepads come equipped with two vibration-inducing motors (left and right).  These are exposed through the <code>GamePad.SetVibration(int index, single left, single right)</code> method, where you can set a vibration in either motor using a floating point value between 0 and 1.</p>
<p>Thus, to start vibration in both of player one&rsquo;s gamepad&rsquo;s motors at half-strength, you would use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GamePad.SetVibration(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5f</span>. <span style="color:#ae81ff">0.5f</span>);</span></span></code></pre></div><p>To stop them you would need to send:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GamePad.SetVibration(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div>
            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="input-manager">Input Manager</h1>

<p>At this point, you may be noticing that our input processing could quickly dominate our <code>Game</code> class, and can be very messy.  Especially if we want to support multiple forms of input in the same game.  Consider if we wanted to do a platformer - we might want the player to be able to use the keyboard <em>or</em> a gamepad.</p>
<p>One technique we can employ is an <em>input manager</em>, a class that handles polling the input and abstracts it to just the commands we care about.  I.e. for a simple platformer, we might want the four directions and &ldquo;jump&rdquo;.</p>
<p>We can create a class called <em>InputManager</em> that would provide those:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.Xna.Framework;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.Xna.Framework.Input;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Manages input for a simple platformer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InputManager</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The player&#39;s direction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Direction { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// If the player pressed jump this frame </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Jump { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Note that we use <code>public</code> auto-properties, but override the <code>set</code> to be <code>private</code>.  This way outside code can access these boolean properties, but only the code in this class can set them.</p>
<p>We&rsquo;ll also need to declare our state variables:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// Input state variables</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> KeyboardState currentKeyboardState;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> KeyboardState priorKeyboardState;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> GamePadState currentGamePadState;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> GamePadState priorGamePadState;</span></span></code></pre></div><p>And, we&rsquo;ll process these in an update method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Update the input object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The game time&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Update input state</span>
</span></span><span style="display:flex;"><span>        priorKeyboardState = currentKeyboardState;
</span></span><span style="display:flex;"><span>        currentKeyboardState = Keyboard.GetState();
</span></span><span style="display:flex;"><span>        priorGamePadState = currentGamePadState;
</span></span><span style="display:flex;"><span>        currentGamePadState = GamePad.GetState(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Assign actions based on input</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This looks just like how we updated state before.  The next step is to abstract the input <em>into</em> the properties we defined.  We&rsquo;ll start with the <code>Direction</code>, which we are using a <code>Vector2</code> to represent.  This conveniently matches with our gamepad&rsquo;s thumbstick representation, so we can assign it directly:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Right thumbstick</span>
</span></span><span style="display:flex;"><span>    Direction = currentGamePadState.Thumbsticks.Right;</span></span></code></pre></div><p>If there is no gamepad available, this will be the vector $(0,0)$.  Then we can check the WASD keys, and assign a corresponding value</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// WASD keys:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (currentKeyboardState.IsKeyDown(Keys.W)) Direction += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>,-<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (currentKeyboardState.IsKeyDown(Keys.A)) Direction += <span style="color:#66d9ef">new</span> Vector2(-<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (currentKeyboardState.IsKeyDown(Keys.S)) Direction += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (currentKeyboardState.IsKeyDown(Keys.D)) Direction += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div><p>Note that we are adding a unit vector to the (supposedly zero) existing vector.  This does mean that a player using <em>both</em> keyboard and mouse could double the direction vector length, so if this is important in your game you&rsquo;ll need additional logic to prevent it.</p>
<p>For the <em>jump</em>, we want that to be a discrete push, i.e. it is only <code>true</code> the frame the button is pushed.  So we&rsquo;ll first need to reset it to false (in case it was true in a prior frame):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// reset jump</span>
</span></span><span style="display:flex;"><span>    Jump = <span style="color:#66d9ef">false</span>;</span></span></code></pre></div><p>Now we can check if the &ldquo;A&rdquo; button is pressed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentGamePadState.IsButtonDown(Buttons.A) &amp;&amp;  priorGamePadState.IsButtonUp(Buttons.A))
</span></span><span style="display:flex;"><span>        Jump = <span style="color:#66d9ef">true</span>;</span></span></code></pre></div><p>Similarly, we can check for the spacebar:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(currentKeyboardState.IsKeyDown(Keys.Space) &amp;&amp; priorKeyboardState.IsKeyUp(Keys.Space))
</span></span><span style="display:flex;"><span>        Jump = <span style="color:#66d9ef">true</span>;</span></span></code></pre></div><p>Now, we just need to construct an instance of <code>InputManager</code> in our game, invoke its <code>Update()</code> at the start of our game class&rsquo; <code>Update()</code> method, and then we can use the <code>Direction</code> and <code>Jump</code> properties to determine what should happen in our game.</p>
<p>This idea can be adapted to any game you want to make - but it will always be specific to the game, as what the controls need to do will vary from game to game.  It also makes it easier to allow for multiple forms of input, and to also do user-controlled <em>input mapping</em>, where users can reassign keys/buttons to corresponding actions.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="input-state">Input State</h1>

<p>The <a href="https://github.com/tomizechsterson/game-state-management-monogame" target="_blank">Game State Management Sample</a>
 provides a contrasting approach to the input manager.  Instead of being tailored to a specific game, it seeks to provide generic access to all input information.  It also handles multiplayer input, and can be used to manage when a player switches gamepads.  A simplified form (which does not handle gestural input) is provided below.</p>
<p>In particular, the <code>IsButtonPressed(Buttons button, PlayerIndex? controllingPlayer, out PlayerIndex playerIndex)</code> can check for a key press on any connected keyboard, or identify what player&rsquo;s keyboard was the source of the input.  And the <code>IsNewButtonPress(Buttons button, PlayerIndex? controllingPlayer, out PlayerIndex playerIndex)</code> is handled the same way, but detects <em>new</em> button presses.</p>
<p>There are also equivalents for keyboard input.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Helper for reading input from keyboard, gamepad, and touch input. This class </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// tracks both the current and previous state of the input devices, and implements </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// query methods for high level input actions such as &#34;move up through the menu&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// or &#34;pause the game&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InputState</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> MaxInputs = <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">readonly</span> KeyboardState[] CurrentKeyboardStates;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">readonly</span> GamePadState[] CurrentGamePadStates;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> KeyboardState[] _lastKeyboardStates;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> GamePadState[] _lastGamePadStates;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">bool</span>[] GamePadWasConnected;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> InputState()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        CurrentKeyboardStates = <span style="color:#66d9ef">new</span> KeyboardState[MaxInputs];
</span></span><span style="display:flex;"><span>        CurrentGamePadStates = <span style="color:#66d9ef">new</span> GamePadState[MaxInputs];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _lastKeyboardStates = <span style="color:#66d9ef">new</span> KeyboardState[MaxInputs];
</span></span><span style="display:flex;"><span>        _lastGamePadStates = <span style="color:#66d9ef">new</span> GamePadState[MaxInputs];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        GamePadWasConnected = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">bool</span>[MaxInputs];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Reads the latest user input state.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; MaxInputs; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _lastKeyboardStates[i] = CurrentKeyboardStates[i];
</span></span><span style="display:flex;"><span>            _lastGamePadStates[i] = CurrentGamePadStates[i];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            CurrentKeyboardStates[i] = Keyboard.GetState();
</span></span><span style="display:flex;"><span>            CurrentGamePadStates[i] = GamePad.GetState((PlayerIndex)i);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Keep track of whether a gamepad has ever been</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// connected, so we can detect if it is unplugged.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (CurrentGamePadStates[i].IsConnected)
</span></span><span style="display:flex;"><span>                GamePadWasConnected[i] = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helper for checking if a key was pressed during this update. The</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// controllingPlayer parameter specifies which player to read input for.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If this is null, it will accept input from any player. When a keypress</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// is detected, the output playerIndex reports which player pressed it.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsKeyPressed(Keys key, PlayerIndex? controllingPlayer, <span style="color:#66d9ef">out</span> PlayerIndex playerIndex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (controllingPlayer.HasValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Read input from the specified player.</span>
</span></span><span style="display:flex;"><span>            playerIndex = controllingPlayer.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i = (<span style="color:#66d9ef">int</span>)playerIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> CurrentKeyboardStates[i].IsKeyDown(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Accept input from any player.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IsKeyPressed(key, PlayerIndex.One, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsKeyPressed(key, PlayerIndex.Two, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsKeyPressed(key, PlayerIndex.Three, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsKeyPressed(key, PlayerIndex.Four, <span style="color:#66d9ef">out</span> playerIndex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helper for checking if a button was pressed during this update.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The controllingPlayer parameter specifies which player to read input for.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If this is null, it will accept input from any player. When a button press</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// is detected, the output playerIndex reports which player pressed it.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsButtonPressed(Buttons button, PlayerIndex? controllingPlayer, <span style="color:#66d9ef">out</span> PlayerIndex playerIndex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (controllingPlayer.HasValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Read input from the specified player.</span>
</span></span><span style="display:flex;"><span>            playerIndex = controllingPlayer.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i = (<span style="color:#66d9ef">int</span>)playerIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> CurrentGamePadStates[i].IsButtonDown(button);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Accept input from any player.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IsButtonPressed(button, PlayerIndex.One, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsButtonPressed(button, PlayerIndex.Two, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsButtonPressed(button, PlayerIndex.Three, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsButtonPressed(button, PlayerIndex.Four, <span style="color:#66d9ef">out</span> playerIndex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helper for checking if a key was newly pressed during this update. The</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// controllingPlayer parameter specifies which player to read input for.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If this is null, it will accept input from any player. When a keypress</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// is detected, the output playerIndex reports which player pressed it.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsNewKeyPress(Keys key, PlayerIndex? controllingPlayer, <span style="color:#66d9ef">out</span> PlayerIndex playerIndex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (controllingPlayer.HasValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Read input from the specified player.</span>
</span></span><span style="display:flex;"><span>            playerIndex = controllingPlayer.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i = (<span style="color:#66d9ef">int</span>)playerIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (CurrentKeyboardStates[i].IsKeyDown(key) &amp;&amp;
</span></span><span style="display:flex;"><span>                    _lastKeyboardStates[i].IsKeyUp(key));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Accept input from any player.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IsNewKeyPress(key, PlayerIndex.One, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewKeyPress(key, PlayerIndex.Two, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewKeyPress(key, PlayerIndex.Three, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewKeyPress(key, PlayerIndex.Four, <span style="color:#66d9ef">out</span> playerIndex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helper for checking if a button was newly pressed during this update.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The controllingPlayer parameter specifies which player to read input for.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If this is null, it will accept input from any player. When a button press</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// is detected, the output playerIndex reports which player pressed it.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsNewButtonPress(Buttons button, PlayerIndex? controllingPlayer, <span style="color:#66d9ef">out</span> PlayerIndex playerIndex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (controllingPlayer.HasValue)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Read input from the specified player.</span>
</span></span><span style="display:flex;"><span>            playerIndex = controllingPlayer.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i = (<span style="color:#66d9ef">int</span>)playerIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> CurrentGamePadStates[i].IsButtonDown(button) &amp;&amp;
</span></span><span style="display:flex;"><span>                    _lastGamePadStates[i].IsButtonUp(button);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Accept input from any player.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IsNewButtonPress(button, PlayerIndex.One, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewButtonPress(button, PlayerIndex.Two, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewButtonPress(button, PlayerIndex.Three, <span style="color:#66d9ef">out</span> playerIndex) ||
</span></span><span style="display:flex;"><span>                IsNewButtonPress(button, PlayerIndex.Four, <span style="color:#66d9ef">out</span> playerIndex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we learned about <em>input polling</em> and how it is implemented in XNA using structures representing input state and static <code>GetState()</code> methods.  We saw the three primary forms of input we use in the MonoGame framework - the keyboard, the mouse, and the gamepad.</p>
<p>We also saw how a variety of game controllers (i.e. RockBand gear, steering wheels, flight sticks, etc.) are mapped to the standard gamepad; how its state struct is actually composed of several sub-structs; and how to turn on and off the vibration motors.</p>
<p>Finally, we discussed how we can use two copies of a state struct - one from the prior frame and one from the current frame - to determine if a button was just pressed or released.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="sprites">Sprites</h1>

<p>Who are you calling a fairy?</p>
<img src="https://media.giphy.com/media/6AreExUaRw1qw/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Sprites</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>The term &ldquo;sprite&rdquo; refers to a graphical element within a two-dimensional game that moves around the screen - often representing a character, powerup, or other actor.  The term likely was coined in relation to its older definition - a small fairy creature.</p>
<p>Traditionally, sprites are a part of two-dimensional games, and are a <em>raster</em> graphic (one composed of a regular grid of pixels, aka a bitmap).  As the sprites are simply an array of bits representing pixels, and the scene being presented on screen is <em>also</em> just an array of bits representing pixels, we can place a sprite on-screen by simply copying its bits into the right location.</p>
<h2 id="hardware-sprites">Hardware Sprites</h2>
<p>The earliest implementations of sprites did this by substituting the sprite bits for background image bits <em>as the bits were streamed to the screen</em> as part of an analog frame signal.  This was done by specialized hardware that supported a limited number of sprites (hence the name <em>hardware sprites</em>).</p>
<h2 id="bit-blitting">Bit Blitting</h2>
<p>Later games used <em>bit blitting</em> (an abbreviation for bit-boundary block transfer), a technique for copying a smaller bit array into a larger one.  Early graphics hardware implemented bit blitting as a hardware instruction, meaning it could be performed very fast, provided the sprite was drawn to scale.</p>
<h2 id="textured-quads">Textured Quads</h2>
<p>Modern games (and MonoGame) often use the 3D hardware to render sprites, which means they are represented as <em>textured quads</em>.  A textured quad is essentially a rectangle composed of two triangles that always faces the screen.</p>
<p>While it is more complex than traditional sprites, there are several benefits to this approach:</p>
<ol>
<li>It is far easier to scale sprites composed as textured quads than bit-blitted sprites (and scaling is impossible with most hardware sprites)</li>
<li>Textured Quad sprites can be rotated to an arbitrary angle using the graphics hardware.  Bit-blitted sprites could only be flipped (mirrored) in the X or Y direction, true rotations required additional sprite images drawn from the desired angle</li>
<li>Textured Quad sprites can take advantage of the Z-buffer to do depth sorting.  Traditional bit-blitted sprites had to be drawn using the <em>painters algorithm</em> or similar techniques to ensure proper layering.</li>
<li>Textured sprites are rendered using <em>shader</em> programs on the graphics card, so many unique effects can be applied to them.</li>
</ol>
<p>In this chapter, we&rsquo;ll examine how the MonoGame implementation of textured quads works.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="drawing-sprites">Drawing Sprites</h1>

<p>MonoGame provides the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Graphics.SpriteBatch.html" target="_blank"><code>SpriteBatch</code></a>
 class to help mitigate the complexity of implementing textured quad sprites.  It provides an abstraction around the rendering process that lets us render sprites with a minimum of fuss, with as much control as we might need.</p>
<p>As the name suggests, the <code>SpriteBatch</code> <em>batches</em> sprite draw requests so that they can be drawn in an optimized way.  We&rsquo;ll explore the different modes we can put the <code>SpriteBatch</code> in soon.  But for now, this explains why every batch begins with a call to <code>SpriteBatch.Begin()</code>, then an arbitrary number of <code>SpriteBatch.Draw()</code> calls, followed by a <code>SpriteBatch.End()</code> call.</p>
<p>We&rsquo;ve already used this pattern in our Hello Game example from chapter 1:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    _spriteBatch.Begin();            
</span></span><span style="display:flex;"><span>    _spriteBatch.Draw(_ballTexture, _ballPosition, Color.White);
</span></span><span style="display:flex;"><span>    _spriteBatch.End();</span></span></code></pre></div><p>In this example, we draw a single sprite, using the <code>_ballTexture</code>, and drawing the graphic it represents with the upper-right corner at <code>_ballPosition</code>, and blend white (<code>Color.White</code>) with the sprite texture&rsquo;s own colors.</p>
<p>The <code>SpriteBatch.Draw()</code> method actually has a seven available overrides for your use:</p>
<ul>
<li><code>public void Draw(Texture2D texture, Rectangle destinationRectangle, Color color)</code></li>
<li><code>public void Draw(Texture2D texture, Rectangle destinationRectangle, Rectangle? sourceRectangle, Color color)</code></li>
<li><code>public void Draw(Texture2D texture, Rectangle destinationRectangle, Rectangle? sourceRectangle, Color color, float rotation, Vector2 origin, SpriteEffects effects, float layerDepth)</code></li>
<li><code>Draw(Texture2D texture, Vector2 position, Color color)</code></li>
<li><code>Draw(Texture2D texture, Vector2 position, Rectangle? sourceRectangle, Color color)</code></li>
<li><code>Draw(Texture2D texture, Vector2 position, Rectangle? sourceRectangle, Color color, float rotation, Vector2 origin, Vector2 scale, SpriteEffects effects, float layerDepth)</code></li>
<li><code>Draw(Texture2D texture, Vector2 position, Rectangle? sourceRectangle, Color color, float rotation, Vector2 origin, float scale, SpriteEffects effects, float layerDepth)</code></li>
</ul>
<p>Rather than explain each one individually, we&rsquo;ll explore what the various parameters are used for, and you can select the one that matches your needs.</p>
<h4 id="texture2d-texture">Texture2D texture</h4>
<p>The <code>texture</code> parameter is a <code>Texture2D</code> containing the sprite you want to draw.  Every override includes this parameter.  If the texture has not been loaded (is null), then invoking <code>Draw()</code> will throw an <code>ArgumentNullException</code>.</p>
<h4 id="rectangle-destinationrectangle">Rectangle destinationRectangle</h4>
<p>The <code>destinationRectangle</code> is a rectangle whose coordinates are where the sprite should be drawn, in screen coordinates.  If the rectangle&rsquo;s dimensions are not the same as those of the source image (or the sub-image specified by <code>sourceRectangle</code>), it will be scaled to match.  If the aspect ratios are different, this will result in a stretched or squished sprite.  Note that the <code>Rect</code> uses integers for coordinates, so calculated floats used to place the sprite will potentially be truncated.</p>
<h4 id="color-color">Color color</h4>
<p>The <code>color</code> parameter is a <code>Color</code> that will be blended with the colors in the texture to determine the final color of the sprite.  Using <code>Color.White</code> effectively keeps the texture color the same, while using <code>Color.Red</code> will make the sprite&rsquo;s pixels all redder, <code>Color.Yellow</code> will make them more yellow, etc.  This parameter can be utilized to make the sprite flash different colors for damage, invulnerability, etc.</p>
<h4 id="vector2-position">Vector2 position</h4>
<p>As an alternative to the <code>destinationRectangle</code>, a sprite&rsquo;s position on-screen can be specified with <code>position</code>, which is a <code>Vector2</code>.  This position specifies the upper-left hand corner of where the sprite will be drawn on-screen (unless the <code>origin</code> parameter is set).  Note that when we use the <code>position</code> parameter, the width and height matches that of the texture (or sub-image specified by the <code>sourceRectangle</code>), unless a <code>scale</code> is also provided.</p>
<h4 id="rectangle-sourcerectangle">Rectangle? sourceRectangle</h4>
<p>The <code>sourceRectangle</code> is a rectangle that defines a <em>subarea</em> of the source texture (<code>texture</code>) to use as the sprite.  This is useful for <em>texture atlases</em>, where more than one sprite appear in the same texture, and also for <em>sprite animation</em> where multiple frames of animation appear in the same texture.  We&rsquo;ll discuss both of these approaches soon.</p>
<p>Note that the question mark in <code>Rectangle?</code> indicates it is a <em>nullable</em> type (i.e. it can be null as well as the <code>Rectangle</code> struct).  When it is <code>null</code>, the entire texture is used as the <code>sourceRectangle</code>.</p>
<h4 id="float-rotation">float rotation</h4>
<p>The <code>rotation</code> is a rotation value measured in radians that should be applied to the sprite.  This is one of the big benefits of textured quad sprites, as the graphics hardware makes rotations a very efficient operation (without this hardware, it becomes a much more difficult and computationally expensive operation).  This rotation is about the <code>origin</code> of the sprite, which is why all the overrides that specify the <code>rotation</code> also specify the <code>origin</code>.</p>
<h4 id="vector2-origin">Vector2 origin</h4>
<p>The <code>origin</code> is the spot within the sprite where rotations and scaling are centered.  This <em>also</em> affects sprite placement - the <code>position</code> vector indicates where the <code>origin</code> of the sprite will fall on-screen.  It is a vector measured relative to the upper-left-hand-corner of the sprite, in <em>texture</em> coordinates (i.e. pixels of the source texture).</p>
<p>Thus, for our 64x64 pixel ball texture, if we wanted the origin to be at the center, we would specify a value of <code>new Vector2(32,32)</code>.  This would also mean that when our ball was at position $(0,0)$, it would be centered on the origin and 3/4 of the ball would be off-screen.</p>
<h4 id="float-scale">float scale</h4>
<p>The <code>scale</code> is a scalar value to scale the sprite by.  For example, a value of $2.0f$ will make the sprite twice as big, while $0.5f$ would make it half as big.  This scaling is in relation to the <code>origin</code>, so if the origin is at the center of the sprite grows in all directions equally.  If instead it is at $(0,0)$, the sprite will grow to the right and down only.</p>
<h4 id="vector2-scale">Vector2 scale</h4>
<p>The <code>scale</code> can also be specified as a <code>Vector2</code>, which allows for a different horizontal and vertical scaling factor.</p>
<h4 id="spriteeffects-effects">SpriteEffects effects</h4>
<p>The <code>effects</code> parameter is one of the <code>SpriteEffects</code> enum&rsquo;s values.  These are:</p>
<ul>
<li><code>SpriteEffects.None</code> - the sprite is drawn normally</li>
<li><code>SpriteEffects.FlipHorizontally</code> - the sprite is drawn with the texture flipped in the horizontal direction</li>
<li><code>SpriteEffects.FlipVertically</code> - the sprite is drawn with the texture flipped in the vertical direction</li>
</ul>
<p>Note you can specify both horizontal and vertical flipping with a bitwise or: <code>SpriteEffects.FlipHorizontally | SpriteEffects.FlipVertically</code></p>
<h4 id="single-layerdepth">single layerDepth</h4>
<p>The <code>layerDepth</code> is an integer that indicates which sprites should be drawn &ldquo;above&rdquo; or &ldquo;below&rdquo; others (i.e. which ones should obscure the others).  Think of it as assembling a collage.  Sprites with a higher <code>layerDepth</code> value are closer to the top, and if they share screen space with sprites with a <code>lowerDepth</code>, those sprites are obscured.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="texture-atlases">Texture Atlases</h1>

<p>A <em>texture atlas</em> is a texture that is used to represent <em>multiple</em> sprites.  For example, this texture from Kinney&rsquo;s 1Bit Pack <a href="https://opengameart.org/content/1-bit-pack" target="_blank">available on OpenGameArt</a>
 contains all the sprites to create a roguelike in a single texture:</p>
<p>
<a href="#image-8076c5213dd9b08feb1b77b6929e4b67" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1bitpack/colored_packed.png" alt="Kinney&amp;rsquo;s 1Bit Pack Texture Atlas" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-8076c5213dd9b08feb1b77b6929e4b67">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/1bitpack/colored_packed.png" alt="Kinney&amp;rsquo;s 1Bit Pack Texture Atlas" class="lightbox-image" loading="lazy">
</a></p>
<p>In this case, each sprite is 15x15 pixels, with a 1 pixel outline.  So to draw the cactus in the second row and sixth column of sprites, we would use a source rectangle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> sourceRect = <span style="color:#66d9ef">new</span> Rectangle(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">16</span>);</span></span></code></pre></div><p>Thus, to draw the sprite on-screen at position $(50,50)$ we could use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    GraphicsDevice.Clear(Color.CornflowerBlue);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add your drawing code here</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin();
</span></span><span style="display:flex;"><span>    spriteBatch.Draw(atlas, <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">50</span>), <span style="color:#66d9ef">new</span> Rectangle(<span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">15</span>), Color.White);
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">base</span>.Draw(gameTime);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And we&rsquo;d see:</p>
<p>
<a href="#image-911e0d4dbef512e8591e461ef94407fd" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.1.png" alt="The rendered sprite from the sprite atlas" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-911e0d4dbef512e8591e461ef94407fd">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.1.png" alt="The rendered sprite from the sprite atlas" class="lightbox-image" loading="lazy">
</a></p>
<p>This texture atlas is laid out in 16x16 tiles, which makes calculating the <code>X</code> and <code>Y</code> of our source rectangle straightforward:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> x = xIndex * <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> y = yIndex * <span style="color:#ae81ff">16</span>;</span></span></code></pre></div><p>The formula involved for a particular texture atlas will depend on the size and spacing between sprites.  Also, some texture atlases are not evenly spaced.  In those cases, it may be useful to define a <code>Rectangle</code> constant for each one, i.e.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> Rectangle helicopterSource = <span style="color:#66d9ef">new</span> Rectangle(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">80</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> Rectangle missileSource = <span style="color:#66d9ef">new</span> Rectangle(<span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">210</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">3</span>);</span></span></code></pre></div>
  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>The texture used in the above example has a brown background.  If you would like to replace this with transparent black, you can set a <em>color key color</em> in the mgcb content editor.  Any pixel this color in the source image will be turned into transparent black when the content is compiled.  In this case, our color&rsquo;s RGB values are (71, 45, 60):</p>
<p>
<a href="#image-286ec5369324a91da3b69df7a265737e" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.2.png" alt="Setting the Color Key Color" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-286ec5369324a91da3b69df7a265737e">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.2.png" alt="Setting the Color Key Color" class="lightbox-image" loading="lazy">
</a></p>
<p>The result is that sprites rendered from the texture now have a transparent background:</p>
<p>
<a href="#image-9aa5231b4983ce99e38b5fd0897252d7" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.3.png" alt="The rendered sprite with a transparent background" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9aa5231b4983ce99e38b5fd0897252d7">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.3.3.png" alt="The rendered sprite with a transparent background" class="lightbox-image" loading="lazy">
</a></p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="animated-sprites">Animated Sprites</h1>

<p>To animate a sprite, we simply swap the image it is using.  Animated sprites typically lay out all their frames in a single texture, just like a texture atlas. Consider this <a href="https://opengameart.org/content/bat-sprite" target="_blank">animated bat sprite by bagzie</a>
 from OpenGameArt:</p>
<p>
<a href="#image-5fab68101f41507ea43c44b1818cbfef" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/32x32-bat-sprite.png" alt="Animated bat spritesheet" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-5fab68101f41507ea43c44b1818cbfef">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/32x32-bat-sprite.png" alt="Animated bat spritesheet" class="lightbox-image" loading="lazy">
</a></p>
<p>The images of the bat are laid out into a 4x4 grid of 32x32 pixel tiles.  We can create the illusion of motion by swapping which of these images we display.  However, we don&rsquo;t want to swap it every frame - doing so will be too quick for the viewer to follow, and destroy the illusion.  So we also need a timer and an idea of the direction the sprite is facing.</p>
<p>To represent the direction, we might define an enum. And since the enum can represent a numerical value, let&rsquo;s assign the corresponding row index to each direction:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// The directions a sprite can face </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> Direction {
</span></span><span style="display:flex;"><span>    Down = <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    Right = <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    Up = <span style="color:#ae81ff">2</span>, 
</span></span><span style="display:flex;"><span>    Left = <span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>With this extra state to track, it makes sense to create a class to represent our sprite:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a bat</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BatSprite</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The animated bat texture </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Texture2D texture;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// A timer variable for sprite animation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> directionTimer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// A timer variable for sprite animation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> animationTimer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The current animation frame </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">short</span> animationFrame;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">///&lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The bat&#39;s position in the world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">///&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Position { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">///&lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The bat&#39;s direction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Direction Direction { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We&rsquo;ll need a <code>LoadContent()</code> method to load our texture:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Loads the bat sprite texture</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;content&#34;&gt;The ContentManager&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> LoadContent(ContentManager content) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    texture = content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;32x32-bat-sprite.png&#34;</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Let&rsquo;s make our bat fly in a regular pattern, switching directions every two seconds.  To do this, we would want to give our bat an <code>Update()</code> method that updates a timer to determine when it is time to switch:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// advance the direction timer</span>
</span></span><span style="display:flex;"><span>    directionTimer += gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// every two seconds, change direction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(directionTimer &gt; <span style="color:#ae81ff">2.0</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span>(Direction)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> Direction.Up: 
</span></span><span style="display:flex;"><span>                Direction = Direction.Down;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> Direction.Down:
</span></span><span style="display:flex;"><span>                Direction = Direction.Left;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> Direction.Left:
</span></span><span style="display:flex;"><span>                Direction = Direction.Right;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> Direction.Right:
</span></span><span style="display:flex;"><span>                Direction = Direction.Up;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// roll back timer </span>
</span></span><span style="display:flex;"><span>        directionTimer -= <span style="color:#ae81ff">2.0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// move bat in desired direction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (Direction)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> Direction.Up:
</span></span><span style="display:flex;"><span>            Position += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">1</span>) * <span style="color:#ae81ff">100</span> * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> Direction.Down:
</span></span><span style="display:flex;"><span>            Position += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) * <span style="color:#ae81ff">100</span> * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> Direction.Left:
</span></span><span style="display:flex;"><span>            Position += <span style="color:#66d9ef">new</span> Vector2(-<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>) * <span style="color:#ae81ff">100</span> * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> Direction.Right:
</span></span><span style="display:flex;"><span>            Position += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>) * <span style="color:#ae81ff">100</span> * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We&rsquo;ll use a similar technique to advance the animation frame - once every 16th of a second, in the <code>Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime, SpriteBatch spriteBatch) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// advance the animation timer </span>
</span></span><span style="display:flex;"><span>    animationTimer += gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Every 1/16th of a second, advance the animation frame </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(animationTimer &gt; <span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        animationFrame++;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(animationFrame &gt; <span style="color:#ae81ff">3</span>) animationFrame = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        animationTimer -= <span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Determine the source rectangle </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> sourceRect = <span style="color:#66d9ef">new</span> Rectangle(animationFrame * <span style="color:#ae81ff">32</span>, (<span style="color:#66d9ef">int</span>)Direction * <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the bat using the current animation frame </span>
</span></span><span style="display:flex;"><span>    spriteBatch.Draw(texture, Position, sourceRect, Color.White);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Notice because our <code>Direction</code> enum uses integer values, we can cast it to be an <code>int</code> and use it to calculate the <code>sourceRect</code>&rsquo;s x-coordinate.</p>
<p>We can then construct a bat (or multiple bats) in our game, and invoke their <code>LoadContent()</code>, <code>Update()</code>, and <code>Draw()</code> methods in the appropriate places.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>You may have noticed that our <code>BatSprite</code> can be thought of as a <em>state machine</em>, or the <a href="https://gameprogrammingpatterns.com/state.html" target="_blank">state pattern</a>
.  You could argue that we have four possible states for each of the directions that bat is flying.  Moreover, you could argue that each of those states has four sub-states for the animation frame that is being displayed.  These are both accurate observations - the state pattern is an <em>extremely useful</em> one in game design.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="sprite-text">Sprite Text</h1>

<p>Text in videogames is challenging.  In the early days of computing, video cards had a limited number of modes - the most common was for displaying text that was streamed to the video card as ASCII character data.  This is also how the command prompt and terminals work - they operate on streams of character data.</p>
<p>But games used <em>different</em> modes that used the limited memory of the card to supply pixel data in a variety of formats.  Notably, text support was non-existent in these modes.</p>
<p>Fast-forward to the modern day.  Now text is typically handled by the operating system and its windowing libraries.  Which are notably unusable within a DirectX rendering context.  So we still use the same techniques used in those earliest video games to render text.  Bitmap fonts.</p>
<p>A bitmap font is one in which each character is represented by a raster graphic - a bitmap.  Much like sprites, these are copied into the bitmap that is the scene.  Thus, we have to bit blit each character one at a time.  This is in contrast to the fonts used by modern operating systems, which are <em>vector</em> based.  A vector font contains the <em>instructions</em> for drawing the font characters, so it can be drawn at any scale.</p>
<p>MonoGame provides some support for drawing text through the <code>SpriteBatch</code>.  But to use this functionality, we first need to create a <code>SpriteFont</code></p>
<h2 id="spritefonts">SpriteFonts</h2>
<p>A <code>SpriteFont</code> object is similar to the sprite <code>BatSprite</code> class we worked on in the last section.  It wraps around a texture containing rendered font characters, and provides details on how to render each character.  However, we don&rsquo;t construct <code>SpriteFont</code> objects ourselves, rather we load them through the <code>ContentManager</code> and the content pipeline.</p>
<p>The content pipeline <em>creates</em> a sprite font from an existing font installed on your computer.  Essentially, it renders each needed character from the font into a texture atlas, and combines that with information about where each character is in that atlas.  To create your sprite font, choose the <em>create new item</em> from the MGCB Editor, and then select &ldquo;SpriteFont Description (.spritefont)&rdquo;:</p>
<p>
<a href="#image-f2672470b395100381749826a723d405" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.5.1.png" alt="Creating the sprite font in the MGCB Editor" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f2672470b395100381749826a723d405">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/3.5.1.png" alt="Creating the sprite font in the MGCB Editor" class="lightbox-image" loading="lazy">
</a></p>
<p>This will create a SpriteFont Description, which will be compiled into a <code>SpriteFont</code>.  It also adds this description into your <em>Content</em> folder.  Open it, and you will see it is nothing more than an XML file, which specifies some details of the font:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">This file contains an xml description of a font, and will be read by the XNA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Framework Content Pipeline. Follow the comments to customize the appearance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">of the font in your game, and to change the characters which are available to draw
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">with.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;XnaContent</span> <span style="color:#a6e22e">xmlns:Graphics=</span><span style="color:#e6db74">&#34;Microsoft.Xna.Framework.Content.Pipeline.Graphics&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Asset</span> <span style="color:#a6e22e">Type=</span><span style="color:#e6db74">&#34;Graphics:FontDescription&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Modify this string to change the font that will be imported.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;FontName&gt;</span>Arial<span style="color:#f92672">&lt;/FontName&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Size is a float value, measured in points. Modify this value to change
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    the size of the font.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Size&gt;</span>12<span style="color:#f92672">&lt;/Size&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Spacing is a float value, measured in pixels. Modify this value to change
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    the amount of spacing in between characters.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Spacing&gt;</span>0<span style="color:#f92672">&lt;/Spacing&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    UseKerning controls the layout of the font. If this value is true, kerning information
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    will be used when placing characters.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;UseKerning&gt;</span>true<span style="color:#f92672">&lt;/UseKerning&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Style controls the style of the font. Valid entries are &#34;Regular&#34;, &#34;Bold&#34;, &#34;Italic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    and &#34;Bold, Italic&#34;, and are case sensitive.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Style&gt;</span>Regular<span style="color:#f92672">&lt;/Style&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    If you uncomment this line, the default character will be substituted if you draw
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    or measure text that contains characters which were not included in the font.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- &lt;DefaultCharacter&gt;*&lt;/DefaultCharacter&gt; --&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    CharacterRegions control what letters are available in the font. Every
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    character from Start to End will be built and made available for drawing. The
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    default range is from 32, (ASCII space), to 126, (&#39;~&#39;), covering the basic Latin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    character set. The characters are ordered according to the Unicode standard.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    See the documentation for more information.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;CharacterRegions&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;CharacterRegion&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;Start&gt;</span>&amp;#32;<span style="color:#f92672">&lt;/Start&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;End&gt;</span>&amp;#126;<span style="color:#f92672">&lt;/End&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/CharacterRegion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/CharacterRegions&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/Asset&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/XnaContent&gt;</span></span></span></code></pre></div><p>You can edit the values of the various elements to control the font, as well as attributes like size and style that will be used to create the raster representation.  Any font installed on your development machine can be used (though for uncommon fonts, it is a good idea to include the font&rsquo;s file, usually a .ttf, in your repository so you can install it on other development machines).</p>
<p>The <code>SpriteFont</code> can then be loaded with the <code>ContentManager</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>SpriteFont spriteFont = Content.Load&lt;SpriteFont&gt;(<span style="color:#e6db74">&#34;name-of-spritefont&#34;</span>);</span></span></code></pre></div><p>Where the supplied string is the same name as the <em>.spritefont</em> file, without the extension.</p>
<p>Once loaded, text can be drawn to the screen with <code>SpriteBatch.DrawString(SpriteFont spriteFont, Vector2 position, Color color)</code>. There are several overrides to choose from:</p>
<ul>
<li><code>DrawString(SpriteFont spriteFont, string text, Vector2 position, Color color)</code></li>
<li><code>DrawString(SpriteFont spriteFont, string text, Vector2 position, Color color, float rotation, Vector2 origin, Vector2 scale, SpriteEffects effects, float layerDepth)</code></li>
<li><code>DrawString(SpriteFont spriteFont, string text, Vector2 position, Color color, float rotation, Vector2 origin, float scale, SpriteEffects effects, float layerDepth)</code></li>
<li><code>DrawString(SpriteFont spriteFont, StringBuilder text, Vector2 position, Color color)</code></li>
<li><code>DrawString(SpriteFont spriteFont, StringBuilder text, Vector2 position, Color color, float rotation, Vector2 origin, Vector2 scale, SpriteEffects effects, float layerDepth)</code></li>
<li><code>DrawString(SpriteFont spriteFont, StringBuilder text, Vector2 position, Color color, float rotation, Vector2 origin, float scale, SpriteEffects effects, float layerDepth)</code></li>
</ul>
<p>As with <code>SpriteBatch.Draw()</code>, we&rsquo;ll explore what the various parameters are used for, and you can select the one that matches your needs.</p>
<h4 id="spritefont-spritefont">SpriteFont spriteFont</h4>
<p>The <code>spriteFont</code> parameter is a <code>SpriteFont</code> object describing the font you want to write with.  If the <code>SpriteFont</code> has not been loaded (is null), then invoking <code>DrawText()</code> will throw an <code>ArgumentNullException</code>.</p>
<h4 id="string-text">string text</h4>
<p>The <code>text</code> parameter is the string you want to draw onto the screen.</p>
<h4 id="stringbuilder-text">StringBuilder text</h4>
<p>Optionally, a <code>StringBuilder</code> object can be supplied as the <code>text</code> parameter.</p>
<h4 id="vector2-position">Vector2 position</h4>
<p>This position specifies the upper-left hand corner of where the text will be drawn on-screen (unless the <code>origin</code> parameter is set).</p>
<h4 id="color-color">Color color</h4>
<p>The <code>color</code> parameter is a <code>Color</code> the text will be rendered in (this is actually blended as is with sprites, but the base color is white, so whatever color you choose is the color that will be displayed)</p>
<h4 id="float-rotation">float rotation</h4>
<p>The <code>rotation</code> is a rotation value measured in radians that should be applied to the text. This rotation is about the <code>origin</code> of the sprite, which is why all the overrides that specify the <code>rotation</code> also specify the <code>origin</code>.</p>
<h4 id="vector2-origin">Vector2 origin</h4>
<p>The <code>origin</code> is the spot within the text where rotations and scaling are centered.  This <em>also</em> affects text placement - the <code>position</code> vector indicates where the <code>origin</code> of the text will fall on-screen.  It is a vector measured relative to the upper-left-hand-corner of the text, in <em>texture</em> coordinates (i.e. pixels of the source texture).</p>
<h4 id="float-scale">float scale</h4>
<p>The <code>scale</code> is a scalar value to scale the text by.  For example, a value of $2.0f$ will make the text twice as big, while $0.5f$ would make it half as big.  This scaling is in relation to the <code>origin</code>, so if the origin is at the center of the text grows in all directions equally.  If instead it is at $(0,0)$, the text will grow to the right and down only.</p>
<h4 id="vector2-scale">Vector2 scale</h4>
<p>The <code>scale</code> can also be specified as a <code>Vector2</code>, which allows the horizontal and vertical scaling factors to be different.</p>
<h4 id="spriteeffects-effects">SpriteEffects effects</h4>
<p>The <code>effects</code> parameter is one of the <code>SpriteEffects</code> enum&rsquo;s values.  These are:</p>
<ul>
<li><code>SpriteEffects.None</code> - the text is drawn normally</li>
<li><code>SpriteEffects.FlipHorizontally</code> - the text is drawn with the texture flipped in the horizontal direction</li>
<li><code>SpriteEffects.FlipVertically</code> - the text is drawn with the texture flipped in the vertical direction</li>
</ul>
<p>Note you can specify both horizontal and vertical flipping with a bitwise or: <code>SpriteEffects.FlipHorizontally | SpriteEffects.FlipVertically</code></p>
<h4 id="single-layerdepth">single layerDepth</h4>
<p>The <code>layerDepth</code> is an integer that indicates which sprites should be drawn &ldquo;above&rdquo; or &ldquo;below&rdquo; others (i.e. which ones should obscure the others).  Think of it as assembling a collage.  Sprites with a higher <code>layerDepth</code> value are closer to the top, and if they share screen space with sprites with a <code>lowerDepth</code>, those sprites are obscured.</p>
<h2 id="measuring-with-spritefont">Measuring with SpriteFont</h2>
<p>Note that with <code>SpriteFont</code>, there is no way to specify the width the text should be drawn - it is entirely dependent on the font, the string to render, and any scaling factors applied.  Nor is there any automatic word wrapping.</p>
<p>However, the <code>SpriteFont</code> class does expose a method <code>SpriteFont.Measure(string text)</code> and override <code>SpriteFont.Measure(StringBuilder text)</code> which given a <code>string</code> or <code>StringBuilder</code> return a <code>Vector2</code> indicating the size at which that text would be rendered.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="sorting-sprites">Sorting Sprites</h1>

<p>When drawing sprites, we often refer to the <a href="https://en.wikipedia.org/wiki/Painter%27s_algorithm" target="_blank">Painter&rsquo;s Algorithm</a>
.  This algorithm simply involves drawing the most distant part of the scene <em>first</em> (i.e. background elements) before drawing the closer elements.  This way the closer elements are drawn <em>on top of</em> the elements behind them, as when we draw we are literally copying over the existing pixel color values.</p>
<p>This is even more important when working with <em>translucent</em> (partially transparent) sprites, as we mix the translucent color with the color(s) of the elements underneath the translucent sprite.  If those colors have not yet been set, this blending will not happen.</p>
<p>The <code>SpriteBatch</code> assumes that we batch sprites in the order we want them drawn, i.e. the most distant sprites should have their <code>Draw()</code> calls first.  For many games, this is simple to accomplish, but there are some where it becomes significantly challenging (i.e. tilemap games where some tiles are &ldquo;above&rdquo; the background layer).  For these games, we can utilize the <code>SpriteBatch</code>&rsquo;s built-in sorting.</p>
<p>This is activated by calling <code>SpriteBatch.Begin(SpriteSortMode.BackToFront)</code> instead of <code>SpriteBatch.Begin()</code>.  This replaces the default sorting mode, <code>SpriteSortMode.Deferred</code> with the back-to-front sorting, based on the <code>depthLayer</code> specified in the sprite&rsquo;s <code>Draw()</code> call.  When using this mode, the <code>SpriteBatch</code> sorts the sprites immediately before it renders them.</p>
<p>A couple of things to remember about this sorting:</p>
<ol>
<li>It is more efficient if the sprites are for the most part batched in the order they need to be drawn (as there is less rearranging to do)</li>
<li>The sorting order is not assured to be the same from frame-to-frame for sprites with the same <code>depthLayer</code> value.</li>
</ol>
<p>There is also a <code>SpriteSortMode.FrontToBack</code> mode that sorts sprites in the opposite order.  It can be helpful when your game specifies the <code>depthLayer</code> values opposite the expected order (larger numbers to the back).</p>
<p>In addition to these depth-sorting options, there is a <code>SpriteSortMode.Immediate</code> which, instead of batching the sprites draws them <em>immediately</em> when the <code>Draw()</code> call is made.  This can be less efficient as it requires the sprite drawing effect (a shader program) to be loaded into the graphics card for each sprite (rather than once for all sprites).</p>
<p>Finally, there is a <code>SpriteSortMode.Texture</code> option that orders sprites by their source texture.  As swapping textures is an expensive operation for the graphics card, arranging all sprites that use each texture to be drawn together can result in better efficiency.  However, this approach can make layered sprites be drawn out-of-order.  Thus, when possible it is better to use texture atlases to minimize texture swaps.</p>
<p>The <code>SpriteBatch.Begin()</code> has additional settings that can be overridden - we&rsquo;ll examine some of these in the lessons to come.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this section we discussed the history of sprite implementations in video games, and saw the specific methods employed by MonoGame - textured quads rendered using the 3D hardware, and abstracted through the interface supplied by the <code>SpriteBatch</code> class.  We saw how textures can be rendered as sprites through <code>SpriteBatch.Draw()</code> calls, and how those calls can be customized to position, scale, rotate, recolor, and order the sprites.</p>
<p>We also saw how to optimize our sprite usage with texture atlases, where multiple sprite images are placed in a single texture, and drawn by specifying a source rectangle.  We also saw how this approach can be used to create sprite animation by combining a texture atlas populated with frames of animation with a timer controlling which frame of the animation is displayed.</p>
<p>We also saw how the <code>SpriteBatch</code> and content pipeline provide a means for transforming a modern font into a bitmap font that can be utilized within our games to draw arbitrary strings.  We also saw that these can also be customized similar to regular sprites.  Finally, we examined the various sorting modes available with the <code>SpriteSortMode</code> enum.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="collisions">Collisions</h1>

<p>We can&rsquo;t all live on a frictionless plane in a vacuum</p>
<img src="https://media.giphy.com/media/3MW7RxLPLQGOc/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Collisions</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>At the heart of every game design is interaction - interaction between the player and a simulated game world.  This simulation imposes rules about how interaction is allowed to unfold, and in nearly all cases is built upon the mechanism of collision detection - detecting when one sprite touches or overlaps another within the game world.</p>
<p>Consider the basic mechanics of many classic games:</p>
<ul>
<li>In <em>Space Invaders</em>, bullets from the playerâs turret destroy invading aliens, while alienâs bullets chew away the playerâs shields and kill the player if they strike him or her.</li>
<li>In the <em>Super Mario Bros.</em> series, jumping on an enemy squishes them - yet letting the enemy walk into Mario will kill him.</li>
<li>In the <em>Sonic</em> series, running over an enemy while spinning will destroy that enemy, freeing the trapped animal within, yet walking into the same enemy will hurt Sonic.</li>
</ul>
<p>In each of these examples, the basis for interacting with other sprites is collision detection, and, depending on the nature of the collision, different in-game effects are triggered.</p>
<p>So how do we detect collisions between two sprites? That is the subject of this chapter.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="collision-shapes">Collision Shapes</h1>

<p>Perhaps the most straightforward approach is the use of a <em>collision shape</em> (also called a <em>collision primitive</em> or <em>bounding area</em>).  This is a simplified representation of the sprite - simplified in a way that allows for easy mathematical detection of collision events.  The collision shape mimics the shape of the overall sprite:</p>
<p>
<a href="#image-1d8228f4c0b25475bff9c6d25c8b4663" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.1.png" alt="Collision shapes in Sonic and Super Mario Bros." style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1d8228f4c0b25475bff9c6d25c8b4663">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.1.png" alt="Collision shapes in Sonic and Super Mario Bros." class="lightbox-image" loading="lazy">
</a></p>
<blockquote>
<p>For a good visualization of collision shapes and the mathematics behind the collision detection, visit <a href="http://www.jeffreythompson.org/collision-detection/table_of_contents.php" target="_blank">Jeffrey Thompson&rsquo;s Collision Detection Page</a>
</p>
</blockquote>
<p>Thus, circular sprites are represented by circles, and rectangular sprites by rectangles.  Very small sprites (like circles) can be approximated by a point.  Circles, rectangles, and points are by far the most common of 2D collision shapes, because the mathematics involved in detecting collisions with these shapes is very straightforward, and because the memory required to store these collision shapes is minimal.</p>
<p>Bounding points are typically defined with a single point (x &amp; y). Bounding circles are typically defined with a center point (x &amp; y) and a radius.  Bounding rectangles are typically defined by a position (x &amp; y) and a width and height - although an alternate definition using left, top, right, and bottom values is also sometimes used.  Also, while the position often refers to the upper left corner, it can also be set in the center of the rectangle, or at the middle bottom, or anywhere else that is convenient - as long as the positioning is consistent throughout the game code, it wonât be an issue.</p>
<p>These values can be stored as either an integer or floating point number. When rendered on-screen, any fractional values will be converted to whole pixels, but using floats can preserve more detail until that point.</p>
<p>Here are some straightforward struct representations for each:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingCircle</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> X;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Y;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Radius;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingRectangle</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> X;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Y;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Width;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Height;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingPoint</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> X;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Y;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="point-on-point-collisions">Point on Point Collisions</h3>
<p>Because a point has no size, two points collide only if they have the same x and y values.  In other words, two points collide if they are the same point.  This is simple to implement in code:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between two points</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p1&#34;&gt;the first point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p2&#34;&gt;the second point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true when colliding, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingPoint p1, BoundingPoint p2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p1.X == p2.X &amp;&amp; p1.Y == p2.Y;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="circle-on-circle-collisions">Circle on Circle Collisions</h3>
<p>Only slightly harder than checking for collisions between two points is a collision between two circles.  Remember a circle is defined as all points that are $radius$ distance from the $center$.  For two circles to collide, some of these points must fall within the region defined by the other.  If we were to draw a line from center to center:</p>
<p>
<a href="#image-d25fcaad2929ac5e8c13cbc476d72bfb" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.2.png" alt="Colliding and non-colliding bounding circles" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d25fcaad2929ac5e8c13cbc476d72bfb">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.2.png" alt="Colliding and non-colliding bounding circles" class="lightbox-image" loading="lazy">
</a></p>
<p>We can very quickly see that if the length of this line is greater than the sum of the radii of the circle, the two circles do not overlap.  We can calculate the distance between the circles using the distance formula:</p>
<p>$$
distance = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}
$$</p>
<p>This can then be compared to the sum of the two circleâs radii, giving us an indication of the relationship between the two shapes:</p>
<p>$$
(r_2 + r_1) &lt; \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2} \quad \text{The circles do not intersect}
$$
$$
(r_2 + r_1) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2} \quad \text{The circles touch}
$$
$$
(r_2 + r_1) &gt; \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2} \quad \text{The circles overlap}
$$</p>
<p>However, computing the square root is a costly operation in computational terms, so we will typically square both sides of the equation and use a comparison of the squares instead:</p>
<p>$$
(r_2 + r_1)^2 &lt; (x_2 - x_1)^2 + (y_2 - y_1)^2 \quad \text{The circles do not intersect}
$$
$$
(r_2 + r_1)^2 = (x_2 - x_1)^2 + (y_2 - y_1)^2 \quad \text{The circles touch}
$$
$$
(r_2 + r_1)^2 &gt; (x_2 - x_1)^2 + (y_2 - y_1)^2 \quad \text{The circles overlap}
$$
From these inequalities we can very easily write a test for determining if our shapes collide.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between two circles</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;c1&#34;&gt;the first circle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;c2&#34;&gt;the second circle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true for a collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingCircle c1, BoundingCircle c2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Math.Pow(c1.Radius + c2.Radius, <span style="color:#ae81ff">2</span>) &gt;= Math.Pow(c2.X - c1.X, <span style="color:#ae81ff">2</span>) + Math.Pow(c2.Y - c1.Y, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="rectangle-on-rectangle-collisions">Rectangle on Rectangle Collisions</h3>
<p>There are many possible algorithms to use in detecting when a rectangle collides with another rectangle, each with its own strengths and weaknesses.  Again, we can turn to a graphical representation to help us generate our test:</p>
<p>
<a href="#image-eb1a68b6801bd80069b056c226d5f94e" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.3.png" alt="Rectangle on rectangle collisions" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-eb1a68b6801bd80069b056c226d5f94e">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.3.png" alt="Rectangle on rectangle collisions" class="lightbox-image" loading="lazy">
</a></p>
<p>From this first image, we might assume that two rectangles collide if one of their corners falls within the other.  Thus, we might think that simply checking if any of the corners of one rectangle fall within the other would give us our result.  But that overlooks one important case:</p>
<p>
<a href="#image-ada689441b5f502920e6a80329574466" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.4.png" alt="Overlapping Rectangles" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ada689441b5f502920e6a80329574466">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.4.png" alt="Overlapping Rectangles" class="lightbox-image" loading="lazy">
</a></p>
<p>As this example makes clear, the important concept is that one rectangle must overlap the other rectangle in two dimensions (both the X and the Y) for a collision to occur.  Thus, we could check:</p>
<p>Horizontally:</p>
<ul>
<li>if a&rsquo;s left side falls within b&rsquo;s horizontal span</li>
<li>or if a&rsquo;s right side falls within b&rsquo;s horizontal span</li>
<li>or if b&rsquo;s left side falls within a&rsquo;s horizontal span</li>
<li>or if b&rsquo;s right side falls within a&rsquo;s horizontal span</li>
</ul>
<p>and vertically:</p>
<ul>
<li>if a&rsquo;s top side falls within b&rsquo;s vertical span</li>
<li>or if a&rsquo;s bottom side falls within b&rsquo;s vertical span</li>
<li>or if b&rsquo;s top side falls within a&rsquo;s vertical span</li>
<li>or if b&rsquo;s bottom side falls within a&rsquo;s vertical span</li>
</ul>
<p>That is a lot of cases!  It also makes for a monster boolean expression, an does a lot of operations.  As with many boolean expressions, we can instead consider the negation - proving that the two rectangles <em>do not overlap</em>.  This is far simpler; all we need to prove is that the two do not overlap horizontally or vertically.  Thus we can check:</p>
<p>Horizontally:</p>
<ul>
<li>if a is to the left of b</li>
<li>or if a is to the right of b</li>
</ul>
<p>or Vertically:</p>
<ul>
<li>if a is above b</li>
<li>or if a is below b</li>
</ul>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between two rectangles</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;r1&#34;&gt;The first rectangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;r2&#34;&gt;The second rectangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingRectangle r1, BoundingRectangle r2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> !(r1.X + r1.Width &lt; r2.X    <span style="color:#75715e">// r1 is to the left of r2</span>
</span></span><span style="display:flex;"><span>            || r1.X &gt; r2.X + r2.Width     <span style="color:#75715e">// r1 is to the right of r2</span>
</span></span><span style="display:flex;"><span>            || r1.Y + r1.Height &lt; r2.Y    <span style="color:#75715e">// r1 is above r2 </span>
</span></span><span style="display:flex;"><span>            || r1.Y &gt; r2.Y + r2.Height); <span style="color:#75715e">// r1 is below r2</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="point-on-circle-collisions">Point on Circle Collisions</h3>
<p>To determine if a point and circle collide is a degenerate case of circle on circle collision where one circle has a radius of 0. THus:</p>
<p>$$
r &gt;= \sqrt{(x_c - x_p)^2 + (y_c - y_p)^2} \quad \text{collision}
$$</p>
<p>Which can be rewritten to avoid the square root as:</p>
<p>$$
r^2 &gt;= (x_c - x_p)^2 + (y_c - y_p)^2 \quad \text{collision}
$$</p>
<p>And in code:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between a circle and point</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;c&#34;&gt;the circle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;the point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingCircle c, BoundingPoint p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Math.Pow(c.Radius, <span style="color:#ae81ff">2</span>) &gt;= Math.Pow(c.X - p.X, <span style="color:#ae81ff">2</span>) + Math.Pow(c.Y - p.Y, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="point-on-rectangle-collisions">Point on Rectangle Collisions</h3>
<p>Similarly, a point and rectangle collide if the point falls within the bounds or on an edge of the rectangle.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between a rectangle and a point</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;r&#34;&gt;The rectangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;The point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingRectangle r, BoundingPoint p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p.X &gt;= r.X &amp;&amp; p.X &lt;= r.X + r.Width &amp;&amp; p.Y &gt;= r.Y &amp;&amp; p.Y &lt;= r.Y + r.Height;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="circle-on-rectangle-collisions">Circle on Rectangle Collisions</h3>
<p>A circle-on-rectangle collision is a bit more challenging. To understand our strategy, let&rsquo;s start with a number line:</p>
<p>
<a href="#image-191daa9c45e4ce043b8ba2e6989dcbdb" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.5.png" alt="Number Line" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-191daa9c45e4ce043b8ba2e6989dcbdb">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.2.5.png" alt="Number Line" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice the red line from 0 to 4?  What is the closest point that falls within that line to the value -2? To the value 5?  To the value 3?  The answers are: 0, 3, and 4.  Basically, if the point falls within the section, it is the point itself.  Otherwise it is the closest endpoint.  Mathematically, this is the clamp operation, and MonoGame provides a method to calculate it: <code>MathHelper.Clamp(float value, float min, float max)</code>.  It will clamp the provided value to the provided min and max.</p>
<p>If we clamp the circle&rsquo;s center point to the extents of the rectangle, the result is <em>the nearest point in or on the rectangle to the center of the circle</em>.  If the distance between the center and the nearest point is greater than the radius of the circle, then we <em>know</em> the two aren&rsquo;t intersecting.  We can write this using the point/circle test we declared earlier:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Determines if there is a collision between a circle and rectangle</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;r&#34;&gt;The bounding rectangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;c&#34;&gt;The bounding circle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true for collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingRectangle r, BoundingCircle c)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    BoundingPoint p;
</span></span><span style="display:flex;"><span>    p.X = MathHelper.Clamp(c.X, r.X, r.X + r.Width);
</span></span><span style="display:flex;"><span>    p.Y = MathHelper.Clamp(c.Y, r.Y, r.Y + r.Height);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Collides(c, p);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="collision-helper">Collision Helper</h1>

<p>There are many ways we could organize the methods we saw in the previous section, but one particularly apt one is to organize them into a static helper class, much like our <code>Math</code> and <code>MathHelper</code> classes, i.e. <code>CollisionHelper</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class containing collision detection methods</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CollisionHelper</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Detects a collision between two points</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p1&#34;&gt;the first point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p2&#34;&gt;the second point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;true when colliding, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingPoint p1, BoundingPoint p2)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> p1.X == p2.X &amp;&amp; p1.Y == p2.Y;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... more static collision detection methods</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>With such a helper in place, we could also go back and expand our structures, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a bounding point for determining collisions</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingPoint</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> X;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Y;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a BoundingPoint with the provided coordinates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;x&#34;&gt;The x coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;y&#34;&gt;The y coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BoundingPoint(<span style="color:#66d9ef">float</span> x, <span style="color:#66d9ef">float</span> y)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        X = x;
</span></span><span style="display:flex;"><span>        Y = y;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Determines if this BoundingPoint collides with another BoundingPoint</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;o&#34;&gt;the other bounding point&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> CollidesWith(BoundingPoint o)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CollisionHelper.Collides(o, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Determines if this BoundingPoint collides with a BoundingCircle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;c&#34;&gt;the BoundingCircle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> CollidesWith(BoundingCircle c)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CollisionHelper.Collides(c, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Determines if this BoundingPoint collides with a BoundingCircle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;r&#34;&gt;the BoundingRectangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;true on collision, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> CollidesWith(BoundingRectangle r)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CollisionHelper.Collides(r, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We could, of course, directly implement the collision methods within the structs, but this approach avoids duplicating code.  It also more closely follows the style of the XNA framework.</p>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>For your collision detection to be accurate, you must keep your bounding volumes in sync with your sprites - i.e. every time you move a sprite, you must also move its bounding volume.  Alternatively, you may wish to <em>create</em> yh</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="separating-axis-theorem">Separating Axis Theorem</h1>

<p>But what about sprites with shapes <em>don&rsquo;t</em> map to a circle or rectangle, such as this spaceship sprite:</p>
<p>
<a href="#image-68fcc55402cdb28475bd0d982fe85e05" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.1.png" alt="Polygonal spaceship sprite" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-68fcc55402cdb28475bd0d982fe85e05">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.1.png" alt="Polygonal spaceship sprite" class="lightbox-image" loading="lazy">
</a></p>
<p>We could represent this sprite with a bounding polygon:</p>
<p>
<a href="#image-99c65e91c3e91ad741800cc5d4ddc8a2" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.2.png" alt="Bounding Polygon" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-99c65e91c3e91ad741800cc5d4ddc8a2">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.2.png" alt="Bounding Polygon" class="lightbox-image" loading="lazy">
</a></p>
<p>The polygon can be represented as a data structure using a collection of vectors from its origin (the same <code>origin</code> we use in rendering the sprite) to the points defining its corners:</p>
<p>
<a href="#image-a3e4093d7a3010d19fbcfd63a88738b0" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.3.png" alt="Bounding Polygon vectors" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-a3e4093d7a3010d19fbcfd63a88738b0">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.3.png" alt="Bounding Polygon vectors" class="lightbox-image" loading="lazy">
</a></p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A struct representing a convex bounding polygon</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingPolygon</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The corners of the bounding polygon, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// in relation to its origin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IEnumerable&lt;Vector2&gt; Corners;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The center of the polygon in the game world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Center;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>But can we detect collisions between arbitrary polygons? Yes we can, but it requires more work (which is why many sprites stick to a rectangular or circular shape).</p>
<h2 id="separating-axis-theorem">Separating Axis Theorem</h2>
<p>To detect polygon collisions algorithmically, we turn to the <a href="https://en.wikipedia.org/wiki/Hyperplane_separation_theorem#Use_in_collision_detection" target="_blank"><em>separating axis theorem</em></a>
, which states:</p>
<blockquote>
<p>For any n-dimensional euclidean space, if we can find a hyperplane separating two closed, compact sets of points we can say there is no intersection between the sets.</p>
</blockquote>
<p>As games typically only deal with 2- or 3-dimensional space, we can re-express these general claims in a more specific form:</p>
<p><em>For 2-dimensional space</em>: If we can find a separating axis between two convex shapes, we can say there is no intersection between them.</p>
<p><em>For 3-dimensional space</em>: If we can find a separating plane between two convex shapes we can say there is no intersection between them.</p>
<p>This is actually common-sense if you think about it.  If you can draw a line between two shapes without touching either one, they <em>do not overlap</em>. In a drawing, this is quite easy to do - but we donât have the luxury of using our human minds to solve this problem; instead weâll need to develop an algorithmic process to do the same.</p>
<p>We can accomplish this by <em>projecting</em> the shapes onto an axis and checking for overlap.  If we can find one axis where the projections donât overlap, then we can say that the two shapes donât collide (you can see this in the figure to the left).  This is exactly the process we used with the bounding box collision test earlier - we simply tested the x and y-axis for separation.</p>
<p>Mathematically, we represent this by projecting the shapes onto an axis - think of it as casting a shadow.  If we can find an axis where the two shadows don&rsquo;t overlap, then we know the two don&rsquo;t intersect:</p>
<p>
<a href="#image-0cb99193cd1c99536c32300b6dff0d1d" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.4.png" alt="Projecting arbitrary shapes onto a separating axis" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0cb99193cd1c99536c32300b6dff0d1d">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.4.png" alt="Projecting arbitrary shapes onto a separating axis" class="lightbox-image" loading="lazy">
</a></p>
<p>How do we accomplish the projection?  Consider each edge (the line between vertices in our polygon) as vector $A$, and the projection axis as vector $B$, as in the following figure:</p>
<p>
<a href="#image-9c15a17a0399e7b28c21575d385fd419" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.5.png" alt="Mathematical projection onto an axis" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9c15a17a0399e7b28c21575d385fd419">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.5.png" alt="Mathematical projection onto an axis" class="lightbox-image" loading="lazy">
</a></p>
<p>We have two formula that can be useful for interpreting this figure: the trigonometric definition of cosine (1) and the geometric definition of the cross-product (2).</p>
<p>$$
cos\theta = \frac{|projection\ of\ A\ onto\ B|}{|A|} \tag{1}
$$</p>
<p>$$
A \cdot B = |A||B|cos\theta \tag{2}
$$</p>
<p>These two equations can be combined to find a formula for projection (3):</p>
<p>$$
projection\ of\ A\ onto\ B = A \cdot \overline{B}, where\ \overline{B} \text{ is a unit vector in the direction of B} \tag{3}
$$</p>
<p>Thus, given two vectors - one for the axis (which needs to be a unit vector), and one to a corner of our collision polygon, we can project the corner onto the axis.  If we do this for <em>all</em> corners, we can find the minimum and maximum projection from the polygon.</p>
<p>A helper method to do this might be:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> MinMax FindMaxMinProjection(BoundingPolygon poly, Vector2 axis)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> projection = Vector2.Dot(poly.Corners[<span style="color:#ae81ff">0</span>], axis);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> max = projection;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> min = projection;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> i = <span style="color:#ae81ff">1</span>; i &lt; poly.Corners.Length; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        projection = Vector2.Dot(poly.Corners[i], axis);
</span></span><span style="display:flex;"><span>        max = max &gt; projection ? max : projection;
</span></span><span style="display:flex;"><span>        min = min &lt; projection ? min : projection;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> MinMax(min, max);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And the class to represent the minimum and maximum bounds:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// An object representing minimum and maximum bounds</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MinMax</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The minimum bound</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Min;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The maximum bound</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Max;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new MinMax pair</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> MinMax(<span style="color:#66d9ef">float</span> min, <span style="color:#66d9ef">float</span> max)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Min = min;
</span></span><span style="display:flex;"><span>        Max = max;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Since we would only be using this class within the collision helper, we could declare it within that class and make it private - one of the few times it makes sense to declare a private class.</p>
<p>If we determine the minimum and maximum projection for <em>both</em> shapes, we can see if they overlap:</p>
<p>
<a href="#image-f2a61abe2378b4f8e0f45c0a04440279" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.6.png" alt="Projecting Bounding Polygons onto an axis" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f2a61abe2378b4f8e0f45c0a04440279">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.6.png" alt="Projecting Bounding Polygons onto an axis" class="lightbox-image" loading="lazy">
</a></p>
<p>If there is no overlap, then we have found a separating axis, and can terminate the search.</p>
<p>But just which axes should we test?  Ideally weâd like a minimal set that promises if a separating axis does exist, it will be found.  Geometrically, it can be shown that the bare minimum we need to test is an axis parallel to each edge normal of the polygon - that is, an axis at a right angle to the polygonâs edge.  Each edge has two normals, a left and right:</p>
<p>
<a href="#image-d9cf566411480e2fefe540da4539fd1b" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.7.png" alt="The edge normals" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d9cf566411480e2fefe540da4539fd1b">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.4.7.png" alt="The edge normals" class="lightbox-image" loading="lazy">
</a></p>
<p>In 2D, an edge normal is a unit vector (of length 1) perpendicular to the edge vector (a vector along the edge).  We can calculate it by exchanging the x and y components and negating one of them.</p>
<p>Depending on the order weâve declared our points (clockwise or anti-clockwise) one of these normals will face out of the polygon, while the other will face in.  As long as weâre consistent, either direction will work.  We calculate the normals by iterating over our points and creating vectors to represent each edge, and then calculating a perpendicular vector to that edge.</p>
<p>If we were to keep using a <code>struct</code> to represent our collision shape, we could add a field for the normals and implement the normal generation within the constructor:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A struct representing a convex bounding polygon</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BoundingPolygon</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The corners of the bounding polygon, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// in relation to its center</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2[] Corners;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The center of the polygon in the game world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Center;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The normals of each corner of this bounding polygon</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2[] Normals;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new arbitrary convex bounding polygon</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// In order to be used with Separating Axis Theorem, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// the bounding polygon MUST be convex.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;center&#34;&gt;The center of the polygon&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;corners&#34;&gt;The corners of the polygon&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BoundingPolygon(Vector2 center, IEnumerable&lt;Vector2&gt; corners)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Store the center and corners</span>
</span></span><span style="display:flex;"><span>        Center = center;
</span></span><span style="display:flex;"><span>        Corners = corners.ToArray();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Determine the normal vectors for the sides of the shape</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We can use a hashset to avoid duplicating normals</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> normals = <span style="color:#66d9ef">new</span> HashSet&lt;Vector2&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Calculate the first edge by subtracting the first from the last corner</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> edge = Corners[Corners.Length - <span style="color:#ae81ff">1</span>] - Corners[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Then determine a perpendicular vector </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> perp = <span style="color:#66d9ef">new</span> Vector2(edge.Y, -edge.X);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Then normalize </span>
</span></span><span style="display:flex;"><span>        perp.Normalize();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add the normal to the list</span>
</span></span><span style="display:flex;"><span>        normals.Add(perp);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Repeat for the remaining edges</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> i = <span style="color:#ae81ff">1</span>; i &lt; Corners.Length; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            edge = Corners[i] - Corners[i - <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            perp = <span style="color:#66d9ef">new</span> Vector2(edge.Y, -edge.X);
</span></span><span style="display:flex;"><span>            perp.Normalize();
</span></span><span style="display:flex;"><span>            normals.Add(perp);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Store the normals</span>
</span></span><span style="display:flex;"><span>        Normals = normals.ToArray();
</span></span><span style="display:flex;"><span>    }    </span></span></code></pre></div><p>To detect a collision between two <code>BoundingPolygons</code>, we iterate over their combined normals, generating the <code>MinMax</code> of each and testing it for an overlap.  Implemented as a method in our <code>CollisionHelper</code>, it would look like something like this:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Detects a collision between two convex polygons</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p1&#34;&gt;the first polygon&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;p2&#34;&gt;the second polygon&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;returns&gt;true when colliding, false otherwise&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> Collides(BoundingPolygon p1, BoundingPolygon p2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check the first polygon&#39;s normals</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> normal <span style="color:#66d9ef">in</span> p1.Normals)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Determine the minimum and maximum projection </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// for both polygons</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> mm1 = FindMaxMinProjection(p1, normal);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> mm2 = FindMaxMinProjection(p2, normal);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Test for separation (as soon as we find a separating axis,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we know there is no possibility of collision, so we can </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// exit early)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (mm1.Max &lt; mm2.Min || mm2.Max &lt; mm1.Min) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Repeat for the second polygon&#39;s normals</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> normal <span style="color:#66d9ef">in</span> p2.Normals)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Determine the minimum and maximum projection </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// for both polygons</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> mm1 = FindMaxMinProjection(p1, normal);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> mm2 = FindMaxMinProjection(p2, normal);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Test for separation (as soon as we find a separating axis,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we know there is no possibility of collision, so we can </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// exit early)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (mm1.Max &lt; mm2.Min || mm2.Max &lt; mm1.Min) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If we reach this point, no separating axis was found</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// and the two polygons are colliding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We can also treat our other collision shapes as special cases, handling the projection onto an axis based on their characteristics (i.e. a circle will always have a min and max of projection of center - radius and projection of center + radius).</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="per-pixel-collision-detection">Per-Pixel Collision Detection</h1>

<p>Another brute-force approach that can be used with raster graphics when a high degree of accuracy is needed is per-pixel collision detection.  This process assumes that a portion of the raster graphics being examined are composed of transparent pixels (i.e. not a part of the object portrayed).</p>
<p>
<a href="#image-915b8613286be9cadfb1e7272f49f699" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.5.1.png" alt="An example of where per-pixel collision detection is useful - the two raster graphics overlap, yet the helicopters are not colliding" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-915b8613286be9cadfb1e7272f49f699">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/4.5.1.png" alt="An example of where per-pixel collision detection is useful - the two raster graphics overlap, yet the helicopters are not colliding" class="lightbox-image" loading="lazy">
</a></p>
<p>Consider the figure above - there are two raster graphics that overlap.  To determine if they collide on a per-pixel basis, we must compare every overlapping pixel between the two images (the purple area).  To do this, we must 1) establish the size of the overlapping area, 2) map pixel indices within that area to an index in each graphic, and 3) compare the corresponding pixels in each graphic to see if they are both non-transparent (and therefore colliding).</p>
<p>The following pseudocode does just that for an overlapping area of 200x300 pixels, with the overlapping area beginning at (600, 0) in raster graphic 1 and (0, 10) in raster graphic 2:</p>
<div class="wrap-code highlight"><pre tabindex="0"><code>for(x = 0; x &lt; 200; x++) {
    for(y = 0; y &lt; 300; y++) {
        if( !(isTransparent(raster1[x + 600][y]) || isTransparent(raster2[x][y+10]) ) {
          return true;
        }
    }
   return false;
}</code></pre></div><p>Note that we short-circuit our investigation as soon as we find an overlapping pixel that is not transparent in at least one of the raster arrays.  Yet our worse-case scenario is $O(width x height)$ of the overlapping region.</p>
<p>Implementing per-pixel collision detection in MonoGame requires us to extract the texture data with <code>Texture2D.GetData()</code>, into which we need to pass an array of <code>Color</code>, i.e. given a <code>Texture2D</code> variable <code>texture</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> textureData = <span style="color:#66d9ef">new</span> Color[texture.Width * texture.Height];
</span></span><span style="display:flex;"><span>texture.GetData(textureData);</span></span></code></pre></div><p>Then we can access the individual colors in the array.  However, we must <em>also</em> account for how the texture is positioned in the world.  This gets even more complicated if the texture has been scaled or rotated.  Ratstating describes one approach to tackling this in his post <a href="https://rastating.github.io/xna-per-pixel-collision-detection-on-rotated-objects/" target="_">C# XNA Per Pixel Collision Detection on Rotated Objects</a>.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="multiphase-collision-detection">Multiphase Collision Detection</h1>

<p>It should be clear that the per-pixel and SAT-based approaches can become very computationally expensive.  For this reason, games that need fine-grained collision detection often resort to a multi-phase approach, which utilizes two or more processing passes.  Each pass uses an increasingly sophisticated (and therefore costly) collision detection algorithm to find collisions, but only tests those objects that previous passes identified as âpossibly collidingâ.  The more simple methods employed in the first few passes typically can reject a great deal of possible collisions, reducing the number of more expensive comparisons that will be tried later.</p>
<p>The first pass typically consists of testing using axis-aligned bounding boxes or bounding circles, which bound (enclose) the object.  As we have already seen, there are very quick collision tests to use with both axis-aligned bounding boxes and with circles.  And pair of objects whose bounding areas register a collision are placed in a queue (as a pair) for testing in the next pass.</p>
<p>The next pass will typically resort to a SAT-based algorithm using a simplified outline of the shape in question.  This may be the final pass, or it may be used to identify shapes for per-pixel collision detection (or the second pass may be per-pixel detection).</p>
<p>In games that use hierarchical sprite representations (where a sprite may be composed of sub-sprites), the first pass is a bounding area for the entire sprite, but the second pass compares individual parts (often bounding areas for each subpart), which can then be further refined by a SAT or per-pixel approach.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we looked at implementing collision detection using bounding shapes, the separating axis theorem, and per-pixel evaluation.  We discussed the merits of the different approaches, and saw how multiphase collision detection can avoid expensive collision detection tests.</p>
<p>There are other techniques we can use to avoid unneeded collision tests as well.  We&rsquo;ll talk about one of these, spatial partitioning in an upcoming chapter.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="audio">Audio</h1>

<h3 id="chapter-5">Chapter 5</h3>
<h1 id="audio">Audio</h1>
<p>Get your games rocking!</p>
<img src="https://media.giphy.com/media/ahqXZjdmep0Zy/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Audio</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>We often focus on the <em>visual</em> aspects of games, but the <em>audio</em> aspects can really make a game shine.  Consider that many game tracks are now presented as orchestral performances:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/DgslU4EKKHY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nOJi5QSxJbw" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>And how important sound effects can be for conveying what is happening in a game?</p>
<p>In this chapter, we will explore both sound effects and music, and how to implement them within MonoGame.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="sound-effects">Sound Effects</h1>

<p>From the &ldquo;bing&rdquo; of a coin box in <em>Super Mario Bros</em> to the reveal chimes of the <em>Zelda</em> series, sound effects provide a powerful mechanism for informing the player of what is happening in your game world.</p>
<h3 id="soundeffect-class">SoundEffect Class</h3>
<p>MonoGame represents sound effects with the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.SoundEffect.html" target="_blank"><code>SoundEffect</code></a>
 class.  Like other asset types, we don&rsquo;t normally construct this directly, we rather load it through the content pipeline.  Usually, a sound effect will start as a <em>.wav</em> file, though a handful of other file formats are acceptable.</p>
<p>Once loaded, the <code>SoundEffect</code> can be played with the <code>SoundEffect.Play()</code> method. This is essentially a fire-and-forget method - you invoke, it and the framework takes care of loading and playing the sound.</p>
<p>You can also use the <code>SoundEffect.Play(float volume, float pitch, float pan)</code> to customize the playback:</p>
<ul>
<li><code>volume</code> ranges from $0.0$ (silence) to $1.0$ (full volume)</li>
<li><code>pitch</code> adjusts the pitch from $-1.0$ (down an octave) to $1.0$ (up an octave), with $0.0$ indicating no change</li>
<li><code>pan</code> pans the sound in stereo, with $-1.0$ entirely on the left speaker, and $1.0$ on the right, and $0.0$ centered.</li>
</ul>
<p>Note that the per-sound-effect volume is multiplied by the static <code>SoundEffect.MasterVolume</code> property. This allows for the adjustment of <em>all</em> sound effects in the game, separate from music.</p>

  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>Note that if you invoke <code>Play()</code> on a sound effect multiple frames in a row, it will start playing another copy of the sound effect on each frame.  <em>The result will be an ugly mash of sound</em>.  So be sure that you only invoke <code>Play()</code> <em>once</em> per each time you want to use the sound!</p>
</div>
</div>
<h3 id="soundeffectinstance-class">SoundEffectInstance Class</h3>
<p>If you need finer control of your sound effects, you can also create a <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.SoundEffectInstance.html" target="_blank"><code>SoundEffectInstance</code></a>
 from one with: <code>SoundEffect.CreateInstance()</code>.  This represents a single <em>instance</em> of a sound effect, so invoking its <code>Play()</code> method will restart the sound from the beginning (essentially, <code>SoundEffect.Play()</code> creates a <code>SoundEffectInstance</code> that plays and disposes of itself automatically).</p>
<p>The <code>SoundEffectInstance</code> exposes properties that can be used to modify its behavior:</p>
<ul>
<li><code>IsLooped</code> is a boolean that when set to true, causes the sound effect to loop indefinitely.</li>
<li><code>Pan</code> pans the sound in stereo, with $-1.0$ entirely on the left speaker, and $1.0$ on the right, and $0.0$ centered.</li>
<li><code>Pitch</code> adjusts the pitch from $-1.0$ (down an octave) to $1.0$ (up an octave), with $0.0$ indicating no change</li>
<li><code>Volume</code> ranges from $0.0$ (silence) to $1.0$ (full volume)</li>
<li><code>State</code> returns a <code>SoundState</code> enumeration value, one of (<code>SoundState.Paused</code>, <code>SoundState.Playing</code>, or <code>SoundState.Stopped</code>)</li>
</ul>
<p>The <code>SoundEffectInstance</code> also provides a number of methods:</p>
<ul>
<li><code>Play()</code> plays or resumes the sound effect</li>
<li><code>Pause()</code> pauses the sound effect</li>
<li><code>Resume()</code> resumes a paused sound effect</li>
<li><code>Stop()</code> immediately stops the sound effect (so when started it starts from the beginning)</li>
<li><code>Stop(bool immediate)</code> also stops the sound effect, immediately if <code>true</code>, or its authored release phase, i.e. a fade, if <code>false</code></li>
</ul>
<p>Perhaps the strongest reason for creating a <code>SoundEffectInstance</code> is to be able to crate positional sound.  We&rsquo;ll discuss this next.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="positional-sounds">Positional Sounds</h1>

<p>Positional sounds provide the illusion of depth and movement by using panning, doppler shift, and other techniques to emulate the affect movement and distance have on sounds.  Positional sounds can convey important information in games, especially when combined with surround-sound speakers and headphones.</p>
<p>To create positional sound effects, we need to place the sound in a 3D (or pseudo 2D) soundscape, which incorporates both a <em>listener</em> (i.e. the player) and an <em>emitter</em> (the source of the sound).  Consider the example soundscape below:</p>
<p>
<a href="#image-d97daf54d113d520d11bfd7e84f0e003" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/5.3.1.png" alt="An example soundscape" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-d97daf54d113d520d11bfd7e84f0e003">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/5.3.1.png" alt="An example soundscape" class="lightbox-image" loading="lazy">
</a></p>
<p>We have two sound effects, one played by <em>emitter A</em> and one by <em>emitter B</em>, and the player is represented by the <em>listener</em>.  If we imagine the listener is facing downwards, we would expect that the sound from emitter A will play more on the right speaker, and emitter B on the left (given stereo speakers).  For a surround sound system, these would be further distinguished by playing on the <em>front</em> speakers.</p>
<p>In addition to determining which speaker(s) a sound is played with, positional sounds also usually incorporate <em>attenuation</em> and <em>doppler effect</em>.</p>
<p><a href="https://en.wikipedia.org/wiki/Acoustic_attenuation" target="_blank">Attenuation</a>
 in this context means that sound waves get softer the farther they travel (as some of the energy in the wave is absorbed by the air as heat).  Thus, as emitter B is farther from the listener than emitter A, we would expect that if the same sound were played by both emitters, emitter B would be softer.</p>
<p><a href="https://en.wikipedia.org/wiki/Doppler_effect" target="_blank">Doppler effect</a>
 refers to the change in pitch of a sound when either the emitter or listener is moving.  When the distance between the emitter and listener  is getting smaller, the sound waves emitted by the emitter are closer together (higher frequency), resulting in a higher pitch.  And when they are moving apart, the waves are farther apart, resulting in a lower frequency and pitch.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>Position, attenuation, and doppler effect represent some of the easiest-to-implement aspects of the physics of sound, which is why they are commonly implemented in video game audio libraries.  More complex is the interaction of sound with the environment, i.e. absorption and reflection by surfaces in the game world. This parallels the early days of 3D rendering, when the Phong illumination model (which we&rsquo;ll talk about soon) provided a simplistic but adequate technique for handling lights in a 3D scene.</p>
</div>
</div>
<p>The MonoGame framework provides two classes for establishing positional sound, the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.AudioEmitter.html" target="_blank"><code>AudioEmitter</code></a>
 and <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Audio.AudioListener.html" target="_blank"><code>AudioListener</code></a>
.</p>
<h3 id="audiolistener-class">AudioListener Class</h3>
<p>The <code>AudioListener</code> class represents the player (or microphone) in the game world, and all position, attenuation, and doppler effects are calculated relative to its position, orientation, and velocity.  It exposes four properties:</p>
<ul>
<li><code>Position</code> is a <code>Vector3</code> defining the position of the listener in the game world</li>
<li><code>Forward</code> is a <code>Vector3</code> defining the direction the listener is facing in the game world.</li>
<li><code>Up</code> is a <code>Vector3</code> defining the direction <em>up</em> relative to the direction the player is facing (generally it would be <code>Vector3.Up</code>).  It is used as part of the 3D math calculating the effects.</li>
<li><code>Velocity</code> is a <code>Vector3</code> defining the velocity at which the listener is moving in the game world.</li>
</ul>
<p>When using an <code>AudioListener</code> instance, you would set these each update to reflect the corresponding position, orientation, and velocity of the player.</p>
<h3 id="audioemitter-class">AudioEmitter Class</h3>
<p>The <code>AudioEmitter</code> class represents the source of a sound in the game world.  It exposes the same properties as the <code>AudioListener</code>:</p>
<ul>
<li><code>Position</code> is a <code>Vector3</code> defining the position of the emitter in the game world</li>
<li><code>Forward</code> is a <code>Vector3</code> defining the direction the emitter is facing in the game world.</li>
<li><code>Up</code> is a <code>Vector3</code> defining the direction <em>up</em> relative to the direction the emitter is facing (generally it would be <code>Vector3.Up</code>).  It is used as part of the 3D math calculating the effects.</li>
<li><code>Velocity</code> is a <code>Vector3</code> defining the velocity at which the emitter is moving in the game world.</li>
</ul>
<h3 id="playing-positional-sound">Playing Positional Sound</h3>
<p>Positional sounds are played by a <code>SoundEffectInstance</code>, not by the actual emitter; the emitter rather serves to locate the sound source.  Thus, to calculate and apply the 3D effects on a sound effect we would use something like:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>SoundEffect sfx = Content.Load&lt;sfx&gt;(<span style="color:#e6db74">&#34;sound&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> instance = sfx.CreateInstance();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> listener = <span style="color:#66d9ef">new</span> AudioListener();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// TODO: Position and orient listener </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> emitter = <span style="color:#66d9ef">new</span> AudioEmitter();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// TODO: Position and orient emitter</span>
</span></span><span style="display:flex;"><span>instance.Apply3D(listener, emitter);</span></span></code></pre></div><h3 id="using-positional-sound-in-a-2d-game">Using Positional Sound in a 2D Game</h3>
<p>The positional sound support in MonoGame is for 3D soundscapes, but just as we can render 2D sprites using 3D hardware, we can create 2D soundscapes in 3D.  The easiest technique for this is to position all our emitters and listeners in the plane $z=0$.</p>
<p>The <code>Vector3</code> constructor actually has support for this built-in as it can take a <code>Vector2</code> for the <code>X</code> and <code>Y</code> components, and a separate scalar for the <code>Z</code> component.  Consider a game where we represent the player&rsquo;s position with a <code>Vector2 position</code>, direction with a <code>Vector2 direction</code>, and velocity with a <code>Vector2 velocity</code>.  We can update our <code>AudioListener listener</code> with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Update listener properties</span>
</span></span><span style="display:flex;"><span>listener.Position = <span style="color:#66d9ef">new</span> Vector3(position, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>listener.Forward = <span style="color:#66d9ef">new</span> Vector3(direction, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>listener.Velocity = <span style="color:#66d9ef">new</span> Vector3(velocity, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div><p>Since the <code>Up</code> vector will never change, we can just set it to <code>Vector3.UnitZ</code> (which is the vector $&lt;0,0,1&gt;$) when we first create the listener.</p>
<p>The emitters would be set up the same way.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="music">Music</h1>

<p>Music also has a powerful role to play in setting the mood.  It can also be used to convey information to the player, as <em>Super Mario Bros</em> does when the remaining time to finish the level falls below 1 minute.</p>
<h3 id="song-class">Song Class</h3>
<p>While it is possible to play music using a <code>SoundEffect</code>,
MonoGame supports music through the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Media.Song.html" target="_blank"><code>Song</code></a>
 class.  This represents a song loaded from a wav or mp4 file.</p>
<p>In addition to the audio data, the <code>Song</code> defines properties for accessing the audio file&rsquo;s metadata:</p>
<ul>
<li><code>Name</code> is the name of the song</li>
<li><code>Album</code> is the album the song is from</li>
<li><code>Artist</code> is the song&rsquo;s artist</li>
<li><code>Duration</code> is the length of the song.</li>
<li><code>Genre</code> is the genre of the song</li>
<li><code>TrackNumber</code> is song&rsquo;s track number on its album</li>
</ul>
<p>Note that for these properties to be populated, the original audio file would need to have the corresponding metadata set.</p>
<p>Unlike the <code>SoundEffect</code>, the <code>Song</code> class does not have a play method.  Instead it is played with the static <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Media.MediaPlayer.html" target="_blank"><code>MediaPlayer</code></a>
 class, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Song song = Content.Load&lt;Song&gt;(<span style="color:#e6db74">&#34;mysong&#34;</span>);
</span></span><span style="display:flex;"><span>MediaPlayer.Play(song);</span></span></code></pre></div><h3 id="songcollection-class">SongCollection Class</h3>
<p>Invoking <code>MediaPlayer.Play()</code> will <em>immediately end the current song</em>, so if you want your game to transition between songs smoothly, you&rsquo;ll probably want to use the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Media.SongCollection.html" target="_blank"><code>SongCollection</code></a>
 class.</p>
<p>As you might expect, this is a collection of <code>Song</code> objects, and implements methods:</p>
<ul>
<li><code>Add(Song song)</code> adds a song to the collection</li>
<li><code>Clear()</code> clears the collection.</li>
</ul>
<p><code>SongCollections</code> can also be played with the static <code>MediaPlayer.Play(SongCollection collection)</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Song song1 = Content.Load&lt;Song&gt;(<span style="color:#e6db74">&#34;song1&#34;</span>);
</span></span><span style="display:flex;"><span>Song song2 = Content.Load&lt;Song&gt;(<span style="color:#e6db74">&#34;song2&#34;</span>);
</span></span><span style="display:flex;"><span>Song song3 = Content.Load&lt;Song&gt;(<span style="color:#e6db74">&#34;song3&#34;</span>);
</span></span><span style="display:flex;"><span>SongCollection songCollection = <span style="color:#66d9ef">new</span> SongCollection();
</span></span><span style="display:flex;"><span>songCollection.Add(song1);
</span></span><span style="display:flex;"><span>songCollection.Add(song2);
</span></span><span style="display:flex;"><span>songCollection.Add(song3);
</span></span><span style="display:flex;"><span>MediaPlayer.Play(songCollection);</span></span></code></pre></div><h3 id="the-mediaplayer-class">The MediaPlayer Class</h3>
<p>The static <code>MediaPlayer</code> class is really an interface to the Windows Media Player.  Unlike the <code>SoundEffect</code> class, which communicates directly with the sound card and manipulates audio buffers, songs are piped through the Windows Media Player.  Hence, the reason <code>MediaPlayer</code> can only play a single song at a time.</p>
<p>Some of the most useful properties of the <code>MediaPlayer</code> for games are:</p>
<ul>
<li><code>IsMuted</code> - A boolean property that can be used to mute or unmute the game&rsquo;s music</li>
<li><code>Volume</code> - A number between 0 (silent) and 1 (full volume) that the music will play at</li>
<li><code>IsRepeating</code> - A boolean property that determines if the song or song list should repeat</li>
<li><code>IsShuffled</code> - A boolean property that determines if a song list should be played in a shuffled order</li>
<li><code>State</code> - A value of the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.Media.MediaState.html" target="_blank"><code>MediaState</code></a>
 enum, describing the current state of the media player, which can be <code>MediaState.Paused</code>, <code>MediaState.Playing</code>, or <code>MediaState.Stopped</code>.</li>
</ul>
<p>Much like you would expect from a media playing device, the <code>MediaPlayer</code> also implements some familiar controls as methods:</p>
<ul>
<li><code>Play(Song song)</code> and <code>Play(SongList songList)</code> play the specified song or song list.</li>
<li><code>Pause()</code> pauses the currently playing song</li>
<li><code>Resume()</code> resumes a paused song</li>
<li><code>Stop()</code> stops playing the current song</li>
<li><code>MoveNext()</code> moves to the next song in the song list</li>
<li><code>MovePrevious()</code> moves to the previous song in the song list</li>
</ul>
<p>In addition, the <code>MediaPlayer</code> implements two events that may be useful:</p>
<ul>
<li><code>ActiveSongChanged</code> - triggered when the active song changes</li>
<li><code>MediaStateChanged</code> - triggered when the media state changes</li>
</ul>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>This section only touches on the classes, methods and properties of the <code>Microsoft.Xna.Framework.Media</code> namespace most commonly used in games.  Because it is a wrapper around the Windows Media Player, it is also possible to access and play the users&rsquo; songs and playlists that have been added to Windows Media Player.  Refer to the MonoGame documentation for more details.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="physics">Physics</h1>

<p>For every action&hellip;</p>
<img src="https://media.giphy.com/media/o65WgXSDBVY1G/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Physics</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Much of gameplay derives from how agents in the game world (players, enemies, puzzle pieces, interactive items, etc) interact with each other.  This is the domain of <em>physics</em>, the rules of how physical (or game) objects interact.  In a sense the game physics define how the game&rsquo;s simulation will unfold.</p>
<p>While game physics often correlate to the physics of the world we inhabit <em>they don&rsquo;t have to!</em>  In fact, most game physics approaches at least <em>simplify</em> real-world physics models to allow for real-time processing, and some abandon real-world physics altogether.</p>
<p>When games <em>do</em> try to implement realistic physics, they typically start with <em>rigid body dynamics</em>, a simplification of real-world physics where objects are represented as a <em>rigid body</em> and a <em>point mass</em>.  In games, the rigid body is essentially the collision shape we covered in chapter 4, and a point mass represents the object&rsquo;s position as a vector, and the mass as a float.</p>
<p>In this chapter we&rsquo;ll examine how to implement rigid body physics in games.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="linear-dynamics">Linear Dynamics</h1>

<p>At some point in your K-12 education, you probably encountered the equations of linear motion, which describe motion in terms of time, i.e.:</p>
<p>$$v = at + v_0 \tag{1}$$
$$p = p_0 + v_ot + \frac{1}{2}at^2 \tag{2}$$
$$p = p_0 + \frac{1}{2}(v+v_0)t \tag{3}$$
$$v^2 = v_0^2 2a(r - r_0) \tag{4}$$
$$p = p_0 + vt - \frac{1}{2}at^2 \tag{5}$$</p>
<p>These equations can be used to calculate motion in a video game setting as well, i.e. to calculate an updated position <code>vector2 position</code> given velocity <code>vector2 velocity</code> and acceleration <code>vector2 acceleration</code>, we can take equation (5):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>position += velocity * gameTime.ElapsedGameTime.TotalSeconds + <span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">2</span> * acceleration * Math.Pow(gameTime.ElapsedGameTime.TotalSeconds);</span></span></code></pre></div><p>This seems like a lot of calculations, and it is.  If you&rsquo;ve also taken calculus, you probably encountered the relationship between position, velocity, and acceleration.</p>
<blockquote>
<p>position is where the object is located in the world
velocity is <em>the rate of change</em> of the position
acceleration is <em>the rate of change</em> of the velocity</p>
</blockquote>
<p>If we represent the position as a function (6), then <em>velocity is the derivative of that function</em> (7), and the acceleration <em>is the second derivative</em> (8):</p>
<p>$$s(t) \tag{6}$$
$$v(t) = s&rsquo;(t) \tag{7}$$
$$a(t) = v&rsquo;(t) \tag{8}$$</p>
<p>So, do we need to do calculus to perform game physics?  Well, yes and no.</p>
<p>Calculus is based around the idea of looking at small sections of a function (it literally comes from the latin term for &ldquo;small stone&rdquo;).  Differential calculus cuts a function curve into small pieces to see how it changes, and Integral calculus joins small pieces to see how much there is.</p>
<p>Now consider our timestep - 1/30th or 1/60th of a second.  That&rsquo;s already a pretty small piece.  So if we want to know the current velocity, given our acceleration, we could <em>just look at that small piece</em>, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>velocity += acceleration * gameTime.elapsedGameTime.TotalSeconds;</span></span></code></pre></div><p>Similarly, our position is:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>position += velocity * gameTime.elapsedGameTime.TotalSeconds</span></span></code></pre></div><p>That&rsquo;s it.  We can consider our acceleration as an instantaneous change (i.e. we apply a force).  Remeber the definition of force?</p>
<p>$$\overline{F} = m\overline{a} \tag{9}$$</p>
<p>So to find our acceleration, we rearrange equation 9 to read:</p>
<p>$$\overline{a} = \overline{F}/m$$</p>
<p>Thus, our acceleration would be the force acting on the body, divided by the mass of the body.  We could calculate this from real values, or try different numbers until we found ones that &ldquo;felt right&rdquo;.</p>
<p>If we have multiple forces acting on an object, we simply sum the individual accelerations to find the net acceleration at that instant, which is then applied to the velocity.</p>

  
  
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fa-fw fas fa-lightbulb"></i> Tip</div>
  <div class="box-content">

<p>Games are a &ldquo;soft&rdquo; simulation, in that we are emulating, but often not <em>duplicating</em> behavior of objects the real world.  This also brings into play <a href="https://en.wikipedia.org/wiki/Hyperreality" target="_blank">hyperreality</a>
, a philosophical concept that deals with modern humans&rsquo; inability to distinguish perceptions of reality and simulated realities.</p>
<p>One great example is LucasArt&rsquo;s <a href="https://en.wikipedia.org/wiki/Digital_Molecular_Matter" target="_blank">Digital Molecular Matter</a>
 developed for the <em>Force Unleashed</em> series.  Early tests with the physics engine duplicated the breaking of objects based on the actual molecular physics involved.  Playtesters responded that it &ldquo;felt fake&rdquo; as wood did not explode into splinters and glass did not shatter into clouds of thousands of pieces when broken&hellip; so the developers made the effects more unrealistically intense to satisfy player expectations.</p>
</div>
</div>
<h3 id="lunar-lander">Lunar Lander</h3>
<p>Let&rsquo;s look at a simple example, a lunar-lander style game.  We have a lunar lander that has a downward-facing thruster that the player can fire with the spacebar, causing an acceleration of 10 pixels/second<sup>2</sup>.  The lander is also moving laterally at a velocity of 100 pixels/second, and gravity is pulling downward at 5 pixels/second<sup>2</sup>.  We could write an update function like:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Initial velocity </span>
</span></span><span style="display:flex;"><span>Vector2 velocity = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> t = (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboardState.IsKeyDown(Keys.Space))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// apply thruster acceleration upward</span>
</span></span><span style="display:flex;"><span>        velocity += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">40</span>) * t;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// apply gravity downward</span>
</span></span><span style="display:flex;"><span>    velocity += <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">30</span>) * t
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update position</span>
</span></span><span style="display:flex;"><span>    position += velocity * t;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Note that we can avoid all those complicated calculations, <em>because we are only looking at a small slice of time</em>.  If we wanted to look at a bigger span of time, i.e. where a bomb might fall, we have to take more into account.</p>
<p>Also, notice that for this game, we ignore any friction effects (after all, we&rsquo;re in the vacuum of space).  Game programmers often take advantage of any simplifications to these calculations we can.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="angular-dynamics">Angular Dynamics</h1>

<p>There is a second set of equations that govern angular motion (rotation) you may have encountered, where $\omega$ is angular velocity, $\alpha$ the angular acceleration, and $\theta$ the rotation of the body:</p>
<p>$$\omega = \omega_0 + \alpha t \tag{1}$$
$$\theta = \theta_0 + \omega_0 t + \frac{1}{2}\alpha t^2 \tag{2}$$
$$\theta = \theta_0 + \frac{1}{2}(\omega_0 + \omega)t \tag{3}$$
$$\omega^2 = \omega_0^2 + 2\alpha(\theta-\theta_0) \tag{4}$$
$$\theta = \theta_0 + \omega t - \frac{1}{2}\alpha t^2 \tag{5}$$</p>
<p>These equations parallel those we saw for linear dynamics, and in fact, have the same derivative relationships between them:</p>
<p>$$\theta(t) \tag{6}$$
$$\omega(t) = \theta&rsquo;(t) \tag{7}$$
$$\alpha(t) = \omega&rsquo;(t) \tag{8}$$</p>
<p>And, just like linear dynamics, we can utilize this relationship and our small timestep to sidestep complex calculations in our code.  Thus, we can calculate the rotational change from the angular velocity (assuming <code>float rotation</code>, <code>angularVelocity</code>, and <code>angularAcceleration</code> values expressed in radians):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>rotation += angularVelocity * gameTime.elapsedGameTime.TotalSeconds;</span></span></code></pre></div><p>And the change in angular velocity can be calculated from the angular acceleration:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>angularAcceleration = angularVelocity * gameTime.elapsedGameTime.TotalSeconds;</span></span></code></pre></div><p>Finally, angular acceleration can be imposed with an instantaneous force.  However, this is slightly more complex than we saw with linear dynamics, as this force needs to be applied somewhere <em>other than the center of mass</em>.  Doing so applies both rotational and linear motion to an object.  This rotational aspect is referred to as <em>torque</em>, and is calculated by taking the cross product of the force&rsquo;s point of application relative to the center of mass and the force vector.  Thus:</p>
<p>$$\tau = \overline{r} x \overline{F}$$</p>
<p>Where $tau$ is our torque, $\overline{r}$ is the vector from the center of mass to where the force is applied, and $\overline{F}$ is the force vector.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>torque = force.X * r.Y - force.Y * r.X;</span></span></code></pre></div><p>Torque is the force imposing angular acceleration, and can be applied directly to the velocity:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>angularAcceleration += torque * gameTime.ElapsedGameTime.TotalSeconds;</span></span></code></pre></div><p>And much like force and linear acceleration, multiple torques applied to an object are summed.</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>XNA does not define the cross product function in its <code>Vector2</code> library, so we computed it manually above.  If you would like to add it as a method in your projects, we can do so using an <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/extension-methods" target="_blank">extension method</a>
, i.e. define in one of your game&rsquo;s namespaces:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Vector2Extensions</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Computes the cross product of two Vector2 structs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param ref=&#34;a&#34;&gt;The first vector&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param ref=&#34;b&#34;&gt;The second vector&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">float</span> CrossProduct(Vector2 a, Vector2 b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a.X * b.Y - a.Y * b.X;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Computes the cross product of this vector with another</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param ref=&#34;other&#34;&gt;the other vector&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">float</span> Cross(<span style="color:#66d9ef">this</span> Vector2 a, Vector2 other)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CrossProduct(a, other);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>As long as this class is in scope (i.e. you have an appropriate <code>using</code> statement), you should be able to invoke <code>Cross()</code> on any <code>Vector2</code>.  So the code listing:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>torque = force.X * r.Y - force.Y * r.X;</span></span></code></pre></div><p>Could be rewritten as:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>torque = force.Cross(r);</span></span></code></pre></div><p>Â </p>
</div>
</div>
<h3 id="rocket-thrust">Rocket Thrust</h3>
<p>Let&rsquo;s work through an example.  Consider this diagram:</p>
<p>
<a href="#image-3b9be2a95a4490b8e8757f11376eb481" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.3.1.png" alt="Torque applied to a spaceship" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-3b9be2a95a4490b8e8757f11376eb481">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.3.1.png" alt="Torque applied to a spaceship" class="lightbox-image" loading="lazy">
</a></p>
<p>The red arrow is the force vector applied from the left rocket.  The green arrow is the vector from the position the force is applied to the center of mass of the ship.  Firing just this one rocket will impose a rotation on the ship in the direction of the white arrow.  Firing <em>both</em> rockets will impose an opposite torque, cancelling both.</p>
<p>Let&rsquo;s write the control code for this spaceship.  We&rsquo;ll define class fields for both linear and angular velocity and acceleration, as well as position, direction, and angle.  We&rsquo;ll also supply a constant for the amount of linear acceleration applied by our spaceship:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Constants</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> LINEAR_ACCELERATION = <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Linear movement fields</span>
</span></span><span style="display:flex;"><span>Vector2 position;
</span></span><span style="display:flex;"><span>Vector2 direction;
</span></span><span style="display:flex;"><span>Vector2 velocity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Angular movement fields</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> angle; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> angularVelocity;</span></span></code></pre></div><p>Then we&rsquo;ll use these in our update method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    KeyBoardState keyboardState = Keyboard.GetState();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> t = (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>    Vector2 acceleration = Vector2.Zero; <span style="color:#75715e">// linear acceleration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> angularAcceleration = <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// angular acceleration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Determine if the left rocket is firing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboardState.IsKeyPressed(Keys.A))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// LABEL A: Apply linear force in the direction we face from left rocket</span>
</span></span><span style="display:flex;"><span>        acceleration += direction * LINEAR_ACCELERATION * t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO 1: Calculate and apply torque from left rocket</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Determine if the right rocket is firing </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboardState.IsKeyPressed(Keys.D))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// LABEL B: Apply linear force in the direction we face from right rocket</span>
</span></span><span style="display:flex;"><span>        acceleration += direction * LINEAR_ACCELERATION * t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO 2: Calculate and apply torque from right rocket</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Update linear velocity and position </span>
</span></span><span style="display:flex;"><span>    velocity += acceleration * t;
</span></span><span style="display:flex;"><span>    position += velocity * t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update angular velocity and rotation </span>
</span></span><span style="display:flex;"><span>    angularVelocity += angularAcceleration * t;
</span></span><span style="display:flex;"><span>    angle += angularVelocity * t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// LABEL C: Apply rotation to our direction vector  </span>
</span></span><span style="display:flex;"><span>    direction = Vector2.Transform(Vector2.UnitY, <span style="color:#66d9ef">new</span> Matrix.CreateRotationZ(theta));
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>There&rsquo;s a lot  going on in this method, so let&rsquo;s break it down in pieces, starting with the code following the <code>LABEL</code> comments:</p>
<h4 id="label-a--b---apply-linear-force-in-the-direction-we-face-from-left-rocket-and-right-rocket">LABEL A &amp; B - Apply linear force in the direction we face from left rocket and right rocket</h4>
<p>When we apply force against a body <em>not toward its center</em>, part of that force becomes torque, but the rest of it is linear acceleration.  Technically, we can calculate exactly what this is with trigonometry.  But in this case, we don&rsquo;t care - we just want the ship to accelerate in the direction it is facing.  So we multiply the <code>direction</code> vector by a constant representing the force divided by the mass of our spaceship (acceleration), and the number of seconds that force was applied.</p>
<p>Note that we consider our spaceship mass to be constant here.  If we were really trying to be 100% accurate, the mass would change over time as we burn fuel.  But that&rsquo;s extra calculations, so unless you are going for realism, it&rsquo;s simpler to provide a constant, a lÃ¡ <code>LINEAR_ACCELERATION</code>.  Yet another example of simplifying physics for games.</p>
<h4 id="label-c---apply-rotation-to-our-direction-vector">LABEL C - Apply rotation to our direction vector</h4>
<p>We need to know the direction the ship is facing to apply our linear acceleration.  Thus, we need to convert our angle <code>angle</code> into a <code>Vector2</code>.  We can do this with trigonometry:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>direction.X = (<span style="color:#66d9ef">float</span>)Math.Cos(theta);
</span></span><span style="display:flex;"><span>direction.Y = (<span style="color:#66d9ef">float</span>)Math.Sin(theta);</span></span></code></pre></div><p>Or we can utilize matrix operations:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>direction = Vector2.Transform(Vector2.UnitY, <span style="color:#66d9ef">new</span> Matrix.CreateRotationZ(theta));</span></span></code></pre></div><p>We&rsquo;ll discuss the math behind this second method soon.  Either method will work.</p>
<h3 id="todo-1-calculate-and-apply-torque-from-left-rocket">TODO 1: Calculate and apply torque from left rocket</h3>
<p>Here we need to insert code for calculating the torque.  First, we need to know the distance from the rocket engine to the center of mass of the ship.  Let&rsquo;s assume our ship sprite is $152x115$, and our center of mass is at $&lt;76,50&gt;$.  Thus, our <code>r</code> vector would be:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 r = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">76</span>,<span style="color:#ae81ff">50</span>);</span></span></code></pre></div><p>The second value we need is our force.  We could factor in our ship rotation at this point, but it is easier if we instead rotate our coordinate system and place its origin at the center of mass for the ship, i.e.:</p>
<p>
<a href="#image-e3ff97170bb649d3e6986d65b72a0219" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.3.2.png" alt="The rotated coordinate system" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e3ff97170bb649d3e6986d65b72a0219">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.3.2.png" alt="The rotated coordinate system" class="lightbox-image" loading="lazy">
</a></p>
<p>Then our force vector is simply a vector in the upward direction, whose magnitude is the amount of the force tangential to the <code>r</code> vector.  For simplicity, we&rsquo;ll use a literal constant instead of calculating this:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 force = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, FORCE_MAGNITUDE);</span></span></code></pre></div><p>Then we can calculate the torque with the cross product of these two vectors:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">float</span> torque = force.X * r.Y - force.Y * r.X;</span></span></code></pre></div><p>And then calculate the rotational acceleration:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">float</span> angularAcceleration += torque / ROTATIONAL_INERTIA;</span></span></code></pre></div><p>The <code>ROTATIONAL_INERTIA</code> represents the resistance of the body to rotation (basically, it plays the same role as mass in linear dynamics).  For simplicity, we could treat it as $1$ (no real effect - after all, we&rsquo;re in a vacuum), which allows us to refactor as:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">float</span> angularAcceleration += torque;</span></span></code></pre></div><h3 id="todo-2-calculate-and-apply-torque-from-right-rocket">TODO 2: Calculate and apply torque from right rocket</h3>
<p>Now that we&rsquo;ve seen the longhand way of doing things &ldquo;properly&rdquo;, let&rsquo;s apply some game-programming savvy shortcuts to our right-engine calculations.</p>
<p>Note that for this example, the vector <code>r</code> does not change - the engine should always be the same distance from the center of mass, and the force vector of the engine will always be in the same direction. relative to <code>r</code>.  So the cross product of the two will <em>always be the same</em>.  So we could pre-calculate this value, <em>and</em> apply the proper moment of inertia, leaving us with a single constant representing the angular acceleration from the engines which we can represent as a constant, <code>ANGULAR_ACCELERATION</code>.  Since this is reversed for the  right engine, our simplified acceleration calculation would be:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>angularAcceleration -= ANGULAR_ACCELERATION * t;</span></span></code></pre></div><p>(and the right engine would have been <code>angularAcceleration += ANGULAR_ACCELERATION * t;</code>)</p>
<p>Thus, with careful thought we can simplify six addition operations, four multiplications, one subtraction, one multiplication, and two struct allocation operations to just <em>two multiplications and two additions</em>.  This kind of simplification and optimization is common in game programming.  And, in fact, after calculating the <code>ANGULAR_ACCELERATION</code> value we would probably tweak it until the movement felt natural and fun (or just guess at the value to begin with)!</p>
<p>Of course, if we were doing scientific simulation, we would instead have to carry out all of the calculations, couldn&rsquo;t use fudge factors, and would have additional considerations.  For example, if the fuel tanks are not at the center of mass, then every time we fire our rockets <em>the center of mass will shift!</em>  That is why scientific simulations are considered <em>hard simulations</em>.  Not so much because they are hard to write - but because accuracy is so important.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="elastic-collisions">Elastic Collisions</h1>

<p>Now that we&rsquo;ve looked at movement derived from both linear and angular dynamics, let&rsquo;s revisit them from the perspective of <em>collisions</em>.  If we have two rigid bodies that collide, what should be the outcome?  Consider an <em>elastic</em> collision (one in which the two objects &ldquo;bounce off&rdquo; one another).  From Newtonian mechanics we know that:</p>
<ol>
<li>Energy must be conserved</li>
<li>Momentum must be conserved</li>
</ol>
<p>Thus, if we consider our two objects in isolation (as a system of two), the total system must have the same energy and momentum <em>after</em> the collision that it had <em>before</em> (Note we are talking about <em>perfectly</em> elastic collisions here - in the real world some energy would be converted to heat and sound).</p>
<p>Momentum is the product of mass and velocity of an object:</p>
<p>$$\rho = mv\tag{0}$$</p>
<p>Since we have two objects, the total momentum in the system is the sum of those:</p>
<p>$$\rho = m_1v_1 + m_2v_2\tag{1}$$</p>
<p>And, due to the law of conservation of momentum,</p>
<p>$$\rho_{before} = \rho_{after} \tag{2}$$</p>
<p>So, substituting equation 1 before and after the collision we find:</p>
<p>$$m_1u_1 + m_2u_2 = m_1v_1 + m_2v_2\tag{3}$$</p>
<p>Where $u$ is the velocity <em>before</em> a collision, and $v$ is the velocity <em>after</em> (note that the mass of each object does not change).</p>
<p>And since our objects are both moving, they also have kinetic energy:</p>
<p>$$E_k = \frac{1}{2}mv^2\tag{4}$$</p>
<p>As energy is conserved, the energy <em>before</em> the collision and <em>after</em> must likewise be conserved:</p>
<p>$$E_{before} = E_{after} \tag{5}$$</p>
<p>Substituting equation 4 into 5 yields:</p>
<p>$$\frac{1}{2}m_0u_0^2 + \frac{1}{2}m_1u_1^2 = \frac{1}{2}m_0v_0^2 + \frac{1}{2}m_1v_1^2 \tag{6}$$</p>
<p>Assuming we enter the collision knowing the values of $u_0, u_1, m_0, and m_1$, we have two unknowns $v_0$ and $v_1$ and two equations containing them (equations 3 and 6).  Thus, we can solve for $v_0$ and $v_1$:</p>
<p>$$v_0 = \frac{m_0 - m_1}{m_0 + m_1}u_0 + \frac{2m_1}{m_0+m_1}u_1 \tag{7}$$
$$v_1 = \frac{2m_0}{m_0+m_1}u_0 + \frac{m_1 - m_0}{m_0 + m_1}u_1 \tag{8}$$</p>
<p>These two equations can give us the new velocities in a single dimension.  But we&rsquo;re primarily interested in <em>two</em> dimensions, and our velocities are expressed as <code>Vector2</code> objects.  However, there is a simple solution; use a coordinate system that aligns with the axis of collision, i.e. for two masses colliding, A and B:</p>
<p>
<a href="#image-160ff48fa2c3e38bf41af05f76b9c41f" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.4.1.png" alt="Aligning the coordinate system with the axis of collision" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-160ff48fa2c3e38bf41af05f76b9c41f">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.4.1.png" alt="Aligning the coordinate system with the axis of collision" class="lightbox-image" loading="lazy">
</a></p>
<p>Note how the X-axis in the diagram is aligned with the line between the centers of mass A and B.  We can accomplish this in code by calculating the vector between the center of the two bodies, and determining the angle between that vector and the x-Axis:</p>
<p>
<a href="#image-62a8052247f66b51291de7ae85bb198b" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.4.2.png" alt="Finding the angle between the line of collision and x-axis" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-62a8052247f66b51291de7ae85bb198b">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/6.4.2.png" alt="Finding the angle between the line of collision and x-axis" class="lightbox-image" loading="lazy">
</a></p>
<p>Remember that the angle between two vectors is related to the dot product:</p>
<p>$$cos\theta = \frac{ a \cdotp b}{||a||*||b||} \tag {9}$$</p>
<p>If both vectors $a$ and $b$ are of unit length (normalized), then this simplifies to:</p>
<p>$$cos\theta = a \cdotp b \tag {10}$$</p>
<p>And $\theta$ can be solved for by:</p>
<p>$$\theta = cos^{-1}(a \cdotp b) \tag{11}$$</p>
<p>Given two rigid bodies <code>A</code> and <code>B</code>, we could then calculate this angle using their centers:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Determine the line between centers of colliding objects A and B</span>
</span></span><span style="display:flex;"><span>Vector2 collisionLine = A.Center - B.Center;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Normalize that line</span>
</span></span><span style="display:flex;"><span>collisionLine.Normalize();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Determine the angle between the collision line and the x-axis</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> angle = Math.Acos(Vector2.Dot(collisionLine, Vector2.UnitX));</span></span></code></pre></div><p>Once we have this angle, we can rotate our velocity vectors using it, so that the coordinate system now aligns with that axis:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 u0 = Vector2.Transform(Matrix.CreateRotationZ(A.Velocity, angle));
</span></span><span style="display:flex;"><span>Vector2 u1 = Vector2.Transform(Matrix.CreateRotationZ(B.Velocity, angle));</span></span></code></pre></div><p>We can use these values, along with the masses of the two objects, to calculate the changes in the X-component of the velocity using equations (7) and (8):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">float</span> m0 = A.Mass;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> m1 = B.Mass;
</span></span><span style="display:flex;"><span>Vector2 v0;
</span></span><span style="display:flex;"><span>v0.X = ((m0 - m1) / (m0 + m1)) * u0.X + ((<span style="color:#ae81ff">2</span> * m1) / (m0 + m1)) * u1.X;
</span></span><span style="display:flex;"><span>Vector2 v1;
</span></span><span style="display:flex;"><span>v1.X = ((<span style="color:#ae81ff">2</span> * m0) / (m0 + m1)) * u0.X + ((m1 - m0) / (m0 + m1)) * u1.X;</span></span></code></pre></div><p>And, because the collision axis and the x-axis are the same, this transfer of velocity <em>only</em> occurs along the x-axis.  The y components stay the same!</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>v0.Y = u0.Y;
</span></span><span style="display:flex;"><span>v1.Y = u0.Y;</span></span></code></pre></div><p>Then, we can rotate the velocities back to the original coordinate system and assign the transformed velocities to our bodies:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>A.Velocity = Vector2.Transform(v0, Matrix.CreateRotationZ(-angle));
</span></span><span style="display:flex;"><span>B.Velocity = Vector2.Transform(v1, Matrix.CreateRotationZ(-angle));</span></span></code></pre></div><p>Some notes on this process:</p>
<ol>
<li>
<p>at this point we are not accounting for when the collision has gone some way into the bodies; it is possible that after velocity is transferred one will be &ldquo;stuck&rdquo; inside the other.  A common approach to avoid this is to move the two apart based on how much overlap there is.  A more accurate and costly approach is to calculate the time from the moment of impact until end of frame, move the bodies with the inverse of their original velocities multiplied by this delta t, and then apply the <em>new</em> velocities for the same delta t.</p>
</li>
<li>
<p>this approach only works on two bodies at a time.  If you have three or more colliding, the common approach is to solve for each pair in the collision multiple times until they are not colliding.  This is not accurate, but gives a reasonable approximation in many cases.</p>
</li>
</ol>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="physics-engines">Physics Engines</h1>

<p>If we want to incorporate more robust and realistic physics than that we have just explored, we would be well-served to look at <em>physics engines</em> designed for use in games.  These are simulations built along the same lines as what we&rsquo;ve discussed - essentially they represent the objects in the game world as rigid bodies, and provide the means for simulating them somewhat realistically.</p>
<h2 id="farseer--velcro-physics">Farseer / Velcro Physics</h2>
<p>One of the best-known of the physics engines developed for XNA was the Farseer Physics Engine, which was renamed to Velcro Physics when it was moved from CodePlex to GitHub.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-architecture">Game Architecture</h1>

<p>Reorganizing your code&hellip;</p>
<img src="https://media.giphy.com/media/caVdtPeN83dza/giphy.gif"/>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Game Architecture</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Now that you&rsquo;ve moved through much of the foundations of building games, let&rsquo;s take a step back and talk about how to best <em>organize</em> that task.  After all, games are one of the most complex software systems you can build.  In the words of Jason Gregory, a game is:</p>
<blockquote>
<p>A soft real-time interactive agent-based simulation</p>
</blockquote>
<p>This means that not only do you need to process user input, update a simulated world, and then render that simulated world, you <em>also</em> have to do this in realtime (i.e. within 1/60th of a second)!  This is not a trivial challenge!</p>
<p>As with any software system, organization can go a long way to managing this complexity.  Consider this diagram of a AAA game engine&rsquo;s software architecture:</p>
<p>
<a href="#image-1f1b2eb2a18c177efbd79032a25e3e7b" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/7.1.1.png" alt="Software Engine Architecture" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-1f1b2eb2a18c177efbd79032a25e3e7b">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/7.1.1.png" alt="Software Engine Architecture" class="lightbox-image" loading="lazy">
</a></p>
<p>Note how the engine is broken into systems and organized into layers.  Building an engine like this is outside the scope of this book (I encourage you to read Jason Gregory&rsquo;s <em>Game Engine Architecture</em> if you&rsquo;d like to delve into it), but the idea of loosely coupled systems is certainly something we can adapt.  Moreover, it is already explicitly supported by the MonoGame framework.  We&rsquo;ll explore how in this chapter.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-services">Game Services</h1>

<p>A common approach in software architecture for loose coupling of systems is the use of <em>services</em>.  Services are implemented with 1) a <em>service provider</em> - essentially a collection of services that can be searched for a service, and new services can be registered with, 2) interfaces that define specific services how to work with the service, and 3) classes that implement these interfaces. This is the <a href="https://gameprogrammingpatterns.com/service-locator.html" target="_blank">Service Locator Pattern</a>
 as implemented in C#.</p>
<p>For a Service Provider, MonoGame provides the <a href="https://docs.monogame.net/api/Microsoft.Xna.Framework.GameServiceContainer.html" target="_blank"><code>GameServiceContainer</code></a>
 class, and the <code>Game</code> class has one as its <code>Service</code> property.  The default game class adds at least two services: an <code>IGraphicsDeviceService</code> and an <code>IGraphicsDeviceManager</code>.  If we need to retrieve the graphics device for some reason we could use the code:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> gds = game.Services.GetService(<span style="color:#66d9ef">typeof</span>(IGraphicDeviceService));
</span></span><span style="display:flex;"><span>GraphicsDevice gd = gds.GraphicsDevice;</span></span></code></pre></div><p>We can add any service we want to with the <code>GameServicesContainer.AddService(Type type, object provider)</code>.  In effect, the <code>GameServicesContainer</code> acts as a dictionary for finding initialized instances of services you would use across the game.  For example, we might want to have a custom service for reporting achievements in the game.  Because the implementation would be different for the Xbox than the Playstation, we could define an interface to represent our type:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IAchievementService</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> RegisterAchievement(Achievement achievement);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Then we could author <em>two</em> classes implementing this interface, one for the Xbox and one for the Playstation.  We would initalize and register the appropriate one for the build of our program:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>game.Services.AddService(IAchievementService, <span style="color:#66d9ef">new</span> XBoxAchievementService());</span></span></code></pre></div><p>This provides us with that desirable &ldquo;loose coupling&rdquo;, where the only change we&rsquo;d need to make between the two builds is what achievement service we initialize.  A second common use for the <code>GameServicesContainer</code> is it can be passed to a constructor to provide multiple services as a single parameter, instead of having to pass each one separately.  It can also be held onto to retrieve the service at a later point in the execution, as is the case with the <code>ContentManager</code> constructor.</p>
<p>Game services are a good replacement for systems that you might otherwise use the <a href="https://gameprogrammingpatterns.com/singleton.html" target="_blank">Singleton Pattern</a>
 to implement.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-components">Game Components</h1>

<p>A second useful decoupling pattern in MonoGame is the use of <em>game components</em>.  You&rsquo;ve probably noticed that many of the classes you have written have a similar pattern: they each have a <code>LoadContent()</code>, <code>Update()</code>, and <code>Draw()</code> method, and these often take the same arguments.  In your game class, you probably mostly invoke these methods for each class in turn.  MonoGame provides the concept of game components to help manage this task.  This involves: 1) a <code>GameComponentCollection</code> which game components are registered with, and components are implemented by extending the <code>GameComponent</code> or <code>DrawableGameComponent</code> base classes.</p>
<p>The <code>Game</code> implements a <code>GameCollection</code> in its <code>Components</code> property.  It will iterate through all components it holds, invoking the <code>Update()</code> and <code>Draw()</code> methods within the game loop.</p>
<h3 id="gamecomponent">GameComponent</h3>
<p>The <code>GameComponent</code> base class implements <code>IGameComponent</code>, <code>IUpdatable</code>, and <code>IDisposable</code> interfaces.  It has the following properties:</p>
<ul>
<li><code>Enabled</code> - this boolean indicates if the component will be updated</li>
<li><code>Game</code> - the game this component belongs to</li>
<li><code>UpdateOrder</code> - an integer used to sort the order in which game component&rsquo;s <code>Update()</code> method is invoked</li>
</ul>
<p>It also has the following virtual methods, which can be overridden:</p>
<ul>
<li><code>Dispose(bool disposing)</code> - Disposes of the component</li>
<li><code>Initialize()</code> - Initializes the component; used to set/load any non-graphical content; invoked during the game&rsquo;s initialization step</li>
<li><code>Update(GameTime gameTime)</code> - Invoked every pass through the game loop</li>
</ul>
<p>Finally, it also implements the following events:</p>
<ul>
<li><code>EnabledChanged</code> - triggered when the <code>Enabled</code> property changes</li>
<li><code>UpdateOrderChanged</code> - triggered when the <code>UpdateOrder</code> property changes</li>
</ul>
<h3 id="drawablegamecomponent">DrawableGameComponent</h3>
<p>The <code>DrawableGameComponent</code> inherits from the <code>GameComponent</code> base class, and additionally implements the <code>IDrawable</code> interface.  In addition to its inherited properties, it declares:</p>
<ul>
<li><code>DrawOrder</code> - an integer that determines the order game components are drawn in</li>
<li><code>GraphicsDevice</code> - the graphics device used to draw the game component</li>
<li><code>Visible</code> - a boolean that determines if the game component should be drawn</li>
</ul>
<p>It also has the additional virtual methods:</p>
<ul>
<li><code>LoadContent()</code> - Loads graphical content, invoked by the game during its content loading step</li>
<li><code>Draw(GameTime gameTime)</code> - Draws the game component, invoked during the game loop</li>
</ul>
<p>Finally, it implements the additional properties:</p>
<ul>
<li><code>DrawOrderChanged</code> - triggered when the <code>DrawOrder</code> property changes</li>
<li><code>VisibleChanged</code> - triggered when the <code>Visible</code> property changes</li>
</ul>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>The concept of Game Component espoused by MonoGame is <em>not</em> the same one defined by the <a href="https://gameprogrammingpatterns.com/component.html" target="_blank">Component Pattern</a>
, though it could potentially be leveraged to implement that pattern.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-screens">Game Screens</h1>

<p>XNA offered a sample building with these ideas that further organized a game into <em>screens</em> that has been <a href="https://github.com/tomizechsterson/game-state-management-monogame" target="_blank">ported to MonoGame</a>
.This was heavily influenced by Windows Phone, and includes gestures and &ldquo;tombstoning&rdquo; support.  A more simplified form is presented here.  It organizes a game into &ldquo;screens&rdquo;, each with its own logic and rendering, such as a menu, puzzle, cutscene, etc.</p>
<p>A scene manager game component manages a stack of these screens, and updates and renders the topmost.  Thus, from a gameplay screen, if we trigger a cutscene it would be pushed onto the stack, play, and then pop itself from the stack.  Similarly, pressing the &ldquo;menu&rdquo; button would push the menu screen onto the stack, leaving the player to interact with the menu instead of the game.  Screens manage their transition on and off this stack - and can incorporate visual effects into the transition.</p>
<h3 id="screenstate-enum">ScreenState Enum</h3>
<p>This enumeration represents the states a GameScreen can be in.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Enumerations of the possible screen states</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> ScreenState
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    TransitionOn,
</span></span><span style="display:flex;"><span>    Active,
</span></span><span style="display:flex;"><span>    TransitionOff,
</span></span><span style="display:flex;"><span>    Hidden
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="gamescreen">GameScreen</h3>
<p>The <code>GameScreen</code> class is an abstract base class that represents a single screen.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A screen is a single layer of game content that has</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// its own update and draw logic and can be combined </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// with other layers to create complex menus or game</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// experiences</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GameScreen</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Indicates if this screen is a popup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Normally when a new screen is brought over another, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// the covered screen will transition off.  However, this</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// bool indicates the covering screen is only a popup, and </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// the covered screen will remain partially visible</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsPopup { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The amount of time taken for this screen to transition on</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> TimeSpan TransitionOnTime {<span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>;} = TimeSpan.Zero;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The amount of time taken for this screen to transition off</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> TimeSpan TransitionOffTime {<span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>;} = TimeSpan.Zero;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The screen&#39;s position in the transition</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;value&gt;Ranges from 0 to 1 (fully on to fully off)&lt;/value&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">float</span> TransitionPosition { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The alpha value based on the current transition position</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> TransitionAlpha =&gt; <span style="color:#ae81ff">1f</span> - TransitionPosition;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The current state of the screen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ScreenState ScreenState { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = ScreenState.TransitionOn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Indicates the screen is exiting for good (not simply obscured)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// There are two possible reasons why a screen might be transitioning</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// off. It could be temporarily going away to make room for another</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// screen that is on top of it, or it could be going away for good.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// This property indicates whether the screen is exiting for real:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// if set, the screen will automatically remove itself as soon as the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// transition finishes.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsExiting { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Indicates if this screen is active</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsActive =&gt; !_otherScreenHasFocus &amp;&amp; (
</span></span><span style="display:flex;"><span>        ScreenState == ScreenState.TransitionOn ||
</span></span><span style="display:flex;"><span>        ScreenState == ScreenState.Active);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> _otherScreenHasFocus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The ScreenManager in charge of this screen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ScreenManager ScreenManager { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets the index of the player who is currently controlling this screen,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// or null if it is accepting input from any player. </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// This is used to lock the game to a specific player profile. The main menu </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// responds to input from any connected gamepad, but whichever player makes </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// a selection from this menu is given control over all subsequent screens, </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// so other gamepads are inactive until the controlling player returns to the </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// main menu.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> PlayerIndex? ControllingPlayer { <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Activates the screen.  Called when the screen is added to the screen manager </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// or the game returns from being paused.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Activate() { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Deactivates the screen.  Called when the screen is removed from the screen manager </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// or when the game is paused.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Deactivate() { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Unloads content for the screen. Called when the screen is removed from the screen manager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Unload() { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the screen. Unlike HandleInput, this method is called regardless of whether the screen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// is active, hidden, or in the middle of a transition.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime, <span style="color:#66d9ef">bool</span> otherScreenHasFocus, <span style="color:#66d9ef">bool</span> coveredByOtherScreen)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _otherScreenHasFocus = otherScreenHasFocus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (IsExiting)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// If the screen is going away forever, it should transition off</span>
</span></span><span style="display:flex;"><span>            ScreenState = ScreenState.TransitionOff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!UpdateTransitionPosition(gameTime, TransitionOffTime, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>                ScreenManager.RemoveScreen(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(coveredByOtherScreen)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// if the screen is covered by another, it should transition off</span>
</span></span><span style="display:flex;"><span>            ScreenState = UpdateTransitionPosition(gameTime, TransitionOffTime, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                ? ScreenState.TransitionOff
</span></span><span style="display:flex;"><span>                : ScreenState.Hidden;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Otherwise the screen should transition on and become active.</span>
</span></span><span style="display:flex;"><span>            ScreenState = UpdateTransitionPosition(gameTime, TransitionOnTime, -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                ? ScreenState.TransitionOn
</span></span><span style="display:flex;"><span>                : ScreenState.Active;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the TransitionPosition property based on the time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;an object representing time in the game&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;time&#34;&gt;The amount of time the transition should take&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;direction&#34;&gt;The direction of the transition&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;true if still transitioning, false if the transition is done&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> UpdateTransitionPosition(GameTime gameTime, TimeSpan time, <span style="color:#66d9ef">int</span> direction)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// How much should we move by?</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> transitionDelta = (time == TimeSpan.Zero)
</span></span><span style="display:flex;"><span>            ? <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            : (<span style="color:#66d9ef">float</span>)(gameTime.ElapsedGameTime.TotalMilliseconds / time.TotalMilliseconds);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Update the transition time</span>
</span></span><span style="display:flex;"><span>        TransitionPosition += transitionDelta * direction;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Did we reach the end of the transition?</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(direction &lt; <span style="color:#ae81ff">0</span> &amp;&amp; TransitionPosition &lt;= <span style="color:#ae81ff">0</span> || direction &gt; <span style="color:#ae81ff">0</span> &amp;&amp; TransitionPosition &gt;= <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            TransitionPosition = MathHelper.Clamp(TransitionPosition, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// if not, we are still transitioning</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Handles input for this screen.  Only called when the screen is active,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// and not when another screen has taken focus.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing time in the game&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;input&#34;&gt;An object representing input&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> HandleInput(GameTime gameTime, InputState input) { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the GameScreen.  Only called with the screen is active, and not </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// when another screen has taken the focus.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing time in the game&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime) { }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// This method tells the screen to exit, allowing it time to transition off</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ExitScreen()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (TransitionOffTime == TimeSpan.Zero)
</span></span><span style="display:flex;"><span>            ScreenManager.RemoveScreen(<span style="color:#66d9ef">this</span>);    <span style="color:#75715e">// If the screen has a zero transition time, remove it immediately</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            IsExiting = <span style="color:#66d9ef">true</span>;    <span style="color:#75715e">// Otherwise flag that it should transition off and then exit.</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h4 id="screenmanager">ScreenManager</h4>
<p>The <code>ScreenManager</code> class manages the screens, updating and drawing only when appropriate.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// The ScreenManager is a component which manages one or more GameScreen instance.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// It maintains a stack of screens, calls their Update and Draw methods when </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// appropriate, and automatically routes input to the topmost screen.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScreenManager</span> : DrawableGameComponent
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> List&lt;GameScreen&gt; _screens = <span style="color:#66d9ef">new</span> List&lt;GameScreen&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> List&lt;GameScreen&gt; _tmpScreensList = <span style="color:#66d9ef">new</span> List&lt;GameScreen&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> ContentManager _content;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> InputState _input = <span style="color:#66d9ef">new</span> InputState();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> _isInitialized;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A SpriteBatch shared by all GameScreens</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> SpriteBatch SpriteBatch { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A SpriteFont shared by all GameScreens</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> SpriteFont MenuFont { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new ScreenManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this ScreenManager belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ScreenManager(Game game) : <span style="color:#66d9ef">base</span>(game) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _content = <span style="color:#66d9ef">new</span> ContentManager(game.Services, <span style="color:#e6db74">&#34;Content&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the ScreenManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Initialize()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Initialize();
</span></span><span style="display:flex;"><span>        _isInitialized = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Loads content for the ScreenManager and its screens</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> LoadContent()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        SpriteBatch = <span style="color:#66d9ef">new</span> SpriteBatch(GraphicsDevice);
</span></span><span style="display:flex;"><span>        MenuFont = _content.Load&lt;SpriteFont&gt;(<span style="color:#e6db74">&#34;MenuFont&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Tell each of the screens to load thier content </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> screen <span style="color:#66d9ef">in</span> _screens)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            screen.Activate();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Unloads content for the ScreenManager&#39;s screens</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> UnloadContent()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> screen <span style="color:#66d9ef">in</span> _screens)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            screen.Unload();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates all screens managed by the ScreenManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing time in the game&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Read in the keyboard and gamepad</span>
</span></span><span style="display:flex;"><span>        _input.Update();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Make a copy of the screen list, to avoid confusion if </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the process of updating a screen adds or removes others</span>
</span></span><span style="display:flex;"><span>        _tmpScreensList.Clear();
</span></span><span style="display:flex;"><span>        _tmpScreensList.AddRange(_screens);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> otherScreenHasFocus = !Game.IsActive;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> coveredByOtherScreen = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span>(_tmpScreensList.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Pop the topmost screen </span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> screen = _tmpScreensList[_tmpScreensList.Count - <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            _tmpScreensList.RemoveAt(_tmpScreensList.Count - <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            screen.Update(gameTime, otherScreenHasFocus, coveredByOtherScreen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (screen.ScreenState == ScreenState.TransitionOn || screen.ScreenState == ScreenState.Active)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// if this is the first active screen, let it handle input </span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!otherScreenHasFocus)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    screen.HandleInput(gameTime, _input);
</span></span><span style="display:flex;"><span>                    otherScreenHasFocus = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// if this is an active non-popup, all subsequent </span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// screens are covered </span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!screen.IsPopup) coveredByOtherScreen = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the appropriate screens managed by the SceneManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing time in the game&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> screen <span style="color:#66d9ef">in</span> _screens)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (screen.ScreenState == ScreenState.Hidden) <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            screen.Draw(gameTime);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Adds a screen to the ScreenManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;screen&#34;&gt;The screen to add&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> AddScreen(GameScreen screen)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        screen.ScreenManager = <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>        screen.IsExiting = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If we have a graphics device, tell the screen to load content</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_isInitialized) screen.Activate();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _screens.Add(screen);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> RemoveScreen(GameScreen screen)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If we have a graphics device, tell the screen to unload its content </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_isInitialized) screen.Unload();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _screens.Remove(screen);
</span></span><span style="display:flex;"><span>        _tmpScreensList.Remove(screen);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Exposes an array holding all the screens managed by the ScreenManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;An array containing references to all current screens&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> GameScreen[] GetScreens()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _screens.ToArray();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="other-changes">Other Changes</h3>
<p>This sample also uses the <code>InputState</code> class <a href="https://ksu-cs-textbooks.github.io/cis580/02-player-input/07-input-state/">introduced in chapter 7</a>
.  In your game class, you need to create the <code>ScreenManager</code>, and then add your custom screen classes, which can be done in your constructor or <code>Initialize()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> screenManager = <span style="color:#66d9ef">new</span> ScreenManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> ExampleScreenA());
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> ExampleScreenB());
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div><p>Once added, the screen&rsquo;s <code>Initialize</code>, <code>LoadContent()</code>, <code>Update()</code>, and <code>Draw()</code> methods will all be invoked automatically as appropriate by the <code>Game</code> class.</p>
<p>It might also make sense to register the <code>ScreenManager</code> as a service, especially if you expect to add additional screens as the game is running:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// From within your Game class</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.Services.AddService(<span style="color:#66d9ef">typeof</span>(ScreenManager), screenManager);</span></span></code></pre></div><p>Screens can be added at any time, which pushes them to the top of the stack - a common use would be to open a menu or submenu.</p>
<p>You can also stack as many screens as you like at the start of the game - you might arrange a multilevel game this way:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> CreditsScreen());
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> Level8Screen());
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> Level7Screen());
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> Level6Screen());
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> Level1Screen());
</span></span><span style="display:flex;"><span>screenManager.AddScreen(<span style="color:#66d9ef">new</span> OpeningScreen());</span></span></code></pre></div><p>And invoke each screen&rsquo;s <code>ExitScreen()</code> when the level is completed.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we explored some new tools for organizing our game code.  We learned about how MonoGame utilizes services to provide loosely-coupled access between a service provider and consumer.  We also saw how the MonoGame concept of Game Components works, and how we can define custom game components and add them to the <code>Game.Component</code> collection.  Finally, we explored one further organization tool in the Game Screen concept from the XNA GameStateManagement sample.  Each of these can help make larger games easier to build and maintain.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="spritebatch-transforms">SpriteBatch Transforms</h1>

<p>Moving in place&hellip;</p>
<img src="https://media.giphy.com/media/3o85xzkvl1siB2rHSo/giphy.gif"/>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of SpriteBatch Transforms</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>When we introduced the <code>SpriteBatch</code>, we mentioned that the <code>SpriteBatch.Begin()</code> had some additional arguments we could take advantage of.  One of these is for a <em>transformation matrix</em>.   This is a matrix that represents the transformation applied to convert the 3D world representation into two dimensions (remember, in MonoGame we&rsquo;re using 3D hardware to render a 2D game).  For many games, the default setting for this transformation matrix is fine - but if we override this, we can create many powerful effects, including:</p>
<ul>
<li>Adding scrolling to our game world with minimal disruption to our current code</li>
<li>Adding <em>parallax scrolling</em> to our game world (where different layers scroll at different speeds, simulating depth)</li>
<li>Creating interesting visual effects like zooming, spinning, or shaking our game scene</li>
<li>Automatically scaling our game for full-screen presentation</li>
</ul>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="transforms">Transforms</h1>

<p>Before we delve into using the SpriteBatch, let&rsquo;s quickly revisit the concept of Transformations using Matrices.  Our MonoGame games use 3D hardware to render 2D scenes, and the individual sprites are represented as textured quads - a polygon consisting of two triangles arranged in a rectangle.  The SpriteBatch computes the coordinates of the corners of this quad from the <code>SpriteBatch.Draw()</code> parameters.  These vectors are then <em>transformed</em> for the final drawing process by multiplying them by a matrix specified in the <code>SpriteBatch.Begin()</code> method.</p>
<p>By default, the matrix used by the <code>SpriteBatch</code> is the <em>identity</em> matrix:</p>
<p>$$
I = \begin{vmatrix} 1 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{vmatrix}
$$</p>
<p>Any vector multiplied by this matrix will be the same vector (This is why it is called the identity matrix, by the way):</p>
<p>$$
V_i = V_0 * I = \begin{vmatrix}4\\3\\8\\1\end{vmatrix} * \begin{vmatrix} 1 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{vmatrix} = \begin{vmatrix}4\\3\\8\\1\end{vmatrix}
$$</p>
<p>But we can substitute a <em>different</em> matrix for the identity matrix.  The most common includes <em>scaling</em>, <em>translation</em>, and <em>rotation</em> matrices.  While it is possible to define the transformation matrices by hand by calling the <code>Matrix</code> constructor, MonoGame provides several methods for creating specific transformation matrices.</p>
<h3 id="scale">Scale</h3>
<p>A Scale matrix is similar to the Identity matrix, but instead of 1s on the diagonal, it provides scaling values:</p>
<p>$$
S = \begin{vmatrix} x &amp; 0 &amp; 0 &amp; 0\\0 &amp; y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{vmatrix}
$$</p>
<p>Any vector multiplied by this matrix will have its components scaled correspondingly:</p>
<p>$$
V_s = V_0 * S = \begin{vmatrix}4\\3\\8\\1\end{vmatrix} * \begin{vmatrix} x &amp; 0 &amp; 0 &amp; 0\\0 &amp; y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{vmatrix} = \begin{vmatrix}4x\\3y\\8z\\1\end{vmatrix}
$$</p>
<p>In MonoGame, a scale matrix can be created with one of the following methods:</p>
<ul>
<li><code>Matrix.CreateScale(float x, float y, float z)</code> - A scaling matrix using x, y, and z to scale in the corresponding axes</li>
<li><code>Matrix.CreateScale(Vector3 scale)</code> - A scaling matrix using the x, y, and z components of the Vector3 to scale in the corresponding axes</li>
<li><code>Matrix.CreateScale(float scale)</code> - A scaling matrix that scales equally along the x, y, and z axis by the scale provided</li>
</ul>
<h3 id="translation">Translation</h3>
<p>A Translation matrix also begins with an identity matrix, and adds translation values in the x, y, and z in the fourth row (which is why transforms for 3D math use 4x4 matrices):</p>
<p>$$
T = \begin{vmatrix} 1 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 \\ t_x &amp; t_y &amp; t_z &amp; 1 \end{vmatrix}
$$</p>
<p>Any vector multiplied by this matrix will have its components translated accordingly:</p>
<p>$$
V_t = V_0 * T = \begin{vmatrix}4\\3\\8\\1\end{vmatrix} * \begin{vmatrix} 1 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 \\ t_x &amp; t_y &amp; t_z &amp; 1 \end{vmatrix} = \begin{vmatrix}4+t_x\\3+t_y\\8+t_z\\1\end{vmatrix}
$$</p>
<h3 id="rotation">Rotation</h3>
<p>A rotation matrix is a bit more involved, and there are separate matrices for each primary axis.  In a 2D game, we typically only rotate around the z-axis, whose rotation matrix is:</p>
<p>$$
R_z = \begin{vmatrix} \cos{\theta} &amp; \sin{\theta} &amp; 0 &amp; 0\\ -\sin{\theta} &amp; \cos{\theta} &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{vmatrix}
$$</p>
<p>Here $\theta$ is the rotation measured in radians in the clockwise direction.</p>
<p>In MonoGame, a z-Rotation matrix can be created with one of the following method:</p>
<ul>
<li><code>Matrix.CreateRotationZ(float angle)</code> - A rotation matrix about the z-axis using the supplied angle</li>
</ul>
<p>Additionally, rotations about the x and y axes can be created with:</p>
<ul>
<li><code>Matrix.CreateRotationX(float angle)</code> - A rotation matrix about the x-axis using the supplied angle</li>
<li><code>Matrix.CreateRotationY(float angle)</code> - A rotation matrix about the y-axis using the supplied angle</li>
</ul>
<h3 id="composite-transformations">Composite Transformations</h3>
<p>Moreover, we can <em>combine</em> multiple operations by multiplying their matrices together.  I.e. given the translation matrix $T$ and the rotation matrix $R$, we could apply the translation followed by the rotation by computing a composite matrix $C$ that combines the operations:</p>
<p>$$
C = T * R
$$</p>
<p>In MonoGame we can multiply matrices with <code>Matrix.Multiply()</code> or by using the <code>*</code> operator.  I.e. to perform the translation described above we could use either:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> compositeTransform = Matrix.Multiply(Matrix.CreateTranslation(x, y, z), Matrix.CreateRotation(angle));</span></span></code></pre></div><p>or</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> translation = Matrix.CreateTranslation(x, y, z);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> rotation = Matrix.CreateRotation(angle);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> compositeTransform = translation * rotation;</span></span></code></pre></div>
  
  
<div class="box notices cstyle warning">
  <div class="box-label"><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div>
  <div class="box-content">

<p>The order the matrices are concatenated in determines the order in which the operations are performed!  DirectX (and hence, MonoGame) uses left-to-right order, i.e. the leftmost matrix effect happens <em>first</em>, and the rightmost <em>last</em>.</p>
</div>
</div>
<p>Now let&rsquo;s put this knowledge of transforms to practical use.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="screen-scrolling">Screen Scrolling</h1>

<p>Perhaps the most common use of transforms with the sprite batch is to support <em>screen scrolling</em>, i.e. shifting the viewport (the visible part of the game world) around to allow for larger game worlds.</p>
<p>Consider what it would take to shift the game world using just what we&rsquo;ve learned about sprites.  We&rsquo;d need to keep track of an offset for where the viewport begins relative to the world:</p>
<p>
<a href="#image-007d9a1a3f12d8fa6f2d21bc51ec83fe" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.1.png" alt="The Game World and Viewport" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-007d9a1a3f12d8fa6f2d21bc51ec83fe">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.1.png" alt="The Game World and Viewport" class="lightbox-image" loading="lazy">
</a></p>
<p>Then, when we draw our game objects (like sprites), we&rsquo;d need to add this offset vector to the position of <em>each</em> as we draw them:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    spriteBatch.Begin();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> sprite <span style="color:#66d9ef">in</span> Sprites)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        spriteBatch.Draw(sprite.Texture, sprite.Position + offset, Color.White);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>This doesn&rsquo;t look too bad&hellip; but what about when we use a different <code>SpriteBatch.Draw()</code> override?  Or we position some sprites with a <code>Rectangle</code> instead of a <code>Vector2</code>?  We now need to start handling special cases, which can make our code quite a bit more complex and difficult to read.</p>
<p>However, the <code>SpriteBatch.Begin()</code> call takes an optional transformation matrix as a parameter, and applies its transform to <em>all</em> sprites drawn within the batch.  Thus, we can create a single transformation matrix to represent our offset, and apply it to the <code>SpriteBatch</code>.  Then we can use whatever <code>SpriteBatch.Draw()</code> override we want, and we don&rsquo;t need to worry about adjusting positioning of sprites - we just draw them where they go in the world, and the <code>SpriteBatch</code> only draws the portion of the world we want to show:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw game sprites within the world, however you need to.</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="auto-scrolling">Auto-Scrolling</h3>
<p>To build an auto-scrolling game (one where the screen is constantly scrolling at a set speed), you simply need to update the offset vector every frame, just as you would any moving object.  For example, to auto-scroll the screen vertically at a constant speed, we could use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Vertical auto-scrolling</span>
</span></span><span style="display:flex;"><span>    offset.Y += Vector2.UnitY * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds * SCROLL_SPEED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw game sprites within the world, however you need to.</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>You can of course vary the scrolling speed as well - perhaps scrolling faster as the game progresses, or varying scrolling speed based on some player state (like firing thrusters).</p>
<h3 id="player-synched-scrolling">Player-Synched Scrolling</h3>
<p>A second possibility is to keep the player centered in the screen by scrolling the world around them.  For this, you need to know a vector from the player to the origin of the screen (<code>PlayerOffset</code>) and the position of the player in the world (<code>PlayerPosition</code>).  The <code>ViewportOffset</code> is the difference of these:</p>
<p>
<a href="#image-6379f1c20fb4b7036ec090156b7af767" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.2.png" alt="Player-synched Scrolling" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6379f1c20fb4b7036ec090156b7af767">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.2.png" alt="Player-synched Scrolling" class="lightbox-image" loading="lazy">
</a></p>
<p>Thus, each frame you update the offset vector based on the offset and the player&rsquo;s current position in the world:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Player-synched scrolling</span>
</span></span><span style="display:flex;"><span>    offset = PlayerOffset - Player.Position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw game sprites within the world, however you need to.</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>If we want our player to be able to reach the edge of the screen without the &ldquo;blank space&rdquo; at the edge of the game world showing, we can clamp the offset vector to a region defined by a <code>MinScroll</code> and <code>MaxScroll</code> vector:</p>
<p>
<a href="#image-ef167acf99117effb67e486e7a463398" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.3.png" alt="Clamped Player-Synched Scrolling" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ef167acf99117effb67e486e7a463398">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/8.3.3.png" alt="Clamped Player-Synched Scrolling" class="lightbox-image" loading="lazy">
</a></p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Player-synched scrolling</span>
</span></span><span style="display:flex;"><span>    offset = Player.Position - PlayerOffset;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Clamp the resulting vector to the visible region</span>
</span></span><span style="display:flex;"><span>    offset = Vector2.Clamp(offset, MinScroll, MaxScroll);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw game sprites within the world, however you need to.</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="visibility-culling">Visibility Culling</h3>
<p>Regardless of how we determine what part of the game world is visible, we only need to draw the content (i.e. sprites) that fall within that region.  If we invoke <code>SpriteBatch.Draw()</code> for items that fall off-screen, we create extra, unnecessary work.  It can be helpful to use some form of the <a href="https://gameprogrammingpatterns.com/spatial-partition.html" target="_blank">Spatial Partition Pattern</a>
 to identify the objects that fall on-screen, and only attempt to draw those.</p>
<p>Once we have spatial partitioning set up, we may also choose to only <em>update</em> game objects that fall on-screen (or near to the screen) as a further optimization.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="parallax-scrolling">Parallax Scrolling</h1>

<p>A further refinement of screen scrolling is <em>parallax scrolling</em>, where we seek to emulate depth in our world by scrolling different layers of the game at different speeds, as shown in this example:</p>
<img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Parallax_scrolling_example_scene.gif">
<p>This mimics our perceptions of the world - think to the last time you took a long car trip.  How quickly did objects in the distance seem to move relative to your car?  How about nearer objects (i.e. fenceposts or power poles)?  And how large did each seem?</p>
<p>Essentially, objects in the distance seem both <em>smaller</em> and to move slower relative to our position than nearer objects.  To accomplish parallax scrolling we break our game sprites into different <em>layers</em>, and render each layer using a different <code>SpriteBatch</code> batch, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the first layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">2</span>].X, offset[<span style="color:#ae81ff">2</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw third layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the second layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">1</span>].X, offset[<span style="color:#ae81ff">1</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw second layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the first layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">0</span>].X, offset[<span style="color:#ae81ff">0</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw first layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Unless we are using a <code>SpriteSortMode</code> that sorts sprites by depth values (i.e. <code>SpriteSort.BackToFront</code> or <code>SpriteSort.FrontToBack</code>), it is important that we draw the rearmost layer first, and then the layers in front.  The above example assumes that layer 0 is the front-most layer.</p>
<h3 id="determining-the-offset-vectors">Determining the Offset Vectors</h3>
<p>The offset vector for the layer in which the player is drawn is determined similarly to the offset for regular screen scrolling.  The remaining offset vectors are scaled from this vector.  Layers <em>behind</em> the player are scrolled at a slower speed, and hence scaled to be <em>smaller</em>.  So if in our example the player is in layer 0, we would update our offsets accordingly - maybe the second layer scrolls at 2/3 speed, and the rearmost at 1/3 speed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// assuming offset is the calculated offset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    offsets[<span style="color:#ae81ff">0</span>] = offset;
</span></span><span style="display:flex;"><span>    offsets[<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">0.666f</span> * offset; <span style="color:#75715e">// 1/3 the main layer&#39;s speed</span>
</span></span><span style="display:flex;"><span>    offsets[<span style="color:#ae81ff">2</span>] = <span style="color:#ae81ff">0.333f</span> * offset; <span style="color:#75715e">// 2/3 the main layer&#39;s speed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the first layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">2</span>].X, offset[<span style="color:#ae81ff">2</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw third layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the second layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">1</span>].X, offset[<span style="color:#ae81ff">1</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw second layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the first layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">0</span>].X, offset[<span style="color:#ae81ff">0</span>].Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw first layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Similarly, if you add layers  <em>in front of</em> the player are scrolled faster, and hence should be <em>larger</em>.</p>
<h3 id="scaling-layers">Scaling Layers</h3>
<p>If your art is not drawn pre-scaled for the layer we are using it on, we can combine the translation operation with a scaling operation by concatenating two matrices.  This also has the practical benefit of scaling the scrolling speed in the same operation (and thus, you only need a single offset vector).  Thus, the above example would be refactored as:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// assuming offset is the calculated offset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the third layer&#39;s offset and resizing</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>) * Matrix.CreateScale(<span style="color:#ae81ff">0.333f</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw third layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation and scale matrix representing the second layer&#39;s offset and resizing</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset[<span style="color:#ae81ff">1</span>].X, offset[<span style="color:#ae81ff">1</span>].Y, <span style="color:#ae81ff">0</span>) * Matrix.CreateScale(<span style="color:#ae81ff">0.666f</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw second layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the translation matrix representing the first layer&#39;s offset</span>
</span></span><span style="display:flex;"><span>    Matrix transform = Matrix.CreateTranslation(offset.X, offset.Y, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the transformed game world</span>
</span></span><span style="display:flex;"><span>    spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Draw first layer&#39;s sprites</span>
</span></span><span style="display:flex;"><span>    spriteBatch.End();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Note that <em>this</em> approach assumes all art is drawn to the same scale, thus, a background that is scaled in half <em>needs to be twice as big as the foreground</em>!  For this reason, we don&rsquo;t normally see this version used outside of tile maps.  However, with tiles it can maximize the use of tile resources at little extra cost.  We&rsquo;ll explore the use of tile maps in an upcoming chapter.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="scaling-to-the-screen">Scaling to the Screen</h1>

<p>One of the challenges of creating a computer game in the modern day is deciding the resolution you will display the game at.  We discussed this previously in our <a href="https://ksu-cs-textbooks.github.io/cis580/01-intro-to-monogame/03-the-game-window/">coverage of the game window</a>
.  But instead of forcing a single resolution, we can instead use a scaling matrix with our <code>SpriteBatch.Begin()</code> call to adapt to the monitor resolution.</p>
<p>Let&rsquo;s begin by assuming we want to display our game full-screen using the monitor&rsquo;s default resolution.  We can get this from the <code>GraphicsAdapter</code> class (which represents the graphics hardware), and then use that as our preferred back buffer width and height.  This code in the constructor will accomplish this goal:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Use full-screen at screen resolution</span>
</span></span><span style="display:flex;"><span>DisplayMode screen = GraphicsAdapter.DefaultAdapter.CurrentDisplayMode;
</span></span><span style="display:flex;"><span>_graphics.IsFullScreen = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>_graphics.PreferredBackBufferWidth = screen.Width;
</span></span><span style="display:flex;"><span>_graphics.PreferredBackBufferHeight = screen.Height;</span></span></code></pre></div><p>Note that if you do this later (i.e. not in your <code>Game</code> class constructor), you&rsquo;ll need to also apply your changes with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>_graphics.ApplyChanges();</span></span></code></pre></div><p>This is because as the game is constructed, the graphics device has not yet been initialized.  But once it <em>is</em> initialized, it will have to be reset.</p>
<h3 id="deciding-a-design-resolution">Deciding a Design Resolution</h3>
<p>Next you need to decide at what resolution you will <em>design</em> the game for.  This resolution is the size of your viewport <em>as you are calculating it relative to the game world</em>.  So if your entire world should be displayed on-screen, this is the size of the world.  This also determines the ideal dimensions of your sprites and other art in the game - these should all be drawn based on the design resolution.</p>
<p>Ideally, you want your design resolution to be close to the resolution you expect your game to be displayed most commonly, as the game will be scaled to account for any difference between the monitor and game resolution.  You might consider one of the common television resolutions:</p>
<ul>
<li>XVGA (1024x768) is a 4:3 ratio (the same as old TVs), and was once the most common monitor size.</li>
<li>WXVGA (1280x800) is a 16:10 aspect ratio, and displaced XVGA in the mid-2000&rsquo;s.  It is a common resolution for notebook and smartphone screens</li>
<li>720P (1280x720) is a 16:9 aspect ratio, and matches the 720p HDTV standard</li>
<li>1080P (1920x1080) is a 16:9 aspect ratio, and matches the 1020p HDTV standard, used for broadcast television and Blu-ray</li>
<li>4K (3840x2160) is a 16:9 aspect ratio, and is commonly used by 4K consumer electronics</li>
</ul>
<p>You probably want to pick a resolution equal or smaller than your lower-end target devices, as this means your assets will also be designed at a smaller resolution (and therefore require less memory to store).  When rendering your game, you will scale the game up to the actual device resolution.</p>
<p>Now, there are two primary strategies we might want to use for this scaling - scaling our game so that it <em>fits</em> or <em>fills</em> the available screen real estate.  If we are fitting to the screen, and our game uses a different aspect ratio than the monitor, we will have <em>letterboxing</em> (black bars on either the top and bottom or left and right sides of the screen).  Alternatively, if we are filling the screen and the aspect ratios don&rsquo;t match, then part of the game scene will not appear on-screen.</p>
<h3 id="fitting-the-screen">Fitting the Screen</h3>
<p>To fit the screen, we need to scale the game until the bigger dimension matches the corresponding screen dimension.  Then we need to translate our game so it is centered in the other dimension.  Which dimension is bigger depends on the aspect ratios of both your game and screen.  Once we know the larger dimension (our <em>primary</em> dimension), we determine a scaling factor by dividing the corresponding screen dimension by the corresponding game dimension:</p>
<p>$$scale = \frac{screen_{primary}}{game_{primary}}$$</p>
<p>We will scale both game dimensions using this scaling factor, so that our game maintains its aspect ratio.  If we wish our screen to be centered in the other dimension, we&rsquo;ll need to calculate an offset based on the other dimension (accounting for the scaling of the game screen):</p>
<p>$$offset_{other} = \frac{(screen_{other} - game_{other} * scale)}{2}$$</p>
<p>We divide the leftover space in half, which determines how far down or over on the screen we need to start rendering our game.</p>
<p>To accomplish this in MonoGame, we might use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> (screen.AspectRatio &lt; game.AspectRatio)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// letterbox vertically</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Scale game to screen width</span>
</span></span><span style="display:flex;"><span>    _gameScale = (<span style="color:#66d9ef">float</span>)screen.Width / game.Width;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// translate vertically</span>
</span></span><span style="display:flex;"><span>    _gameOffset.Y = (screen.Height - game.Height * _gameScale) / <span style="color:#ae81ff">2f</span>;
</span></span><span style="display:flex;"><span>    _gameOffset.X = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// letterbox horizontally</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Scale game to screen height </span>
</span></span><span style="display:flex;"><span>    _gameScale = (<span style="color:#66d9ef">float</span>)screen.Height / game.Height;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// translate horizontally</span>
</span></span><span style="display:flex;"><span>    _gameOffset.X = (screen.Width - game.Width * _gameScale) / <span style="color:#ae81ff">2f</span>;
</span></span><span style="display:flex;"><span>    _gameOffset.Y = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="filling-the-screen">Filling the Screen</h3>
<p>If instead we wish to fill all available screen space, and our aspect ratios of the game and screen do not match, some of the game will fall off-screen and not be visible.  The process is very similar - first we determine our primary dimension (which is now the <em>smaller</em> dimension - opposite of the scale to fill approach).  Once we know it, we calculate the scale the same way:</p>
<p>$$scale = \frac{screen_{primary}}{game_{primary}}$$</p>
<p>And we calculate the offset in the other dimension the same way as well:</p>
<p>$$offset_{other} = \frac{(screen_{other} - game_{other} * scale)}{2}$$</p>
<p>Note that in this case, because the scaled game is larger in the other dimension, this offset is negative.</p>
<p>Example code for MonoGame:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// 1. Determine which dimension must overflow screen </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(screen.AspectRatio &lt; game.AspectRatio)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// overflow horizontally</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Scale game to screen height </span>
</span></span><span style="display:flex;"><span>    _gameScale = (<span style="color:#66d9ef">float</span>)screen.Height / game.Height;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// translate horizontally </span>
</span></span><span style="display:flex;"><span>    _gameOffset.X = (screen.Width - game.Width * _gameScale) / <span style="color:#ae81ff">2f</span>;
</span></span><span style="display:flex;"><span>    _gameOffset.Y = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// overflow vertically</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Scale game to screen width </span>
</span></span><span style="display:flex;"><span>    _gameScale = (<span style="color:#66d9ef">float</span>)screen.Width / game.Width;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// translate vertically</span>
</span></span><span style="display:flex;"><span>    _gameOffset.Y = (screen.Height - game.Height * _gameScale) / <span style="color:#ae81ff">2f</span>;
</span></span><span style="display:flex;"><span>    _gameOffset.X = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="transforming-the-spritebatch">Transforming the SpriteBatch</h3>
<p>Once we&rsquo;ve calculated our scale and offset, we can use these when invoking <code>SpriteBatch.Begin()</code> to automatically scale and position the game within the available screen real estate.  We first must create a scaling matrix, which will scale up the game scene to our screen, and then we must translate based on our calculated offset to position the game screen within the screen:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#75715e">// Determine the necessary transform to scale and position game on-screen</span>
</span></span><span style="display:flex;"><span>Matrix transform =                 
</span></span><span style="display:flex;"><span>    Matrix.CreateScale(_gameScale) * <span style="color:#75715e">// Scale the game to screen size </span>
</span></span><span style="display:flex;"><span>    Matrix.CreateTranslation(_gameOffset.X, _gameOffset.Y, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// Translate game to letterbox position</span></span></span></code></pre></div><p>Then we can apply this transformation to any <code>SpriteBatch.Begin()</code> call used to render game sprites:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">// Draw the game using SpriteBatch</span>
</span></span><span style="display:flex;"><span>_spriteBatch.Begin(transformMatrix: transform);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">//TODO: Draw Calls</span>
</span></span><span style="display:flex;"><span>_spriteBatch.End();</span></span></code></pre></div><h3 id="variations">Variations</h3>
<p>Note that you may choose to <em>not</em> transform and scale some <code>SpriteBatch</code> operations - such as when drawing your GUI.  You can use a separate batch for those (but remember, the bounds of the screen viewport may be different depending on your screen resolution, so you may want to position elements relative to the available space).  Or, you could use the scale-to-fill strategy for your game and the scale-to-fit strategy for your GUI.</p>
<p>Another alternative is that instead of determining the resolution based on the graphics adapter default, you can allow the user to select resolutions from a menu.</p>
<h3 id="github-example">GitHub Example</h3>
<p>I&rsquo;ve posted an example project that allows you to explore these concepts on GitHub: <a href="https://github.com/zombiepaladin/scale-to-screen" target="_blank">https://github.com/zombiepaladin/scale-to-screen</a>
</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>While the discussion here focused on games which are sized to the screen, it can <em>also</em> apply to games in which the world is <em>larger</em> than the screen, and the displayed portions of the game scroll with the player.  In those cases, you still need to define your game&rsquo;s design resolution, which determines how much of the game will appear on-screen at any given time.</p>
<p>You just need to combine the ideas from this approach with those handling scrolling, which we&rsquo;ll talk about next.</p>
</div>
</div>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="special-effects">Special Effects</h1>

<p>In addition to the more practical uses like scrolling, combining matrix transformations with the <code>SpriteBatch</code> can be used to create a variety of special effects, i.e. zooming into and out of the scene, rotating game worlds, screen shaking, and probably many others.</p>
<h3 id="zooming">Zooming</h3>
<p>To zoom into the scene, we simply scale up all the elements.  However, we need this scaling to occur <em>from the center of the viewport (the part of the game we see)</em>.  If we simply used a scale matrix, the scaling would be centered on the world origin, so we would end up displaying a different part of the world.</p>
<p>Consider two maps - one at twice the scale of the first.  If you laid the two maps so that the the two upper-left hand corners were aligned, and then put a pin through a city in the smaller map, the corresponding city in the larger map would actually be to the right and below the pin.  Instead of lining up the corners, you would need to line up the two cities.</p>
<p>We can do the same thing in MonoGame by <em>translating</em> everything in our world so that the origin is now at the center of our screen.  Consider the case where our game&rsquo;s viewport is 760x480, and the distance it&rsquo;s top-left corner is from the origin of the world is represented by the <code>offset</code> vector.  We can create a translation matrix that would move the center of that viewport to the origin with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix zoomTranslation = Matrix.CreateTranslation(-offset.X - <span style="color:#ae81ff">760f</span>/<span style="color:#ae81ff">2</span>, -offset.Y - <span style="color:#ae81ff">480f</span>/<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div><p>And our scale matrix with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix zoomScale = Matrix.CreateScale(zoom);</span></span></code></pre></div><p>Where <code>zoom</code> is our zoom factor (<code>1.0f</code> indicating no zoom, &gt; 1 indicating zooming in, and &lt; 1 indicating zooming out).</p>
<p>The transformation matrix we would use to zoom would then be the translation matrix multiplied by our scale matrix, then multiplied by the <em>inverse</em> of the translation matrix.  Basically, we move the world to the origin, scale, and then move it back:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix zoomTransform = zoomTranslation * zoomScale * Matrix.Invert(zoomTranslation);</span></span></code></pre></div><p>We can then plug this matrix into our <code>SpriteBatch.Begin()</code> method as the <code>transformMatrix</code> parameter:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>_spriteBatch.Draw(transformMatrix: zoomTransform);</span></span></code></pre></div><h3 id="spinning-the-world">Spinning the World</h3>
<p>Another interesting technique is to <em>spin</em> the game world.  For example, we might have a platform-style game where the player walks around a rotating planetoid.  For this, we simply use a rotation matrix.  But, as with scaling, we need to first translate the world to the origin of our rotation (the center of our planetoid), rotate, and translate back:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix spinTranslation = Matrix.CreateTranslation(-<span style="color:#ae81ff">860</span>, -<span style="color:#ae81ff">908</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>Matrix spinRotation = Matrix.CreateRotationZ(_rotation);
</span></span><span style="display:flex;"><span>Matrix spinTransform = spinTranslation * spinRotation * Matrix.Invert(spinTranslation);</span></span></code></pre></div><h3 id="screen-shake">Screen Shake</h3>
<p>A third technique that can create an interesting effect is to <em>shake</em> the game world.  This could be used to visually represent an earthquake, rocket launch, or other intense action.  Basically we want to create small changes in the position of the viewport each frame.  This could be done completely randomly, but using a function like $sine$ or $cosine$ yields more predictable results (remember, the output of these functions falls the range $(-1 .. 1)$ and are the inverse of the other).</p>
<p>We can combine those functions with a timer to create a shaking effect, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Matrix shakeTransform = Matrix.Identity;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (_shaking)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _shakeTime += (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalMilliseconds;
</span></span><span style="display:flex;"><span>    shakeTransform = Matrix.CreateTranslation(<span style="color:#ae81ff">10</span> * MathF.Sin(_shakeTime), <span style="color:#ae81ff">10</span> * MathF.Cos(_shakeTime), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_shakeTime &gt; <span style="color:#ae81ff">3000</span>) _shaking = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Will create a three-second shaking of the screen, when the resulting translation matrix is use with the <code>SpriteBatch</code>.  This results in a 20-pixel variation on the position items are rendered in the game world.  You could elaborate upon this simple technique by applying easing (making the magnitude of the shake grow and fall during the shake duration).</p>
<h3 id="github-example">GitHub Example</h3>
<p>You can of course combine these effects into a composite operation.  I&rsquo;ve posted an example project doing just that on GitHub: <a href="https://github.com/zombiepaladin/spritebatch-transform-special-effects" target="_blank">https://github.com/zombiepaladin/spritebatch-transform-special-effects</a>
 for your perusal.  And this is just a small sampling of what you could possibly do.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we explored using the <code>transformMatrix</code> parameter of <code>SpriteBatch.Begin()</code> to apply a transformation matrix to an entire batch of sprites we are rendering.  This provides us with an easy mechanism for implementing a scrolling world in our games.  We also looked at how we could clamp that scrolling to keep the edges of the game world on-screen.</p>
<p>Building upon the scrolling idea, we also examined parallax scrolling, where we create the illusion of depth by scrolling multiple layers at different speeds.  When implemented with <code>SpriteBatch</code>, each layer used a different batch of sprites and its own transform matrix.</p>
<p>We also explored other ideas for manipulating the <code>SpriteBatch</code> transform, including effects like zooming, spinning the game world, and shaking the scene.  We saw how these could be combined through simple matrix multiplication to create composite effects.</p>
<p>Finally, we saw how we could use scaling to adapt our game to any monitor resolution while preserving our games&rsquo; designed aspect ratio.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="particle-systems">Particle Systems</h1>

<p>One, Two, three, &hellip; BOOM!</p>
<img src="https://media.giphy.com/media/2dnGHOAQt1tIziib5X/giphy.gif" />
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Particle Systems</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Continuing our exploration of the SpriteBatch and Sprites, let&rsquo;s turn our attention to <em>particle systems</em>.  Particle systems leverage thousands of very small sprites to create the illusion of fire, smoke, explosions, precipitation, waterfalls, and many other interesting effects.  They are a staple in modern game engines both to create ambience (i.e. fires and smoke) and to enhance gameplay (glowing sparkles around objects that can be interacted with).  In this section, we&rsquo;ll discuss the basics of how particle systems work, and iteratively build a particle system in MonoGame that can be used in your own games.</p>
<p>This approach is based on one that appeared in the original XNA samples, but has been modified for ease of use.  You can see the original source updated for MonoGame on GithHub at <a href="https://github.com/CartBlanche/MonoGame-Samples/tree/master/ParticleSample" target="_blank">https://github.com/CartBlanche/MonoGame-Samples/tree/master/ParticleSample</a>
</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-particle">The Particle</h1>

<p>At the heart of a particle system is a collection of particles - tiny sprites that move independently of one another, but when rendered together, create the interesting effects we are after.  To draw each individual particle, we need to know where on the screen it should appear, as well as the texture we should be rendering, and any color effects we might want to apply.  Moreover, each frame our particles will be moving, so we&rsquo;ll also want to be able to track information to make that process easier, like velocity, acceleration, and how long a particle has been &ldquo;alive&rdquo;.</p>
<p>With thousands of particles in a system, it behooves us to think on efficiency as we write this representation.  The <a href="https://gameprogrammingpatterns.com/flyweight.html" target="_blank">flyweight pattern</a>
 is a great fit here - each particle in the system can be implemented as a flyweight.  This means that we only store the information that is <em>specific to that particle</em>.  Any information shared by <em>all</em> particles will instead be stored in the <code>ParticleSystem</code> class, which we&rsquo;ll define separately.</p>
<p>We&rsquo;ll start with a fairly generic properties that are used by most particle systems:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a single particle in a particle system </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current position of the particle. Default (0,0).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Vector2 Position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current velocity of the particle. Default (0,0).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Vector2 Velocity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current acceleration of the particle. Default (0,0).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Vector2 Acceleration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current rotation of the particle. Default 0.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Rotation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current angular velocity of the particle. Default 0.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> AngularVelocity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current angular acceleration of the particle. Default 0.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> AngularAcceleration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current scale of the particle.  Default 1.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Scale = <span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current lifetime of the particle (how long it will &#34;live&#34;).  Default 1s.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Lifetime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// How long this particle has been alive </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> TimeSinceStart;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// The current color of the particle. Default White</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Color Color = Color.White;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// If this particle is still alive, and should be rendered</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> Active =&gt; TimeSinceStart &lt; Lifetime;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Here we&rsquo;ve created fields to hold all information unique to the particle, both for updating and drawing it.  Feel free to add or remove fields specific to your needs; this sampling represents only some of the most commonly used options.  Note that we don&rsquo;t define a texture here - all the particles in a particle system typically share a single texture (per the flyweight pattern), and that texture is maintained by the particle system itself.</p>
<p>We should also write an initialize function to initialize the values of a newly minted particle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Sets the particle up for first use, restoring defaults</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Position = <span style="color:#66d9ef">where</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Velocity = Vector2.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Acceleration = Vector2.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Rotation = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularVelocity = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularAcceleration = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Scale = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Color = Color.White;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Lifetime = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.TimeSinceStart = <span style="color:#ae81ff">0f</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We can also provide some overloads of this method to allow us to specify additional parameters (avoiding setting them twice - once to the default value and once to the expected value).  An easy way to keep these under control is to provide <em>default</em> values.  Unfortunately, we can only do this for values that can be determined at compile time (i.e. primitives), so the vectors cannot have a default value.  Thus, we would need at least three overloads:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Sets the particle up for first use </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(Vector2 position, Vector2 velocity, <span style="color:#66d9ef">float</span> lifetime = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> scale = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> rotation = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularVelocity = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularAcceleration = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Position = position;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Velocity = velocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Acceleration = Vector2.Zero;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Lifetime = lifetime;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.TimeSinceStart = <span style="color:#ae81ff">0f</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Scale = scale;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Rotation = rotation;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularVelocity = angularVelocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularAcceleration = angularAcceleration;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Color = Color.White;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Sets the particle up for first use </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(Vector2 position, Vector2 velocity, Vector2 acceleration, <span style="color:#66d9ef">float</span> lifetime = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> scale = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> rotation = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularVelocity = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularAcceleration = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Position = position;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Velocity = velocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Acceleration = acceleration;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Lifetime = lifetime;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.TimeSinceStart = <span style="color:#ae81ff">0f</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Scale = scale;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Rotation = rotation;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularVelocity = angularVelocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularAcceleration = angularAcceleration;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Color = Color.White;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Sets the particle up for first use </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Initialize(Vector2 position, Vector2 velocity, Vector2 acceleration, Color color, <span style="color:#66d9ef">float</span> lifetime = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> scale = <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">float</span> rotation = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularVelocity = <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">float</span> angularAcceleration = <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Position = position;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Velocity = velocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Acceleration = acceleration;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Lifetime = lifetime;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.TimeSinceStart = <span style="color:#ae81ff">0f</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Scale = scale;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Rotation = rotation;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularVelocity = angularVelocity;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.AngularAcceleration = angularAcceleration;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Color = color;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>You might wonder why we don&rsquo;t use a constructor for this initialization.  The answer is because we&rsquo;ll want to reuse the same <code>Particle</code> instance multiple times - we&rsquo;ll see this soon, in the particle system.  We&rsquo;ll turn our attention to that next.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-particle-system-class">The Particle System Class</h1>

<p>The next part of the particle system is the class representing the particle system itself.  Like any other sprite-based strategy, this will involve both an <code>Update()</code> and <code>Draw()</code> method that must be invoked every time through the game loop.  But ideally we&rsquo;d like our particle systems to be an almost hands-off system - once it&rsquo;s created, we can just let it do its thing without intervention.  This is where the idea of game components from our <a href="">architecture discussion</a>
 can come into play - our particle system can inherit from the  <code>DrawableGameComponent</code> class, which means it can be added to to our <code>Game.Components</code> list and the <code>Game</code> will handle invoking those methods for us every frame:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a generic particle system</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ParticleSystem</span> : DrawableGameComponent
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add fields, properties, and methods</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Now we want to add generic functionality for a particle system, and in doing so, we want to make sure the system is as efficient as possible - remember, we may be updating and rendering <em>thousands</em> of sprites for each active particle system.  We&rsquo;ll keep this in mind throughout the design process.  Let&rsquo;s start by defining some fields that determine the behavior of the particle system.  As we do this, we&rsquo;ll stretch our use of the C# programming language in ways you may have not done so previously.</p>
<h3 id="constants">Constants</h3>
<p>We&rsquo;ll start by defining a couple of constants, <code>AlphaBlendDrawOrder</code> and <code>AdditiveBlendDrawOrder</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The draw order for particles using Alpha Blending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Particles drawn using additive blending should be drawn on top of </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// particles that use regular alpha blending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> AlphaBlendDrawOrder = <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The draw order for particles using Additive Blending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Particles drawn using additive blending should be drawn on top of </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// particles that use regular alpha blending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/remarks&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> AdditiveBlendDrawOrder = <span style="color:#ae81ff">200</span>;</span></span></code></pre></div><p>Remember that the <code>DrawOrder</code> property of a <code>DrawableGameComponent</code> determines the order in which they are drawn.  These constants represent values we can reference when setting that draw order, based on what kind of alpha blending we are using.</p>
<h3 id="static-fields">Static Fields</h3>
<p>To use our particle systems, we&rsquo;ll need both a <code>ContentManager</code> and <code>SpriteBatch</code> instance.  We could create one for each particle system, but that creates a lot of unnecessary objects.  Alternatively, we could share the ones created in our <code>Game</code> class, which would be the most efficient approach.  However, that does mean those need to be made public, and we need to pass the derived class into this one.  As a comfortable middle ground, we&rsquo;ll create protected static fields for these, so that all particle systems share a single set:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A SpriteBatch to share amongst the various particle systems</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">static</span> SpriteBatch spriteBatch;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A ContentManager to share amongst the various particle systems</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">static</span> ContentManager contentManager;</span></span></code></pre></div><h3 id="private-fields">Private Fields</h3>
<p>This class needs to hold our collection of particles, and in keeping with the <a href="https://gameprogrammingpatterns.com/data-locality.html" target="_blank">data locality pattern</a>
, we&rsquo;d like these to be stored sequentially.  An array is therefore a great fit.  Add it as a private field to the class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The collection of particles </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Particle[] particles;</span></span></code></pre></div><p>We&rsquo;ll also use a <code>Queue</code> (from <code>System.Collections.Generic</code>) to hold references to unused particles.  This way we can avoid re-creating particles and creating a glut in memory that will result in the garbage collector running often.  We could store a reference directly to the particle location, or an index indicating its position in the array.  We&rsquo;ll opt for the former here, as it provides some benefits in usage:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A Queue containing indices of unused particles in the Particles array</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Queue&lt;Particle&gt; freeParticles;</span></span></code></pre></div><p>As we said in the discussion of the <code>Particle</code> class, in using the <a href="https://gameprogrammingpatterns.com/flyweight.html" target="_blank">Flyweight Pattern</a>
 the actual texture will be held by our <code>ParticleSystem</code>, so let&rsquo;s add a private variable to hold that:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The texture this particle system uses </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Texture2D texture;</span></span></code></pre></div><p>We&rsquo;ll also keep track of an origin vector for when we draw the textures:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The origin when we&#39;re drawing textures </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Vector2 origin;</span></span></code></pre></div><h3 id="public-fields">Public Fields</h3>
<p>It can also be useful to know how many particles are currently available (free) in the system.  We can expose this value with a public property:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The available particles in the system </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> FreeParticleCount =&gt; freeParticles.Count;</span></span></code></pre></div><h3 id="protected-fields">Protected Fields</h3>
<p>A slightly unique approach we&rsquo;ll adopt here is defining a number of <code>protected</code> fields that essentially define the behavior of the particle system.  These represent the information that is shared amongst all particles in the system.  We make them protected so that derived particle systems can adjust them to suit the needs of the effect we are trying to create.  For example the <code>blendState</code> determines how a texture is drawn, and the <code>textureFilename</code> helps define which texture to use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;The BlendState to use with this particle system&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> BlendState blendState = BlendState.AlphaBlend;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;The filename of the texture to use for the particles&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">string</span> textureFilename;</span></span></code></pre></div><p>We&rsquo;ll also use a min/max pair to determine the number of particles to activate in the system each time we add particles:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;The minimum number of particles to add when AddParticles() is called&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> minNumParticles;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;The maximum number of particles to add when AddParticles() is called&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> maxNumParticles;</span></span></code></pre></div><p>Like the <code>Particle</code> class&rsquo; fields, these too could be tweaked to meet the needs of your game.</p>
<h3 id="constructor">Constructor</h3>
<p>As the <code>DrawableGameComponent</code> has a constructor requiring a <code>Game</code> instance, we must provide our own constructor that passes that along by invoking <code>base()</code> (which runs the constructor of the base object).  We&rsquo;ll also want to initialize our <code>particles</code> array and <code>freeParticles</code> queue, which means we need to know the maximum number of particles we&rsquo;ll allow in this particle system.  Therefore, we&rsquo;ll add that as a second parameter.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new instance of a particle system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ParticleSystem(Game game, <span style="color:#66d9ef">int</span> maxParticles) : <span style="color:#66d9ef">base</span>(game) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Create our particles</span>
</span></span><span style="display:flex;"><span>        particles = <span style="color:#66d9ef">new</span> Particle[maxParticles];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; particles.Length; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            particles[i] = <span style="color:#66d9ef">new</span> Particle();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add all free particles to the queue</span>
</span></span><span style="display:flex;"><span>        freeParticles = <span style="color:#66d9ef">new</span> Queue&lt;Particle&gt;(particles);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Run the InitializeConstants hook</span>
</span></span><span style="display:flex;"><span>        InitializeConstants();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Since none of the particles are in use, we&rsquo;ll also initialize our Queue with <em>all</em> the newly created particles.  This has the helpful side effect of allocating enough memory to hold a reference to each particle in our array, ensuring we never need to re-allocate.</p>
<p>Finally, we invoke <code>InitializeConstants()</code>, a protected method that is intended to be used as a <em>hook</em> - a method that can be overridden to inject your own functionality into the class.  Let&rsquo;s look at this, and the other hook methods next</p>
<h3 id="virtual-hook-methods">Virtual Hook Methods</h3>
<p>Now that we have the structure of the class put together, let&rsquo;s start thinking about the functionality.  We&rsquo;ll write a couple of <code>virtual</code> hook methods to define the default behavior we expect from our particles - most notably setting those protected constant values, <em>initializing</em> new active particles to the particle system, and then <em>updating</em> those particles each frame.  We&rsquo;ll make these methods virtual so we can override them in derived classes, but also provide a base implementation when one makes sense.  Let&rsquo;s start with <code>InitializeConstants()</code> we invoked above:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Used to do the initial configuration of the particle engine.  The </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// protected constants `textureFilename`, `minNumParticles`, and `maxNumParticles`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// should be set in the override.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> InitializeConstants() { }</span></span></code></pre></div><p>If the <code>textureFilename</code> is not set here, we&rsquo;ll encounter a runtime error, so this <em>must</em> be overridden in the derived classes. As a possible way to emphasize this, we could instead declare this method, and the <code>ParticleSystem</code> class as <code>abstract</code>.</p>
<p>In contrast, the <code>InitializeParticle()</code> hook method will provide some logic that could potentially be used, but will also probably be overridden in most cases:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// InitializeParticle randomizes some properties for a particle, then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// calls initialize on it. It can be overridden by subclasses if they </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// want to modify the way particles are created.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;the particle to initialize&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;the position on the screen that the particle should be</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> InitializeParticle(Particle p, Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Initialize the particle with default values</span>
</span></span><span style="display:flex;"><span>        p.Initialize(<span style="color:#66d9ef">where</span>);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Similarly, we will supply a default implementation for <em>updating</em> a particle.  Our default approach is based on Newtonian physics:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the individual particles.  Can be overridden in derived classes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;particle&#34;&gt;The particle to update&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;dt&#34;&gt;The elapsed time&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> UpdateParticle(Particle particle, <span style="color:#66d9ef">float</span> dt)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Update particle&#39;s linear motion values</span>
</span></span><span style="display:flex;"><span>        particle.Velocity += particle.Acceleration * dt;
</span></span><span style="display:flex;"><span>        particle.Position += particle.Velocity * dt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Update the particle&#39;s angular motion values</span>
</span></span><span style="display:flex;"><span>        particle.AngularVelocity += particle.AngularAcceleration * dt;
</span></span><span style="display:flex;"><span>        particle.Rotation += particle.AngularVelocity * dt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Update the time the particle has been alive </span>
</span></span><span style="display:flex;"><span>        particle.TimeSinceStart += dt;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This implementation works for a wide variety of particle systems, but it can be overridden by a derived particle system if something different is needed.</p>
<h3 id="drawablegamecomponent-overrides">DrawableGameComponent Overrides</h3>
<p>Now we can tackle the methods from <code>DrawableGameComponent</code>, which we&rsquo;ll need to replace with our own custom overrides.  First, we&rsquo;ll load the texture in our <code>LoadContent</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Override the base class LoadContent to load the texture. once it&#39;s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// loaded, calculate the origin.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;throws&gt;A InvalidOperationException if the texture filename is not provided&lt;/throws&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> LoadContent()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create the shared static ContentManager and SpriteBatch,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// if this hasn&#39;t already been done by another particle engine</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (contentManager == <span style="color:#66d9ef">null</span>) contentManager = <span style="color:#66d9ef">new</span> ContentManager(Game.Services, <span style="color:#e6db74">&#34;Content&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (spriteBatch == <span style="color:#66d9ef">null</span>) spriteBatch = <span style="color:#66d9ef">new</span> SpriteBatch(Game.GraphicsDevice);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// make sure sub classes properly set textureFilename.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrEmpty(textureFilename))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> message = <span style="color:#e6db74">&#34;textureFilename wasn&#39;t set properly, so the &#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;particle system doesn&#39;t know what texture to load. Make &#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;sure your particle system&#39;s InitializeConstants function &#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;properly sets textureFilename.&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(message);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// load the texture....</span>
</span></span><span style="display:flex;"><span>        texture = contentManager.Load&lt;Texture2D&gt;(textureFilename);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... and calculate the center. this&#39;ll be used in the draw call, we</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// always want to rotate and scale around this point.</span>
</span></span><span style="display:flex;"><span>        origin.X = texture.Width / <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        origin.Y = texture.Height / <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.LoadContent();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>In addition to loading the texture, we make sure that our shared <code>ContentManager</code> and <code>SpriteBatch</code> are created, and calculate the <code>Origin</code> for the texture.</p>
<p>Our <code>Update()</code> method iterates over the particles and updates each one, invoking our <code>UpdateParticle()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Overriden from DrawableGameComponent, Update will update all of the active</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// particles.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// calculate dt, the change in the since the last frame. the particle</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// updates will use this value.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> dt = (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// go through all of the particles...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (Particle p <span style="color:#66d9ef">in</span> particles)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (p.Active)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// ... and if they&#39;re active, update them.</span>
</span></span><span style="display:flex;"><span>                UpdateParticle(p, dt);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// if that update finishes them, put them onto the free particles</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// queue.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!p.Active)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    freeParticles.Enqueue(p);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Notice that we only update the <em>active</em> particles.  And if a particle is no longer active after we update it, we add it to the <code>freeParticles</code> queue to be reused.</p>
<p>Similarly, our <code>Draw()</code> method draws only the active particles:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Overriden from DrawableGameComponent, Draw will use the static </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// SpriteBatch to render all of the active particles.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// tell sprite batch to begin, using the BlendState specified in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// initializeConstants</span>
</span></span><span style="display:flex;"><span>        spriteBatch.Begin(blendState: blendState);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (Particle p <span style="color:#66d9ef">in</span> particles)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// skip inactive particles</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!p.Active)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            spriteBatch.Draw(texture, p.Position, <span style="color:#66d9ef">null</span>, p.Color,
</span></span><span style="display:flex;"><span>                p.Rotation, origin, <span style="color:#ae81ff">1</span>, SpriteEffects.None, <span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        spriteBatch.End();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Draw(gameTime);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Note that we provide a <code>SpriteBlendState</code> to the <code>SpriteBatch.Begin()</code> call, as different blend states can replicate different effects.  We&rsquo;ll see this in play soon.</p>
<h3 id="methods-for-adding-particles-to-the-system">Methods for Adding Particles to the System</h3>
<p>Finally, we need some methods to add active particles into our system (otherwise, nothing will ever be drawn)!  We&rsquo;ll create two generic protected methods for doing this, which can be utilized by the derived particle system classes.  We&rsquo;ll start with one that adds particles at a specific position (defined by a <code>Vector2</code>):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// AddParticles&#39;s job is to add an effect somewhere on the screen. If there </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// aren&#39;t enough particles in the freeParticles queue, it will use as many as </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// it can. This means that if there not enough particles available, calling</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// AddParticles will have no effect.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;where the particle effect should be created&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> AddParticles(Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the number of particles we want for this effect is a random number</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// somewhere between the two constants specified by the subclasses.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> numParticles =
</span></span><span style="display:flex;"><span>            RandomHelper.Next(minNumParticles, maxNumParticles);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create that many particles, if you can.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; numParticles &amp;&amp; freeParticles.Count &gt; <span style="color:#ae81ff">0</span>; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// grab a particle from the freeParticles queue, and Initialize it.</span>
</span></span><span style="display:flex;"><span>            Particle p = freeParticles.Dequeue();
</span></span><span style="display:flex;"><span>            InitializeParticle(p, <span style="color:#66d9ef">where</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This approach is especially useful for effects like explosions, which start with a bunch of particles, but don&rsquo;t create more.</p>
<p>We may instead want to supply a region of screen space (say, a rectangle) to fill with particles:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// AddParticles&#39;s job is to add an effect somewhere on the screen. If there </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// aren&#39;t enough particles in the freeParticles queue, it will use as many as </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// it can. This means that if there not enough particles available, calling</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// AddParticles will have no effect.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;where the particle effect should be created&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> AddParticles(Rectangle <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the number of particles we want for this effect is a random number</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// somewhere between the two constants specified by the subclasses.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> numParticles =
</span></span><span style="display:flex;"><span>            RandomHelper.Next(minNumParticles, maxNumParticles);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// create that many particles, if you can.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; numParticles &amp;&amp; freeParticles.Count &gt; <span style="color:#ae81ff">0</span>; i++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// grab a particle from the freeParticles queue, and Initialize it.</span>
</span></span><span style="display:flex;"><span>            Particle p = freeParticles.Dequeue();
</span></span><span style="display:flex;"><span>            InitializeParticle(p, RandomHelper.RandomPosition(<span style="color:#66d9ef">where</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This works well for something like rain and snow - we can add it just off-screen (say above the top of the screen) and let it flow over the screen based on its direction and speed.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="example-particle-systems">Example Particle Systems</h1>

<p>To create a particle system, we&rsquo;ll derive a class from the <code>ParticleSystem</code> class and override its <code>InitializeConstants()</code>, and possibly its <code>InitializeParticle()</code> and <code>UpdateParticle()</code> methods.  Let&rsquo;s look at some examples:</p>
<h3 id="rain-particle-system">Rain Particle System</h3>
<p>This is a simplistic implementation of rain that is spawned in a predefined rectangle and falls to the bottom of the screen.  The texture we&rsquo;ll use is <a href="https://ksu-cs-textbooks.github.io/cis580/images/drop.png">this drop</a>
</p>
<p>We start by defining a class extending the <code>ParticleSystem</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class embodying a particle system emulating rain</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RainParticleSystem</span> : ParticleSystem
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add Implementation</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Inside this class, we&rsquo;ll define a private <code>Rectangle</code> field to represent where the rain begins:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The source of the rain</span>
</span></span><span style="display:flex;"><span>    Rectangle _source;</span></span></code></pre></div><p>And a boolean property to start and stop the rain:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Determines if it is currently raining or not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> IsRaining { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#66d9ef">true</span>;</span></span></code></pre></div><p>We&rsquo;ll add a constructor that must also invoke the <code>ParticleSystem</code> constructor.  We&rsquo;ll supply the <code>Rectangle</code> to use for the source, and hard-code a maximum amount of particles (this may need to be tweaked for larger/smaller rain effects - if there aren&rsquo;t enough particles there will be gaps in the rain):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs the rain particle system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this particle system belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;source&#34;&gt;A rectangle defining where the raindrops start&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> RainParticleSystem(Game game, Rectangle source) : <span style="color:#66d9ef">base</span>(game, <span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _source = source;    
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We override the <code>InitializeConstants()</code> to set the number of particles that should be spawned with an <code>AddParticles()</code> method call, and the name of the texture to use:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initialize the particle system constants</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeConstants()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We&#39;ll use a raindrop texture</span>
</span></span><span style="display:flex;"><span>        textureFilename = <span style="color:#e6db74">&#34;opaque-drop&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We&#39;ll spawn a large number of particles each frame </span>
</span></span><span style="display:flex;"><span>        minNumParticles = <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>        maxNumParticles = <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Then we override the <code>InitializeParticle()</code> method of the base <code>ParticleSystem</code> to provide custom behavior for our rain particles.  Basically, they just fall straight down.  However, you could expand on this to add wind, etc.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes individual particles</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;Where the particle appears&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeParticle(Particle p, Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.InitializeParticle(p, <span style="color:#66d9ef">where</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// rain particles fall downward at the same speed</span>
</span></span><span style="display:flex;"><span>        p.Velocity = Vector2.UnitY * <span style="color:#ae81ff">260</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// rain particles have already hit terminal velocity,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// and do not spin, so we don&#39;t need to set the other</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// physics values (they default to 0)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we&#39;ll use blue for the rain </span>
</span></span><span style="display:flex;"><span>        p.Color = Color.Blue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// rain particles are small</span>
</span></span><span style="display:flex;"><span>        p.Scale = <span style="color:#ae81ff">0.1f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// rain particles need to reach the bottom of the screen</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// it takes about 3 seconds at current velocity/screen size</span>
</span></span><span style="display:flex;"><span>        p.Lifetime = <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Finally, we&rsquo;ll override the <code>Update()</code> method from <code>DrawableGameComponent</code> to add spawning new droplets every frame within our source rectangle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Override the default DrawableGameComponent.Update method to add </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// new particles every frame.  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing the game time&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Spawn new rain particles every frame</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(IsRaining) AddParticles(_source);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="explosion-particle-system">Explosion Particle System</h3>
<p>Another particle effect we see often in games is explosions.  Let&rsquo;s create an effect that will let us create explosions at specific points on-screen as our game is running.  We&rsquo;ll use <a href="https://ksu-cs-textbooks.github.io/cis580/images/explosion.png">this explosion texture</a>
.</p>
<p>We again start by defining a new class derived from <code>ParticleSystem</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A GameComponent providing a particle system to render explosions in a game</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExplosionParticleSystem</span> : ParticleSystem
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add implementation</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Our constructor will invoke the base <code>ParticleSystem</code> constructor, but we&rsquo;ll also ask for the maximum number of anticipated explosions the system needs to handle.  As each explosion needs 20-25 particles, we&rsquo;ll multiply that value by 25 to determine how many particles the system needs to have:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new explosion particle system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game to render explosions in&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;maxExplosions&#34;&gt;The anticipated maximum number of explosions on-screen at one time&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ExplosionParticleSystem(Game game, <span style="color:#66d9ef">int</span> maxExplosions)
</span></span><span style="display:flex;"><span>        : <span style="color:#66d9ef">base</span>(game, maxExplosions * <span style="color:#ae81ff">25</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>The explosion will use an explosion texture, 20-25 particles per explosion, and <em>additive blending</em>.  This blend mode means if two particles overlap, their colors are added together.  As more particle combine, the combined color gets closer to white, meaning the center of the explosion will be bright white, but as the particles spread out they will get redder (as the texture is red and yellow).  We&rsquo;ll set these up by overriding the <code>ParticleSystem.InitializeConstants()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Set up the constants that will give this particle system its behavior and</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// properties.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeConstants()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        textureFilename = <span style="color:#e6db74">&#34;explosion&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We&#39;ll use a handful of particles for each explosion</span>
</span></span><span style="display:flex;"><span>        minNumParticles = <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>        maxNumParticles = <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Additive blending is very good at creating fiery effects.</span>
</span></span><span style="display:flex;"><span>        blendState = BlendState.Additive;
</span></span><span style="display:flex;"><span>        DrawOrder = AdditiveBlendDrawOrder;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We&rsquo;ll also override <code>ParticleSystem.InitializeParticle()</code> to provide the default starting state for all particles:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the particle &lt;paramref name=&#34;p&#34;/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;Where the particle begins its life&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeParticle(Particle p, Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.InitializeParticle(p, <span style="color:#66d9ef">where</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Explosion particles move outward from the point of origin in all directions,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// at varying speeds</span>
</span></span><span style="display:flex;"><span>        p.Velocity = RandomHelper.RandomDirection() * RandomHelper.NextFloat(<span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Explosions should be relatively short lived</span>
</span></span><span style="display:flex;"><span>        p.Lifetime = RandomHelper.NextFloat(<span style="color:#ae81ff">0.5f</span>, <span style="color:#ae81ff">1.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Explosion particles spin at different speeds</span>
</span></span><span style="display:flex;"><span>        p.AngularVelocity = RandomHelper.NextFloat(-MathHelper.PiOver4, MathHelper.PiOver4);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Explosions move outwards, then slow down and stop because of air resistance.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Let&#39;s set acceleration so that when the particle is at max lifetime, the velocity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// will be zero.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We&#39;ll use the equation vt = v0 + (a0 * t). (If you&#39;re not familiar with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// this, it&#39;s one of the basic kinematics equations for constant</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// acceleration, and basically says:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// velocity at time t = initial velocity + acceleration * t)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We&#39;ll solve the equation for a0, using t = p.Lifetime and vt = 0.</span>
</span></span><span style="display:flex;"><span>        p.Acceleration = -p.Velocity / p.Lifetime;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And we&rsquo;ll also override the <code>ParticleSystem.Update()</code> method, so we can use custom logic to change the color and scale of the particle over its lifetime:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// We override the UpdateParticle() method to scale and colorize </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// explosion particles over time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;particle&#34;&gt;the particle to update&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;dt&#34;&gt;the time elapsed between frames&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> UpdateParticle(Particle particle, <span style="color:#66d9ef">float</span> dt)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.UpdateParticle(particle, dt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// normalized lifetime is a value from 0 to 1 and represents how far</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// a particle is through its life. 0 means it just started, .5 is half</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// way through, and 1.0 means it&#39;s just about to be finished.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// this value will be used to calculate alpha and scale, to avoid </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// having particles suddenly appear or disappear.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> normalizedLifetime = particle.TimeSinceStart / particle.Lifetime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we want particles to fade in and fade out, so we&#39;ll calculate alpha</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// to be (normalizedLifetime) * (1-normalizedLifetime). this way, when</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// normalizedLifetime is 0 or 1, alpha is 0. the maximum value is at</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// normalizedLifetime = .5, and is</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// (normalizedLifetime) * (1-normalizedLifetime)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// (.5)                 * (1-.5)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// .25</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// since we want the maximum alpha to be 1, not .25, we&#39;ll scale the </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// entire equation by 4.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> alpha = <span style="color:#ae81ff">4</span> * normalizedLifetime * (<span style="color:#ae81ff">1</span> - normalizedLifetime);
</span></span><span style="display:flex;"><span>        particle.Color = Color.White * alpha;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// make particles grow as they age. they&#39;ll start at 75% of their size,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// and increase to 100% once they&#39;re finished.</span>
</span></span><span style="display:flex;"><span>        particle.Scale = particle.Scale * (.<span style="color:#ae81ff">75f</span> + .<span style="color:#ae81ff">25f</span> * normalizedLifetime);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And finally, we need to allow the game to place explosion effects, so we&rsquo;ll add a public method to do so:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Places an explosion at location &lt;paramref name=&#34;where&#34;/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;The location of the explosion&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> PlaceExplosion(Vector2 <span style="color:#66d9ef">where</span>) =&gt; AddParticles(<span style="color:#66d9ef">where</span>);</span></span></code></pre></div><h3 id="pixieparticlesystem">PixieParticleSystem</h3>
<p>Another common use for particle systems is to have them <em>emitted</em> from an object in the game - i.e. the player, an enemy, or something the player can interact with.  Let&rsquo;s explore this idea by making a particle system that emits colored sparks that fall to the ground, like pixie dust.  For this particle system, we&rsquo;ll use <a href="https://ksu-cs-textbooks.github.io/cis580/images/particle.png">this particle texture with a circular gradient</a>
.</p>
<p>Let&rsquo;s start by defining an interface that can serve as our emitter representation.  With an emitter, the particle starts in the same place as the emitter, so need to know its location in the game world, so a <code>Vector2</code> we&rsquo;ll name <code>Position</code>.  Also, if the emitter is moving, we need to know the velocity it is moving at, as the particle will also start with that as its initial velocity, so we&rsquo;ll add a second <code>Vector2</code> named <code>Velocity</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// An interface for the emitter of a particle system</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IParticleEmitter</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The position of the emitter in the world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Position { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The velocity of the emitter in the world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Velocity { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Then we start the particle system the same way as before, by defining a class that inherits from <code>ParticleSystem</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A particle system that drops &#34;pixie dust&#34; from an emitter</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PixieParticleSystem</span> : ParticleSystem
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Add implementation</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We&rsquo;ll want a list of emitters of our <code>IParticleEmitter</code> class so we know where to spawn those particles (this way we can have multiple pixies!):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The emitter for this particle system</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List&lt;IParticleEmitter&gt; Emitters { <span style="color:#66d9ef">get</span>; } = <span style="color:#66d9ef">new</span> List&lt;IParticleEmitter&gt;();</span></span></code></pre></div><p>And we&rsquo;ll construct our particle system with an expected number of pixies to support (with each using around 200 particles):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new PixieParticleSystem to support up to &lt;paramref name=&#34;maxPixies&#34;/&gt; pixies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this system belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;maxPixies&#34;&gt;The maximum number of pixies to support&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> PixieParticleSystem(Game game, <span style="color:#66d9ef">int</span> maxPixies): <span style="color:#66d9ef">base</span>(game, <span style="color:#ae81ff">200</span> * maxPixies) { }</span></span></code></pre></div><p>We override <code>ParticleSystem.InitializeConstants()</code> to set up the particle system values:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Set up the constants that will give this particle system its behavior and</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// properties.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeConstants()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        textureFilename = <span style="color:#e6db74">&#34;particle&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        minNumParticles = <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        maxNumParticles = <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        blendState = BlendState.Additive;
</span></span><span style="display:flex;"><span>        DrawOrder = AdditiveBlendDrawOrder;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And <code>ParticleSystem.InitializeParticle()</code> to initialize individual particles:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initialize the particles</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;p&#34;&gt;The particle to initialize&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;where&#34;&gt;Where the particle initially appears&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InitializeParticle(Particle p, Vector2 <span style="color:#66d9ef">where</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.InitializeParticle(p, <span style="color:#66d9ef">where</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The particle&#39;s initial velocity is the same as the emitter&#39;s</span>
</span></span><span style="display:flex;"><span>        p.Velocity = _emitter.Velocity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The particle is affected by gravity</span>
</span></span><span style="display:flex;"><span>        p.Acceleration.Y = <span style="color:#ae81ff">400</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Randomize the particle size</span>
</span></span><span style="display:flex;"><span>        p.Scale = RandomHelper.NextFloat(<span style="color:#ae81ff">0.1f</span>, <span style="color:#ae81ff">0.5f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Randomize the lifetime of the particles</span>
</span></span><span style="display:flex;"><span>        p.Lifetime = RandomHelper.NextFloat(<span style="color:#ae81ff">0.1f</span>, <span style="color:#ae81ff">1.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The particle also is affected by air resistance;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// lets&#39; scale its X acceleration so it stops moving horizontally by the time it dies</span>
</span></span><span style="display:flex;"><span>        p.Acceleration.X = -p.Velocity.X / p.Lifetime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Since we&rsquo;ll just use the build-in physics, we don&rsquo;t need to override <code>ParticleSystem.UpdateParticle()</code>.  But we will need to add new particles every frame, so we&rsquo;ll override <code>GameComponent.Update()</code> to do so:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Override Update() to add some particles each frame</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;An object representing game time&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">base</span>.Update(gameTime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add particles at the emitter position</span>
</span></span><span style="display:flex;"><span>        AddParticles(_emitter.Position);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This particle system can now be attached to any object implementing the <code>IParticleEmitter</code> interface, and the particles will be spawned wherever that emitter is in the game world!</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="using-particle-systems">Using Particle Systems</h1>

<p>Now that we&rsquo;ve defined some example particle systems, let&rsquo;s see how we can put them into use.</p>
<h3 id="adding-rain">Adding Rain</h3>
<p>Let&rsquo;s start with our <code>RainParticleSystem</code>, and add rain that runs down the screen.  Since we don&rsquo;t need to start/stop the rain for this simple example, all we need to do is construct the particle system and add it to the <code>Game.Components</code> list in the <code>Game.Initialize()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    RainParticleSystem rain = <span style="color:#66d9ef">new</span> RainParticleSystem(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> Rectangle(<span style="color:#ae81ff">100</span>, -<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">10</span>));
</span></span><span style="display:flex;"><span>    Components.Add(rain);</span></span></code></pre></div>
  
  
<div class="box notices cstyle hint">
  <div class="box-label"></div>
  <div class="box-content">

<p>Because the <code>ExplosionParticleSystem</code> inherits from <code>DrawableGameComponent</code>, we can add it to the <code>Game.Components</code> list.  This means the game will automatically call its <code>LoadContent()</code>, <code>Update()</code> and <code>Draw()</code> methods for us.  We could instead not add it to the components list, and manually invoke these ourselves.</p>
</div>
</div>
<h3 id="adding-explosions">Adding Explosions</h3>
<p>Let&rsquo;s say we want an explosion to appear on-screen wherever we click our mouse.  We&rsquo;ll use the <code>ExplosionParticleSystem</code> from the previous section to accomplish this.</p>
<p>First, because we will need to access this system in multiple methods of <code>Game</code> we&rsquo;ll need to create a field to represent it in our <code>Game</code> class.  We&rsquo;ll also want to keep track of the previous mouse state:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ExplosionParticleSystem explosions;
</span></span><span style="display:flex;"><span>    MouseState oldMouseState;</span></span></code></pre></div><p>And initialize it in our <code>Game.Initialize()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    explosions = <span style="color:#66d9ef">new</span> ExplosionParticleSystem(<span style="color:#66d9ef">this</span>, <span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>    Components.Add(explosions);</span></span></code></pre></div><p>We set the particle system to use up to 20 explosions on-screen at a time (as it takes about a second for an explosion to finish, this is probably more than enough, unless we have a very explosive game).</p>
<p>Next, we add some logic to our <code>Update()</code> method to update the mouse state, and determine if we need to place an explosion:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    MouseState newMouseState = Mouse.GetState();
</span></span><span style="display:flex;"><span>    Vector2 mousePosition = <span style="color:#66d9ef">new</span> Vector2(mouseState.X, mouseState.Y);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(newMouseState.Left == ButtonState.Down &amp;&amp; oldMouseState.Left == ButtonState.Up) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        explosions.PlaceExplosion(mousePosition);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Now, whenever we click our mouse, we&rsquo;ll see an explosion spawn!</p>
<h3 id="adding-a-pixie">Adding a Pixie</h3>
<p>Rather than declare a class to represent the mouse and go through that effort, let&rsquo;s just implement the <code>IParticleEmitter</code> interface directly on our <code>Game</code>.  Thus, we need to implement <code>Position</code> and <code>Velocity</code> properties:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Position { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector2 Velocity { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }</span></span></code></pre></div><p>We&rsquo;ll set these in the <code>Game.Update()</code> method, based on our mouse state:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Velocity = mousePosition - Position;
</span></span><span style="display:flex;"><span>    Position = mousePosition;</span></span></code></pre></div><p>And we&rsquo;ll need to add the particle system in the <code>Game.Initialize()</code> method, and set its emitter to the <code>Game</code> instance:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    PixieParticleSystem pixie = <span style="color:#66d9ef">new</span> PixieParticleSystem(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    Components.Add(pixie);</span></span></code></pre></div><p>Now the mouse should start dripping a trail of sparks!</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="refactoring-as-a-game-component">Refactoring as a Game Component</h1>

<p>In this chapter we examined the idea of particle systems, which draw a large number of sprites to create visual effects within the game.  We also went over the design of such a system we can use with MonoGame, leveraging the <code>DrawableGameComponent</code> base class and design approaches like hook methods, to make a relatively hands-off but flexible approach to create new custom particle systems.  We also created three example particle systems to emulate rain, explosions, and a trail of sparks.  You can use these as a starting point for creating your own custom particle systems to meet the needs of your games.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="content-pipeline">Content Pipeline</h1>

<p>Get Your Assets into the Game!</p>
<iframe src="https://giphy.com/embed/k5b6fkFnSA3yo" width="479" height="480" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/sonymusicperu-mariobross-k5b6fkFnSA3yo">via GIPHY</a></p>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Content Pipeline</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>The creation of assets (textures, audio, models, etc) is a major aspect of game development. In fact, asset creators account for most of a game development team (often a 90/10 split between asset creators and programmers). So creating and using assets is a very important part of creating games!</p>
<p>To make this process manageable, most assets are created with other software tools - editors specific to the kind of asset we are dealing with. Asset creators become quite proficient with these tools, and provide their assets in a save file form specific to one of these tools.</p>
<p>We can load these files directly in our game, especially if our game targets Windows, where we have a lot of available supporting libraries. But those file formats are tailored towards the needs of the editor program - they often contain data we don&rsquo;t need, or format it in a way that must be transformed to use in our games. And the processing involved in loading can be a lot more involved than we like, causing long load times.</p>
<p>One way around this is the use of a <em>Content Pipeline</em> which transforms assets from an editor-specific file format to one optimized for our games. This happens during the <em>build</em> process, so the transformed asset files are bundled with our executable, ready to be utilized.</p>
<p>This chapter will describe the content pipeline approach specific to XNA.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="the-content-pipeline">The Content Pipeline</h1>

<p>As we described in the introduction, the XNA Content Pipeline&rsquo;s purpose is to transform asset files (content) in to a form most readily useable by our games. It is implemented as a separate build step that is run every time we compile our game. In fact, each XNA game is actually <em>two</em> projects - the <em>Content</em> project, and the <em>Game</em> project.</p>
<p>The pipeline is broken up into several steps:</p>
<ol>
<li>Importing the asset data</li>
<li>Processing the asset data</li>
<li>Serializing the asset data</li>
<li>Loading the serialized asset data</li>
</ol>
<p>You can see the process here:</p>
<p>
<a href="#image-45f3c67dfd8b8b3cd9e2ce815fa130b3" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/11.2.1.png" alt="XNA Content Pipeline" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-45f3c67dfd8b8b3cd9e2ce815fa130b3">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/11.2.1.png" alt="XNA Content Pipeline" class="lightbox-image" loading="lazy">
</a></p>
<p>Each of these steps is accomplished by a different class.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="extending-the-pipeline">Extending the Pipeline</h1>

<p>You might be wondering why the content pipeline in XNA was created this way - with importers, processors, content writers, and content readers.  The answer is simple - modularity.  If you want to load a new image format that the <code>TextureImporter</code> does not handle, you can write your own custom importer to load its data into a <code>TextureContent</code> object, and then still use the existing <code>TextureProcessor</code> and serialization process.</p>
<p>Alternatively, you may want to handle a new content type that has no associated classes in XNA at all.  In this case, you will need to write a custom importer, processor, writer, and reader.</p>
<p>The tilemaps created by Tiled that we discussed in the previous chapter are a good candidate for this - so let&rsquo;s use that as an example. In this case, our input file is a .tmx file, which is really just a specialized XML file. We can load this data using a process much like the <code>Squared.Tilemap</code> example in the last chapter.</p>
<p>Once loaded, we want to convert the data into a form more akin to how we want to represent tilemaps in <em>our specific game</em>, i.e. transform the tile properties into specific properties we define for our game&rsquo;s tiles, and change the objects into actual spawn points, etc. Our custom content processor can accomplish these tasks.</p>
<p>In addition to loading the tilemap, we&rsquo;d also like to create the textures that correspond to the tilesets, so that we don&rsquo;t have to load them separately. This is also something we can do with a custom content processor.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="extending-the-pipeline">Extending the Pipeline</h1>

<p>You might be wondering why the content pipeline in XNA was created this way - with importers, processors, content writers, and content readers.  The answer is simple - modularity.  If you want to load a new image format that the <code>TextureImporter</code> does not handle, you can write your own custom importer to load its data into a <code>TextureContent</code> object, and then still use the existing <code>TextureProcessor</code> and serialization process.</p>
<p>Alternatively, you may want to handle a new content type that has no associated classes in XNA at all.  In this case, you will need to write a custom importer, processor, writer, and reader.</p>
<p>The tilemaps created by Tiled that we discussed in the previous chapter are a good candidate for this - so let&rsquo;s use that as an example. In this case, our input file is a .tmx file, which is really just a specialized XML file. We can load this data using a process much like the <code>Squared.Tilemap</code> example in the last chapter.</p>
<p>Once loaded, we want to convert the data into a form more akin to how we want to represent tilemaps in <em>our specific game</em>, i.e. transform the tile properties into specific properties we define for our game&rsquo;s tiles, and change the objects into actual spawn points, etc. Our custom content processor can accomplish these tasks.</p>
<p>In addition to loading the tilemap, we&rsquo;d also like to create the textures that correspond to the tilesets, so that we don&rsquo;t have to load them separately. This is also something we can do with a custom content processor.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="extending-the-pipeline">Extending the Pipeline</h1>

<p>You might be wondering why the content pipeline in XNA was created this way - with importers, processors, content writers, and content readers.  The answer is simple - modularity.  If you want to load a new image format that the <code>TextureImporter</code> does not handle, you can write your own custom importer to load its data into a <code>TextureContent</code> object, and then still use the existing <code>TextureProcessor</code> and serialization process.</p>
<p>Alternatively, you may want to handle a new content type that has no associated classes in XNA at all.  In this case, you will need to write a custom importer, processor, writer, and reader.</p>
<p>The tilemaps created by Tiled that we discussed in the previous chapter are a good candidate for this - so let&rsquo;s use that as an example. In this case, our input file is a .tmx file, which is really just a specialized XML file. We can load this data using a process much like the <code>Squared.Tilemap</code> example in the last chapter.</p>
<p>Once loaded, we want to convert the data into a form more akin to how we want to represent tilemaps in <em>our specific game</em>, i.e. transform the tile properties into specific properties we define for our game&rsquo;s tiles, and change the objects into actual spawn points, etc. Our custom content processor can accomplish these tasks.</p>
<p>In addition to loading the tilemap, we&rsquo;d also like to create the textures that correspond to the tilesets, so that we don&rsquo;t have to load them separately. This is also something we can do with a custom content processor.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="tile-maps">Tile Maps</h1>

<p>I feel like weâve passed that tree beforeâ¦</p>
<iframe src="https://giphy.com/embed/cjbfyJrICOaKIXBWyG" width="480" height="307" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/muppets-cjbfyJrICOaKIXBWyG">via GIPHY</a></p>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Tile Maps</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>While the earliest video games often featured worlds that were sized to the dimensions of the screen, it was not long before game worlds were to grow larger.  This brought serious challenges to game development, as the platforms of the time did not have very large memory resources to draw upon.</p>
<p>A similar problem existed in storing raster images in early computers, where memory space was a premium.  Remember, raster images have three or four color channels - Red, Green, Blue, and sometimes Alpha.  If each channel is 8 bits, and an image is 13 x 21 pixels like the one below, our total memory consumption would be 8 x 4 x 13 x 21 = 8,736 bits, about 1 KB.  But the image only contains three colors!  Given that, can you think of a way to represent it with a smaller memory footprint?</p>
<p>
<a href="#image-7552705a3e195870b946f60223b51a71" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.1.1.png" alt="Raster Image using a Color Palette" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7552705a3e195870b946f60223b51a71">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.1.1.png" alt="Raster Image using a Color Palette" class="lightbox-image" loading="lazy">
</a></p>
<p>The answer they adopted was the use of a <em>color palette</em>, a collection of 8, 16, or 32 colors.  This collection was 0-indexed (so the first color was represented by a 0, the next by a 1, and so on&hellip;).  This meant you needed to sore 8 x 4 x 8 = 245 bits for a 8-color palette, and the actual image could be represented as a list of 3-bit color keys (3 bits can represent 0-7, the full range of keys for a 8-color palette).  So we only need an additional 3 x 13 x 21 = 819 bits to represent the image data.  The actual image therefore could be represented by only 1,064 bits - about 1/8th a KB.  The memory savings grow larger the larger the image represented.</p>
<p>With the concept of palettized image formats in mind, letâs look at an example of an early game - Super Mario Bros.  Do you notice anything about the game world that harkens back to our earlier use of palettes?</p>
<p>
<a href="#image-39d8939f8436efca19777831d97709bd" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.1.2.png" alt="Super Mario Bros" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-39d8939f8436efca19777831d97709bd">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.1.2.png" alt="Super Mario Bros" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice how so much of the scene seems to be the same texture repeated?  Much like the color palette applies a collection of colors on a regular grid, a tile engine applies a collection of tile textures on a regular grid.  This allows a large level to be drawn with only a handful of textures.  Moreover, these textures are typically stored in a texture atlas (i.e. all the tiles appear in a single texture).</p>
<p>Let&rsquo;s look at how we can implement this strategy in our own games.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="tilemap-concepts">Tilemap Concepts</h1>

<p>Let&rsquo;s start from a purely conceptual level, with some diagrams using tile assets created <a href="https://opengameart.org/content/platform-tileset-nature" target="_blank">by Eris available from OpenGameArt</a>
.  A tile map could be thought of as a grid of tiles, as demonstrated in this image:</p>
<p>
<a href="#image-2c8e5b788149acc0c07e591436065e14" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.1.png" alt="Tile map Example" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-2c8e5b788149acc0c07e591436065e14">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.1.png" alt="Tile map Example" class="lightbox-image" loading="lazy">
</a></p>
<p>Along with the map is the tile set, which defines the individual tiles that can be used within the map, i.e.:</p>
<p>
<a href="#image-3c124cefcbced72414d86c172da8fa59" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.2.png" alt="Tile set Example" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-3c124cefcbced72414d86c172da8fa59">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.2.png" alt="Tile set Example" class="lightbox-image" loading="lazy">
</a></p>
<p>We assign a number to each tile in the tile set:</p>
<p>
<a href="#image-c2558dfb8b5665c8e4fc03e14ea5c0fe" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.3.png" alt="Numbered tile set" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c2558dfb8b5665c8e4fc03e14ea5c0fe">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.3.png" alt="Numbered tile set" class="lightbox-image" loading="lazy">
</a></p>
<p>We can then specify what tile fills a grid cell in the tile map with the same number, i.e.:</p>
<p>
<a href="#image-7c4d9400c88c0386636eaa1ddfc1e29a" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.4.png" alt="Tile map with numbered tiles" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7c4d9400c88c0386636eaa1ddfc1e29a">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.4.png" alt="Tile map with numbered tiles" class="lightbox-image" loading="lazy">
</a></p>
<p>You can see that a relatively complex map can be quickly assembled from a relative handful of tiles.  Looking at the image above, you may naturally consider a 2-dimensional array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> map = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[,] 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  {-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">46</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">52</span>,<span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">37</span>,<span style="color:#ae81ff">38</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {<span style="color:#ae81ff">52</span>,<span style="color:#ae81ff">53</span>,<span style="color:#ae81ff">57</span>,<span style="color:#ae81ff">47</span>, <span style="color:#ae81ff">4</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">44</span>,<span style="color:#ae81ff">23</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">48</span>, <span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">38</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">44</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">37</span>,<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">38</span>,-<span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>  {<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">57</span>,<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">4</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">44</span>,<span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">29</span>,<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">25</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">52</span>,<span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">61</span>, <span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">39</span>,<span style="color:#ae81ff">25</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">62</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">62</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,-<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>  {-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">23</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">44</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">23</span>,-<span style="color:#ae81ff">1</span>,-<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">62</span>,-<span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And to draw the map, we would iterate over this array, drawing the corresponding tile from the tileset:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; map.GetLength(<span style="color:#ae81ff">0</span>); x++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; map.GetLength(<span style="color:#ae81ff">1</span>); y++)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> tileIndex = map[x,y];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(tileIndex == -<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">continue</span>; <span style="color:#75715e">// -1 indicates no tile, so skip drawing</span>
</span></span><span style="display:flex;"><span>    DrawTile(x, y, tileIndex);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>So you can see we need to implement classes corresponding to 1) the set of available tiles, and 2) the tile map, which is really just a collection of indices for the tile set.  But before we do that, we need to discuss 2d and 1d arrays in a bit more detail.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="2d-and-1d-arrays">2D and 1D Arrays</h1>

<p>Let&rsquo;s talk briefly about how a 2d array is actually stored <em>in memory</em>.  We like to think of it as looking something like this visualization:</p>
<p>
<a href="#image-6b4ccbba549bfd852aa614b193cb24ce" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.5.png" alt="2D array visualization" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6b4ccbba549bfd852aa614b193cb24ce">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.5.png" alt="2D array visualization" class="lightbox-image" loading="lazy">
</a></p>
<p>But in reality, it is stored <em>linearly</em>, like this:</p>
<p>
<a href="#image-9a0a73c31c5ba863461855641e44453c" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.6.png" alt="2D array in memory" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-9a0a73c31c5ba863461855641e44453c">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.6.png" alt="2D array in memory" class="lightbox-image" loading="lazy">
</a></p>
<p>To access a particular element in the array, the 2d coordinates must be transformed into a 1d index.  Note that each row follows the proceeding rows, so the starting index of each row would be the width of the row, <em>plus</em> the x-coordinate, i.e. the index of $(3,1)$ would be $1 * width + 3$:</p>
<p>
<a href="#image-4807cbea451c8e1f9d5148875c31937e" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.7.png" alt="Accessing (3,1)" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-4807cbea451c8e1f9d5148875c31937e">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.7.png" alt="Accessing (3,1)" class="lightbox-image" loading="lazy">
</a></p>
<p>This can be generalized into the equation:</p>
<p>$$
i = y * width + x
$$</p>
<p>And the reverse operation, converting an index into 2d coordinates, would be:</p>
<p>$$
x = i \% width
$$
$$
y = i / width
$$</p>

  
  
<div class="box notices cstyle info">
  <div class="box-label"><i class="fa-fw fas fa-info-circle"></i> Info</div>
  <div class="box-content">

<p>Note that we are using <em>integer division</em> and <em>modulus</em> in these equations, as the $y$ value is the number of full rows (i.e. $width$), and the $y$ is the distance into the partial row (i.e. the remainder).</p>
</div>
</div>
<p>Thus, all we need to treat a 1d array as a 2d array (in addition to the data) is the width of the array.  The height is only needed to calculate the array size (and thus the upper bound), which would be:</p>
<p>$$
size = width * height
$$</p>
<p>The <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/arrays/multidimensional-arrays" target="_blank">C# Multidimensional Array</a>
 simply builds on this concept, wrapping the array data in an object (note that for each dimension, you will have a corresponding size for that dimension, i.e. width, height, and depth for a 3d array).</p>
<h3 id="efficiency-and-2d-arrays">Efficiency and 2d Arrays</h3>
<p>Now, a note on efficiency - iterating through a C# multi-dimensional array is slower than the corresponding 1d array, as the interpreter optimizes 1d array operations (see <a href="https://mdfarragher.medium.com/high-performance-arrays-in-c-2d55c04d37b5" target="_blank">What is Faster In C#: An int[] or an int[,]</a>
 for a technical discussion of why).  With that in mind, for a game we&rsquo;ll always want to use a 1d array to represent 2d data.</p>
<p>A second note on efficiency.  The order in which you iterate over the array <em>also</em> has an impact on efficiency.  Consider an arbitrary 2d array <code>arr</code> implemented as a 1d array with <code>width</code> and <code>height</code>.</p>
<p>What would be the difference between loop 1:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> sum = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; width; x++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; height; y++)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    sum += arr[y * width + x]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And loop 2:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> sum = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; height; y++)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; width; x++)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    sum += arr[y * width + x]
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>You probably would think they are effectively the same, and <em>logically</em> they are - they both will compute the sum of all the elements in the array.  But loop 2 will potentially run much faster.  The reason comes down to a hardware detail - how RAM and the L2 and L1 caches interact.</p>
<p>When you load a variable into a hardware register to do a calculation, it is loaded from RAM.  But as it is loaded, the memory containing it, and some of the memory around it is also loaded into the L2 and L1 caches.  If the next value in memory you try to access is cached, then it can be loaded from the cache instead of RAM.  This makes the operation much faster, as the L2 and L1 caches are located quite close to the CPU, and RAM is a good distance away (possibly many inches!).</p>
<p>Consider the order in which loop 1 accesses the array.  It first accesses the first element in the first row.  Then the first element in the second row, and then the first element in the third row, then the second element in the first row, and so on&hellip; You can see this in the figure below:</p>
<p>
<a href="#image-201fdccf12af7a83be62cb2ea2204720" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.8.png" alt="Loop 1 access order" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-201fdccf12af7a83be62cb2ea2204720">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.8.png" alt="Loop 1 access order" class="lightbox-image" loading="lazy">
</a></p>
<p>Now, consider the same process for Loop 2:</p>
<p>
<a href="#image-e48fdba18713cfd777c48cfa9a6473d6" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.9.png" alt="Loop 2 access order" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e48fdba18713cfd777c48cfa9a6473d6">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/10.2.9.png" alt="Loop 2 access order" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice how all the memory access happens linearly? This makes the most efficient use of the cached data, and will perform much better when your array is large.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="a-basic-tile-engine">A Basic Tile Engine</h1>

<p>Now that we have a good sense of what a tile map consists of, as well as how to effectively use a 1-dimensional array as a 2-dimensional array, let&rsquo;s discuss actual implementations. As we discussed conceptually, we need: 1) a set of tiles, and 2) the arrangement of those tiles into a map.</p>
<p>Let&rsquo;s start by thinking about our tiles.  To draw a tile, we need to know:</p>
<ol>
<li>What texture the tile appears in</li>
<li>The bounds of the tile in that texture</li>
<li>Where the tile should appear on screen</li>
</ol>
<p>To determine this information, we need several other items:</p>
<ul>
<li>The width of the map in tiles</li>
<li>The height of the map in tiles</li>
<li>The width of a tile in pixels</li>
<li>The height of a tile in pixels</li>
</ul>
<p>And we can simplify the problem with some assumptions:</p>
<ul>
<li>Tiles are all the same size</li>
<li>The tileset image has the tiles organized side-by-side in a grid pattern</li>
</ul>
<h4 id="representing-the-map">Representing the Map</h4>
<p>Given this understanding, we can determine some fields we&rsquo;ll need to keep track of the data:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;The map filename&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span> _mapFilename;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;The tileset texture&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Texture2D _tilesetTexture;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;The map and tile dimensions&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> _tileWidth, _tileHeight, _mapWidth, _mapHeight;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;The tileset data&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Rectangle[] _tiles;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;The map data&lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span>[] _map;</span></span></code></pre></div><h4 id="loading-the-data">Loading the Data</h4>
<p>Now let&rsquo;s turn our attention to how we can <em>populate</em> those fields. Let&rsquo;s first consider how we might write the data for a tilemap in a text file:</p>
<div class="wrap-code highlight"><pre tabindex="0"><code>tileset
64, 64
10, 10
3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 2, 2, 2, 2, 2, 2, 3, 3, 2, 4, 4, 1, 4, 2, 2, 2, 3, 3, 2, 2, 2, 2, 4, 4, 4, 2, 3, 3, 2, 2, 2, 2, 2, 2, 1, 2, 3, 3, 3, 1, 3, 2, 2, 2, 4, 4, 3, 3, 2, 2, 3, 2, 3, 2, 2, 4, 4, 3, 2, 2, 3, 2, 3, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3</code></pre></div><p>In this example, the first line is the name of the tileset image file (which is loaded through the content pipeline, so it has no extension).  The second line is the width and height of a tile, and the third line is the width and height of the map (measured in tiles).  The last line is the indices of the tiles from the tileset image.</p>
<p>Loading the data from this file requires a method like this:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> LoadContent(ContentManager content)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read in the map file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> data = File.ReadAllText(Path.Join(content.RootDirectory, _mapFilename));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> lines = data.Split(<span style="color:#e6db74">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// First line is tileset image file name </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> tilesetFileName = lines[<span style="color:#ae81ff">0</span>].Trim();
</span></span><span style="display:flex;"><span>    _tilesetTexture = content.Load&lt;Texture2D&gt;(tilesetFileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Second line is tile size</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> secondLine = lines[<span style="color:#ae81ff">1</span>].Split(<span style="color:#e6db74">&#39;,&#39;</span>);
</span></span><span style="display:flex;"><span>    _tileWidth = <span style="color:#66d9ef">int</span>.Parse(secondLine[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    _tileHeight = <span style="color:#66d9ef">int</span>.Parse(secondLine[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Now that we know the tile size and tileset</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// image, we can determine tile bounds</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> tilesetColumns = _tilesetTexture.Width / _tileWidth;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> tilesetRows = _tilesetTexture.Height / _tileWidth;
</span></span><span style="display:flex;"><span>    _tiles = <span style="color:#66d9ef">new</span> Rectangle[tilesetColumns * tilesetRows];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; tilesetRows; y++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; tilesetColumns; x++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _tiles[y * tilesetColumns + x] = <span style="color:#66d9ef">new</span> Rectangle(
</span></span><span style="display:flex;"><span>                x * _tileWidth, <span style="color:#75715e">// upper left-hand x cordinate</span>
</span></span><span style="display:flex;"><span>                y * _tileHeight, <span style="color:#75715e">// upper left-hand y coordinate</span>
</span></span><span style="display:flex;"><span>                _tileWidth, <span style="color:#75715e">// width </span>
</span></span><span style="display:flex;"><span>                _tileHeight <span style="color:#75715e">// height</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Third line is map size (in tiles)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> thirdLine = lines[<span style="color:#ae81ff">2</span>].Split(<span style="color:#e6db74">&#39;,&#39;</span>);
</span></span><span style="display:flex;"><span>    _mapWidth = <span style="color:#66d9ef">int</span>.Parse(thirdLine[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    _mapHeight = <span style="color:#66d9ef">int</span>.Parse(thirdLine[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Fourth line is map data</span>
</span></span><span style="display:flex;"><span>    _map = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[_mapWidth * _mapHeight];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> fourthLine = lines[<span style="color:#ae81ff">3</span>].Split(<span style="color:#e6db74">&#39;,&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; _mapWidth * _mapHeight; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _map[i] = <span style="color:#66d9ef">int</span>.Parse(fourthLine[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>While there is a lot going on here, it is also mostly basic File I/O based on the structure of the file.</p>
<h4 id="rendering-the-tilemap">Rendering the Tilemap</h4>
<p>Finally, drawing the map involves iterating over the data and invoking <code>SpriteBatch.Draw()</code> for each tile that needs drawn.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(GameTime gameTime, SpriteBatch spriteBatch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; _mapHeight; y++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; _mapWidth; x++) 
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Indexes start at 1, so shift for array coordinates</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> index = _map[y * _mapWidth + x] - <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Index of -1 (shifted from 0) should not be drawn</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (index == -<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            spriteBatch.Draw(
</span></span><span style="display:flex;"><span>                _tilesetTexture,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Vector2(
</span></span><span style="display:flex;"><span>                    x * _tileWidth,
</span></span><span style="display:flex;"><span>                    y * _tileHeight
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                _tiles[index],
</span></span><span style="display:flex;"><span>                Color.White
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Organizing these fields and methods into a class gives us a simple tile engine. This can be expanded to address a lot of different games&rsquo; needs.  However, it <em>does</em> require building the map file by hand, using raw tile indices.  This gets challenging quickly, which leads us to our next topic - using a tilemap editor.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="tiled-editor">Tiled Editor</h1>

<p>Once we start thinking in terms of large, complex maps editing the map by hand becomes a daunting task. Instead, we want a tool to edit the map visually. One of the best free tools to do so is the <a href="https://www.mapeditor.org/" target="_blank">Tiled Map Editor</a>
. Tiled is free, open-source, and widely used in the games industry. It allows you to quickly create a tilemap by importing tilesets and drawing the map using a suite of visual tools.  You can read more about Tiled and its functionality in the <a href="https://doc.mapeditor.org/en/stable/tiled" target="_blank">documentation</a>
 and covered in <a href="https://youtu.be/ZwaomOYGuYo" target="_blank">this video series by GamesfromScratch</a>
.</p>
<p>However, it adds additional concepts to tile maps that we have not yet discussed.</p>
<h3 id="properties">Properties</h3>
<p>Because Tiled is intended to be usable in a wide variety of games, it allows <em>properties</em> to be defined on almost everything.  In Tiled, properties are simply key/value pairs, i.e. <code>&quot;Opacity&quot;</code> might be set to <code>0.5</code>.  There are no pre-defined keys, instead you decide what properties you need for your game.  The properties are stored in collections, essentially a <code>Dictionary&lt;string, string&gt;</code>, which is how we&rsquo;ll interpret them in our C# code.</p>
<h3 id="tilesets">Tilesets</h3>
<p>Tilesets are implemented in a similar fashion to our earlier discussions, however:</p>
<ol>
<li>An index of 0 represents &ldquo;no tile&rdquo;.  This allows you to used unsigned integers as a tile index</li>
<li>More than one tileset can be used.  Each new tileset begins with the next index.  So if we have two tilesets with eight tiles each, the first tileset will have indices 1-8, and the second will have 9-16.</li>
<li>Individual tiles can have properties - which is commonly used for collision information, to identify solid surfaces and platforms, etc.</li>
</ol>
<h3 id="map-layers">Map Layers</h3>
<p>Instead of a single 2d array of tiles, Tiled allows you to create maps with <em>multiple</em> layers, each with its own 2d array.  This can be used in a variety of ways:</p>
<ol>
<li>To create a foreground and background layer, a common approach in top-down views because it allows the player to walk behind foreground elements (i.e. the base of a tree is in the background layer, but the branches and crown is in the foreground)</li>
<li>To implement parallax scrolling - where layers scroll at different speeds to create the illusion of depth.  We discuss the implementation details of parallax scrolling <a href="https://ksu-cs-textbooks.github.io/cis580/08-spritebatch-transforms/04-parallax-scrolling/">in chapter 8</a>
.</li>
<li>To create complex, multi-level dungeons where players can move between layers</li>
</ol>
<p>Conceptually, a map layer is implemented the same way as the simple tile map we discussed earlier. It is a 2d array of tile indices implemented as a 1d array, along with storing the width, height, and any properties that apply to the entire layer.</p>
<p>In addition to layers of tiles, Tiled also supports <em>image</em> and <em>object</em> layers.</p>
<h4 id="image-layers">Image Layers</h4>
<p>An image layer represents an image that is <em>not</em> a tile.  This can be used for large bitmaps that cover the entire layer, or smaller ones that appear in a particular spot.  Images can also repeat to fill the layer or defined space.</p>
<h5 id="object-layers">Object Layers</h5>
<p>In addition to tiles, and images, Tiled allows you to place &ldquo;objects&rdquo; in a map. These are represented by boxes that do not correspond to the grid system of the tiles.  Objects are simply a rectangle plus properties, and can be used to represent anything you need to place in the game world - spawn positions, event triggers, doors, etc.</p>
<p>Objects are organized into <em>object layers</em>, which are essentially a collection of objects.</p>
<h3 id="working-with-tiled-in-monogame">Working with Tiled in MonoGame</h3>
<p>Tiled uses an XML file format, <a href="https://doc.mapeditor.org/en/stable/reference/tmx-map-format/" target="_blank">TMX</a>
.  Thus, you can load a TMX file and then parse it with an XML parsing library.  In fact, Tiled was released with an example engine that does this, created by Kevin Gadd.  This was later converted into C# for use with XNA by Stephen Balanger and Zach Musgrave.</p>
<p>I further converted this for use with the current version of MonoGame, with additional documentation.  It can be found <a href="https://github.com/CIS580/tiled-monogame" target="_blank">on GitHub</a>
.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we learned about tile maps, an important technique for creating large game worlds with small memory footprints. We also examined the Tiled map editor and saw an example of loading a Tiled map. However, this approach used traditional File I/O.  In our next chapter, we&rsquo;ll learn how to use the Content Pipeline to process the TMX file directly.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="basic-3d-rendering">Basic 3D Rendering</h1>

<p>It&rsquo;s all triangles!</p>
<img src="https://media.giphy.com/media/3oKIPaYYYLafTAM0i4/giphy.gif"/>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Basic 3D Rendering</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>The term &ldquo;3D rendering&rdquo; refers to converting a three-dimensional representation of a scene into a two-dimensional frame.  While there are multiple ways to represent and render three-dimensional scenes (ray-tracing, voxels, etc.), games are dominated by a standardized technique supported by graphics card hardware.  This approach is so ubiquitous that when we talk about 3D rendering in games, this is the approach we are typically referring to.</p>
<p>Remember that games are &ldquo;real-time&rdquo;, which means they <em>must</em> present a new frame every 1/30th of a second to create the illusion of motion.  Thus, a 3D game must perform the conversion from 3D representation to 2D representation, <em>plus</em> update the game world, within that narrow span of time.  To fully support monitors with higher refresh rates, this span may be cut further - 1/60th of a second for a 60-hertz refresh rate, or 1/120th of a second for a 120-hertz refresh rate.  Further, to support VR googles, the frame must be rendered <em>twice</em>, once from the perspective of each eye, which further halves the amount of time available for a single frame.</p>
<p>This need for speed is what has driven the adoption and evolution of graphics cards.  The hardware of the graphics cards includes a <em>graphics processing unit</em>, a processor that has been optimized for the math needed to support this technique, and dedicated <em>video memory</em>, where the data needed to support 3D rendering is stored.  The GPU operates in parallel with and semi-independently from the CPU - the game running on the CPU sends instructions to the GPU, which the GPU carries out.  Like any multiprocessor program, care must be taken to avoid accessing shared memory (RAM or Video RAM) concurrently.  This sharing of memory and transmission of instructions is facilitated by a low-level rendering library, typically <a href="https://en.wikipedia.org/wiki/DirectX" target="_blank">DirectX</a>
 or <a href="https://en.wikipedia.org/wiki/OpenGL" target="_blank">OpenGL</a>
.</p>
<p>MonoGame supports both, through different kinds of projects, and provides abstractions that provide a platform-independence layer, in the <a href="https://www.monogame.net/documentation/?page=N_Microsoft_Xna_Framework_Graphics" target="_blank">Xna.Framework.Graphics namespace</a>
.  One important aspect of this layer is that it provides managed memory in conjunction with C#, which is a departure from most game programing (where the developer must manage their memory explicitly, allocating and de-allocating as needed).</p>
<h2 id="the-graphics-pipeline">The Graphics Pipeline</h2>
<p>This process of rendering using 3D accelerated hardware is often described as the Graphics Pipeline:</p>
<p>
<a href="#image-6bbd750cd8533e685f4aa5e8500bf1eb" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/graphics-pipeline.png" alt="Graphics Pipeline" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-6bbd750cd8533e685f4aa5e8500bf1eb">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/graphics-pipeline.png" alt="Graphics Pipeline" class="lightbox-image" loading="lazy">
</a></p>
<p>We&rsquo;ll walk through this process as we write a demonstration project that will render a rotating 3D cube.  The starter code for this project can be found on <a href="https://github.com/ksu-cis/basic-3d-starter" target="_blank">GitHub</a>
.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="it-starts-with-triangles">It Starts with Triangles</h1>

<p>You probably remember from our discussions of matrix math that we can create matrices to represent arbitrary transformations.  Moreover, we can transform a vector by multiplying it by one of these transformation matrices.  This is the mathematical foundations of hardware-accelerated 3D rendering.  In fact, the GPU is nothing more than a processor optimized for performing matrix and vector operations.</p>
<p>We model our three-dimensional worlds with triangles.  Lots and lots of triangles.  Why triangles?  Remember that three points define a plane.  Three points also can define a triangle.  So we know that the three endpoints of a triangle will <em>always</em> be coplanar.  If we used more than three points, there is a possibility that we might screw up and have one out-of-plane, which would break the process.  So 3D rendering is almost entirely based on rendering triangles (you can also render lines and points with OpenGL and DirectX, but XNA only supports triangles and lines).</p>
<p>Complex objects are therefore composed of multiple triangles, which typically share sides and create a closed shape with a distinct inside and outside.  We call these <em>triangle meshes</em>, and they effectively create a hollow shell in the shape of the object to be rendered:</p>
<p>
<a href="#image-38dafab3752b243e375fdaf4ae59f04f" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/triangle-mesh.png" alt="Triangle Mesh" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-38dafab3752b243e375fdaf4ae59f04f">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/triangle-mesh.png" alt="Triangle Mesh" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="vertices">Vertices</h2>
<p>Rather than creating structures for storing triangles, we store the endpoints of the triangles as <em>vertices</em>.  These vertices are a data structure that (at a minimum) defines the coordinate of the triangle endpoint in three dimensions (A Vector3 in XNA).  Vertices can contain additional data needed to render the mesh, including color, texture coordinates, and additional vectors like the surface normal (a Vector3 pointing <em>out</em> from the surface).</p>
<p>Let&rsquo;s create a class to represent our cube, and give it an array of vertices that have both a position and a color:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class for rendering a single triangle</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Triangle</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The vertices of the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    VertexPositionColor[] vertices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Note the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_VertexPositionColor" target="_blank">VertexPositionColor</a>
 is defined in the <code>Microsoft.Xna.Framework.Graphics</code> namespace.</p>
<h2 id="triangles">Triangles</h2>
<p>Triangles are then defined by the order the vertices are presented to the graphics card, defined by a <em>graphics primitive type</em>.  There are four supported by XNA, and appear in the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_PrimitiveType" target="_blank">PrimitiveType enumeration</a>
.  These are <em>LineList</em>, <em>LineStrip</em>, <em>TriangleList</em>, and <em>TriangleStrip</em>.  The first two vertices in a <code>LineList</code> define the two endpoints of a line, the second two, a second line.  In contrast, with a <code>LineStrip</code> each successive line connects to the previous one, sharing a vertex.  Thus vertices 0 and 1 define the first line, vertices 1 and 2 define the second, vertices 2 and 3 the third, and so on&hellip;</p>
<p>The <code>TriangleList</code> and <code>TriangleStrip</code> work the same way.  In a <code>TriangleList</code> each three vertices define a single triangle.  Hence vertices 0, 1, and 2 define the first triangle, and vertices 3, 4, and 5, the second, and so on.  With the <code>TriangleStrip</code>, vertices 0, 1, and 2 define the first triangle; vertices 1, 2, and 3 define the second, vertices 2, 3, and 4 the third, and so on&hellip;</p>
<p>Our <code>Triangle</code> will only be using vertices 0, 1, and 2, so either approach will be identical.  Let&rsquo;s go ahead and define those vertices in a helper method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the vertices of the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> InitializeVertices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        vertices = <span style="color:#66d9ef">new</span> VertexPositionColor[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// vertex 0</span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">0</span>].Position = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">0</span>].Color = Color.Red;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// vertex 1</span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">1</span>].Position = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">1</span>].Color = Color.Green;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// vertex 2 </span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">2</span>].Position = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">2</span>].Color = Color.Blue;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="the-effect">The Effect</h2>
<p>One of the major innovations of hardware graphics has been the introduction of <em>programmable shaders</em>.  A shader is simply a program that runs on a GPU, and performs some steps of the graphics pipeline.  At the time XNA was created, there were three points in the graphics pipeline where programmable shaders could be inserted: the <em>vertex shader</em>, the <em>geometry shader</em>, and the <em>pixel shader</em> (additional shader points have been added to graphics cards since).  These shaders are written in a language specific to the GPU and graphics library (DirectX or OpenGL).  In XNA, this language is <a href="https://en.wikipedia.org/wiki/High-Level_Shading_Language" target="_blank">HLSL</a>
.</p>
<p>XNA seeks to simplify the details of setting up shaders by abstracting the heavy lifting into the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_Effect" target="_blank">Effect Class</a>
.  An <code>Effect</code> handles configuring the graphics device to produce a specific effect through a combination of shaders and hardware settings.  We can create custom classes derived from the <code>Effect</code> class, or use one of those already defined in XNA:</p>
<ul>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_BasicEffect.html" target="_blank">BasicEffect</a>
</li>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_AlphaTestEffect.html" target="_blank">AlphaTestEffect</a>
</li>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_DualTextureEffect.html" target="_blank">DualTextureEffect</a>
</li>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_EnvironmentMapEffect.html" target="_blank">EnvironmentMapEffect</a>
</li>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_SkinnedEffect.html" target="_blank">SkinnedEffect</a>
</li>
<li><a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Graphics_SpriteEffect.html" target="_blank">SpriteEffect</a>
</li>
</ul>
<p>With our triangle, we&rsquo;ll use the <code>BasicEffect</code>, which provides a basic rendering pipeline.  Let&rsquo;s add a field for one to our <code>Triangle</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The effect to use rendering the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    BasicEffect effect;</span></span></code></pre></div><p>The effect also needs  a reference to the <code>GraphicsDevice</code> held by our <code>Game</code> instance; so let&rsquo;s also add a <code>Game</code> field:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The game this triangle belongs to </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Game game;</span></span></code></pre></div><p>You&rsquo;ll also need to add the <code>Microsoft.Xna.Framework</code> namespace to make <code>Game</code> available.</p>
<p>Now let&rsquo;s initialize our effects settings in a second helper method, <code>InitializeEffect()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the BasicEffect to render our triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> InitializeEffect()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect = <span style="color:#66d9ef">new</span> BasicEffect(game.GraphicsDevice);
</span></span><span style="display:flex;"><span>        effect.World = Matrix.Identity;
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>), <span style="color:#75715e">// The camera position</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#75715e">// The camera target,</span>
</span></span><span style="display:flex;"><span>            Vector3.Up            <span style="color:#75715e">// The camera up vector</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.Projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,                         <span style="color:#75715e">// The field-of-view </span>
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,   <span style="color:#75715e">// The aspect ratio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.1f</span>, <span style="color:#75715e">// The near plane distance </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">100.0f</span> <span style="color:#75715e">// The far plane distance</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.VertexColorEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>There&rsquo;s a lot going on here, so lets&rsquo; break it down.</p>
<h3 id="the-world-matrix">The World Matrix</h3>
<p>The line <code>effect.World = Matrix.Identity</code> creates the <em>world matrix</em>.  This matrix embodies a transformation that transforms our vertices from <em>model space</em> to <em>game space</em>.  Consider our triangle - it has three endpoints (0, 1, 0), (1, 1, 0), and (1, 0, 0).  As it is defined, it has one endpoint above the origin, one to the right, and the third is above and to the right - in line with the others.  This is its <em>model space</em>.  We might want it to appear somewhere else in our game world - say at (100, 100, 0).  We call our game world <em>world space</em>, and a matrix that would embody the transformation needed to move our triangle from its model space coordinates to its world space coordinates is the <em>world matrix</em>.  We&rsquo;re using <code>Matrix.Identity</code> here, which won&rsquo;t change those coordinates at all.</p>
<p>Instead of thinking of triangles, think of crates.  We probably would use the same crate multiple times throughout our game.  The crate would have been drawn in a modeling program, and probably had its origin at a corner or bottom corner (model space).  When we put it into the level, we would translate and rotate it to get it in just the right spot (world space).  We might put a second copy in a different location, with its own translation.  Hence, the two instances would have the same model coordinates, but different transformations to place them in the world, embodied in different world matrices.</p>
<h3 id="the-view-matrix">The View Matrix</h3>
<p>The line <code>effect.View = Matrix.CreateLookAt(..)</code> creates the <em>view matrix</em>.  This is the transform that shifts us from <em>world space</em> into <em>view space</em>.  View space is relative to the position of the observer - the eye (or camera) is at the origin (0, 0, 0), and they are looking along the z-axis.  Since the observer exists somewhere in the game world, the view transformation shifts the coordinate system so that that position becomes the origin, and everything in the world moves along with it.</p>
<p><a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Matrix_CreateLookAt" target="_blank">Matrix.CreateLookAt()</a>
 is a method for creating a matrix to embody this transformation, and allows us to specify where the observer is looking from, and to.  The first argument is the position of the observer - where the observer&rsquo;s eye would be in the world.  The second argument is a vector in the direction the observer is looking.  The third helps orient the observer by defining which direction is up.  Normally this would be the up vector (0, 1, 0), but if the observer was a plane that was executing a barrel roll, it would be the down vector (0, -1, 0) halfway through the roll, and every value between as the plane rolled.</p>
<h3 id="the-projection-matrix">The Projection Matrix</h3>
<p>The line <code>effect.Projection = Matrix.CreatePerspectiveFieldOfView(...)</code> creates the <em>projection matrix</em>.  This is the matrix that transforms our 3D scene into a 2D one.  It does this by setting z-values to 0 while (possibly) tweaking x- and y-values to create the illusion of perspective.  There are two commonly used projections in video games: <em>orthographic</em>, which simply removes the z-values, flattening the scene; and <em>perspective</em>, which stretches distant objects an squishes near ones, creating the illusion of depth.</p>
<p><a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Matrix_CreatePerspectiveFieldOfView" target="_blank">Matrix.CreatePerspectiveFieldOfView()</a>
 creates a perspective matrix that accounts for the field of view of the observer.  The first argument is an angle measuring how wide the field of view should be, measured in radians.  Humans have approximately a 120 degree field-of-view, but most of this is peripheral vision, so we typically use smaller numbers.  This can also be tweaked to provide the illusion of using a telescope or wide lens.  The second argument is the aspect ratio - this should match the aspect ratio of the screen, or the result will seem distorted.  For this reason we draw its value directly from the <code>GraphicsDevice</code>.  The last two values are floats indicating the far and near planes.  The near plane is how close objects can be to the observer before they won&rsquo;t be rendered, and the far plan is how far away they can be.</p>
<p><a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Matrix_CreateOrthographic" target="_blank">Matrix.CreateOrthographic()</a>
 creates an orthographic matrix.  As there is no distortion, its arguments simply describe a cube, with the near plane and far plane composing the nearest and farthest sides.  The near face is centered on the observer, and only the vertices within the cube are rendered.</p>
<h3 id="vertex-color">Vertex Color</h3>
<p>Finally, the line <code>effect.VertexColorEnabled</code> indicates we want to use the colors in the vertex data to set the color of the triangle.  Since each corner has a different color, the pixels on the face of the triangle will be linearly interpolated by the distance to each corner, creating a gradient.</p>
<h2 id="constructing-the-triangle">Constructing the Triangle</h2>
<p>We&rsquo;ll need to write a constructor that will call both the initialization methods, as well as accept the <code>Game</code> instance:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a triangle instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game that is creating the triangle&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Triangle(Game game)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeEffect();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="drawing-the-triangle">Drawing the Triangle</h2>
<p>And we&rsquo;ll need to draw our triangle using our <code>BasicEffect</code> and <code>GraphicDevice</code>.  Let&rsquo;s put this code into a <code>Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawUserPrimitives&lt;VertexPositionColor&gt;(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList, 
</span></span><span style="display:flex;"><span>            vertices,       <span style="color:#75715e">// The vertex data </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,              <span style="color:#75715e">// The first vertex to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>               <span style="color:#75715e">// The number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>An <code>Effect</code> can require multiple passes through the rendering pipeline, and can even contain multiple techniques.  The line <code>effect.CurrentTechnique.Passes[0].Apply()</code> therefore sets up the graphics device for the first pass with the current technique (with our <code>BasicEffect</code>, it only has one pass).  Then we trigger the rendering with <code>game.GraphicsDevice.DrawUserPrimitives&lt;VertexPositionColor&gt;(...)</code>.  We need to specify what kind of vertex data the graphics card should expect, hence the template <code>&lt;VertexPositionColor&gt;</code>.  The first argument is the type of primitive to render.  In our case, either <code>PrimitiveType.TriangleList</code> or <code>PrimitiveType.TriangleStrip</code> will work, as both use the first three vertices to define the first triangle, and we only have one.  The second argument is an offset in our vertex data - we&rsquo;re starting with the first, so its value is <code>0</code>.  The last argument is the number of primitives (in this case, triangles) to draw.  We only have one defined, so its value is <code>1</code>.</p>
<h2 id="adding-the-triangle-to-game1">Adding the Triangle to Game1</h2>
<p>Now let&rsquo;s use our <code>Triangle</code> in <code>Game1</code>.  Add a field for the triangle to the <code>Game1</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The triangle to draw</span>
</span></span><span style="display:flex;"><span>    Triangle triangle;</span></span></code></pre></div><p>And construct it in our <code>Game1.LoadContent()</code>.  We want to be sure the graphics device is set up before we construct our <code>Triangle</code>, so this is a good spot:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the triangle</span>
</span></span><span style="display:flex;"><span>    triangle = <span style="color:#66d9ef">new</span> Triangle(<span style="color:#66d9ef">this</span>);</span></span></code></pre></div><p>And finally, let&rsquo;s render it in our <code>Game1.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the triangle </span>
</span></span><span style="display:flex;"><span>    triangle.Draw();</span></span></code></pre></div><p>If you run your code, you should now see the triangle rendered:</p>
<p>
<a href="#image-4318c47896018918674a1367f0f90660" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-2.1.png" alt="The rendered triangle" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-4318c47896018918674a1367f0f90660">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-2.1.png" alt="The rendered triangle" class="lightbox-image" loading="lazy">
</a></p>
<h2 id="rotating-the-triangle">Rotating the Triangle</h2>
<p>Let&rsquo;s go one step farther, and make our triangle rotate around the center of the world.  To do this, we&rsquo;ll add an <code>Update()</code> method to our <code>Triangle</code> class, and modify the <code>effect.World</code> matrix:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Rotates the triangle around the y-axis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The GameTime object&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> angle = (<span style="color:#66d9ef">float</span>)gameTime.TotalGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>        effect.World = Matrix.CreateRotationY(angle);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>The <code>gameTime.TotalGameTime.TotalSeconds</code> represents the total time that has elapsed since the game started running.  We pass this to the <code>Matrix.CreateRotationY()</code> to provide the angle (measured in radians) that the triangle should rotate.</p>
<p>Finally, we&rsquo;ll need to add the <code>Triangle.Update()</code> call to our <code>Game1.Update()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the triangle </span>
</span></span><span style="display:flex;"><span>    triangle.Update(gameTime);</span></span></code></pre></div><p>Now when you run the program, your triangle rotates around the y-axis.  But for 180 degrees of the rotation, it disappears!  What is happening?</p>
<h2 id="backface-culling">Backface Culling</h2>
<p>If we think back to the idea that the triangles in a 3D mesh are the <em>surface</em> of the object, it makes sense that we would only want to draw the <em>outside</em> faces (as the inside faces will always be obscured).  This is exactly what the graphics device is doing - using a technique called <a href="https://en.wikipedia.org/wiki/Back-face_culling" target="_blank">backface culling</a>
 to only draw triangles that are facing the camera (which eliminates around half the triangles in the scene).</p>
<p>But how do we know which face is the front-facing one?  The graphics device uses <em>winding order</em> to determine this.  Winding order refers to the order the vertices are presented to the hardware.  We can change this value by changing the <a href="">CullMode</a>
.  By default, XNA uses <code>CullCounterClockwiseFace</code>; let&rsquo;s try swapping that.  Add these lines to your <code>Triangle.Draw()</code> method, before you invoke  <code>DrawUserPrimitives()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Change the backface culling mode</span>
</span></span><span style="display:flex;"><span>    RasterizerState rasterizerState = <span style="color:#66d9ef">new</span> RasterizerState();
</span></span><span style="display:flex;"><span>    rasterizerState.CullMode = CullMode.CullClockwiseFace;
</span></span><span style="display:flex;"><span>    game.GraphicsDevice.RasterizerState = rasterizerState;</span></span></code></pre></div><p>Now its the <em>other</em> face of the triangle that does not appear!  Try changing the <code>CullMode.CullClockwiseFace</code> to <code>CullMode.None</code>.  Now <em>both</em> faces appear!</p>
<p>It is a good idea to cache the prior state <em>before</em> you make changes, and restore them when we&rsquo;re done.  I.e., we should refactor our <code>Draw()</code> method to:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Cache old rasterizer state</span>
</span></span><span style="display:flex;"><span>        RasterizerState oldState = game.GraphicsDevice.RasterizerState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Disable backface culling </span>
</span></span><span style="display:flex;"><span>        RasterizerState rasterizerState = <span style="color:#66d9ef">new</span> RasterizerState();
</span></span><span style="display:flex;"><span>        rasterizerState.CullMode = CullMode.None;
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.RasterizerState = rasterizerState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Apply our effect</span>
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Draw the triangle</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawUserPrimitives&lt;VertexPositionColor&gt;(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList, 
</span></span><span style="display:flex;"><span>            vertices,       <span style="color:#75715e">// The vertex data </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,              <span style="color:#75715e">// The first vertex to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>               <span style="color:#75715e">// The number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Restore the prior rasterizer state </span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.RasterizerState = oldState;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Otherwise, our change to the rasterizer state could affect other things we are drawing.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="rendering-a-textured-quad">Rendering a Textured Quad</h1>

<p>While the point of a <code>TriangleStrip</code> is to optimize by reducing the number of vertices, in most cases it still will have repeats, and it is difficult to define a complex mesh out of a single strip.  Thus, in addition to vertices, we can provide <em>indices</em> to specific vertices.  The collection of indices contains nothing more than integers referencing vertices in the vertices collection.  This means each unique vertex needs to be defined exactly once, and the indices take on the role of defining the triangles by giving the position of each successive vertex in the triangle list in the vertex array.</p>
<h2 id="defining-a-textured-quad">Defining a Textured Quad</h2>
<p>Let&rsquo;s give this a try by defining a <code>Quad</code> class with both vertices and indices:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a quad (a rectangle composed of two triangles)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Quad</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The vertices of the quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    VertexPositionTexture[] vertices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The vertex indices of the quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">short</span>[] indices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The effect to use rendering the triangle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    BasicEffect effect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The game this cube belongs to </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>You will note that instead of our vertex structure being a <code>VertexPositionColor</code>, this time we&rsquo;re using <code>VertexPositionTexture</code>.  Instead of giving each vertex a color, this time we&rsquo;ll be giving it a texture coordinate, and having our <code>effect</code> apply a texture to the face of the quad.</p>
<p>Note also that we use the <code>short</code> data type for our index array.  As a quad has only four vertices (one in each corner), we only need four vertices to define one.  If our vertices start at index 0, that means we only need to represent indices 1-4, so a short is more than sufficient.  With a larger vertex array, we might need to use a larger type of integer.</p>
<h3 id="defining-the-vertices">Defining the Vertices</h3>
<p>As with our triangle, we&rsquo;ll initialize our vertices in a helper method, <code>InitializeVertices</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the vertices of our quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeVertices() {
</span></span><span style="display:flex;"><span>        vertices = <span style="color:#66d9ef">new</span> VertexPositionTexture[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Define vertex 0 (top left)</span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">0</span>].Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">0</span>].TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Define vertex 1 (top right)</span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">1</span>].Position = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">1</span>].TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1</span>, -<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// define vertex 2 (bottom right)</span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">2</span>].Position = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1</span>, -<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">2</span>].TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// define vertex 3 (bottom left) </span>
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">3</span>].Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1</span>, -<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        vertices[<span style="color:#ae81ff">3</span>].TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>The quad is two by two, centered on the origin.  The texture coordinates are expressed as floats that fall in the range [0 &hellip; 1].  The texture coordinate (0,0) is the upper-left hand corner of our texture, and (1, 1) is the lower-right corner.</p>
<h3 id="defining-the-indices">Defining the Indices</h3>
<p>Now let&rsquo;s define our indices in their own helper method, <code>InitializeIndices</code>.  Let&rsquo;s assume we&rsquo;re using a triangle list, so we&rsquo;ll need to define all six vertices (with a triangle strip we could cut this to 4):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initialize the indices of our quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeIndices() {
</span></span><span style="display:flex;"><span>        indices = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">short</span>[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Define triangle 0 </span>
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">0</span>] = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">1</span>] = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">2</span>] = <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// define triangle 1</span>
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">3</span>] = <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">4</span>] = <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>        indices[<span style="color:#ae81ff">5</span>] = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="initializing-the-effect">Initializing the Effect</h2>
<p>And we&rsquo;ll need to set up our effect, which we&rsquo;ll again do in a method named <code>InitializeEffect()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the basic effect used to draw the quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeEffect()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect = <span style="color:#66d9ef">new</span> BasicEffect(game.GraphicsDevice);
</span></span><span style="display:flex;"><span>        effect.World = Matrix.Identity;
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>), <span style="color:#75715e">// The camera position</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#75715e">// The camera target,</span>
</span></span><span style="display:flex;"><span>            Vector3.Up            <span style="color:#75715e">// The camera up vector</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.Projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,                         <span style="color:#75715e">// The field-of-view </span>
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,   <span style="color:#75715e">// The aspect ratio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.1f</span>, <span style="color:#75715e">// The near plane distance </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">100.0f</span> <span style="color:#75715e">// The far plane distance</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.TextureEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        effect.Texture = game.Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;monogame-logo&#34;</span>);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This looks almost identical to our triangle example.  The only difference is in the last two lines - instead of setting <code>effect.VertexColorEnabled</code>, we&rsquo;re setting <code>effect.TextureEnabled</code> to <code>true</code>, and providing the <em>monogame-logo.png</em> texture to the <code>effect</code>.</p>
<h3 id="draw-method">Draw() Method</h3>
<p>Now let&rsquo;s write our <code>Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawUserIndexedPrimitives&lt;VertexPositionTexture&gt;(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList,
</span></span><span style="display:flex;"><span>            vertices,   <span style="color:#75715e">// The vertex collection</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,          <span style="color:#75715e">// The starting index in the vertex array</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span>,          <span style="color:#75715e">// The number of indices in the shape</span>
</span></span><span style="display:flex;"><span>            indices,    <span style="color:#75715e">// The index collection</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,          <span style="color:#75715e">// The starting index in the index array</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">2</span>           <span style="color:#75715e">// The number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="the-quad-constructor">The Quad Constructor</h3>
<p>To wrap up the <code>Quad</code>, we&rsquo;ll need to add a constructor that takes a parameter of type <code>Game</code> and invokes our initialization:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs the Quad</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The Game the Quad belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Quad(Game game)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeIndices();
</span></span><span style="display:flex;"><span>        InitializeEffect();
</span></span><span style="display:flex;"><span>    }   </span></span></code></pre></div><h2 id="adding-our-quad-to-game1">Adding our Quad to Game1</h2>
<p>Now let&rsquo;s use our <code>Quad</code> in <code>Game1</code>.  Add a field for the quad to the <code>Game1</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The quad to draw</span>
</span></span><span style="display:flex;"><span>    Quad quad;</span></span></code></pre></div><p>And construct it in our <code>Game1.LoadContent()</code>.  We want to be sure the graphics device is set up before we construct our <code>Quad</code>, so this is a good spot:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the quad</span>
</span></span><span style="display:flex;"><span>    quad = <span style="color:#66d9ef">new</span> Quad(<span style="color:#66d9ef">this</span>);</span></span></code></pre></div><p>And finally, let&rsquo;s render it in our <code>Game1.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the quad</span>
</span></span><span style="display:flex;"><span>    quad.Draw();</span></span></code></pre></div><p>If you run your code, you should now see the textured quad rendered:</p>
<p>
<a href="#image-65bd9564a34e165fc827a5cb2d91e190" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-3.1.png" alt="The rendered quad" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-65bd9564a34e165fc827a5cb2d91e190">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-3.1.png" alt="The rendered quad" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice that even though our texture has a transparent background, the background is rendered in black.  Alpha blending is managed by the <code>GraphicsDevice.BlendState</code>, so we&rsquo;ll need to tweak it before we draw the quad:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    game.GraphicsDevice.BlendState = BlendState.AlphaBlend;</span></span></code></pre></div><p>Notice the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_BlendState" target="_blank">BlendState</a>
 class is the same one we used with <code>SpriteBatch</code> - and it works the same way.</p>
<p>If you run the game now, the logo&rsquo;s background will be properly transparent.</p>
<p>Just as with the <code>RasterizerState</code>, it is a good idea to restore the old <code>BlendState</code>.  So our final <code>Quad.Draw()</code> method might look like:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// Draws the quad</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Cache the old blend state </span>
</span></span><span style="display:flex;"><span>    BlendState oldBlendState = game.GraphicsDevice.BlendState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Enable alpha blending </span>
</span></span><span style="display:flex;"><span>    game.GraphicsDevice.BlendState = BlendState.AlphaBlend;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Apply our effect</span>
</span></span><span style="display:flex;"><span>    effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Render the quad</span>
</span></span><span style="display:flex;"><span>    game.GraphicsDevice.DrawUserIndexedPrimitives&lt;VertexPositionTexture&gt;(
</span></span><span style="display:flex;"><span>        PrimitiveType.TriangleList,
</span></span><span style="display:flex;"><span>        vertices,   <span style="color:#75715e">// The vertex collection</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>,          <span style="color:#75715e">// The starting index in the vertex array</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">4</span>,          <span style="color:#75715e">// The number of indices in the shape</span>
</span></span><span style="display:flex;"><span>        indices,    <span style="color:#75715e">// The index collection</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>,          <span style="color:#75715e">// The starting index in the index array</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>           <span style="color:#75715e">// The number of triangles to draw</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Restore the old blend state </span>
</span></span><span style="display:flex;"><span>    game.GraphicsDevice.BlendState = oldBlendState;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>This <code>Quad</code> is very similar to the sprites we&rsquo;ve worked with already - in fact, the <code>SpriteBatch</code> is an optimized way of drawing a lot of textured quads.  It also configures the graphics device and has its own effect, the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_SpriteEffect" target="_blank">SpriteEffect</a>
.  Because of this optimization, in most cases, you&rsquo;ll want to use the <code>SpriteBatch</code> for textured quads.  But it is good to understand how it is drawing 2D sprites using the 3D pipeline.</p>
<p>Speaking of&hellip; so far we&rsquo;ve only drawn 2D shapes in a 3D world.  Let&rsquo;s move on to an actual 3D shape next.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="rendering-a-cube">Rendering a Cube</h1>

<p>We&rsquo;ll continue our exploration of the rendering pipeline with another shape - a cube.  And as before, we&rsquo;ll introduce another concept - <em>vertex</em> and <em>index buffers</em>.</p>
<p>For our triangle and quad, we drew our shapes using <code>GraphicsDevice.DrawUserPrimitives&lt;T&gt;()</code> and <code>GraphicsDevice.DrawUserIndexedPrimitives&lt;T&gt;()</code>.   Our <code>vertices</code> and <code>indices</code> were simply arrays we declared normally, that we passed to the graphics card using the aforementioned methods.  As with most variables we deal with in C#, the memory used by the <code>vertices</code> and <code>indices</code> arrays was allocated from the computer&rsquo;s RAM.  When we invoked the methods, one of the tasks they do is stream the data to the GPU, so that it can be rendered.</p>
<p>This process can be significantly sped up if, instead of storing the vertex and index data in RAM, we store it in Video Ram (VRAM).  VRAM is the memory that is a part of our graphics card.  Not surprisingly, the GPU has direct access to VRAM and can stream data from it quite quickly - more quickly than it can from RAM.  Especially if we are drawing the same shape using the same vertex and index data every frame.</p>
<p>So how do we get this data into the VRAM?  We have to create a <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_VertexBuffer" target="_blank">VertexBuffer</a>
 and an <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_IndexBuffer" target="_blank">IndexBuffer</a>
.  Let&rsquo;s create a <code>Cube</code> class with instances of these classes.</p>
<h2 id="defining-the-cube-class">Defining the Cube Class</h2>
<p>We&rsquo;ll declare a <code>Cube</code> class much like our <code>Triangle</code> and <code>Quad</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class for rendering a cube</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cube</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The vertices of the cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    VertexBuffer vertices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The vertex indices of the cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    IndexBuffer indices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The effect to use rendering the cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    BasicEffect effect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The game this cube belongs to </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>The only real difference at this point is the use of a <code>VertexBuffer</code> and <code>IndexBuffer</code> as fields.</p>
<h3 id="creating-the-vertex-buffer">Creating the Vertex Buffer</h3>
<p>We need to create the vertex data in much the same way we did with our other shapes - we start with a collection of vertices (we&rsquo;ll use an array again, and give our vertices colors), but then we&rsquo;ll copy that data <em>into</em> the <code>VertexBuffer</code>, which effectively copies it into VRAM (if space is available).  Once again we&rsquo;ll wrap this in an initialization method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initialize the vertex buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeVertices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> vertexData = <span style="color:#66d9ef">new</span> VertexPositionColor[] { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>), Color = Color.Blue },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>), Color = Color.Green },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>), Color = Color.Red },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>), Color = Color.Cyan },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>), Color = Color.Blue },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>), Color = Color.Red },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>), Color = Color.Green },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionColor() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">3</span>, -<span style="color:#ae81ff">3</span>,  <span style="color:#ae81ff">3</span>), Color = Color.Cyan }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        vertices = <span style="color:#66d9ef">new</span> VertexBuffer(
</span></span><span style="display:flex;"><span>            game.GraphicsDevice,            <span style="color:#75715e">// The graphics device to load the buffer on </span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">typeof</span>(VertexPositionColor),    <span style="color:#75715e">// The type of the vertex data </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">8</span>,                              <span style="color:#75715e">// The count of the vertices </span>
</span></span><span style="display:flex;"><span>            BufferUsage.None                <span style="color:#75715e">// How the buffer will be used</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        vertices.SetData&lt;VertexPositionColor&gt;(vertexData);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We declare our <code>vertexData</code> as an instance variable, which means once this method returns, its memory will be reclaimed.  The <code>VertexBuffer</code> constructor allocates the space needed for the data in VRAM, while the <code>VertexBuffer.SetData()</code> method what actually copies it into that location, managing the process for us.</p>
<p>If we were writing DirectX code in C++, we would need to:</p>
<ol>
<li>Allocate memory in VRAM for the buffer</li>
<li>Lock that memory location (remember, both the GPU and CPU can access VRAM at a given time)</li>
<li>Copy the bytes of the buffer into that location, and</li>
<li>Release the lock</li>
</ol>
<p>If you are interested in seeing what the equivalent code in C++ looks like, visit <a href="http://www.directxtutorial.com/Lesson.aspx?lessonid=9-4-7" target="_blank">www.directxtutorial.com</a>
.  Our vertex and index data is adapted from the cube presented there.</p>
<h3 id="creating-the-index-buffer">Creating the Index Buffer</h3>
<p>The index buffer is initialized and the data copied in the same way:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the index buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeIndices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> indexData = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">short</span>[]
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#75715e">// Side 0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">6</span>, <span style="color:#75715e">// Side 1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#75715e">// Side 2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>, <span style="color:#75715e">// Side 3 </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#75715e">// Side 4 </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">2</span>, <span style="color:#75715e">// Side 5 </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        indices = <span style="color:#66d9ef">new</span> IndexBuffer(
</span></span><span style="display:flex;"><span>            game.GraphicsDevice,            <span style="color:#75715e">// The graphics device to use</span>
</span></span><span style="display:flex;"><span>            IndexElementSize.SixteenBits,   <span style="color:#75715e">// The size of the index </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">36</span>,                             <span style="color:#75715e">// The count of the indices</span>
</span></span><span style="display:flex;"><span>            BufferUsage.None                <span style="color:#75715e">// How the buffer will be used</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        indices.SetData&lt;<span style="color:#66d9ef">short</span>&gt;(indexData);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="initializing-the-effect">Initializing the Effect</h3>
<p>And our <code>BasicEffect</code> is configured identically to how we di so for our <code>Triangle</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the BasicEffect to render our cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> InitializeEffect()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect = <span style="color:#66d9ef">new</span> BasicEffect(game.GraphicsDevice);
</span></span><span style="display:flex;"><span>        effect.World = Matrix.Identity;
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>), <span style="color:#75715e">// The camera position</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#75715e">// The camera target,</span>
</span></span><span style="display:flex;"><span>            Vector3.Up            <span style="color:#75715e">// The camera up vector</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.Projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,                         <span style="color:#75715e">// The field-of-view </span>
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,   <span style="color:#75715e">// The aspect ratio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.1f</span>, <span style="color:#75715e">// The near plane distance </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">100.0f</span> <span style="color:#75715e">// The far plane distance</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.VertexColorEnabled = <span style="color:#66d9ef">true</span>;     
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="drawing-the-cube">Drawing the Cube</h3>
<p>Our <code>cube.Draw()</code> method will be a bit different though:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the Cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// apply the effect </span>
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the vertex buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.SetVertexBuffer(vertices);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the index buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.Indices = indices;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Draw the triangles</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawIndexedPrimitives(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList, <span style="color:#75715e">// Tye type to draw</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first vertex to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first index to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span>                          <span style="color:#75715e">// the number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Before we can use <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Graphics_GraphicsDevice_DrawIndexedPrimitives" target="_blank">GraphicsDevice.DrawIndexedPrimitives()</a>
, we need to tell the <code>GraphicsDevice</code> which <code>VertexBuffer</code> and <code>IndexBuffer</code> to use.  The first is set with a method, the second through assignment.  With both set, we can invoke <code>GraphicsDevice.DrawIndexedPrimitives()</code> and it will draw the contents of the buffers.</p>
<h3 id="constructing-the-cube">Constructing the Cube</h3>
<p>The <code>Cube</code> constructor is back in familiar territory:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a cube instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game that is creating the cube&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Cube(Game1 game)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeIndices();
</span></span><span style="display:flex;"><span>        InitializeEffect();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="adding-the-cube-to-game1">Adding the Cube to Game1</h2>
<p>To render our cube, we must go back to the <code>Game1</code> class and add a reference to one:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The cube to draw </span>
</span></span><span style="display:flex;"><span>    Cube cube;</span></span></code></pre></div><p>Construct it in the <code>Game1.LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the cube</span>
</span></span><span style="display:flex;"><span>    cube = <span style="color:#66d9ef">new</span> Cube(<span style="color:#66d9ef">this</span>);</span></span></code></pre></div><p>And draw it in the <code>Game1.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// draw the cube</span>
</span></span><span style="display:flex;"><span>    cube.Draw();</span></span></code></pre></div><p>If you run your code now, the cube is so big that the front face takes up the whole screen!</p>
<h2 id="changing-the-view-matrix">Changing the View Matrix</h2>
<p>We could scale our cube down with a world transform - but rather than doing that, let&rsquo;s look at it from farther away by changing the view transform.  Let&rsquo;s add an <code>Update()</code> method to our <code>Cube</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the Cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Look at the cube from farther away</span>
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, -<span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>            Vector3.Zero,
</span></span><span style="display:flex;"><span>            Vector3.Up
</span></span><span style="display:flex;"><span>        ); 
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And invoke this method in the <code>Game1.Update()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// update the cube </span>
</span></span><span style="display:flex;"><span>    cube.Update(gameTime);</span></span></code></pre></div><p>Now if you run the program, you should see the cube, and be able to see that its edges are distorted to simulate depth:</p>
<p>
<a href="#image-634fb7f4b2e740be6c6f94d69f395c4c" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-4.1.png" alt="Rendered Cube" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-634fb7f4b2e740be6c6f94d69f395c4c">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/basic-3d-4.1.png" alt="Rendered Cube" class="lightbox-image" loading="lazy">
</a></p>
<p>Let&rsquo;s set our viewpoint rotating around the cube by refactoring our <code>Cube.Update()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the Cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> angle = (<span style="color:#66d9ef">float</span>)gameTime.TotalGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Look at the cube from farther away while spinning around it</span>
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateRotationY(angle) * Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, -<span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>            Vector3.Zero,
</span></span><span style="display:flex;"><span>            Vector3.Up
</span></span><span style="display:flex;"><span>        ); 
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Now our cube appears to be spinning!  But actually, it is our vantage point that is circling the cube, unlike the triangle, which is actually spinning in place.  The final effect is the same, but one spin is applied to the world transform, and the other to the view transform.  We&rsquo;ll speak about both in more detail later.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>This wraps up our discussion of the basics of 3D rendering.  As you might expect, this is just the basic foundations.  From here we&rsquo;ll explore using models, creating lighting effect, animations, and more.  But all of these will depend on understanding and using these basic elements, so get comfortable with them!</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="lighting-and-cameras">Lighting and Cameras</h1>

<p>Lights, Camera, Action!</p>
<img src="https://media.giphy.com/media/U8FvqfxkzxoSpokGaW/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Lighting and Cameras</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>You&rsquo;ve now seen how vertices are grouped into triangles and rendered using accelerated hardware, how we can use a mesh of triangles to represent more complex objects, and how we can apply a texture to that mesh to provide visual detail.  Now we need to add light sources that can add shading to our models, and a camera which can be shared by all objects in a scene to provide a common view and projection matrix.</p>
<p>We&rsquo;ll once again be working from a starter project, which provides our needed content resources.  You can clone the starter from GitHub here: <a href="https://github.com/ksu-cis/lighting-and-cameras-starter" target="_blank">https://github.com/ksu-cis/lighting-and-cameras-starter</a>
</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="adding-a-crate">Adding a Crate</h1>

<p>The first thing we&rsquo;ll want to add is something to render.  For this example we&rsquo;ll employ a very common game prop - a crate.  As you might expect, a crate is little more than a cube with a texture applied.  However, we will need to make a few changes from our previous <code>Cube</code> class.</p>
<h2 id="cratetype-enum">CrateType Enum</h2>
<p>One of these is adding a texture - but we actually have three possible textures to choose from: &ldquo;crate0_diffuse&rdquo;, &ldquo;crate1_diffuse&rdquo;, and &ldquo;crate2_diffuse&rdquo;.   Let&rsquo;s make our single class represent all three possible crates, and use an enumeration to define which crate to create:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// The type of crate to create</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> CrateType
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Slats = <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    Cross,
</span></span><span style="display:flex;"><span>    DarkCross
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>If we mark the first enum value as <code>0</code>, then the second and third will be <code>1</code> and <code>2</code> respectively.  Thus, we can convert an enum value into a filename through casting and concatenation: <code>$&quot;crate{(int)value}_diffuse&quot;</code>.  We&rsquo;ll use this approach in our constructor.</p>
<h2 id="crate-class">Crate Class</h2>
<p>Before we get to that, let&rsquo;s definine the class and its fields:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a crate</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Crate</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The game this crate belongs to</span>
</span></span><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The VertexBuffer of crate vertices</span>
</span></span><span style="display:flex;"><span>    VertexBuffer vertexBuffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The IndexBuffer defining the Crate&#39;s triangles</span>
</span></span><span style="display:flex;"><span>    IndexBuffer indexBuffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The effect to render the crate with</span>
</span></span><span style="display:flex;"><span>    BasicEffect effect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The texture to apply to the crate</span>
</span></span><span style="display:flex;"><span>    Texture2D texture;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>No surprises here - it looks very much like our prior shapes.</p>
<h3 id="initializevertices">InitializeVertices</h3>
<p>But we&rsquo;ll use a different vertex format for our vertices, <code>VertexPositionNormalTexture</code>.  This vertex includes a <code>Position</code> (a <code>Vector3</code>), a <code>Normal</code> (a <code>Vector3</code> that is perpendicular to the surface at the vertex), and a <code>TextureCoordinate</code> (a <code>Vector2</code>):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the vertex of the cube</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeVertices() 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> vertexData = <span style="color:#66d9ef">new</span> VertexPositionNormalTexture[] { 
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Front Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Back Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Backward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Forward },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Top Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Up },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Up },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Up },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Up },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Bottom Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Down },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Down },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Down },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Down },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Left Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Left },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Left },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Left },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3(-<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Left },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Right Face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Right },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">0.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Right },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">0.0f</span>), Normal = Vector3.Right },
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> VertexPositionNormalTexture() { Position = <span style="color:#66d9ef">new</span> Vector3( <span style="color:#ae81ff">1.0f</span>, -<span style="color:#ae81ff">1.0f</span>,  <span style="color:#ae81ff">1.0f</span>), TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">1.0f</span>, <span style="color:#ae81ff">1.0f</span>), Normal = Vector3.Right },
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        vertexBuffer = <span style="color:#66d9ef">new</span> VertexBuffer(game.GraphicsDevice, <span style="color:#66d9ef">typeof</span>(VertexPositionNormalTexture), vertexData.Length, BufferUsage.None);
</span></span><span style="display:flex;"><span>        vertexBuffer.SetData&lt;VertexPositionNormalTexture&gt;(vertexData);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Defining the vertices is not much differen than we did for our <code>Cube</code>, except that we now need to include texture coordinates.  This <em>does</em> mean that we can no longer share vertices between faces, as they will have different texture coordinates.  Similarly, the different faces have different normals, which are a vector <em>out</em> of the face - hence the <code>Vector3.Up</code> (0, 1, 0) for the top face, <code>Vector3.Right</code> (1, 0, 0) for the right face, and so on.</p>
<p>We&rsquo;ll copy these values into our <code>vertexBuffer</code> for later use.</p>
<h3 id="initializing-the-indices">Initializing the Indices</h3>
<p>The index buffer is handled similarily:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the Index Buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> InitializeIndices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> indexData = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">short</span>[]
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Front face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Back face </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Top face</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">9</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Bottom face </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">13</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">14</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Left face </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">17</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">18</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Right face </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">21</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        indexBuffer = <span style="color:#66d9ef">new</span> IndexBuffer(game.GraphicsDevice, IndexElementSize.SixteenBits, indexData.Length, BufferUsage.None);
</span></span><span style="display:flex;"><span>        indexBuffer.SetData&lt;<span style="color:#66d9ef">short</span>&gt;(indexData);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="initializing-the-effect">Initializing the Effect</h3>
<p>And our effect is handled as with the textured quad:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initializes the BasicEffect to render our crate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> InitializeEffect()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect = <span style="color:#66d9ef">new</span> BasicEffect(game.GraphicsDevice);
</span></span><span style="display:flex;"><span>        effect.World = Matrix.CreateScale(<span style="color:#ae81ff">2.0f</span>);
</span></span><span style="display:flex;"><span>        effect.View = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">12</span>), <span style="color:#75715e">// The camera position</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#75715e">// The camera target,</span>
</span></span><span style="display:flex;"><span>            Vector3.Up            <span style="color:#75715e">// The camera up vector</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.Projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,                         <span style="color:#75715e">// The field-of-view </span>
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,   <span style="color:#75715e">// The aspect ratio</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0.1f</span>, <span style="color:#75715e">// The near plane distance </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">100.0f</span> <span style="color:#75715e">// The far plane distance</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        effect.TextureEnabled = <span style="color:#66d9ef">true</span>; 
</span></span><span style="display:flex;"><span>        effect.Texture = texture;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="drawing-the-crate">Drawing the Crate</h3>
<p>As is drawing:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the crate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// apply the effect </span>
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the vertex buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.SetVertexBuffer(vertexBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the index buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.Indices = indexBuffer;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Draw the triangles</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawIndexedPrimitives(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList, <span style="color:#75715e">// Tye type to draw</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first vertex to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first index to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span>                          <span style="color:#75715e">// the number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="constructing-the-crate">Constructing the Crate</h3>
<p>When we construct the crate is where we see the next change - we&rsquo;ll need to determine which texture to load:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Creates a new crate instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this crate belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;type&#34;&gt;The type of crate to use&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Crate(Game game, CrateType type)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.texture = game.Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">$&#34;crate{(int)type}_diffuse&#34;</span>);
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeIndices();
</span></span><span style="display:flex;"><span>        InitializeEffect();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="adding-the-crate-to-the-game">Adding the Crate to the Game</h2>
<p>And, as before, we&rsquo;ll add our crate to the game and draw it.  We&rsquo;ll need an instance variable:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// our crate</span>
</span></span><span style="display:flex;"><span>    Crate crate;</span></span></code></pre></div><p>Which we&rsquo;ll initialize in <code>Game.LoadContent()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// initialize the crate </span>
</span></span><span style="display:flex;"><span>    crate = <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.Slats);</span></span></code></pre></div><p>And render in our <code>Game.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    crate.Draw();</span></span></code></pre></div><p>If you run the game now, you should see our crate appear!</p>
<p>
<a href="#image-e8e3b1d1636823ba0c1277e587950213" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-2.1.png" alt="The rendered crate" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-e8e3b1d1636823ba0c1277e587950213">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-2.1.png" alt="The rendered crate" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="adding-lights">Adding Lights</h1>

<p>Well, we have a crate.  Let&rsquo;s make it more interesting by adding some lights.  To start with, we&rsquo;ll use the <code>BasicEffect</code>&rsquo;s default lights.  Add the line:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>effect.EnableDefaultLighting();</span></span></code></pre></div><p>Into your <code>Crate.IntializeEffect()</code> method.  Then run the program again.  Notice a difference?</p>
<p>
<a href="#image-75cae68e8488387fe26dfdaa5e6d8599" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.1.png" alt="Side-by-side comparison of a lit and unlit crate" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-75cae68e8488387fe26dfdaa5e6d8599">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.1.png" alt="Side-by-side comparison of a lit and unlit crate" class="lightbox-image" loading="lazy">
</a>.</p>
<p>The default lighting is useful to quickly see what our object will look like illuminated, but ultimately, we&rsquo;ll want to define our own lights and how they interact with our objects.</p>
<h2 id="lighting-calculations">Lighting Calculations</h2>
<p>The <code>BasicEffect</code> uses the <a href="https://en.wikipedia.org/wiki/Phong_shading" target="_blank">Phong shading model</a>
 (named after its inventor, Bui Tuong Phong).  This model approximates shading accounting for the smoothness of the object.  It uses an equation to calculate the color of each pixel.  This equation appears in the image below:</p>
<p>
<a href="#image-0b4f63326a74747d1bb9b92b20a87981" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/phong-equation.png" alt="Phong equation" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-0b4f63326a74747d1bb9b92b20a87981">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/phong-equation.png" alt="Phong equation" class="lightbox-image" loading="lazy">
</a></p>
<p>Essentailly, the Phong approach calculates three different lighting values, and combines them into shading values to apply to a model.  Each of these is based on the behavior of light, which is a particle (and a wave) that travels in (largely) stright lines.  We can think of these lines as rays.</p>
<p>The first is <em>ambient</em> light, which reprsents light that has been bouncing around the scene so much that it is hitting our object from all directions.  Rather than try to capture that chaos, the Phong model simply substitutes a single flat value that is applied to all surfaces in the scene.  In a brightly lit scene, this might be a high value; for a creepy night scene, we would use a very low value to provide only dim illumination away from light sources.</p>
<p>The second is <em>diffuse</em> light, which is the light that strikes a surface and scatters.  We choose the strength of this light based on the characteristics of the material.  Rough materials have more diffuse light, as the light striking the surface bounces off in all directions, so only some of it is toward the observer.</p>
<p>The third is <em>specular</em> light, which is <em>also</em> light that strikes a surface and bounces off, and is chosen by the properties of the material.  However, high specular light corresponds to smooth surfaces - because they are smooth, light rays that strike near one another tend to bounce the same direction.  Hence, light that is striking at the right angle will all bounce towards the veiwer, creating &ldquo;hot spots&rdquo; of very bright color.</p>
<p>These calculations are based on the angle between the surface and the viewer - this is why we need to provide a normal, as well as a direction the camera is looking and a direction the light is coming from; the angles between these vectors are used in calculating these lighting components.</p>
<p>The <code>BasicEffect</code> uses the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_DirectionalLight" target="_blank">DirectionalLight class</a>
 to represent lights.  You define the diffuse and specular color as <code>Vector3</code> objects (where the x,y,and z correspond to rgb values, within the range [0..1] where 0 is no light, and 1 is full light).  You also define a direction the light is coming from as a <code>Vector3</code>.  Since ambient light doesn&rsquo;t have a direction, you simply represent it with a color <code>Vector3</code>.  When the object is rendered, the shader combines those color contributions of each light additively with the colors sampled from the texture(s) that are being applied.  We can define up to three directional light sources with the <code>BasicEffect</code>.</p>
<h2 id="customizing-our-crate-lighting">Customizing our Crate Lighting</h2>
<p>Let&rsquo;s see this in action.  Delete the <code>effect.EnableDefaultLighting()</code> line in your <code>Crate.InitializeEffect()</code> and replace it with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Turn on lighting</span>
</span></span><span style="display:flex;"><span>    effect.LightingEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set up light 0</span>
</span></span><span style="display:flex;"><span>    effect.DirectionalLight0.Enabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    effect.DirectionalLight0.Direction = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1f</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1f</span>);
</span></span><span style="display:flex;"><span>    effect.DirectionalLight0.DiffuseColor = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0.8f</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    effect.DirectionalLight0.SpecularColor = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">1f</span>, <span style="color:#ae81ff">0.4f</span>, <span style="color:#ae81ff">0.4f</span>);</span></span></code></pre></div><p>Notice the difference?  We&rsquo;re shining a red light onto our crate from an oblique angle, above and to the left.</p>
<p>
<a href="#image-83a63955236fbd32e82e551a04104806" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.2.png" alt="The Illuminated Crate" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-83a63955236fbd32e82e551a04104806">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.2.png" alt="The Illuminated Crate" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice how one face of the crate is in complete shadow?  Let&rsquo;s add some ambient light with the command:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    effect.AmbientLightColor = <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0.3f</span>, <span style="color:#ae81ff">0.3f</span>, <span style="color:#ae81ff">0.3f</span>);</span></span></code></pre></div><p>
<a href="#image-8141f9fdda5a13db80c66257e69ae369" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.3.png" alt="The crate with ambient light" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-8141f9fdda5a13db80c66257e69ae369">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-3.3.png" alt="The crate with ambient light" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice how the shadowed face is now somewhat visible?</p>
<p>Go ahead and try tweaking the values for <code>AmbientLightColor</code> and <code>DirectionalLight0</code>, and see how that changes the way your crate looks.  You can also set the properties of <code>DirectionalLight1</code> and <code>DirectionalLight2</code>.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="adding-a-camera">Adding a Camera</h1>

<p>So far we&rsquo;ve set the World, View, and Transform matrix of each 3D object within that object.  That works fine for these little demo projects, but once we start building a full-fledged game, we expect to look at everything in the world <em>from the same perspective</em>.  This effectively means we want to use the <em>same</em> view and perspective matrices for all objects in a scene.  Moreover, we want to move that perspective around in a well-defined manner.</p>
<p>What we want is a <em>camera</em> - an object that maintains a position and derives a view matrix from that position.  Our camera also should provide a projection matrix, as we may want to tweak it in response to game activity - i.e. we might swap it for another matrix when the player uses a sniper rifle.</p>
<p>In fact, we may want <em>multiple</em> cameras in a game.  We might want to change from a first-person camera to an overhead camera when the player gets into a vehicle, or we may want to present a fly-through of the level before the player starts playing.  Since each of these may work in very different ways, let&rsquo;s start by defining an interface of their common aspects.</p>
<h2 id="the-icamera-interface">The ICamera Interface</h2>
<p>Those commonalities are our two matrices - the view and the perspective.  Let&rsquo;s expose them with read-only properties (properties with only a getter):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// An interface defining a camera</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ICamera</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The view matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Matrix View { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The projection matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Matrix Projection { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Now let&rsquo;s define some cameras.</p>
<h2 id="circlingcamera">CirclingCamera</h2>
<p>To start with, let&rsquo;s duplicate something we&rsquo;ve already done.  Let&rsquo;s create a camera that just spins around the origin.  We&rsquo;ll call it <code>CirclingCamera</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A camera that circles the origin </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CirclingCamera</span> : ICamera
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We know from our previous work, we&rsquo;ll need to keep track of the angle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera&#39;s angle </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> angle;</span></span></code></pre></div><p>We might also hold a vector for the camera&rsquo;s position:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera&#39;s position</span>
</span></span><span style="display:flex;"><span>    Vector3 position;</span></span></code></pre></div><p>And a rotation speed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera&#39;s speed </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> speed;</span></span></code></pre></div><p>And the <code>Game</code> (which we need to determine the aspect ratio of the screen):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The game this camera belongs to </span>
</span></span><span style="display:flex;"><span>    Game game;</span></span></code></pre></div><p>We&rsquo;ll also define private backing variables for our view and perspective matrices:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The view matrix </span>
</span></span><span style="display:flex;"><span>    Matrix view;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The projection matrix </span>
</span></span><span style="display:flex;"><span>    Matrix projection;</span></span></code></pre></div><p>And fulfill our interface by making them accessible as properties:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The camera&#39;s view matrix </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix View =&gt; view;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The camera&#39;s projection matrix </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix Projection =&gt; projection;</span></span></code></pre></div><p>Then we can add our constructor:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new camera that circles the origin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this camera belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;position&#34;&gt;The initial position of the camera&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;speed&#34;&gt;The speed of the camera&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CirclingCamera(Game game, Vector3 position, <span style="color:#66d9ef">float</span> speed) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.position = position;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.speed = speed;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.view = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            position,
</span></span><span style="display:flex;"><span>            Vector3.Zero,
</span></span><span style="display:flex;"><span>            Vector3.Up
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>This just sets our initial variables.  Finally, we can write our update method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the camera&#39;s positon</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The GameTime object&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// update the angle based on the elapsed time and speed</span>
</span></span><span style="display:flex;"><span>        angle += speed * (<span style="color:#66d9ef">float</span>)gameTime.ElapsedGameTime.TotalSeconds;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Calculate a new view matrix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.view = 
</span></span><span style="display:flex;"><span>            Matrix.CreateRotationY(angle) *
</span></span><span style="display:flex;"><span>            Matrix.CreateLookAt(position, Vector3.Zero, Vector3.Up);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Since our rotation is around the origin, we can simply multiply a lookat matrix by a rotation matrix representing the incremental change.</p>
<h2 id="refactoring-game1">Refactoring Game1</h2>
<p>Finally, we&rsquo;ll need to add our camera to the <code>Game1</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera </span>
</span></span><span style="display:flex;"><span>    CirclingCamera camera;</span></span></code></pre></div><p>Initialize it in the <code>Game.LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Initialize the camera </span>
</span></span><span style="display:flex;"><span>    camera = <span style="color:#66d9ef">new</span> CirclingCamera(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>), <span style="color:#ae81ff">0.5f</span>);</span></span></code></pre></div><p>Update it in the <code>Game1.Update()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the camera </span>
</span></span><span style="display:flex;"><span>    camera.Update(gameTime);</span></span></code></pre></div><p>And in our draw method, we&rsquo;ll need to supply this camera to our <code>crate</code>.  Replace the line <code>crate.Draw()</code> with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>crate.Draw(camera);</span></span></code></pre></div><h3 id="refactoring-crate">Refactoring Crate</h3>
<p>This of course means we&rsquo;ll need to tweak the <code>Draw</code> method in <code>Crate</code>.  Change it to this:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the crate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;camera&#34;&gt;The camera to use to draw the crate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(ICamera camera)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the view and projection matrices</span>
</span></span><span style="display:flex;"><span>        effect.View = camera.View;
</span></span><span style="display:flex;"><span>        effect.Projection = camera.Projection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// apply the effect </span>
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the vertex buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.SetVertexBuffer(vertexBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// set the index buffer</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.Indices = indexBuffer;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Draw the triangles</span>
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawIndexedPrimitives(
</span></span><span style="display:flex;"><span>            PrimitiveType.TriangleList, <span style="color:#75715e">// Tye type to draw</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first vertex to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">0</span>,                          <span style="color:#75715e">// The first index to use</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span>                          <span style="color:#75715e">// the number of triangles to draw</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Now if you run your code, you should find yourself circling the lit crate.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="more-crates">More Crates!</h1>

<p>Let&rsquo;s up the ante a bit, and add <em>multiple</em> crates to the game.</p>
<h2 id="refactor-crate">Refactor Crate</h2>
<p>We don&rsquo;t want all of our crates in the same spot, so it&rsquo;s time to change our world matrix.  Let&rsquo;s refactor our <code>Crate</code> so we can pass a matrix in through the constructor:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Creates a new crate instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this crate belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;type&#34;&gt;The type of crate to use&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;world&#34;&gt;The position and orientation of the crate in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Crate(Game game, CrateType type, Matrix world)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.texture = game.Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">$&#34;crate{(int)type}_diffuse&#34;</span>);
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeIndices();
</span></span><span style="display:flex;"><span>        InitializeEffect();
</span></span><span style="display:flex;"><span>        effect.World = world;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>It is important that we set the <code>effect.World</code> only <em>after</em> we have constructed it in <code>InitializeEffect()</code>.</p>
<h2 id="refactor-game1">Refactor Game1</h2>
<p>Let&rsquo;s use our refactored <code>Crate</code> by changing the variable <code>crate</code> in your <code>Game1</code> class to an array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// A collection of crates</span>
</span></span><span style="display:flex;"><span>    Crate[] crates;</span></span></code></pre></div><p>And initialize them in the <code>Game1.LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Make some crates</span>
</span></span><span style="display:flex;"><span>    crates = <span style="color:#66d9ef">new</span> Crate[] {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.DarkCross, Matrix.Identity),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.Slats, Matrix.CreateTranslation(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.Cross, Matrix.CreateTranslation(-<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.DarkCross, Matrix.CreateRotationY(MathHelper.PiOver4) * Matrix.CreateTranslation(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.Slats, Matrix.CreateTranslation(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>, -<span style="color:#ae81ff">3</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Crate(<span style="color:#66d9ef">this</span>, CrateType.Cross, Matrix.CreateRotationY(<span style="color:#ae81ff">3</span>) * Matrix.CreateTranslation(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>, -<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>    };</span></span></code></pre></div><p>And draw the collection in <code>Game1.Draw()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw some crates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(Crate crate <span style="color:#66d9ef">in</span> crates)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        crate.Draw(camera);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Try running your code now - you should see a collection of crates.</p>
<p>
<a href="#image-ea7c4cdb5c8c390896f61129565d01b9" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-5.1.png" alt="Crates" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-ea7c4cdb5c8c390896f61129565d01b9">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/lighting-and-cameras-5.1.png" alt="Crates" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="fps-camera">FPS Camera</h1>

<p>Let&rsquo;s go ahead and create a camera that the player can actually control.  This time, we&rsquo;ll adopt a camera made popular by PC first-person shooters, where the player&rsquo;s looking direction is controlled by the mouse, and the WASD keys move forward and back and strife side-to-side.</p>
<h2 id="the-fps-camera-class">The FPS Camera Class</h2>
<p>Let&rsquo;s start by defining our class, <code>FPSCamera</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A camera controlled by WASD + Mouse</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FPSCamera</span> : ICamera
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="private-fields">Private Fields</h3>
<p>This camera is somewhat unique in it partially the splits vertical from horizontal axes; the vertical axis <em>only</em> controls the angle the player is looking along, while the horizontal axis informs both looking and the direction of the player&rsquo;s movement.  Thus, we&rsquo;ll need to track these angles separately, and combine them when needed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The angle of rotation about the Y-axis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> horizontalAngle;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The angle of rotation about the X-axis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> verticalAngle;</span></span></code></pre></div><p>We also need to keep track of the position of the camera in the world:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera&#39;s position in the world </span>
</span></span><span style="display:flex;"><span>    Vector3 position;</span></span></code></pre></div><p>And we need to know what the previous state of the mouse was:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The state of the mouse in the prior frame</span>
</span></span><span style="display:flex;"><span>    MouseState oldMouseState;</span></span></code></pre></div><p>And an instance of the <code>Game</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The Game this camera belongs to </span>
</span></span><span style="display:flex;"><span>    Game game;</span></span></code></pre></div><h3 id="public-properties">Public Properties</h3>
<p>We need to define the <code>View</code> and <code>Projection</code> matrices to meet our <code>ICamera</code> inteface requirements:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The view matrix for this camera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix View { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The projection matrix for this camera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix Projection { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">set</span>; }</span></span></code></pre></div><p>We&rsquo;ll keep the setters protected, as they should only be set from within the camera (or a derived camera).</p>
<p>We also will provide a <code>Sensitivity</code> value for fine-tuning the mouse sensitivity; this would likely be adjusted from a menu, so it needs to be public:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The sensitivity of the mouse when aiming</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Sensitivity { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0.0018f</span>;</span></span></code></pre></div><p>We&rsquo;ll likewise expose the speed property, as it may be changed in-game to respond to powerups or special modes:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The speed of the player while moving </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Speed { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0.5f</span>;</span></span></code></pre></div><h3 id="the-constructor">The Constructor</h3>
<p>Constructing the <code>FPSCamera</code> requires a <code>Game</code> instance, and an initial position:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new FPS Camera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this camera belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;position&#34;&gt;The player&#39;s initial position&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> FPSCamera(Game game, Vector3 position)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.position = position;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Inside the constructor, we&rsquo;ll initialize our angles to <code>0</code> (alternatively, you might also add a facing angle to the constructor so you can control both where the player starts and the direction they face):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.horizontalAngle = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.verticalAngle = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>We&rsquo;ll also set up our  projection matrix:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.Projection = Matrix.CreatePerspectiveFieldOfView(MathHelper.PiOver4, game.GraphicsDevice.Viewport.AspectRatio, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1000</span>);</span></span></code></pre></div><p>And finally, we&rsquo;ll center the mouse in the window, and save its state:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Mouse.SetPosition(game.Window.ClientBounds.Width / <span style="color:#ae81ff">2</span>, game.Window.ClientBounds.Height / <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    oldMouseState = Mouse.GetState();</span></span></code></pre></div><h3 id="the-update-method">The Update Method</h3>
<p>The <code>Update()</code> method is where the heavy lifting of the class occurs, updating the camera position and calculating the view matrix.  There&rsquo;s a lot going on here, so we&rsquo;ll assemble it line-by-line, discusing each as we add it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the camera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The current GameTime&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>First up, we&rsquo;ll grab current input states:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> keyboard = Keyboard.GetState();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> newMouseState = Mouse.GetState();</span></span></code></pre></div><p>Then we&rsquo;ll want to handle movement.  Before we move the camera, we need to know what direction it is currenlty facing.  We can represent this with a <code>Vector3</code> in that direction, which we calculate by rotating a forward vector by the horizontal angle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Get the direction the player is currently facing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> facing = Vector3.Transform(Vector3.Forward, Matrix.CreateRotationY(horizontalAngle));</span></span></code></pre></div><p>Then we can apply forward and backward movement along this vector when the W or S keys are pressed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Forward and backward movement</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.W)) position += facing * Speed;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.S)) position -= facing * Speed;</span></span></code></pre></div><p>The A and D keys provide <em>strifing</em> movement, movement <em>perpendicular</em> to the forward vector.  We can find this perpendicular vector by calculating the cross product of the facing and up vectors:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Strifing movement</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.A)) position += Vector3.Cross(Vector3.Up, facing) * Speed;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.D)) position -= Vector3.Cross(Vector3.Up, facing) * Speed;</span></span></code></pre></div><p>That wraps up moving the camera&rsquo;s position in the world.  Now we need to tackle where the camera is looking.  This means adusting the vertical and horizontal angles based on mouse movement this frame (which we caculate by subtracing the new mouse position from the old):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Adjust horizontal angle</span>
</span></span><span style="display:flex;"><span>    horizontalAngle += Sensitivity * (oldMouseState.X - newMouseState.X);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Adjust vertical angle </span>
</span></span><span style="display:flex;"><span>    verticalAngle += Sensitivity * (oldMouseState.Y - newMouseState.Y);</span></span></code></pre></div><p>From these angles, we can calculate the direction the camera is facing, by rotating a forward-facing vector in both the horizontal and vertical axes:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    direction =  Vector3.Transform(Vector3.Forward, Matrix.CreateRotationX(verticalAngle) * Matrix.CreateRotationY(horizontalAngle));</span></span></code></pre></div><p>With that direction, we can now calculate the view matrix using <code>Matrix.CreateLookAt()</code>.  The target vector is the direction vector added to the position:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// create the veiw matrix</span>
</span></span><span style="display:flex;"><span>    View = Matrix.CreateLookAt(position, position + direction, Vector3.Up);</span></span></code></pre></div><p>Lastly, we reset the mouse state.  First we re-center the mouse, and then we save its new centered state as our old mouse state.  This centering is important in Windowed mode, as it keeps our mouse within the window even as the player spins 360 degrees or more.  Otherwise, our mouse would pop out of the window, and could interact with other windows while the player is trying to play our game.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Reset mouse state </span>
</span></span><span style="display:flex;"><span>    Mouse.SetPosition(game.Window.ClientBounds.Width / <span style="color:#ae81ff">2</span>, game.Window.ClientBounds.Height / <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    oldMouseState = Mouse.GetState();</span></span></code></pre></div><p>This does mean that you can no longer use the mouse to close the window, so it is important to have a means to exit the game.  By default, the <code>Game1</code> class uses hitting the escape key to do this. In full games you&rsquo;ll probably replace that functionality with a menu that contains an exit option.</p>
<h2 id="refactoring-the-game-class">Refactoring the Game Class</h2>
<p>Of course, to use this camera, you&rsquo;ll need to replace the <code>CirclingCamera</code> references in <code>Game1</code> with our <code>FPSCamera</code> implementation.  So you&rsquo;ll define a private <code>FPSCamera</code> reference:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The game camera</span>
</span></span><span style="display:flex;"><span>    FPSCamera camera;</span></span></code></pre></div><p>Initialize it with its starting position in the <code>LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Initialize the camera </span>
</span></span><span style="display:flex;"><span>    camera = <span style="color:#66d9ef">new</span> FPSCamera(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>));</span></span></code></pre></div><p>Update it in the <code>Update()</code> method (which isn&rsquo;t really a change):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the camera</span>
</span></span><span style="display:flex;"><span>    camera.Update(gameTime);</span></span></code></pre></div><p>And provide it to the crates in the <code>Draw()</code> method (again, this shouldn&rsquo;t be a change from the <code>CirclingCamera</code> implementation):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw some crates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(Crate crate <span style="color:#66d9ef">in</span> crates)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        crate.Draw(camera);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Now if you run the game, you should be able to move around the scene using WASD keys and the mouse.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this lesson, we&rsquo;ve seen how to apply Phong lighting using the BasicEffect, and how to set up cameras.  Armed with this knowledge, you&rsquo;re ready to start building explorable game environments.</p>
<p>A good next step is to think about what other kinds of cameras you can create.  What about an over-the-shoulder camera that follows the player?  Or a first-person camera that uses GamePad input?  As you now know, a game camera is nothing more than code to determine where the camera is in a scene, and where it is pointed.  From that, you can create a View matrix.  You might also try expanding the options for the Perspective matrix from the default implementation we&rsquo;ve been using.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="heightmap-terrain">Heightmap Terrain</h1>

<p>Keep your feet on the ground!</p>
<img src="https://media.giphy.com/media/8ugUSaSctDDMI/giphy.gif"/>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Heightmap Terrain</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Now that we understand how 3D worlds are built from triangle meshes, and how we can use cameras to explore those worlds, let&rsquo;s start putting those ideas to work.  In this section, we&rsquo;ll focus on creating terrain from a heightmap - a grayscale bitmap representing the changing elevation of the ground.</p>
<p>Like our earlier examples, we&rsquo;ll start from a starter project with our assets pre-loaded.  In addition, we&rsquo;ll include the <code>ICamera</code> interface and the <code>FPSCamera</code> we created in the lesson on <a href="https://ksu-cs-textbooks.github.io/cis580/14-lighting-and-cameras/">Lights and Cameras</a>
.  It is also preloaded with public-domain content assets, including a heightmap from Wikimedia and a grass texture from Para on OpenGameArt&rsquo;s <a href="https://opengameart.org/content/synthetic-grass-texture-pack" target="_blank">Synthetic Grass Texture Pack</a>
.</p>
<p>You can find the starter project here: <a href="https://github.com/ksu-cis/heightmap-terrain-starter" target="_blank">https://github.com/ksu-cis/heightmap-terrain-starter</a>
</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="heightmaps">Heightmaps</h1>

<p>You might be wondering just what a <em>heightmap</em> is.  If you&rsquo;ve ever used a <a href="https://en.wikipedia.org/wiki/Topographic_map" target="_blank">topographic map</a>
, you&rsquo;ve seen a similar idea.  Contour maps include <em>contour</em> lines_, lines that trace when the ground reaches a certain altitude.  Inside the line is higher than that altitude, and outside of the line is lower (or visa-versa).  The contours themselves are typically marked with the altitude they represent.</p>
<p>A heightmap is similar, but instead of using lines, each <em>pixel</em> in the map represents a square section of land, and the color value at that point indicates the average altitude of that square.  Since there is only one value to represent, heightmaps are typically created in grayscale.  And, to optimize space, they may also be saved in a monochrome format (where each pixel is stored as a single 8-bit value, instead of the 32-bits typical for storing RGB values).</p>
<p>
<a href="#image-750855756e9a2ed118d8b02f482da544" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/Heightmap.png" alt="Heightmap Example" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-750855756e9a2ed118d8b02f482da544">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/Heightmap.png" alt="Heightmap Example" class="lightbox-image" loading="lazy">
</a></p>
<p>You can obtain heightmaps in a number of ways.  You can draw a heightmap with any raster graphics program, though it takes a lot of skill and patience to make one that mimics natural terrain.  You can also get real-world heightmaps directly from organizations like the <a href="http://earthexplorer.usgs.gov/" target="_blank">USGS</a>
 or <a href="http://viewfinderpanoramas.org/Coverage%20map%20viewfinderpanoramas_org3.htm" target="_blank">NASA&rsquo;s Viewfinder Project</a>
.  Or you can generate one using Perlin Noise and algorithms that mimic the results of plate tectonics.  There also exist many height-map generation programs, both open-source and commercial.</p>
<p>Along with the height map, you also need to know the sampling resolution (how large each terrain square should be), and the scale that should be applied to the heights (as the pixel values of the heightmap will be in values between 0 and 255).</p>
<p>Now, let&rsquo;s turn our attention to creating a Terrain class that will use a heightmap.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="terrain-class">Terrain Class</h1>

<p>We&rsquo;ll start with the class definition:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing terrain</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Terrain</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The game this Terrain belongs to</span>
</span></span><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>As with most of our classes, we&rsquo;ll keep a reference to the <code>Game</code> object to access the shared <code>ContentManager</code> and <code>GraphicsDevice</code>.</p>
<h3 id="class-fields">Class Fields</h3>
<p>We could store our heightmap directly, but all we really need out of it are the height values, and these need to be scaled.  So instead, we&rsquo;ll store the result of that computation in a 2D array of floats:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The height data </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span>[,] heights;</span></span></code></pre></div><p>It&rsquo;s also convenient to keep track of the width and height of our terrain (in grid cells), and the total number of triangles in the terrain&rsquo;s mesh:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The number of cells in the x-axis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> width;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The number of cells in the z-axis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> height;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The number of triangles in the mesh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> triangles;</span></span></code></pre></div><p>To render the heightmap, we need a <code>VertexBuffer</code> and <code>IndexBuffer</code> to represent our triangle mesh, and a <code>BasicEffect</code> to render it, and a <code>Texture2D</code> to apply to it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The terrain mesh vertices</span>
</span></span><span style="display:flex;"><span>    VertexBuffer vertices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The terrain mesh indices</span>
</span></span><span style="display:flex;"><span>    IndexBuffer indices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The effect used to render the terrain</span>
</span></span><span style="display:flex;"><span>    BasicEffect effect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The texture to apply to the terrain surface</span>
</span></span><span style="display:flex;"><span>    Texture2D texture;</span></span></code></pre></div><h3 id="getting-the-height-data">Getting the Height Data</h3>
<p>We&rsquo;ll write a helper method, <code>LoadHeights()</code>, to convert our heightmap from a <code>Texture2D</code> into our 2D array of floats.  As you might expect from our earlier discussion, we&rsquo;ll also need to know the scaling factor for determining the height. We&rsquo;ll take these as parameters to our method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Converts the supplied Texture2D into height data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;heightmap&#34;&gt;The heightmap texture&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;scale&#34;&gt;The difference between the highest and lowest elevation&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> LoadHeights(Texture2D heightmap, <span style="color:#66d9ef">float</span> scale)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>An easy way to define the scale is to use the difference between the lowest and highest elevations, in the units of the game world.  If we treat the color of the pixel as a value between 0 and 1, we can just multiply the scale by the color.  Unfortunately, our color channels in a <code>Texture2D</code> are actually represented as a byte with value between 0 and 255.  But we can transform that into our desired range by dividing that value by 256.  Instead of doing that division operation in a loop (causing N*M divisions where N is the width of the heightmap and M is the width), we can pre-divide the scale, and get the same effect with a single division operation:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Convert the scale factor to work with our color</span>
</span></span><span style="display:flex;"><span>   scale /= <span style="color:#ae81ff">256</span>;</span></span></code></pre></div><p>We&rsquo;ll also set the <code>width</code> and <code>height</code> properties to match the dimensions of our heightmap:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The number of grid cells in the x-direction</span>
</span></span><span style="display:flex;"><span>    width = heightmap.Width;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The number of grid cells in the z-direction</span>
</span></span><span style="display:flex;"><span>    height = heightmap.Height;</span></span></code></pre></div><p>Which will also be the dimensions of our <code>heights</code> array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    heights = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">float</span>[width, height];            </span></span></code></pre></div><p>Now, we need to get the color data from our heightmap.  We can extract that with the <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Graphics_Texture2D_GetData__1_3" target="_blank">Texture2D.GetData()</a>
 method.  This returns the data as a one-dimensional array of <code>Color</code> structures.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Get the color data from the heightmap</span>
</span></span><span style="display:flex;"><span>    Color[] heightmapColors = <span style="color:#66d9ef">new</span> Color[width * height];
</span></span><span style="display:flex;"><span>    heightmap.GetData&lt;Color&gt;(heightmapColors);</span></span></code></pre></div><p>We can then iterate through our <code>heights</code> array, setting each entry to the color value extracted from the heightmap scaled by our scaling factor:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the heights</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> y = <span style="color:#ae81ff">0</span>; y &lt; height; y++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; width; x++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            heights[x, y] = heightmapColors[x + y * width].R * scale;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Remember that we can convert from two-dimensional array indices to a one-dimensional index with the equation <code>index = x + y * width]</code>.</p>
<p>After setting the heights, we&rsquo;ve finished with this method.  Next we&rsquo;ll tackle creating our vertices</p>
<h3 id="creating-the-vertices">Creating the Vertices</h3>
<p>We&rsquo;ll create our vertices in an <code>InitializeVertices()</code> helper method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Creates the terrain vertex buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeVertices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We&rsquo;ll start by creating an array to hold our vertex data.  We&rsquo;ll use the <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_VertexPositionNormalTexture" target="_blank">VertexPositionNormalTexture</a>
 structure as the type of our vertices.  The size of this array will be the same size as the heightmap data:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    VertexPositionNormalTexture[] terrainVertices = <span style="color:#66d9ef">new</span> VertexPositionNormalTexture[width * height];      </span></span></code></pre></div><p>We&rsquo;ll also create an index variable to simplify the transition between our 2D heights array and our 1D vertex array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>Now we can iterate through the vertex data, setting the <code>Position</code>, <code>Normal</code>, and <code>Texture</code> properties of each vertex:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> z = <span style="color:#ae81ff">0</span>; z &lt; height; z++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; width; x++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            terrainVertices[i].Position = <span style="color:#66d9ef">new</span> Vector3(x, heights[x, z], -z);
</span></span><span style="display:flex;"><span>            terrainVertices[i].Normal = Vector3.Up;
</span></span><span style="display:flex;"><span>            terrainVertices[i].TextureCoordinate = <span style="color:#66d9ef">new</span> Vector2((<span style="color:#66d9ef">float</span>)x / <span style="color:#ae81ff">50f</span>, (<span style="color:#66d9ef">float</span>)z / <span style="color:#ae81ff">50f</span>);
</span></span><span style="display:flex;"><span>            i++;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>A couple of things to be aware of:</p>
<ol>
<li>We are creating our terrain starting at position (0, 0) and out along the positive x-axis and the negative z-axis.  This would be our <em>model</em> coordinates.</li>
<li>Right now, we&rsquo;re treating the surface normal as always being straight up.  It would be more accurate to calculate this normal based on the terrain slope at that point.</li>
<li>We&rsquo;re setting our texture coordinate to be 1/50th of index value.  This means our terrain texture will cover 50 grid cells.  This might need tweaked depending on what textures we are using.</li>
</ol>
<p>Armed with our vertex data, we can create and populate our  <code>VertexBuffer</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    vertices = <span style="color:#66d9ef">new</span> VertexBuffer(game.GraphicsDevice, <span style="color:#66d9ef">typeof</span>(VertexPositionNormalTexture), terrainVertices.Length, BufferUsage.None);
</span></span><span style="display:flex;"><span>    vertices.SetData&lt;VertexPositionNormalTexture&gt;(terrainVertices);</span></span></code></pre></div><h3 id="creating-the-indices">Creating the Indices</h3>
<p>Before we dive into code, let&rsquo;s think about how we want to lay out our triangle mesh.  We could use either a triangle list, or a triangle strip.  With a triangle list, we need to have an index for <em>each</em> of the corners of <em>each</em> triangle.  Since we have two triangles per grid cell, the total number of indices would be <code>indexCount = 3 * width * height</code>.  Conversely, with a triangle strip, we only need <em>one</em> index for each triangle after the first, which needs three.  So its size would be <code>indexCount = width * height + 2</code>.  This is nearly <em>a third</em> of the size!  So naturally, we&rsquo;d like to use a triangle list.  This is pretty straightforward for a single row:</p>
<p>
<a href="#image-30fb1b82fe3e2a1346ce473fffe89159" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.1.png" alt="Single Row Triangle Strip" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-30fb1b82fe3e2a1346ce473fffe89159">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.1.png" alt="Single Row Triangle Strip" class="lightbox-image" loading="lazy">
</a></p>
<p>The diagram above shows what a row defined as a triangle strip looks like.  Each vertex (the purple circle) is labeled by the order it appears in the indices.  The blue arrows denote the triangle edges defined by successive vertices.  The gray dashed lines denote the side of the triangle inferred from the order of the vertices.  And each triangle is numbered in blue by the order it is defined.</p>
<p>But what about the next row?  You might be tempted to start on the left again, but doing so will result in a triangle that stretches across the breadth of the terrain - which will look terrible!</p>
<p>
<a href="#image-028b98e13f7557164aa99fb10af47acb" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.2.png" alt="Triangle Stretching Across the Row" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-028b98e13f7557164aa99fb10af47acb">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.2.png" alt="Triangle Stretching Across the Row" class="lightbox-image" loading="lazy">
</a></p>
<p>This triangle is outlined in the above diagram by the ochre lines.  Note that in the game they won&rsquo;t be curved - the triangle will just slice through the terrain.</p>
<p>Or, we can try zig-zagging, by going right-to-left with the second row.</p>
<p>
<a href="#image-509526adff61a312d7a0952520c1ebe5" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.3.png" alt="Zig-zagging Triangle Strip" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-509526adff61a312d7a0952520c1ebe5">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.3.png" alt="Zig-zagging Triangle Strip" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice that doing so creates a triangle that stretches along the end of the terrain.  This probably wouldn&rsquo;t be a problem as we probably would obscure the edge of our terrain in the game anyway.  But also notice that the diagonals of each terrain row slant the opposite ways.  This <em>does</em> cause a problem for us, which we&rsquo;ll understand in a bit.</p>
<p>Instead, we&rsquo;ll create <em>two</em> extra triangles between each row.</p>
<p>
<a href="#image-510398afb24d9afc5806295896034259" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.4.png" alt="Our Triangle Strip Layout Strategy" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-510398afb24d9afc5806295896034259">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-3.4.png" alt="Our Triangle Strip Layout Strategy" class="lightbox-image" loading="lazy">
</a></p>
<p>Notice that for the two extra triangles created by this pattern, 6 and 7, two of their vertices are the same.  This means they are actually lines!  And they will be rendered as part of the edge of triangles 5 and 8.  Moreover, all our diagonals are slanting the same direction.</p>
<p>Let&rsquo;s use this pattern as we declare our indices in the helper method <code>InitializeIndices()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Creates the index buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeIndices()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>We need to know how many indices are needed to draw our triangles, and use this value to initialize our index array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The number of triangles in the triangle strip</span>
</span></span><span style="display:flex;"><span>    triangles = (width) * <span style="color:#ae81ff">2</span> * (height - <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>[] terrainIndices = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span>[triangles];</span></span></code></pre></div><p>We&rsquo;ll also need a couple of index variables:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> z = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>Now as we iterate over the terrain, we&rsquo;ll need to reverse the direction each row.  So we&rsquo;ll use <em>two</em> inner loops, one for the row running left, and one for the row running right.  Since we don&rsquo;t know which will be our last row, we&rsquo;ll use the same invariant for both (<code>z &lt; height - 1</code>):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(z &lt; height - <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = <span style="color:#ae81ff">0</span>; x &lt; width; x++)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            terrainIndices[i++] = x + z * width;
</span></span><span style="display:flex;"><span>            terrainIndices[i++] = x + (z + <span style="color:#ae81ff">1</span>) * width;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        z++;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(z &lt; height - <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x = width - <span style="color:#ae81ff">1</span>; x &gt;= <span style="color:#ae81ff">0</span>; x--)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                terrainIndices[i++] = x + (z + <span style="color:#ae81ff">1</span>) * width;
</span></span><span style="display:flex;"><span>                terrainIndices[i++] = x + z * width;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        z++;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Another slight optimization we can perform is determining if we can get away with using 16-bit indices, or if we need 32-bit indices.  This is determined by size of our vertex buffer - we need to be able to hold its largest index:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    IndexElementSize elementSize = (width * height &gt; <span style="color:#66d9ef">short</span>.MaxValue) ? IndexElementSize.ThirtyTwoBits : IndexElementSize.SixteenBits;</span></span></code></pre></div><p>Finally, we can create and populate our index buffer:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    indices = <span style="color:#66d9ef">new</span> IndexBuffer(game.GraphicsDevice, elementSize, terrainIndices.Length, BufferUsage.None);
</span></span><span style="display:flex;"><span>    indices.SetData&lt;<span style="color:#66d9ef">int</span>&gt;(terrainIndices);</span></span></code></pre></div><h3 id="creating-the-effect">Creating the Effect</h3>
<p>We&rsquo;ll also initialize our <code>BasicEffect</code>, turning on texture rendering and setting our texture.  We&rsquo;ll also set our world matrix here.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Initialize the effect used to render the terrain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;world&#34;&gt;The world matrix&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeEffect(Matrix world)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect = <span style="color:#66d9ef">new</span> BasicEffect(game.GraphicsDevice);
</span></span><span style="display:flex;"><span>        effect.World = world;
</span></span><span style="display:flex;"><span>        effect.Texture = grass;
</span></span><span style="display:flex;"><span>        effect.TextureEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }   </span></span></code></pre></div><p>We can skip setting the view and projection matrices, as these will come from our camera supplied to the <code>Draw()</code> method.</p>
<h3 id="the-constructor">The Constructor</h3>
<p>The constructor will invoke each of the initialization helper methods we just wrote:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new Terrain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this Terrain belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;heightmap&#34;&gt;The heightmap used to set heights&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;heightRange&#34;&gt;The difference between the lowest and highest elevation in the terrain&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;world&#34;&gt;The terrain&#39;s position and orientation in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Terrain(Game game, Texture2D heightmap, <span style="color:#66d9ef">float</span> heightRange, Matrix world)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        grass = game.Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;ground_grass_gen_08&#34;</span>);
</span></span><span style="display:flex;"><span>        LoadHeights(heightmap, heightRange);
</span></span><span style="display:flex;"><span>        InitializeVertices();
</span></span><span style="display:flex;"><span>        InitializeIndices();
</span></span><span style="display:flex;"><span>        InitializeEffect(world);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>It also loads the default grass texture.</p>
<h3 id="drawing-the-terrain">Drawing the Terrain</h3>
<p>Finally, we can turn our attention to drawing the terrain, which is done just like our prior examples:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the terrain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;camera&#34;&gt;The camera to use&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(ICamera camera)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        effect.View = camera.View;
</span></span><span style="display:flex;"><span>        effect.Projection = camera.Projection;
</span></span><span style="display:flex;"><span>        effect.CurrentTechnique.Passes[<span style="color:#ae81ff">0</span>].Apply();
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.SetVertexBuffer(vertices);
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.Indices = indices;
</span></span><span style="display:flex;"><span>        game.GraphicsDevice.DrawIndexedPrimitives(PrimitiveType.TriangleStrip, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, triangles);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Next we&rsquo;ll make some changes in our <code>Game</code> class to use our terrain.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="using-the-terrain">Using the Terrain</h1>

<p>Let&rsquo;s see our terrain in action.  First we&rsquo;ll need to make some changes in our <code>Game1</code> class.  We&rsquo;ll add a <code>Terrain</code> field:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The terrain </span>
</span></span><span style="display:flex;"><span>    Terrain terrain;</span></span></code></pre></div><p>In our <code>Game1.LoadContent()</code>, we&rsquo;ll load the heightmap and construct our terrain:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Build the terrain</span>
</span></span><span style="display:flex;"><span>    Texture2D heightmap = Content.Load&lt;Texture2D&gt;(<span style="color:#e6db74">&#34;heightmap&#34;</span>);
</span></span><span style="display:flex;"><span>    terrain = <span style="color:#66d9ef">new</span> Terrain(<span style="color:#66d9ef">this</span>, heightmap, <span style="color:#ae81ff">10f</span>, Matrix.Identity);</span></span></code></pre></div><p>And in our <code>Game1.Draw()</code> we&rsquo;ll render it with the existing camera:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the terrain</span>
</span></span><span style="display:flex;"><span>    terrain.Draw(camera);</span></span></code></pre></div><p>Now if you run the game, you should see your terrain, and even be able to move around it using the camera controls (WASD + Mouse).</p>
<p>
<a href="#image-b3c326ad4d239bb541369d275757b862" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-4.1.png" alt="The rendered terrain" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b3c326ad4d239bb541369d275757b862">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-4.1.png" alt="The rendered terrain" class="lightbox-image" loading="lazy">
</a></p>
<p>You&rsquo;ll probably notice that your camera does not change position as you move over the terrain - in fact, in some parts of the map you can actually end up looking up from underneath!</p>
<p>Clearly we need to do a bit more work.  We need a way to tell the camera what its Y-value should be, based on what part of the terrain it is over.</p>
<h2 id="the-iheightmap-interface">The IHeightMap Interface</h2>
<p>Rather than linking our camera <em>directly</em> to our terrain implementation, let&rsquo;s define an interface that could be used for any surface the player might be walking on.  For lack of a better name, I&rsquo;m calling this interface <code>IHeightMap</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// An interface providing methods for determining the </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// height at a point in a height map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IHeightMap</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Gets the height of the map at the specified position</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;x&#34;&gt;The x coordinate in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;z&#34;&gt;The z coordinate in the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;The height at the specified position&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> GetHeightAt(<span style="color:#66d9ef">float</span> x, <span style="color:#66d9ef">float</span> z);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>The interface defines a single method, <code>GetHeightAt()</code>.  Note that we take the X and Z coordinate - these are <em>world coordinates</em> in the game.  The return value is the Y world coordinate corresponding to the elevation of the terrain at <code>x</code> and <code>z</code>.</p>
<h2 id="refactoring-fpscamera">Refactoring FPSCamera</h2>
<p>We can then use this interface within our <code>FPSCamera</code> class to change its height based on its X and Z.  We&rsquo;ll start by adding a property of type <code>ICamera</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets the heightmap this camera is interacting with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IHeightMap HeightMap { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }</span></span></code></pre></div><p>We also might want to add a property to say how far above any heightmap we want the camera to be.  Let&rsquo;s call this <code>HeightOffset</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets how high above the heightmap the camera should be</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> HeightOffset { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">5</span>;</span></span></code></pre></div><p>And we&rsquo;ll modify our <code>FPSCamera.Update()</code> to use the <code>HeightMap</code> and <code>HeightOffset</code> to determine the camera&rsquo;s Y position:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Adjust camera height to heightmap </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(HeightMap != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        position.Y = HeightMap.GetHeightAt(position.X, position.Z) + HeightOffset;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Notice that we wrap this in a <code>null</code> check.  If there is no heightmap, we want to keep our default behavior.</p>
<h2 id="refactoring-game1">Refactoring Game1</h2>
<p>Since the <code>HeightMap</code> is a property of the <code>FPSCamera</code>, we&rsquo;ll need to set it to our terrain in the <code>Game1.LoadContent()</code> method after both the camera and terrain have been created:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    camera.HeightMap = Terrain;</span></span></code></pre></div><h2 id="refactoring-terrain">Refactoring Terrain</h2>
<p>Now we need to implement the <code>IHeightMap</code> interface in our <code>Terrain</code> class.  Add it to the class definition:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Terrain</span> : IHeightMap {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>And add the method it calls for:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets the height of the terrain at</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// the supplied world coordinates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;x&#34;&gt;The x world coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;z&#34;&gt;The z world coordinate&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> GetHeightAt(<span style="color:#66d9ef">float</span> x, <span style="color:#66d9ef">float</span> z)
</span></span><span style="display:flex;"><span>    {}</span></span></code></pre></div><p>Now, let&rsquo;s talk through the process of finding the height.  As our comments suggest, we&rsquo;re using <em>world</em> coordinates, not <em>model</em> coordinates.  As long as the world matrix remains the identity matrix, these are the same.  But as soon as that changes, the world coordinates no longer line up.  So the first thing we need to do is transform them from world coordinates to model coordinates.</p>
<p>Since multiplying a vector in model coordinates by the world matrix transforms them into world coordinates, the inverse should be true.  Specifically, multiplying world coordinates by the <em>inverse of the world matrix</em> should transform them into model coordinates.</p>
<p>The <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Matrix_Invert_1" target="_blank">Matrix.Invert()</a>
 method can create this inverse matrix:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Matrix inverseWorld = Matrix.Invert(effect.World);</span></span></code></pre></div><p>We&rsquo;ll also need the world coordinates as a <code>Vector3</code> to transform:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Vector3 worldCoordinates = <span style="color:#66d9ef">new</span> Vector3(x, <span style="color:#ae81ff">0</span>, z);</span></span></code></pre></div><p>Here we don&rsquo;t care about the y value, so we&rsquo;ll set it to 0.</p>
<p>Then we can apply the transformation with <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_Vector3_Transform_7" target="_blank">Vector3.Transform()</a>
:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Vector3 modelCoordinates = Vector3.Transform(worldCoordinates, inverseWorld);</span></span></code></pre></div><p>At this point, <code>modelCoordinates.X</code> and <code>modelCoordinates.Z</code> correspond to the x and -y indices of our <code>heights</code> array, respectively.  The y coordinate needs to be inverted, because our terrain was defined along the negative z-axis (as the positive z-axis is towards the screen).  Let&rsquo;s save them in float variables so we don&rsquo;t have to remember to invert the z as our y coordinate:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> tx = modelCoordinates.X;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> ty = -modelCoordinates.Z;</span></span></code></pre></div><p>These <em>should</em> correspond to the x and y indices in the <code>heights</code> array, but it is also possible that they are out-of-bounds.  It&rsquo;s a good idea to check:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (tx &lt; <span style="color:#ae81ff">0</span> || ty &lt; <span style="color:#ae81ff">0</span> || tx &gt;= width || ty &gt;= height) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>If we&rsquo;re out-of-bounds, we&rsquo;ll just return a height of 0.  Otherwise, we&rsquo;ll return the value in our <code>heights</code> array:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty];</span></span></code></pre></div><p>Now try running the game and exploring your terrain.  The camera should now move vertically according to the elevation!</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="interpolating-heights">Interpolating Heights</h1>

<p>While you can now walk over your terrain, you probably notice that the camera seems really jittery.  Why isn&rsquo;t it smooth?</p>
<p>Think about how we render our terrain.  The diagram below shows the terrain in one dimension.  At each integral step, we have a height value.  The terrain (represented by green lines) is interpolated between these heights.</p>
<p>
<a href="#image-83f55a6407ccfc8b3e25160bb1521323" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.1.png" alt="The terrain as rendered" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-83f55a6407ccfc8b3e25160bb1521323">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.1.png" alt="The terrain as rendered" class="lightbox-image" loading="lazy">
</a></p>
<p>Now think about what our function transforming world coordinates to heights is doing.  It casts <code>tx</code> to an <code>int</code> to throw away the fractional part of the coordinate in order to get an array index.  Thus, it is a step-like function, as indicated by the red lines in the diagram below:</p>
<p>
<a href="#image-f94ad3dab772c3fe4b7a8f5f68d509db" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.2.png" alt="The current height function" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-f94ad3dab772c3fe4b7a8f5f68d509db">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.2.png" alt="The current height function" class="lightbox-image" loading="lazy">
</a></p>
<p>No wonder our movement is jerky!</p>
<p>Instead, we need to <em>interpolate</em> the height between the two coordinates, so we match up with the visual representation.</p>
<h2 id="linear-interpolation">Linear Interpolation</h2>
<p>We could use a method like <a href="https://www.monogame.net/documentation/?page=M_Microsoft_Xna_Framework_MathHelper_Lerp" target="_blank">MathHelper.Lerp</a>
 to interpolate between two height values:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> height1 = height[(<span style="color:#66d9ef">int</span>)x]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> height2 = height[(<span style="color:#66d9ef">int</span>)x + <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> fraction = x - (<span style="color:#66d9ef">int</span>)x;
</span></span><span style="display:flex;"><span>    MathHelper.Lerp(fraction, height1, height2);</span></span></code></pre></div><p>What does linear interpolation actually do?  Mathematically it&rsquo;s quite simple:</p>
<ol>
<li>Start with the first value at point A (<code>height1</code>)</li>
<li>Calculate the difference between the value at point A and point B (<code>height2 - height1</code>)</li>
<li>Calculate the fraction of the distance between point A and B that  our point of interest lies (<code>x - floor(x)</code>)</li>
<li>Multiply the difference by the fraction, and add it to the height at point A.</li>
</ol>
<p>If we were to write our own linear interpolation implemenation, it might look like:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Lerp(<span style="color:#66d9ef">float</span> fraction, <span style="color:#66d9ef">float</span> value1, <span style="color:#66d9ef">float</span> value2) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> value1 + fraction * (value2 - value1);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>However, we aren&rsquo;t working with just <em>one</em> dimension, we need to consider <em>two</em>.  In other words, we need to use <em>bilinear interpolation</em>.  But XNA does not define a method for this, so we&rsquo;ll have to do it ourselves.</p>
<h2 id="implementing-bilinear-interpolation">Implementing Bilinear Interpolation</h2>
<p>Bilinear interpolation is the extension of linear interpolation into two dimensions.  Instead of interpolating a point on a line (as is the case with linear interpolation), in bilinear interpolation we are interpolating a point on a <em>plane</em>.  But with our terrain, we have <em>two</em> planes per grid cell:</p>
<p>
<a href="#image-501dfef744d0bdf47b2e5f93eacac056" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.3.png" alt="Terrain triangles" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-501dfef744d0bdf47b2e5f93eacac056">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/heightmap-terrain-5.3.png" alt="Terrain triangles" class="lightbox-image" loading="lazy">
</a></p>
<p>In this diagram, <em>n</em> and <em>m</em> are coordinates in our <code>heights</code> array, corresponding to the vertex making up the grid cell.  So if our <code>(x, y)</code> point is in this grid cell,  <code>n &lt; x &lt; n+1</code> and <code>m &lt; y &lt; m+1</code>.</p>
<p>Remember, a triangle defines a plane, and we used <em>two</em> triangles to define each grid cell in our terrain.  So we need to know which triangle our point falls on.</p>
<p>This is why we wanted our diagonals to both face the same way, and also why we wanted them facing the way they do.  If the fractional distance along either the x or y axis is greater than halfway (0.5 in our model coordinates), then we are on the upper-right triangle. The inverse is also true; if both coordinates are less than halfway, we&rsquo;re in the lower left triangle.  Any coordinate falling on line between the two triangles is shared by both.</p>
<p>Let&rsquo;s return to our <code>Terrain.GetHeightAt()</code> method, and start refactoring it.  First, we&rsquo;ll want to change our out-of-bounds test to be slightly more exclusive, as we&rsquo;ll be getting both the height values at both the lower-left corner (tx, ty) and the upper-right corner (tx + 1, ty + 1):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (tx &lt; <span style="color:#ae81ff">0</span> || ty &lt; <span style="color:#ae81ff">0</span> || tx &gt; width - <span style="color:#ae81ff">2</span> || ty &gt; height - <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>We can then delete the line <code>return heights[(int)tx, (int)ty];</code>, and replace it with our test to determine which triangle we are in:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Determine which triangle our coordinate is in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(tx - (<span style="color:#66d9ef">int</span>)tx &lt; <span style="color:#ae81ff">0.5</span> &amp;&amp; ty - (<span style="color:#66d9ef">int</span>)ty &lt; <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// In the lower-left triangle</span>
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// In the upper-right triangle</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Let&rsquo;s finish the lower-left triangle case first.  We&rsquo;ll start with the height at (tx, ty), and add the amount of change along the x-axis as we approach (tx + 1, ty), and the amount of change along the y-axis as we approach (tx, ty + 1).</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>        <span style="color:#75715e">// In the lower-left triangle</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> xFraction = tx - (<span style="color:#66d9ef">int</span>)tx;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> yFraction = ty - (<span style="color:#66d9ef">int</span>)ty; 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> xDifference = heights[(<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span>, (<span style="color:#66d9ef">int</span>)ty] - heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> yDifference = heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span>] - heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty]
</span></span><span style="display:flex;"><span>            + xFraction * xDifference
</span></span><span style="display:flex;"><span>            + yFraction * yDifference;</span></span></code></pre></div><p>The upper-right triangle is similar, only we&rsquo;ll start with the height at (tx + 1, ty + 1) and subtract the amount of change along the x-axis as we approach (tx, ty + 1), and the amount of change along the y-axis as we approach (tx + 1, ty).</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>        <span style="color:#75715e">// In the upper-right triangle</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> xFraction = (<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span> - tx;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> yFraction = (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span> - ty;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> xDifference = heights[(<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span>, (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span>] - heights[(<span style="color:#66d9ef">int</span>)tx, (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> yDifference = heights[(<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span>, (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span>] - heights[(<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span>, (<span style="color:#66d9ef">int</span>)ty];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> heights[(<span style="color:#66d9ef">int</span>)tx + <span style="color:#ae81ff">1</span>, (<span style="color:#66d9ef">int</span>)ty + <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            - xFraction * xDifference
</span></span><span style="display:flex;"><span>            - yFraction * yDifference;</span></span></code></pre></div><p>Now if you run your code, your camera should smootly glide over the terrain!</p>
<p>This <code>GetHeightAt()</code> method can be used for other purposes as well.  For example, we could scatter instances of the crates we developed previously across the terrain, using it to determine what thier Y-position should be.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>Now you&rsquo;ve seen the basics of creating a terrain from a heightmap.  Armed with this knowledge, you can create an outdoor game world.  You can find or create additional heightmaps to add new terrains to your game.  You can swap the textures to create different kinds of environments as well.</p>
<p>But you could also create an even <em>larger</em> worlds by using multiple terrains and stitching them together at the edges - a technique often called <em>terrain patches</em>.  With enough of them, you could create an infinite world by looping back to a prior terrain. Or you could rotate a terrain sideways to create a rugged cliff face, or upside down to create a cavern roof.</p>
<p>And you could also change out the <code>BasicEffect</code> for a custom effect that could blend textures based on height changes, or provide a detail texture.  You could also light the terrain realistically if you adjusted the surface normals to be perpendicular to the slope at each vertex.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="models">Models</h1>

<p>Rendering Complex 3D Objects</p>
<img src="https://media.giphy.com/media/xUA7aTKxZWcHEnAXoQ/giphy.gif"/>
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Models</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>With some experience building our own triangle meshes, let&rsquo;s turn our attention to those that have been built for us by artists working with modeling software.  These meshes are typically organized into a <em>model</em> - a collection of triangle meshes and transformations that collectively define a complex 3D shape.</p>
<p>Like our earlier examples, we&rsquo;ll start from a starter project with our assets pre-loaded.  In addition, we&rsquo;ll include the <code>ICamera</code> interface and the <code>CirclingCamera</code> we created in the lesson on <a href="https://ksu-cs-textbooks.github.io/cis580/14-lighting-and-cameras/">Lights and Cameras</a>
, and the <code>Terrain</code> class and <code>IHeightMap</code> interface from our exploration of <a href="https://ksu-cs-textbooks.github.io/cis580/15-heightmap-terrain/">Heightmap Terrain</a>
.  It is also preloaded with public-domain content assets, including a heightmap from Wikimedia and a ground texture from arikel&rsquo;s on OpenGameArt&rsquo;s [Seamless Textures]https://opengameart.org/content/seamless-textures).</p>
<p>You can find the starter project here: <a href="https://github.com/ksu-cis/model-starter" target="_blank">https://github.com/ksu-cis/model-starter</a>
.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="model-basics">Model Basics</h1>

<p>A <em>model</em> is a collection of the information that defines a 3D object. Rather than being hand-created or hard-coded (as we have done in our previous work), a model is usually created using 3D modeling software (i.e. Blender, 3D Studio, Maya, etc).  Instead of exposing the raw data of the meshes, these software packages provide an abstraction, often based on real-world sculpting techniques or constructive geometry transformations that assist artists in creating complex three-dimensional shapes.</p>
<p>As programmers, our interaction with models typically begins with the data exported from one of these programs as a file.  In our starter project&rsquo;s <em>Content</em> folder, we have one of these files, <em>tank.fbx</em>.  This particular format is text-based (not binary), so you can open it up in a text editor and look at its contents.  There are 3388 lines in the file - definitely more than we want to write.</p>
<p>There are many possible file formats for storing models, and each may include different information in different ways.  However, most will contain:</p>
<ol>
<li>A collection of meshes, defining the different parts of a model.  These meshes are typically laid out as triangle lists with vertex and index data</li>
<li>A collection of textures, which are applied to the meshes.  The textures may be embedded within the file, or be externally referenced (for our example, they are externally referenced).</li>
<li>A collection of &ldquo;bones&rdquo; - transformation matrices which place the different model meshes relative to one another.  Each bone also has a parent bone, allowing you to create hierarchical relationships between the meshes.</li>
<li>Material information used to render the meshes (i.e. data for Phong shading, or sometimes complete shaders)</li>
</ol>
<p>In addition, model files may contain alternative meshes to swap in and out (like different armors for a fantasy knight), and animations.</p>
<h2 id="loading-a-model">Loading a Model</h2>
<p>The XNA Framework provides a <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_Model" target="_blank">Model</a>
 class that is an relatively basic implementation of the main features we just discussed (it captures points 1-4, but no animation data).  As with most content files, it is instantiated through the content pipeline using the <a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Content_Pipeline_FbxImporter.html" target="_blank">FBXImporter</a>
 and <a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Content_Pipeline_Processors_ModelProcessor.html" target="_blank">ModelProcessor</a>
.</p>
<p>Unfortunately, the only file format directly supported by the core XNA Framework is the <a href="https://www.autodesk.com/products/fbx/overview" target="_blank">Autodesk FBX exchange format</a>
, and only the a handful of <em>specific versions</em> that were in existance when XNA was first created.  This is not to say that you cannot write custom importers and/or processors to handle other file formats, but the FBX format remains the only one supported by the core MonoGame install.</p>
<p>Let&rsquo;s try loading a model in our example game.  We&rsquo;ll need to add a <code>Model</code> field to our <code>Game1</code> class:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// A class representing our tank model</span>
</span></span><span style="display:flex;"><span>    Model tank;</span></span></code></pre></div><p>Load the model in our <code>Game1.LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the tank</span>
</span></span><span style="display:flex;"><span>    tank = Content.Load&lt;Model&gt;(<span style="color:#e6db74">&#34;tank&#34;</span>);</span></span></code></pre></div><p>And render it in our <code>Game1.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the tank</span>
</span></span><span style="display:flex;"><span>    tank.Draw(Matrix.Identity, camera.View, camera.Projection);</span></span></code></pre></div><p>Note we need to provide a world, view, and projection matrix to the model to draw it.</p>
<p>If we run the game now, you should see the tank on (actually a bit <em>in</em>) the terrain:</p>
<p>
<a href="#image-b5252e89c2e076a88ef91956a70e2ada" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-2.1.png" alt="The Rendered Model" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-b5252e89c2e076a88ef91956a70e2ada">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-2.1.png" alt="The Rendered Model" class="lightbox-image" loading="lazy">
</a></p>
<p>But, that is about the extent of the functionality offered to us by the <code>Model</code> class.  Much like the <code>Texture2D</code>, it is simply providing us with the data from a content file in a more manageable format.  But as with the <code>Texture2D</code>, we will only use that as a starting point for doing some really interesting things.</p>
<p>Let&rsquo;s start that exploration by defining our own class to use this model.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="tank-class">Tank Class</h1>

<p>Instead of using the <code>Model</code> class directly, let&rsquo;s wrap it in our own custom class, <code>Tank</code>.  As with many of our classes, let&rsquo;s hold onto a <code>Game</code> reference.  In addition, let&rsquo;s have a reference to the <code>Model</code> of the tank, and its position and orentation in the world:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// A class representing a tank in the game</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tank</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The game this tank belongs to </span>
</span></span><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The tank&#39;s model</span>
</span></span><span style="display:flex;"><span>    Model model;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The tank&#39;s position in the world </span>
</span></span><span style="display:flex;"><span>    Vector3 position = Vector3.Zero;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The direction the tank is facing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> facing = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>We set the initial position to (0,0,0) and facing to 0.  Alternatively, we could pass the intial values for these fields through the constructor.</p>
<h2 id="properties">Properties</h2>
<p>As the last comments suggests, we&rsquo;re going to allow our tank to move through the world.  We might add a <code>Speed</code> property so our game can control how fast it moves:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets the speed of the tank</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Speed { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; } = <span style="color:#ae81ff">0.1f</span>;</span></span></code></pre></div><h2 id="constructor">Constructor</h2>
<p>Constructing the tank is rather simple - just saving the <code>Game</code> instance and loading the model:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Constructs a new Tank instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this tank belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Tank(Game game)
</span></span><span style="display:flex;"><span>    {   
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        model = game.Content.Load&lt;Model&gt;(<span style="color:#e6db74">&#34;tank&#34;</span>);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="update-method">Update Method</h2>
<p>In our update, let&rsquo;s control our movement with the WASD keys.  Let&rsquo;s also assume the tank has a zero turning radius, so it can effectively spin in place.  Accordingly, we&rsquo;ll handle rotation and forward/backward movement separately.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the tank, moving it based on player input</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The current GameTime&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> keyboard = Keyboard.GetState();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Forward/Backward Movement </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO: Rotation Movement</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="forwardbackward-movement">Forward/Backward Movement</h3>
<p>Before we can move forward or backward, we first need to determine just what direction that is.  An easy way to do so is to rotate a unit vector facing forward by the facing angle:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> direction = Vector3.Transform(Vector3.Forward, Matrix.CreateRotationY(facing));</span></span></code></pre></div><p>We can then subtract this facing vector, multiplied by our speed, to the tank&rsquo;s position when it is moving forward:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.W))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        position -= Speed * direction;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>And add it when we&rsquo;re moving backward:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (keyboard.IsKeyDown(Keys.S))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        position += Speed * direction;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h3 id="rotational-movement">Rotational Movement</h3>
<p>Rotation is even more straightforward; we&rsquo;ll just add or subtract the speed from the <code>facing</code> angle, depending on which key is pressed:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.A))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        facing += Speed;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.D))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        facing -= Speed;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="drawing-the-tank">Drawing the Tank</h2>
<p>For now, we&rsquo;ll stick with using the <code>Model.Draw()</code> method.  We&rsquo;ll need to supply it with the <code>View</code> and <code>Projection</code> matrices from our camera, and the <code>World</code> matrix will be determined by the <code>facing</code> angle and <code>position</code> vector:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Draws the tank in the world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;camera&#34;&gt;The camera used to render the world&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Draw(ICamera camera)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Matrix world = Matrix.CreateRotationY(facing) * Matrix.CreateTranslation(position);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Matrix view = camera.View;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Matrix projection = camera.Projection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model.Draw(world, view, projection);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><h2 id="refactoring-game1">Refactoring Game1</h2>
<p>Of course, to see our tank in action, we&rsquo;ll need to refactor <code>Game</code> to use it.  Change the <code>tank</code> field to have type <code>Tank</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// A class representing our tank model</span>
</span></span><span style="display:flex;"><span>    Tank tank;</span></span></code></pre></div><p>Swap <code>Content.Load&lt;Model&gt;(&quot;tank&quot;)</code> for our constructor in the <code>Game1.LoadContent()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the tank</span>
</span></span><span style="display:flex;"><span>    tank = <span style="color:#66d9ef">new</span> Tank(<span style="color:#66d9ef">this</span>);</span></span></code></pre></div><p>We&rsquo;ll need to add a call to <code>Tank.Update()</code> in our <code>Game1.Update()</code> method to process user input:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the tank</span>
</span></span><span style="display:flex;"><span>    tank.Update(gameTime);</span></span></code></pre></div><p>And switch the arguments to <code>Tank.Draw()</code> in our <code>Game1.Draw()</code> method to the camera:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Draw the tank</span>
</span></span><span style="display:flex;"><span>    tank.Draw(Matrix.Identity, camera.View, camera.Projection);</span></span></code></pre></div><p>If you run the game now, you should be able to drive your tank through the terrain.  Quite literally <em>through</em>.</p>
<h2 id="getting-on-top-of-the-terrain">Getting on Top of the Terrain</h2>
<p>Rather than have our tank plow through the ground unrelistically, let&rsquo;s get it to set on top of the terrain.  To do so, we&rsquo;ll need to have access to the terrain from within our <code>Tank</code> class.  Let&rsquo;s add a <code>HeightMap</code> property to it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Gets or sets the IHeightMap this tank is driving upon</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IHeightMap HeightMap { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }</span></span></code></pre></div><p>We can then use the <code>IHeightMap.GetHeightAt()</code> method in our <code>Tank.Update()</code> to set the tank to the height of the terrain where it is currently at:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the tank&#39;s height based on the HeightMap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (HeightMap != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        position.Y = HeightMap.GetHeightAt(position.X, position.Z);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Of course, we don&rsquo;t want to do this if the <code>HeightMap</code> property hasn&rsquo;t been set.</p>
<h2 id="refactoring-game1cs">Refactoring Game1.cs</h2>
<p>That setting is accomplished in <code>Game1.LoadContent</code>, after we&rsquo;ve created both the tank and the terrain:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    tank.HeightMap = terrain;</span></span></code></pre></div><p>Now if you run the game, the tank rises and falls with the land it travels over:</p>
<p>
<a href="#image-39e052a3875523bd31620a9643ba5b03" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-3.1.png" alt="The Tank, No Longer Stuck in the Terrain" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-39e052a3875523bd31620a9643ba5b03">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-3.1.png" alt="The Tank, No Longer Stuck in the Terrain" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="skeletal-animation">Skeletal Animation</h1>

<p>Now that we can see our tank clearly, let&rsquo;s see if we can&rsquo;t get that turret to aim. Doing so requires us to explore the concept of <em>skeletal animation</em>.  If you remember in our discussion of models, we said most models include both triangle meshes and <em>bones</em>.  These &ldquo;bones&rdquo; are really just transformation matrices, which are applied to a specific mesh in the model.  Often they also are arranged in a hierarchy, often referred to as a skeleton.  The transformations represented by bones earlier in the hierarchy are concatenated with those lower to compute a final transformation to apply to that mesh.</p>
<p>In our tank, the turret bone is a child of the tank body.  Thus, the turret is transformed by <em>both</em> by the bone of the tank body <em>and</em> the bone of the turret.  Thus, if the tank body moves through the world, the turret comes along for the ride.  Without using this hierarchical approach, we would have to calculate the turret transform based on where the tank currently is, a more challenging proposition.</p>
<h2 id="exposing-the-tanks-transformations">Exposing The Tank&rsquo;s Transformations</h2>
<p>To take advantage of skeletal animation, we&rsquo;ll need to manage the transformations ourselves.  We&rsquo;ll start by declaring an array in the <code>Tank</code> class to hold them:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The bone transformation matrices of the tank</span>
</span></span><span style="display:flex;"><span>    Matrix[] transforms;</span></span></code></pre></div><p>We&rsquo;ll initialize this array in our constructor, after we&rsquo;ve loaded the model:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    transforms = <span style="color:#66d9ef">new</span> Matrix[model.Bones.Count];</span></span></code></pre></div><p>And in our <code>Tank.Draw()</code> method, we&rsquo;ll apply the model&rsquo;s transforms.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    model.CopyAbsoluteBoneTransformsTo(transforms);</span></span></code></pre></div><p>This method walks down the skeleton, concatenating the parent transforms with those of the children bones.  Thus, the transformation matrices in the <code>transforms</code> array after this point are the final transformation that will be applied to the mesh in question.</p>
<p>Then, instead of simply invoking <code>model.draw()</code>, we&rsquo;ll iterate over each mesh, applying its bone transform manually:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// draw the tank meshes </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(ModelMesh mesh <span style="color:#66d9ef">in</span> model.Meshes)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span>(BasicEffect effect <span style="color:#66d9ef">in</span> mesh.Effects)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            effect.EnableDefaultLighting();
</span></span><span style="display:flex;"><span>            effect.World = bones[mesh.ParentBone.Index] * world;
</span></span><span style="display:flex;"><span>            effect.View = camera.View;
</span></span><span style="display:flex;"><span>            effect.Projection = camera.Projection;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        mesh.Draw();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>At this point, our tank will appear exactly as it did before.  These nested loops are pretty much exactly the code that was invoked by <code>model.draw()</code>.  But the default <code>model.draw()</code> does not perform the absolute bone transformation - instead it uses precalculated defaults.  Thus, we must implement this double-loop if we want to use skeletal animation.</p>
<h2 id="rotating-the-turret">Rotating the Turret</h2>
<p>We can rotate the turret by applying a transformation to the bone corresponding to its mesh. This requires us to add some fields to our <code>Tank</code> class.  First, a reference to the bone we want to transform:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The turret bone </span>
</span></span><span style="display:flex;"><span>    ModelBone turretBone;</span></span></code></pre></div><p>We also need to know its original transformation, so let&rsquo;s create a matrix to store that:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The original turret transformation</span>
</span></span><span style="display:flex;"><span>    Matrix turretTransform;</span></span></code></pre></div><p>And we&rsquo;ll also create an angle field to track the turret rotation:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The rotation angle of the turret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> turretRotation = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>We still need to know the bone we want to transform.  If we look through the <em>tank.fbx</em> file, we can find it is named &ldquo;turret_geo&rdquo;.  The <a href="https://www.monogame.net/documentation/?page=P_Microsoft_Xna_Framework_Graphics_Model_Bones" target="_blank">model.Bones</a>
 property can be accessed with either an index, or a key string (like a dictionary).</p>
<p>Thus, after the model is loaded in the constructor we can get a reference to our bone from its name, and from that bone get its original transformation:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the turret fields</span>
</span></span><span style="display:flex;"><span>    turretBone = model.Bones[<span style="color:#e6db74">&#34;turret_geo&#34;</span>];
</span></span><span style="display:flex;"><span>    turretTransform = turretBone.Transform;</span></span></code></pre></div><p>Then in our <code>Tank.Update()</code>, let&rsquo;s use the left and right arrow keys to rotate the turret.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// rotate the turret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Left))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        turretRotation -= Speed;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Right))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        turretRotation += Speed;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Now in the <code>Tank.Draw()</code> method, we need to set the <code>turretBone.Transform</code> to include our rotation:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// apply turret rotation</span>
</span></span><span style="display:flex;"><span>    turretBone.Transform = Matrix.CreateRotationY(turretRotation) * turretTransform;</span></span></code></pre></div><p>Now if you run the game, you should be able to rotate the turret left and right with the arrow keys!</p>
<h2 id="tilting-the-canon">Tilting the Canon</h2>
<p>We can allow the player to tilt the canon barrel using the up and down keys in much the same fashion.  We&rsquo;ll start by adding corresponding fields to the <code>Tank</code> class: an angle of rotation, the canon bone, and default canon transform:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Barrel fields </span>
</span></span><span style="display:flex;"><span>    ModelBone canonBone;
</span></span><span style="display:flex;"><span>    Matrix canonTransform;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> canonRotation = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div><p>And we can populate these in the constructor, once the model is loaded:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the canon fields</span>
</span></span><span style="display:flex;"><span>    canonBone = model.Bones[<span style="color:#e6db74">&#34;canon_geo&#34;</span>];
</span></span><span style="display:flex;"><span>    canonTransform = canonBone.Transform;</span></span></code></pre></div><p>In our <code>Tank.Update()</code>, we can increase or decrease the rotation much like we did with the turret:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the canon angle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Up))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        canonRotation -= Speed;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Down))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        canonRotation += Speed;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>However, we probably don&rsquo;t want an unlimited amount of rotation - or the cannon will rotate right through the turret and tank body!  So let&rsquo;s clamp the final value to a reasonable limit:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Limit canon rotation to a reasonable range </span>
</span></span><span style="display:flex;"><span>    canonRotation = MathHelper.Clamp(canonRotation, -MathHelper.PiOver4, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div><p>Finally, we can add the canon rotation to the <code>Tank.Draw()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    canonBone.Transform = Matrix.CreateRotationX(canonRotation) * canonTransform;</span></span></code></pre></div><p>Now you can drive around the terrain, aiming your cannon wherever you like!</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="chase-camera">Chase Camera</h1>

<p>At this point, we have a pretty impressive tank, but it can be kind of difficult to see.  Let&rsquo;s implement a new kind of camera, which will stay close to the tank, and follow as it moves.  Of course, to do so, we need to know where the tank is.</p>
<h2 id="the-ifollowable-interface">The IFollowable Interface</h2>
<p>Let&rsquo;s create an interface to declare the properties we would need to be able to follow an arbitrary game object - basically, its position in the world, and the direction it is facing:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IFollowable</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The IFollowable&#39;s position in the world </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    Vector3 Position { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The angle the IFollowable is facing, in radians </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> Facing { <span style="color:#66d9ef">get</span>; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>By creating this interface, we can have our camera follow not just the tank, but any class that implements the interface.</p>
<h2 id="refactoring-the-tank">Refactoring the Tank</h2>
<p>We&rsquo;ll need to make our tank implement this interface:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tank</span> : IFollowable 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...</span></span></code></pre></div><p>And add the properties it requires.  This boils down to just exposing existing private fields with a getter:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The position of the tank in the world </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector3 Position =&gt; position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The angle the tank is facing (in radians)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> Facing =&gt; facing;</span></span></code></pre></div><p>Now our tank is ready to be followed.  Let&rsquo;s define our camera next.</p>
<h2 id="the-chasecamera-class">The ChaseCamera Class</h2>
<p>Our <code>ChaseCamera</code> needs to implement the <code>ICamera</code> interface:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// A camera that chases an IFollowable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChaseCamera</span> : ICamera
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>For fields, we&rsquo;ll keep an instance of the <code>Game</code> we belong to, as well as private backing variables for the projection and view matrices:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    Game game;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Matrix projection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Matrix view;</span></span></code></pre></div><p>And for properties, we&rsquo;ll need to implement the <code>View</code> and <code>Projection</code> properties of the <code>ICamera</code> interface.  Plus, we&rsquo;ll add a property for our <code>IFollowable</code> and an offset vector defining where the camera should be in relation to its target.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The target this camera should follow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IFollowable Target { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The positon of the camera in relation to its target</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Vector3 Offset { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The camera&#39;s view matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix View =&gt; view;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// The camera&#39;s projection matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Matrix Projection =&gt; projection;</span></span></code></pre></div><p>For the constructor, we&rsquo;ll initialize the game and offset vector, as well as our matricies:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Creates a new ChaseCamera</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;game&#34;&gt;The game this camera belongs to&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;offset&#34;&gt;The offset the camera should maintian from its target&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ChaseCamera(Game game, Vector3 offset)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.game = game;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.Offset = offset;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.projection = Matrix.CreatePerspectiveFieldOfView(
</span></span><span style="display:flex;"><span>            MathHelper.PiOver4,
</span></span><span style="display:flex;"><span>            game.GraphicsDevice.Viewport.AspectRatio,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.view = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            Vector3.Zero,
</span></span><span style="display:flex;"><span>            offset,
</span></span><span style="display:flex;"><span>            Vector3.Up
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>Finally, we&rsquo;ll need an <code>Update()</code> method to move the camera into position each frame:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// Updates the camera, placing it relative to the target</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;gameTime&#34;&gt;The GameTime&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Update(GameTime gameTime)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Target == <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// calculate the position of the camera</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> position = Target.Position + Vector3.Transform(Offset, Matrix.CreateRotationY(Target.Facing));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.view = Matrix.CreateLookAt(
</span></span><span style="display:flex;"><span>            position,
</span></span><span style="display:flex;"><span>            Target.Position,
</span></span><span style="display:flex;"><span>            Vector3.Up
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p>If we have no target, there&rsquo;s no need to move the camera.  But if there is, we calculate the camera by rotating the offset vector by the target&rsquo;s facing, and adding it to the target&rsquo;s position.  We then create our LookAt matrix.</p>
<h2 id="refactoring-the-game-class">Refactoring the Game Class</h2>
<p>To use the new camera implementation, change the <code>CirclingCamera camera</code> property to a <code>ChaseCamera</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The camera </span>
</span></span><span style="display:flex;"><span>    ChaseCamera camera;</span></span></code></pre></div><p>And swap the camera constructor in <code>Game1.LoadContent()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Create the camera</span>
</span></span><span style="display:flex;"><span>    camera = <span style="color:#66d9ef">new</span> ChaseCamera(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> Vector3(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, -<span style="color:#ae81ff">30</span>));</span></span></code></pre></div><p>In the same method, after both the camera and tank have been created, set the tank as the camera&rsquo;s target:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    camera.Target = tank;</span></span></code></pre></div><p>The rest of the existing camera code (in the <code>Update()</code> and <code>Draw()</code> methods) doesn&rsquo;t need changed.</p>
<p>If you run the game now, you should see the backside of your tank:</p>
<p>
<a href="#image-601bb796d0725f78b19ef31000175ae2" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-6.1.png" alt="The ChaseCamera in Action" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-601bb796d0725f78b19ef31000175ae2">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/models-6.1.png" alt="The ChaseCamera in Action" class="lightbox-image" loading="lazy">
</a></p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>Now that you have a closer view of your tank, you might want to make the individual wheels rotate.  I&rsquo;ll leave that as an exercise for the reader, but the bones you&rsquo;d be interested in are &ldquo;r_back_wheel_geo&rdquo;, &ldquo;l_back_wheel_geo&rdquo;, &ldquo;r_front_wheel_geo&rdquo;, and &ldquo;l_front_wheel_geo&rdquo;.  The front wheels are also set up to be rotated, using the &ldquo;r_steer_geo&rdquo; and &ldquo;l_steer_geo&rdquo; bones.</p>
<p>Clearly there is a lot more you could do just with the tank model.  You can also &ldquo;reskin&rdquo; the tank by swapping out the texture it is using.  You could add particle systems to each of those exhaust pipes on the rear of the tank.  And, you could use the transformation matrix for the cannon to transform a forward vector into a projectile trajectory, to fire shells into the distance.</p>
<p>More importantly, you&rsquo;ve seen the basics of how a model is loaded and used in XNA.  While the current importer is limited, you could also write your own custom importer for other 3D model formats.  As long as it is organized similarly, you could use the existing <code>ModelContent</code> as the target of your importer, and the existing <code>ModelProcessor</code> to convert the loaded data into an xnb file to be loaded as a <code>Model</code>.  Or you could also develop your own model processor and possibly class as well.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="simple-games">Simple Games</h1>

<p>A good starting point</p>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Simple Games</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>As you start your game development journey, you may find yourself wondering &ldquo;What kinds of games can I build, especially in only a week or two?&rdquo;  The answer is, <em>lots</em>.  But if you are having trouble visualizing the possibilities, here are some examples demonstrating what is feasible in a short amount of time.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="snake">Snake</h1>

<iframe src="https://snake.googlemaps.com/" width=400 height=400 style="float: left; margin: 1rem;"></iframe>
<p>Consider the classic game &ldquo;Snake&rdquo;, which has been ported to the first cellular phones, graphing calculators, and even adapted for Google Maps in this project.  While very simple in implementation, it remains an enjoyable game to play.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="flappy-bird">Flappy Bird</h1>

<iframe src="https://flappybird.io/" width=400 height=950 style="float: left; margin: 1rem;"></iframe>
<p>The addictive and oft-copied flappy bird game consists of few elements - a scrolling background, an animated sprite, and obstacles that scroll across the screen, creating the impression of an infinitely large world.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="one-tap-quest">One-Tap Quest</h1>

<iframe src="http://shimage.net/one-tap-quest/" width=400 height=500 style="float: left; margin: 1rem;"></iframe>
<p>A masterful exploration of minimalist interaction, One-Tap-Quest uses a single click as the input to start the player on their path to victory or failure.  The game uses static backgrounds, and a limited number of enemies and power-ups.  Variety and replayability is provided entirely by random spawn locations.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="game-math">Game Math</h1>

<p>What, you didn&rsquo;t think games did math?</p>
<img src="https://media.giphy.com/media/HBWbIuHvXI2Eo/giphy.gif">
            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Game Math</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Math plays a very large role in computer games, as math is used both in the process of simulating game worlds (i.e. to calculate game physics) <em>and</em> in the rendering of the same (i.e. to represent and rasterize 3D objects).  Algebra and trigonometry play a vital role in nearly every game&rsquo;s logic.  However, <em>vectors</em>, <em>matricies</em>, and <em>quaternions</em> play an especially important role in hardware-accelerated 3D rendering.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="coordinate-systems">Coordinate Systems</h1>

<p>Computer games almost universally take place in a simulated 2D or 3D world.  We use <em>coordinate systems</em> to represent the position of various objects within these worlds.  Perhaps the simplest coordinate system is one you encountered in elementary school - the <em>number line</em>:</p>
<p>
<a href="#image-29826a462d483dea2dbe7c2855caf1c5" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.1.png" alt="Number Line" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-29826a462d483dea2dbe7c2855caf1c5">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.1.png" alt="Number Line" class="lightbox-image" loading="lazy">
</a></p>
<p>The number line represents a 1-dimensional coordinate system - its coordinates are a single value that range from $-\infty$ to $\infty$.  We normally express this as a single number.  Adding a second number line running perpendicular to the first gives us a 2-dimensional coordinate system.  The coordinate system you are probably most familiar with is the planar Cartesian Coordinate System:</p>
<p>
<a href="#image-3bfa2e53f546b96fe83e3f84368d9196" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.2.png" alt="Planar Cartesian Coordinates" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-3bfa2e53f546b96fe83e3f84368d9196">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.2.png" alt="Planar Cartesian Coordinates" class="lightbox-image" loading="lazy">
</a></p>
<p>While 2D games sometimes use this coordinate system, most instead adopt the <em>screen coordinate system</em>.  It labels its axes X and Y as does the Cartesian Coordinate System, but the Y-axis increases in the <em>downwards</em> direction.  This arrangement derives from the analog video signals sent to Cathode Ray Tube computer monitors (which were adapted from the earlier television technology), and this legacy has lived on in modern computer monitors.</p>
<p>Points in both coordinate systems are represented by two values, an x-coordinate (distance along the x-axis), and a y-coordinate (distance along the y-axis).  These are usually expressed as a tuple: $(x, y)$.  MonoGame provides the <code>Point</code> struct to represent this, however we more commonly use a <code>Vector2</code> as it can embody the same information but has additional, desirable mathematical properties.</p>
<p>For three dimensions, we add a third axis, the z-axis, perpendicular to both the x-axis and y-axis.  In Cartesian coordinates, the z-axis is typically drawn as being vertical.  However, the two most common 3D rendering hardware libraries (DirectX and OpenGL), have the x-axis horizontal, the y-axis vertical, and the z-axis coming out of or into the screen.  These two approaches are often referred to as <em>left-hand</em> or <em>right-hand</em> coordinate systems, as when you curl the fingers of your right hand from the x-axis to the y-axis, your thumb will point in the direction of the z-axis:</p>
<p>
<a href="#image-7bbb609864b6dd7ee15024ab060b7d5d" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.3.png" alt="Left and Right-hand coordinate systems" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7bbb609864b6dd7ee15024ab060b7d5d">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.2.3.png" alt="Left and Right-hand coordinate systems" class="lightbox-image" loading="lazy">
</a></p>
<p>DirectX adopted the left-hand coordinate system, while OpenGL adopted the right-hand system.  There are some implications for this choice involved in matrix math, which we will discuss later, and for importing 3D models.  A 3D model drawn for a left-hand system will have its z-coordinates reflected when drawn in a right-hand system.  This can be reversed by scaling the model by $-1$ in the z-axis.  When importing models through the content pipeline, this transformation can be specified so that the imported model is already reversed.</p>
<p>Coordinates in a 3D system can be represented as a tuple of three coordinates along each of the axes: $(x, y, z)$.  However, video games universally represent coordinates in 3d space with vectors; MonoGame provides the <code>Vector3</code> for this purpose.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="trigonometry">Trigonometry</h1>

<p>Trigonometry - the math that deals with the side lengths and angles of triangles, plays an important role in many games.  The trigonometric functions Sine, Cosine, and Tangent relate to the ratios of sides in a right triangle:</p>
<p>
<a href="#image-c480c1d0eb4ccf3b2762f270fb84f1fd" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.3.2.png" alt="The trigonometry triangle" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-c480c1d0eb4ccf3b2762f270fb84f1fd">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.3.2.png" alt="The trigonometry triangle" class="lightbox-image" loading="lazy">
</a></p>
<p>$$
\sin{A} = \frac{opposite}{hypotenuse} = \frac{a}{c} \tag{0}
$$</p>
<p>$$
\cos{A} = \frac{adjacent}{hypotenuse} = \frac{b}{c} \tag{1}
$$</p>
<p>$$
\tan{A} = \frac{opposite}{adjacent} = \frac{a}{b} \tag{2}
$$</p>
<p>You can use the <code>System.MathF</code> library to compute $\sin$, $\cos$ using <code>float</code> values:</p>
<ul>
<li><code>MathF.Sin(float radians)</code> computes the $\sin$ of the supplied angle</li>
<li><code>MathF.Cos(float radians)</code> computes the $\cos$ of the supplied angle</li>
<li><code>MathF.Tan(float radians)</code> computes the $\tan$ of the supplied angle</li>
</ul>
<p>You can inverse these operations (compute the angle whose $\sin$, $\cos$, or $\tan$ matches what you supply) with:</p>
<ul>
<li><code>MathF.Asin(float s)</code> computes the angle which produces the supplied $\sin$ value</li>
<li><code>MathF.Acos(float c)</code> computes the angle which produces the supplied $\cos$ value</li>
<li><code>MathF.Atan(float t)</code> computes the angle which produces the supplied $\tan$ value</li>
<li><code>MathF.Atan2(float x, float y)</code> computes the angle with produces the supplied x/y ratio.  This form can be helpful to avoid a division by 0 error if <code>y</code> is 0.</li>
</ul>
<p>These angles are measured in <em>radians</em> - fractions of $\pi$. Positive angles rotate counter-clockwise and negative ones clockwise. It can be helpful to consider radians in relation to the unit circle - a circle with radius 1 centered on the origin:</p>
<p>
<a href="#image-7284695b95441ec3fbee618b0dddfed3" class="lightbox-link">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.3.1.png" alt="The unit circle" style="height: auto; width: auto;" loading="lazy">
</a>
<a href="javascript:history.back();" class="lightbox" id="image-7284695b95441ec3fbee618b0dddfed3">
<img src="https://ksu-cs-textbooks.github.io/cis580/images/b.3.1.png" alt="The unit circle" class="lightbox-image" loading="lazy">
</a></p>
<p>The angle of $0$ radians falls along the x-axis. MonoGame provides some helpful <code>float</code> constants for common measurements in radians:</p>
<ul>
<li><code>MathHelper.TwoPi</code> represents $2\pi$, a full rotation around the unit circle ($360^{\circ}$).</li>
<li><code>MathHelper.Pi</code> represents $\pi$, a half-rotation around the unit circle ($180^{\circ}$).</li>
<li><code>MathHelper.PiOver2</code> represents $\frac{\pi}{2}$, a quarter rotation around the unit circle ($90^{\circ}$).</li>
<li><code>MathHelper.PiOver4</code> represents $\frac{\pi}{4}$, an eighth rotation around the unit circle ($45^{\circ}$).</li>
</ul>
<p>Inside the unit circle you can inscribe a right triangle with angle at the origin of $\theta$.  This triangle has a hypotenuse with length 1, so $\sin{\theta}$ is the length of the opposite leg of the triangle, and $\cos{\theta}$ is the length of the adjacent leg of the triangle.  Of course $\tan{\theta}$ will always equal $1$.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="vectors">Vectors</h1>

<p>Games almost universally use vectors to represent coordinates rather than points, as these have additional mathematical properties which can be very helpful.  In mathematical notation, vectors are expressed similar to points, but use angle brackets, i.e.: $&lt;x, y&gt;$ and $&lt;x, y, z&gt;$ for two- and three-element vectors.  A vector represents both direction <em>and</em> magnitude, and relates to the trigonometric right triangle.  Consider the case of a two-element vector - the vector <em>is the hypotenuse</em> of a right triangle with adjacent leg formed by its X component and opposite leg formed by its Y component.  A three-element vector repeats this relationship in three dimensions.</p>
<p>MonoGame provides structs to represent 2-, 3-, and 4- element vectors:</p>
<ul>
<li><code>Vector2</code> - two-element vectors, often used to represent coordinates in 2d space</li>
<li><code>Vector3</code> - three-element vectors, often used to represent coordinates in 3d space</li>
<li><code>Vector4</code> - four-element vectors, used for affine transformations (more on this soon)</li>
</ul>
<h3 id="magnitude">Magnitude</h3>
<p>The magnitude is the length of the vector.  In XNA it can be computed using <code>Vector2.Length()</code> or <code>Vector3.Length()</code>, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 a = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> length = a.Length();</span></span></code></pre></div><p>This is calculated using the distance formula:</p>
<p>$$|\overline{v}| = \squareroot{(x_0 - x_1)^2 + (y_0 - y1)^2} \tag{0}$$
$$|\overline{v}| = \squareroot{(x_0 - x_1)^2 + (y_0 - y1)^2 + (z_0 - z_1)^2} \tag{1}$$</p>
<p>In some instances, we may be able to compare the square of the distance, and avoid the computation of a square root.  For these cases, the vector classes also define a <code>LengthSquared()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 a = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> lengthSquared = a.LengthSquared();</span></span></code></pre></div><h4 id="normalization">Normalization</h4>
<p>In some cases, it can be useful to normalize (convert into a unit vector, i.e. one of length 1, preserving the side ratios) a vector.  This can be done with <code>Vector2.Normalize()</code> or <code>Vector3.Normalize()</code>.  When invoked on a vector object, it turns the current vector into its normalized form:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 a = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>a.Normalize(); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Now a is a normal vector &lt;0.5, 0.5&gt;</span></span></span></code></pre></div><p>Alternatively, you can use the static version to return a new vector computed from the supplied one:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Vector2 a = <span style="color:#66d9ef">new</span> Vector2(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>b = Vector2.Normalize(); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Vector a is still &lt;10, 10&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Vector b is a normal vector &lt;0.5, 0.5&gt;</span></span></span></code></pre></div><p>Mathematically, normalization is accomplished by</p>
<h4 id="addition">Addition</h4>
<h4 id="subtraction">Subtraction</h4>
<h4 id="multiplication">Multiplication</h4>
<h4 id="division">Division</h4>
<h4 id="barycentric">Barycentric</h4>
<h4 id="linear-interpolation">Linear Interpolation</h4>
<h4 id="reflection">Reflection</h4>
<h4 id="transformation">Transformation</h4>

            <footer class="footline">

            </footer>
          </article>

    
    
    
    
    
    
    
    
    
    
          </section>
          </section>

        </div>
      </main>
    
<div class="git-footer">
<p class="theme-version-footer">5.18.0</p>
<p>Last modified by: 
            <i class='fas fa-user'></i> Russell Feldhausen
            <i class='fas fa-calendar'></i> <a href="https://gitlab.cs.ksu.edu/cs-textbooks/cis580-textbook/-/commit/43f194969a638fa4572819da4b31060ad574a9ce">Aug 11, 2023</a>
</p>
</div>

    
    </div>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/clipboard.min.js?1691771333" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/perfect-scrollbar.min.js?1691771333" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis580/js/theme.js?1691771333" defer></script>
  </body>
</html>
