




  
	
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
	  

  
	
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
	  

  
	
		
		
<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.128.0">
    <meta name="generator" content="Relearn 6.0.0">
    <meta name="description" content="Rendering Complex 3D Objects">
    <meta name="author" content="Nathan Bean">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Models :: K-State CIS 580 Textbook">
    <meta name="twitter:description" content="Rendering Complex 3D Objects">
    <meta property="og:url" content="https://textbooks.cs.ksu.edu/cis580/16-models/">
    <meta property="og:site_name" content="K-State CIS 580 Textbook">
    <meta property="og:title" content="Models :: K-State CIS 580 Textbook">
    <meta property="og:description" content="Rendering Complex 3D Objects">
    <meta property="og:locale" content="en-us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Models :: K-State CIS 580 Textbook">
    <meta itemprop="description" content="Rendering Complex 3D Objects">
    <meta itemprop="datePublished" content="2020-03-20T10:53:05-05:00">
    <meta itemprop="dateModified" content="2023-08-11T11:18:05-05:00">
    <meta itemprop="wordCount" content="4">
    <title>Models :: K-State CIS 580 Textbook</title>
    <link href="https://textbooks.cs.ksu.edu/cis580/16-models/" rel="canonical" type="text/html" title="Models :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/index.xml" rel="alternate" type="application/rss+xml" title="Models :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/tele.html" rel="alternate" type="text/html" title="Models :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/embed.html" rel="alternate" type="text/html" title="Models :: K-State CIS 580 Textbook">
    <link href="/cis580/css/fontawesome-all.min.css?1719519539" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/fontawesome-all.min.css?1719519539" rel="stylesheet"></noscript>
    <link href="/cis580/css/nucleus.css?1719519539" rel="stylesheet">
    <link href="/cis580/css/auto-complete.css?1719519539" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/auto-complete.css?1719519539" rel="stylesheet"></noscript>
    <link href="/cis580/css/perfect-scrollbar.min.css?1719519539" rel="stylesheet">
    <link href="/cis580/css/fonts.css?1719519539" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/css/fonts.css?1719519539" rel="stylesheet"></noscript>
    <link href="/cis580/css/theme.css?1719519539" rel="stylesheet">
    <link href="/cis580/css/theme-auto.css?1719519539" rel="stylesheet" id="R-variant-style">
    <link href="/cis580/css/chroma-auto.css?1719519539" rel="stylesheet" id="R-variant-chroma-style">
    <link href="/cis580/css/variant.css?1719519539" rel="stylesheet">
    <link href="/cis580/css/print.css?1719519539" rel="stylesheet" media="print">
    <link href="/cis580/css/format-print.css?1719519539" rel="stylesheet">
    <script src="/cis580/js/variant.js?1719519539"></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.relBasePath='..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='https:\/\/textbooks.cs.ksu.edu\/cis580';
      window.index_js_url="/cis580/index.search.js";
      // variant stuff
      window.variants && variants.init( [ 'auto', 'light-theme', 'dark-theme' ] );
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
    
    <link href="/cis580/css/custom.css?1719519539" rel="stylesheet">
  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="/cis580/16-models/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li
            itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Models</span><meta itemprop="position" content="1"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/cis580/15-heightmap-terrain/06-summary/" title="Summary (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/cis580/16-models/01-introduction/" title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>

<h1 id="models">Models</h1>

<p>Rendering Complex 3D Objects</p>
<img src="https://media.giphy.com/media/xUA7aTKxZWcHEnAXoQ/giphy.gif"/>
            <footer class="footline">
              
              
              
              
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Models</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="introduction">Introduction</h1>

<p>With some experience building our own triangle meshes, let&rsquo;s turn our attention to those that have been built for us by artists working with modeling software.  These meshes are typically organized into a <em>model</em> - a collection of triangle meshes and transformations that collectively define a complex 3D shape.</p>
<p>Like our earlier examples, we&rsquo;ll start from a starter project with our assets pre-loaded.  In addition, we&rsquo;ll include the <code>ICamera</code> interface and the <code>CirclingCamera</code> we created in the lesson on <a href="https://textbooks.cs.ksu.edu/cis580/14-lighting-and-cameras/" rel="external" target="_blank">Lights and Cameras</a>, and the <code>Terrain</code> class and <code>IHeightMap</code> interface from our exploration of <a href="https://textbooks.cs.ksu.edu/cis580/15-heightmap-terrain/" rel="external" target="_blank">Heightmap Terrain</a>.  It is also preloaded with public-domain content assets, including a heightmap from Wikimedia and a ground texture from arikel&rsquo;s on OpenGameArt&rsquo;s [Seamless Textures]https://opengameart.org/content/seamless-textures).</p>
<p>You can find the starter project here: <a href="https://github.com/ksu-cis/model-starter" rel="external" target="_blank">https://github.com/ksu-cis/model-starter</a>.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="model-basics">Model Basics</h1>

<p>A <em>model</em> is a collection of the information that defines a 3D object. Rather than being hand-created or hard-coded (as we have done in our previous work), a model is usually created using 3D modeling software (i.e. Blender, 3D Studio, Maya, etc).  Instead of exposing the raw data of the meshes, these software packages provide an abstraction, often based on real-world sculpting techniques or constructive geometry transformations that assist artists in creating complex three-dimensional shapes.</p>
<p>As programmers, our interaction with models typically begins with the data exported from one of these programs as a file.  In our starter project&rsquo;s <em>Content</em> folder, we have one of these files, <em>tank.fbx</em>.  This particular format is text-based (not binary), so you can open it up in a text editor and look at its contents.  There are 3388 lines in the file - definitely more than we want to write.</p>
<p>There are many possible file formats for storing models, and each may include different information in different ways.  However, most will contain:</p>
<ol>
<li>A collection of meshes, defining the different parts of a model.  These meshes are typically laid out as triangle lists with vertex and index data</li>
<li>A collection of textures, which are applied to the meshes.  The textures may be embedded within the file, or be externally referenced (for our example, they are externally referenced).</li>
<li>A collection of &ldquo;bones&rdquo; - transformation matrices which place the different model meshes relative to one another.  Each bone also has a parent bone, allowing you to create hierarchical relationships between the meshes.</li>
<li>Material information used to render the meshes (i.e. data for Phong shading, or sometimes complete shaders)</li>
</ol>
<p>In addition, model files may contain alternative meshes to swap in and out (like different armors for a fantasy knight), and animations.</p>
<h2 id="loading-a-model">Loading a Model</h2>
<p>The XNA Framework provides a <a href="https://www.monogame.net/documentation/?page=T_Microsoft_Xna_Framework_Graphics_Model" rel="external" target="_blank">Model</a> class that is an relatively basic implementation of the main features we just discussed (it captures points 1-4, but no animation data).  As with most content files, it is instantiated through the content pipeline using the <a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Content_Pipeline_FbxImporter.html" rel="external" target="_blank">FBXImporter</a> and <a href="https://www.monogame.net/docs/html/T_Microsoft_Xna_Framework_Content_Pipeline_Processors_ModelProcessor.html" rel="external" target="_blank">ModelProcessor</a>.</p>
<p>Unfortunately, the only file format directly supported by the core XNA Framework is the <a href="https://www.autodesk.com/products/fbx/overview" rel="external" target="_blank">Autodesk FBX exchange format</a>, and only the a handful of <em>specific versions</em> that were in existance when XNA was first created.  This is not to say that you cannot write custom importers and/or processors to handle other file formats, but the FBX format remains the only one supported by the core MonoGame install.</p>
<p>Let&rsquo;s try loading a model in our example game.  We&rsquo;ll need to add a <code>Model</code> field to our <code>Game1</code> class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// A class representing our tank model</span>
</span></span><span class="line"><span class="cl">    <span class="n">Model</span> <span class="n">tank</span><span class="p">;</span></span></span></code></pre></div><p>Load the model in our <code>Game1.LoadContent()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Create the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">tank</span> <span class="p">=</span> <span class="n">Content</span><span class="p">.</span><span class="n">Load</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;(</span><span class="s">&#34;tank&#34;</span><span class="p">);</span></span></span></code></pre></div><p>And render it in our <code>Game1.Draw()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Draw the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">tank</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">Matrix</span><span class="p">.</span><span class="n">Identity</span><span class="p">,</span> <span class="n">camera</span><span class="p">.</span><span class="n">View</span><span class="p">,</span> <span class="n">camera</span><span class="p">.</span><span class="n">Projection</span><span class="p">);</span></span></span></code></pre></div><p>Note we need to provide a world, view, and projection matrix to the model to draw it.</p>
<p>If we run the game now, you should see the tank on (actually a bit <em>in</em>) the terrain:</p>
<p><a href="#R-image-1b54282e5839ef5c5616d378921fade2" class="lightbox-link"><img alt="The Rendered Model" class="border lazy lightbox noshadow figure-image" loading="lazy" src="/cis580/images/models-2.1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1b54282e5839ef5c5616d378921fade2"><img alt="The Rendered Model" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="/cis580/images/models-2.1.png"></a></p>
<p>But, that is about the extent of the functionality offered to us by the <code>Model</code> class.  Much like the <code>Texture2D</code>, it is simply providing us with the data from a content file in a more manageable format.  But as with the <code>Texture2D</code>, we will only use that as a starting point for doing some really interesting things.</p>
<p>Let&rsquo;s start that exploration by defining our own class to use this model.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="tank-class">Tank Class</h1>

<p>Instead of using the <code>Model</code> class directly, let&rsquo;s wrap it in our own custom class, <code>Tank</code>.  As with many of our classes, let&rsquo;s hold onto a <code>Game</code> reference.  In addition, let&rsquo;s have a reference to the <code>Model</code> of the tank, and its position and orentation in the world:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// A class representing a tank in the game</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Tank</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The game this tank belongs to </span>
</span></span><span class="line"><span class="cl">    <span class="n">Game</span> <span class="n">game</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The tank&#39;s model</span>
</span></span><span class="line"><span class="cl">    <span class="n">Model</span> <span class="n">model</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The tank&#39;s position in the world </span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector3</span> <span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The direction the tank is facing</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">facing</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>We set the initial position to (0,0,0) and facing to 0.  Alternatively, we could pass the intial values for these fields through the constructor.</p>
<h2 id="properties">Properties</h2>
<p>As the last comments suggests, we&rsquo;re going to allow our tank to move through the world.  We might add a <code>Speed</code> property so our game can control how fast it moves:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Gets or sets the speed of the tank</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Speed</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="m">0.1f</span><span class="p">;</span></span></span></code></pre></div><h2 id="constructor">Constructor</h2>
<p>Constructing the tank is rather simple - just saving the <code>Game</code> instance and loading the model:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Constructs a new Tank instance</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;The game this tank belongs to&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Tank</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">game</span> <span class="p">=</span> <span class="n">game</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="p">=</span> <span class="n">game</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">Load</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;(</span><span class="s">&#34;tank&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h2 id="update-method">Update Method</h2>
<p>In our update, let&rsquo;s control our movement with the WASD keys.  Let&rsquo;s also assume the tank has a zero turning radius, so it can effectively spin in place.  Accordingly, we&rsquo;ll handle rotation and forward/backward movement separately.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Updates the tank, moving it based on player input</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;gameTime&#34;&gt;The current GameTime&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">keyboard</span> <span class="p">=</span> <span class="n">Keyboard</span><span class="p">.</span><span class="n">GetState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Forward/Backward Movement </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Rotation Movement</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h3 id="forwardbackward-movement">Forward/Backward Movement</h3>
<p>Before we can move forward or backward, we first need to determine just what direction that is.  An easy way to do so is to rotate a unit vector facing forward by the facing angle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">direction</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">Forward</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateRotationY</span><span class="p">(</span><span class="n">facing</span><span class="p">));</span></span></span></code></pre></div><p>We can then subtract this facing vector, multiplied by our speed, to the tank&rsquo;s position when it is moving forward:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">W</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span> <span class="p">-=</span> <span class="n">Speed</span> <span class="p">*</span> <span class="n">direction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>And add it when we&rsquo;re moving backward:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">S</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span> <span class="p">+=</span> <span class="n">Speed</span> <span class="p">*</span> <span class="n">direction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h3 id="rotational-movement">Rotational Movement</h3>
<p>Rotation is even more straightforward; we&rsquo;ll just add or subtract the speed from the <code>facing</code> angle, depending on which key is pressed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">A</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">facing</span> <span class="p">+=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">D</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">facing</span> <span class="p">-=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h2 id="drawing-the-tank">Drawing the Tank</h2>
<p>For now, we&rsquo;ll stick with using the <code>Model.Draw()</code> method.  We&rsquo;ll need to supply it with the <code>View</code> and <code>Projection</code> matrices from our camera, and the <code>World</code> matrix will be determined by the <code>facing</code> angle and <code>position</code> vector:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Draws the tank in the world</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;camera&#34;&gt;The camera used to render the world&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Draw</span><span class="p">(</span><span class="n">ICamera</span> <span class="n">camera</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Matrix</span> <span class="n">world</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateRotationY</span><span class="p">(</span><span class="n">facing</span><span class="p">)</span> <span class="p">*</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateTranslation</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Matrix</span> <span class="n">view</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">View</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Matrix</span> <span class="n">projection</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">Projection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">projection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><h2 id="refactoring-game1">Refactoring Game1</h2>
<p>Of course, to see our tank in action, we&rsquo;ll need to refactor <code>Game</code> to use it.  Change the <code>tank</code> field to have type <code>Tank</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// A class representing our tank model</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tank</span> <span class="n">tank</span><span class="p">;</span></span></span></code></pre></div><p>Swap <code>Content.Load&lt;Model&gt;(&quot;tank&quot;)</code> for our constructor in the <code>Game1.LoadContent()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Create the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">tank</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Tank</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></span></span></code></pre></div><p>We&rsquo;ll need to add a call to <code>Tank.Update()</code> in our <code>Game1.Update()</code> method to process user input:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Update the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">tank</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span></span></span></code></pre></div><p>And switch the arguments to <code>Tank.Draw()</code> in our <code>Game1.Draw()</code> method to the camera:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Draw the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">tank</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">Matrix</span><span class="p">.</span><span class="n">Identity</span><span class="p">,</span> <span class="n">camera</span><span class="p">.</span><span class="n">View</span><span class="p">,</span> <span class="n">camera</span><span class="p">.</span><span class="n">Projection</span><span class="p">);</span></span></span></code></pre></div><p>If you run the game now, you should be able to drive your tank through the terrain.  Quite literally <em>through</em>.</p>
<h2 id="getting-on-top-of-the-terrain">Getting on Top of the Terrain</h2>
<p>Rather than have our tank plow through the ground unrelistically, let&rsquo;s get it to set on top of the terrain.  To do so, we&rsquo;ll need to have access to the terrain from within our <code>Tank</code> class.  Let&rsquo;s add a <code>HeightMap</code> property to it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Gets or sets the IHeightMap this tank is driving upon</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IHeightMap</span> <span class="n">HeightMap</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></span></span></code></pre></div><p>We can then use the <code>IHeightMap.GetHeightAt()</code> method in our <code>Tank.Update()</code> to set the tank to the height of the terrain where it is currently at:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Set the tank&#39;s height based on the HeightMap</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">HeightMap</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">Y</span> <span class="p">=</span> <span class="n">HeightMap</span><span class="p">.</span><span class="n">GetHeightAt</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Of course, we don&rsquo;t want to do this if the <code>HeightMap</code> property hasn&rsquo;t been set.</p>
<h2 id="refactoring-game1cs">Refactoring Game1.cs</h2>
<p>That setting is accomplished in <code>Game1.LoadContent</code>, after we&rsquo;ve created both the tank and the terrain:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">tank</span><span class="p">.</span><span class="n">HeightMap</span> <span class="p">=</span> <span class="n">terrain</span><span class="p">;</span></span></span></code></pre></div><p>Now if you run the game, the tank rises and falls with the land it travels over:</p>
<p><a href="#R-image-265ed9e53cc96fed52df37c9de71d9fa" class="lightbox-link"><img alt="The Tank, No Longer Stuck in the Terrain" class="border lazy lightbox noshadow figure-image" loading="lazy" src="/cis580/images/models-3.1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-265ed9e53cc96fed52df37c9de71d9fa"><img alt="The Tank, No Longer Stuck in the Terrain" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="/cis580/images/models-3.1.png"></a></p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="skeletal-animation">Skeletal Animation</h1>

<p>Now that we can see our tank clearly, let&rsquo;s see if we can&rsquo;t get that turret to aim. Doing so requires us to explore the concept of <em>skeletal animation</em>.  If you remember in our discussion of models, we said most models include both triangle meshes and <em>bones</em>.  These &ldquo;bones&rdquo; are really just transformation matrices, which are applied to a specific mesh in the model.  Often they also are arranged in a hierarchy, often referred to as a skeleton.  The transformations represented by bones earlier in the hierarchy are concatenated with those lower to compute a final transformation to apply to that mesh.</p>
<p>In our tank, the turret bone is a child of the tank body.  Thus, the turret is transformed by <em>both</em> by the bone of the tank body <em>and</em> the bone of the turret.  Thus, if the tank body moves through the world, the turret comes along for the ride.  Without using this hierarchical approach, we would have to calculate the turret transform based on where the tank currently is, a more challenging proposition.</p>
<h2 id="exposing-the-tanks-transformations">Exposing The Tank&rsquo;s Transformations</h2>
<p>To take advantage of skeletal animation, we&rsquo;ll need to manage the transformations ourselves.  We&rsquo;ll start by declaring an array in the <code>Tank</code> class to hold them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The bone transformation matrices of the tank</span>
</span></span><span class="line"><span class="cl">    <span class="n">Matrix</span><span class="p">[]</span> <span class="n">transforms</span><span class="p">;</span></span></span></code></pre></div><p>We&rsquo;ll initialize this array in our constructor, after we&rsquo;ve loaded the model:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">transforms</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Matrix</span><span class="p">[</span><span class="n">model</span><span class="p">.</span><span class="n">Bones</span><span class="p">.</span><span class="n">Count</span><span class="p">];</span></span></span></code></pre></div><p>And in our <code>Tank.Draw()</code> method, we&rsquo;ll apply the model&rsquo;s transforms.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">model</span><span class="p">.</span><span class="n">CopyAbsoluteBoneTransformsTo</span><span class="p">(</span><span class="n">transforms</span><span class="p">);</span></span></span></code></pre></div><p>This method walks down the skeleton, concatenating the parent transforms with those of the children bones.  Thus, the transformation matrices in the <code>transforms</code> array after this point are the final transformation that will be applied to the mesh in question.</p>
<p>Then, instead of simply invoking <code>model.draw()</code>, we&rsquo;ll iterate over each mesh, applying its bone transform manually:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// draw the tank meshes </span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span><span class="p">(</span><span class="n">ModelMesh</span> <span class="n">mesh</span> <span class="k">in</span> <span class="n">model</span><span class="p">.</span><span class="n">Meshes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="n">BasicEffect</span> <span class="n">effect</span> <span class="k">in</span> <span class="n">mesh</span><span class="p">.</span><span class="n">Effects</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">effect</span><span class="p">.</span><span class="n">EnableDefaultLighting</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">effect</span><span class="p">.</span><span class="n">World</span> <span class="p">=</span> <span class="n">bones</span><span class="p">[</span><span class="n">mesh</span><span class="p">.</span><span class="n">ParentBone</span><span class="p">.</span><span class="n">Index</span><span class="p">]</span> <span class="p">*</span> <span class="n">world</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">effect</span><span class="p">.</span><span class="n">View</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">View</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">effect</span><span class="p">.</span><span class="n">Projection</span> <span class="p">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">Projection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">mesh</span><span class="p">.</span><span class="n">Draw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>At this point, our tank will appear exactly as it did before.  These nested loops are pretty much exactly the code that was invoked by <code>model.draw()</code>.  But the default <code>model.draw()</code> does not perform the absolute bone transformation - instead it uses precalculated defaults.  Thus, we must implement this double-loop if we want to use skeletal animation.</p>
<h2 id="rotating-the-turret">Rotating the Turret</h2>
<p>We can rotate the turret by applying a transformation to the bone corresponding to its mesh. This requires us to add some fields to our <code>Tank</code> class.  First, a reference to the bone we want to transform:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The turret bone </span>
</span></span><span class="line"><span class="cl">    <span class="n">ModelBone</span> <span class="n">turretBone</span><span class="p">;</span></span></span></code></pre></div><p>We also need to know its original transformation, so let&rsquo;s create a matrix to store that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The original turret transformation</span>
</span></span><span class="line"><span class="cl">    <span class="n">Matrix</span> <span class="n">turretTransform</span><span class="p">;</span></span></span></code></pre></div><p>And we&rsquo;ll also create an angle field to track the turret rotation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The rotation angle of the turret</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">turretRotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span></span></span></code></pre></div><p>We still need to know the bone we want to transform.  If we look through the <em>tank.fbx</em> file, we can find it is named &ldquo;turret_geo&rdquo;.  The <a href="https://www.monogame.net/documentation/?page=P_Microsoft_Xna_Framework_Graphics_Model_Bones" rel="external" target="_blank">model.Bones</a> property can be accessed with either an index, or a key string (like a dictionary).</p>
<p>Thus, after the model is loaded in the constructor we can get a reference to our bone from its name, and from that bone get its original transformation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Set the turret fields</span>
</span></span><span class="line"><span class="cl">    <span class="n">turretBone</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">Bones</span><span class="p">[</span><span class="s">&#34;turret_geo&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">turretTransform</span> <span class="p">=</span> <span class="n">turretBone</span><span class="p">.</span><span class="n">Transform</span><span class="p">;</span></span></span></code></pre></div><p>Then in our <code>Tank.Update()</code>, let&rsquo;s use the left and right arrow keys to rotate the turret.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// rotate the turret</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">Left</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">turretRotation</span> <span class="p">-=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">Right</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">turretRotation</span> <span class="p">+=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Now in the <code>Tank.Draw()</code> method, we need to set the <code>turretBone.Transform</code> to include our rotation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// apply turret rotation</span>
</span></span><span class="line"><span class="cl">    <span class="n">turretBone</span><span class="p">.</span><span class="n">Transform</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateRotationY</span><span class="p">(</span><span class="n">turretRotation</span><span class="p">)</span> <span class="p">*</span> <span class="n">turretTransform</span><span class="p">;</span></span></span></code></pre></div><p>Now if you run the game, you should be able to rotate the turret left and right with the arrow keys!</p>
<h2 id="tilting-the-canon">Tilting the Canon</h2>
<p>We can allow the player to tilt the canon barrel using the up and down keys in much the same fashion.  We&rsquo;ll start by adding corresponding fields to the <code>Tank</code> class: an angle of rotation, the canon bone, and default canon transform:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Barrel fields </span>
</span></span><span class="line"><span class="cl">    <span class="n">ModelBone</span> <span class="n">canonBone</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Matrix</span> <span class="n">canonTransform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">canonRotation</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span></span></span></code></pre></div><p>And we can populate these in the constructor, once the model is loaded:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Set the canon fields</span>
</span></span><span class="line"><span class="cl">    <span class="n">canonBone</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="n">Bones</span><span class="p">[</span><span class="s">&#34;canon_geo&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">canonTransform</span> <span class="p">=</span> <span class="n">canonBone</span><span class="p">.</span><span class="n">Transform</span><span class="p">;</span></span></span></code></pre></div><p>In our <code>Tank.Update()</code>, we can increase or decrease the rotation much like we did with the turret:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Update the canon angle</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">Up</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">canonRotation</span> <span class="p">-=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">keyboard</span><span class="p">.</span><span class="n">IsKeyDown</span><span class="p">(</span><span class="n">Keys</span><span class="p">.</span><span class="n">Down</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">canonRotation</span> <span class="p">+=</span> <span class="n">Speed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>However, we probably don&rsquo;t want an unlimited amount of rotation - or the cannon will rotate right through the turret and tank body!  So let&rsquo;s clamp the final value to a reasonable limit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Limit canon rotation to a reasonable range </span>
</span></span><span class="line"><span class="cl">    <span class="n">canonRotation</span> <span class="p">=</span> <span class="n">MathHelper</span><span class="p">.</span><span class="n">Clamp</span><span class="p">(</span><span class="n">canonRotation</span><span class="p">,</span> <span class="p">-</span><span class="n">MathHelper</span><span class="p">.</span><span class="n">PiOver4</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span></span></span></code></pre></div><p>Finally, we can add the canon rotation to the <code>Tank.Draw()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">canonBone</span><span class="p">.</span><span class="n">Transform</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateRotationX</span><span class="p">(</span><span class="n">canonRotation</span><span class="p">)</span> <span class="p">*</span> <span class="n">canonTransform</span><span class="p">;</span></span></span></code></pre></div><p>Now you can drive around the terrain, aiming your cannon wherever you like!</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="chase-camera">Chase Camera</h1>

<p>At this point, we have a pretty impressive tank, but it can be kind of difficult to see.  Let&rsquo;s implement a new kind of camera, which will stay close to the tank, and follow as it moves.  Of course, to do so, we need to know where the tank is.</p>
<h2 id="the-ifollowable-interface">The IFollowable Interface</h2>
<p>Let&rsquo;s create an interface to declare the properties we would need to be able to follow an arbitrary game object - basically, its position in the world, and the direction it is facing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">interface</span> <span class="nc">IFollowable</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The IFollowable&#39;s position in the world </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The angle the IFollowable is facing, in radians </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">Facing</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>By creating this interface, we can have our camera follow not just the tank, but any class that implements the interface.</p>
<h2 id="refactoring-the-tank">Refactoring the Tank</h2>
<p>We&rsquo;ll need to make our tank implement this interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Tank</span> <span class="p">:</span> <span class="n">IFollowable</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span></span></span></code></pre></div><p>And add the properties it requires.  This boils down to just exposing existing private fields with a getter:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The position of the tank in the world </span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The angle the tank is facing (in radians)</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">float</span> <span class="n">Facing</span> <span class="p">=&gt;</span> <span class="n">facing</span><span class="p">;</span></span></span></code></pre></div><p>Now our tank is ready to be followed.  Let&rsquo;s define our camera next.</p>
<h2 id="the-chasecamera-class">The ChaseCamera Class</h2>
<p>Our <code>ChaseCamera</code> needs to implement the <code>ICamera</code> interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// A camera that chases an IFollowable</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">ChaseCamera</span> <span class="p">:</span> <span class="n">ICamera</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>For fields, we&rsquo;ll keep an instance of the <code>Game</code> we belong to, as well as private backing variables for the projection and view matrices:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">Game</span> <span class="n">game</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Matrix</span> <span class="n">projection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Matrix</span> <span class="n">view</span><span class="p">;</span></span></span></code></pre></div><p>And for properties, we&rsquo;ll need to implement the <code>View</code> and <code>Projection</code> properties of the <code>ICamera</code> interface.  Plus, we&rsquo;ll add a property for our <code>IFollowable</code> and an offset vector defining where the camera should be in relation to its target.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The target this camera should follow</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IFollowable</span> <span class="n">Target</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The positon of the camera in relation to its target</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Vector3</span> <span class="n">Offset</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The camera&#39;s view matrix</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Matrix</span> <span class="n">View</span> <span class="p">=&gt;</span> <span class="n">view</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// The camera&#39;s projection matrix</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Matrix</span> <span class="n">Projection</span> <span class="p">=&gt;</span> <span class="n">projection</span><span class="p">;</span></span></span></code></pre></div><p>For the constructor, we&rsquo;ll initialize the game and offset vector, as well as our matricies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Creates a new ChaseCamera</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;game&#34;&gt;The game this camera belongs to&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;offset&#34;&gt;The offset the camera should maintian from its target&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ChaseCamera</span><span class="p">(</span><span class="n">Game</span> <span class="n">game</span><span class="p">,</span> <span class="n">Vector3</span> <span class="n">offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">game</span> <span class="p">=</span> <span class="n">game</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">Offset</span> <span class="p">=</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">projection</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreatePerspectiveFieldOfView</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">MathHelper</span><span class="p">.</span><span class="n">PiOver4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">game</span><span class="p">.</span><span class="n">GraphicsDevice</span><span class="p">.</span><span class="n">Viewport</span><span class="p">.</span><span class="n">AspectRatio</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="m">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="m">1000</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateLookAt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector3</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector3</span><span class="p">.</span><span class="n">Up</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>Finally, we&rsquo;ll need an <code>Update()</code> method to move the camera into position each frame:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// Updates the camera, placing it relative to the target</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;gameTime&#34;&gt;The GameTime&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Target</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// calculate the position of the camera</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">position</span> <span class="p">=</span> <span class="n">Target</span><span class="p">.</span><span class="n">Position</span> <span class="p">+</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">Offset</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateRotationY</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Facing</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">Matrix</span><span class="p">.</span><span class="n">CreateLookAt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Target</span><span class="p">.</span><span class="n">Position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Vector3</span><span class="p">.</span><span class="n">Up</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>If we have no target, there&rsquo;s no need to move the camera.  But if there is, we calculate the camera by rotating the offset vector by the target&rsquo;s facing, and adding it to the target&rsquo;s position.  We then create our LookAt matrix.</p>
<h2 id="refactoring-the-game-class">Refactoring the Game Class</h2>
<p>To use the new camera implementation, change the <code>CirclingCamera camera</code> property to a <code>ChaseCamera</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// The camera </span>
</span></span><span class="line"><span class="cl">    <span class="n">ChaseCamera</span> <span class="n">camera</span><span class="p">;</span></span></span></code></pre></div><p>And swap the camera constructor in <code>Game1.LoadContent()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="c1">// Create the camera</span>
</span></span><span class="line"><span class="cl">    <span class="n">camera</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChaseCamera</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">Vector3</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="p">-</span><span class="m">30</span><span class="p">));</span></span></span></code></pre></div><p>In the same method, after both the camera and tank have been created, set the tank as the camera&rsquo;s target:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl">    <span class="n">camera</span><span class="p">.</span><span class="n">Target</span> <span class="p">=</span> <span class="n">tank</span><span class="p">;</span></span></span></code></pre></div><p>The rest of the existing camera code (in the <code>Update()</code> and <code>Draw()</code> methods) doesn&rsquo;t need changed.</p>
<p>If you run the game now, you should see the backside of your tank:</p>
<p><a href="#R-image-312e06d31c916c33be1e671c5d234720" class="lightbox-link"><img alt="The ChaseCamera in Action" class="border lazy lightbox noshadow figure-image" loading="lazy" src="/cis580/images/models-6.1.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-312e06d31c916c33be1e671c5d234720"><img alt="The ChaseCamera in Action" class="border lazy lightbox noshadow lightbox-image" loading="lazy" src="/cis580/images/models-6.1.png"></a></p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>

<h1 id="summary">Summary</h1>

<p>Now that you have a closer view of your tank, you might want to make the individual wheels rotate.  I&rsquo;ll leave that as an exercise for the reader, but the bones you&rsquo;d be interested in are &ldquo;r_back_wheel_geo&rdquo;, &ldquo;l_back_wheel_geo&rdquo;, &ldquo;r_front_wheel_geo&rdquo;, and &ldquo;l_front_wheel_geo&rdquo;.  The front wheels are also set up to be rotated, using the &ldquo;r_steer_geo&rdquo; and &ldquo;l_steer_geo&rdquo; bones.</p>
<p>Clearly there is a lot more you could do just with the tank model.  You can also &ldquo;reskin&rdquo; the tank by swapping out the texture it is using.  You could add particle systems to each of those exhaust pipes on the rear of the tank.  And, you could use the transformation matrix for the cannon to transform a forward vector into a projectile trajectory, to fire shells into the distance.</p>
<p>More importantly, you&rsquo;ve seen the basics of how a model is loaded and used in XNA.  While the current importer is limited, you could also write your own custom importer for other 3D model formats.  As long as it is organized similarly, you could use the existing <code>ModelContent</code> as the target of your importer, and the existing <code>ModelProcessor</code> to convert the loaded data into an xnb file to be loaded as a <code>Model</code>.  Or you could also develop your own model processor and possibly class as well.</p>

            <footer class="footline">
              
              
              
              
            </footer>
          </article>

          </section>
        </div>
      </main>
    
<div class="git-footer">
  <p class="theme-version-footer">6.0.0</p>
  <p>Last modified by: 
              <i class='fas fa-user'></i> Russell Feldhausen
              <i class='fas fa-calendar'></i> <a href="https://github.com/ksu-cs-textbooks/cis580/commit/43f194969a638fa4572819da4b31060ad574a9ce">Aug 11, 2023</a>
  </p>
  </div>
  
    
    </div>
    <script src="/cis580/js/clipboard.min.js?1719519539" defer></script>
    <script src="/cis580/js/perfect-scrollbar.min.js?1719519539" defer></script>
    <script src="/cis580/js/theme.js?1719519539" defer></script>
  </body>
</html>
