<!DOCTYPE html>

<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.128.0">
    <meta name="generator" content="Relearn 8.0.0">
    <meta name="description" content="Now that we can see our tank clearly, let’s see if we can’t get that turret to aim. Doing so requires us to explore the concept of skeletal animation. If you remember in our discussion of models, we said most models include both triangle meshes and bones. These “bones” are really just transformation matrices, which are applied to a specific mesh in the model. Often they also are arranged in a hierarchy, often referred to as a skeleton.">
    <meta name="author" content="Nathan H. Bean">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://textbooks.cs.ksu.edu/cis580/images/hero.png">
    <meta name="twitter:title" content="Skeletal Animation :: K-State CIS 580 Textbook">
    <meta name="twitter:description" content="Now that we can see our tank clearly, let’s see if we can’t get that turret to aim. Doing so requires us to explore the concept of skeletal animation. If you remember in our discussion of models, we said most models include both triangle meshes and bones. These “bones” are really just transformation matrices, which are applied to a specific mesh in the model. Often they also are arranged in a hierarchy, often referred to as a skeleton.">
    <meta property="og:url" content="https://textbooks.cs.ksu.edu/cis580/16-models/04-skeletal-animation/index.html">
    <meta property="og:site_name" content="K-State CIS 580 Textbook">
    <meta property="og:title" content="Skeletal Animation :: K-State CIS 580 Textbook">
    <meta property="og:description" content="Now that we can see our tank clearly, let’s see if we can’t get that turret to aim. Doing so requires us to explore the concept of skeletal animation. If you remember in our discussion of models, we said most models include both triangle meshes and bones. These “bones” are really just transformation matrices, which are applied to a specific mesh in the model. Often they also are arranged in a hierarchy, often referred to as a skeleton.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Models">
    <meta property="article:published_time" content="2020-03-24T10:00:00-05:00">
    <meta property="article:modified_time" content="2021-04-23T16:59:02-05:00">
    <meta property="og:image" content="https://textbooks.cs.ksu.edu/cis580/images/hero.png">
    <meta itemprop="name" content="Skeletal Animation :: K-State CIS 580 Textbook">
    <meta itemprop="description" content="Now that we can see our tank clearly, let’s see if we can’t get that turret to aim. Doing so requires us to explore the concept of skeletal animation. If you remember in our discussion of models, we said most models include both triangle meshes and bones. These “bones” are really just transformation matrices, which are applied to a specific mesh in the model. Often they also are arranged in a hierarchy, often referred to as a skeleton.">
    <meta itemprop="datePublished" content="2020-03-24T10:00:00-05:00">
    <meta itemprop="dateModified" content="2021-04-23T16:59:02-05:00">
    <meta itemprop="wordCount" content="823">
    <meta itemprop="image" content="https://textbooks.cs.ksu.edu/cis580/images/hero.png">
    <title>Skeletal Animation :: K-State CIS 580 Textbook</title>
    <link href="https://textbooks.cs.ksu.edu/cis580/16-models/04-skeletal-animation/index.html" rel="canonical" type="text/html" title="Skeletal Animation :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/04-skeletal-animation/index.xml" rel="alternate" type="application/rss+xml" title="Skeletal Animation :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/04-skeletal-animation/index.print.html" rel="alternate" type="text/html" title="Skeletal Animation :: K-State CIS 580 Textbook">
    <link href="/cis580/16-models/04-skeletal-animation/tele.html" rel="alternate" type="text/html" title="Skeletal Animation :: K-State CIS 580 Textbook">
    <link href="/cis580/css/auto-complete/auto-complete.min.css?1755628803" rel="stylesheet">
    <script src="/cis580/js/auto-complete/auto-complete.min.js?1755628803" defer></script>
    <script src="/cis580/js/search-lunr.min.js?1755628803" defer></script>
    <script src="/cis580/js/search.min.js?1755628803" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/cis580/searchindex.en.js?1755628803";
    </script>
    <script src="/cis580/js/lunr/lunr.min.js?1755628803" defer></script>
    <script src="/cis580/js/lunr/lunr.stemmer.support.min.js?1755628803" defer></script>
    <script src="/cis580/js/lunr/lunr.multi.min.js?1755628803" defer></script>
    <script src="/cis580/js/lunr/lunr.en.min.js?1755628803" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/cis580/fonts/fontawesome/css/fontawesome-all.min.css?1755628803" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/cis580/fonts/fontawesome/css/fontawesome-all.min.css?1755628803" rel="stylesheet"></noscript>
    <link href="/cis580/css/perfect-scrollbar/perfect-scrollbar.min.css?1755628803" rel="stylesheet">
    <link href="/cis580/css/theme.min.css?1755628803" rel="stylesheet">
    <link href="/cis580/css/format-html.min.css?1755628803" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/16-models\/04-skeletal-animation\/index.html';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='https:\/\/textbooks.cs.ksu.edu\/cis580';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=false;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'light-theme' ];
      window.relearn.customvariantname = "my-custom-variant";
      // [x] russfeld
      window.relearn.writeVariant=false;
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          
          if (window.relearn.writeVariant) {
            window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
          }
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
    <link href="/cis580/css/custom.css?1755628803" rel="stylesheet">
  </head>
  <body class="mobile-support embed html" data-url="/cis580/16-models/04-skeletal-animation/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      
      
      
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable 16-models" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="skeletal-animation">Skeletal Animation</h1>

<p>Now that we can see our tank clearly, let&rsquo;s see if we can&rsquo;t get that turret to aim. Doing so requires us to explore the concept of <em>skeletal animation</em>.  If you remember in our discussion of models, we said most models include both triangle meshes and <em>bones</em>.  These &ldquo;bones&rdquo; are really just transformation matrices, which are applied to a specific mesh in the model.  Often they also are arranged in a hierarchy, often referred to as a skeleton.  The transformations represented by bones earlier in the hierarchy are concatenated with those lower to compute a final transformation to apply to that mesh.</p>
<p>In our tank, the turret bone is a child of the tank body.  Thus, the turret is transformed by <em>both</em> by the bone of the tank body <em>and</em> the bone of the turret.  Thus, if the tank body moves through the world, the turret comes along for the ride.  Without using this hierarchical approach, we would have to calculate the turret transform based on where the tank currently is, a more challenging proposition.</p>
<h2 id="exposing-the-tanks-transformations">Exposing The Tank&rsquo;s Transformations</h2>
<p>To take advantage of skeletal animation, we&rsquo;ll need to manage the transformations ourselves.  We&rsquo;ll start by declaring an array in the <code>Tank</code> class to hold them:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The bone transformation matrices of the tank</span>
</span></span><span style="display:flex;"><span>    Matrix[] transforms;</span></span></code></pre></div>
<p>We&rsquo;ll initialize this array in our constructor, after we&rsquo;ve loaded the model:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    transforms = <span style="color:#66d9ef">new</span> Matrix[model.Bones.Count];</span></span></code></pre></div>
<p>And in our <code>Tank.Draw()</code> method, we&rsquo;ll apply the model&rsquo;s transforms.</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    model.CopyAbsoluteBoneTransformsTo(transforms);</span></span></code></pre></div>
<p>This method walks down the skeleton, concatenating the parent transforms with those of the children bones.  Thus, the transformation matrices in the <code>transforms</code> array after this point are the final transformation that will be applied to the mesh in question.</p>
<p>Then, instead of simply invoking <code>model.draw()</code>, we&rsquo;ll iterate over each mesh, applying its bone transform manually:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// draw the tank meshes </span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span>(ModelMesh mesh <span style="color:#66d9ef">in</span> model.Meshes)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span>(BasicEffect effect <span style="color:#66d9ef">in</span> mesh.Effects)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            effect.EnableDefaultLighting();
</span></span><span style="display:flex;"><span>            effect.World = bones[mesh.ParentBone.Index] * world;
</span></span><span style="display:flex;"><span>            effect.View = camera.View;
</span></span><span style="display:flex;"><span>            effect.Projection = camera.Projection;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        mesh.Draw();
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<p>At this point, our tank will appear exactly as it did before.  These nested loops are pretty much exactly the code that was invoked by <code>model.draw()</code>.  But the default <code>model.draw()</code> does not perform the absolute bone transformation - instead it uses precalculated defaults.  Thus, we must implement this double-loop if we want to use skeletal animation.</p>
<h2 id="rotating-the-turret">Rotating the Turret</h2>
<p>We can rotate the turret by applying a transformation to the bone corresponding to its mesh. This requires us to add some fields to our <code>Tank</code> class.  First, a reference to the bone we want to transform:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The turret bone </span>
</span></span><span style="display:flex;"><span>    ModelBone turretBone;</span></span></code></pre></div>
<p>We also need to know its original transformation, so let&rsquo;s create a matrix to store that:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The original turret transformation</span>
</span></span><span style="display:flex;"><span>    Matrix turretTransform;</span></span></code></pre></div>
<p>And we&rsquo;ll also create an angle field to track the turret rotation:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// The rotation angle of the turret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> turretRotation = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div>
<p>We still need to know the bone we want to transform.  If we look through the <em>tank.fbx</em> file, we can find it is named &ldquo;turret_geo&rdquo;.  The <a href="https://www.monogame.net/documentation/?page=P_Microsoft_Xna_Framework_Graphics_Model_Bones" rel="external" target="_blank">model.Bones</a> property can be accessed with either an index, or a key string (like a dictionary).</p>
<p>Thus, after the model is loaded in the constructor we can get a reference to our bone from its name, and from that bone get its original transformation:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the turret fields</span>
</span></span><span style="display:flex;"><span>    turretBone = model.Bones[<span style="color:#e6db74">&#34;turret_geo&#34;</span>];
</span></span><span style="display:flex;"><span>    turretTransform = turretBone.Transform;</span></span></code></pre></div>
<p>Then in our <code>Tank.Update()</code>, let&rsquo;s use the left and right arrow keys to rotate the turret.</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// rotate the turret</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Left))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        turretRotation -= Speed;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Right))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        turretRotation += Speed;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<p>Now in the <code>Tank.Draw()</code> method, we need to set the <code>turretBone.Transform</code> to include our rotation:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// apply turret rotation</span>
</span></span><span style="display:flex;"><span>    turretBone.Transform = Matrix.CreateRotationY(turretRotation) * turretTransform;</span></span></code></pre></div>
<p>Now if you run the game, you should be able to rotate the turret left and right with the arrow keys!</p>
<h2 id="tilting-the-canon">Tilting the Canon</h2>
<p>We can allow the player to tilt the canon barrel using the up and down keys in much the same fashion.  We&rsquo;ll start by adding corresponding fields to the <code>Tank</code> class: an angle of rotation, the canon bone, and default canon transform:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Barrel fields </span>
</span></span><span style="display:flex;"><span>    ModelBone canonBone;
</span></span><span style="display:flex;"><span>    Matrix canonTransform;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> canonRotation = <span style="color:#ae81ff">0</span>;</span></span></code></pre></div>
<p>And we can populate these in the constructor, once the model is loaded:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Set the canon fields</span>
</span></span><span style="display:flex;"><span>    canonBone = model.Bones[<span style="color:#e6db74">&#34;canon_geo&#34;</span>];
</span></span><span style="display:flex;"><span>    canonTransform = canonBone.Transform;</span></span></code></pre></div>
<p>In our <code>Tank.Update()</code>, we can increase or decrease the rotation much like we did with the turret:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Update the canon angle</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Up))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        canonRotation -= Speed;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(keyboard.IsKeyDown(Keys.Down))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        canonRotation += Speed;
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<p>However, we probably don&rsquo;t want an unlimited amount of rotation - or the cannon will rotate right through the turret and tank body!  So let&rsquo;s clamp the final value to a reasonable limit:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Limit canon rotation to a reasonable range </span>
</span></span><span style="display:flex;"><span>    canonRotation = MathHelper.Clamp(canonRotation, -MathHelper.PiOver4, <span style="color:#ae81ff">0</span>);</span></span></code></pre></div>
<p>Finally, we can add the canon rotation to the <code>Tank.Draw()</code> method:</p>
<div class="highlight" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    canonBone.Transform = Matrix.CreateRotationX(canonRotation) * canonTransform;</span></span></code></pre></div>
<p>Now you can drive around the terrain, aiming your cannon wherever you like!</p>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
      
      
      
    </div>
    <script src="/cis580/js/clipboard/clipboard.min.js?1755628803" defer></script>
    <script src="/cis580/js/perfect-scrollbar/perfect-scrollbar.min.js?1755628803" defer></script>
    <script src="/cis580/js/theme.min.js?1755628803" defer></script>
  <script src="/cis580/js/embed-iframe.min.js?1755628803" defer></script>
  </body>
</html>
